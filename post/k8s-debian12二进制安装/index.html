<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Debian12二进制安装k8s v1.25.12 - AGou's Blog-2</title><meta name=Description content="关于博主"><meta property="og:title" content="Debian12二进制安装k8s v1.25.12"><meta property="og:description" content="篇幅过长，为了更好的阅读体验可以前往我的文档-k8s Debian12 二进制安装 或者我的备用博客地址 .
一、预先准备
1.1 服务器角色
环境信息：

k8s版本：v1.25.12
Debian12(bookworm)：内核6.1.0-9-amd64




角色
IP
组件列表




master
172.19.82.157
kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、etcd、containerd


node01
172.19.82.158
kubelet、kube-proxy、containerd、etcd


node02
172.19.82.159
kubelet、kube-proxy、containerd、etcd"><meta property="og:type" content="article"><meta property="og:url" content="https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2023-08-27T10:33:38+08:00"><meta property="article:modified_time" content="2023-08-27T10:33:38+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="Debian12二进制安装k8s v1.25.12"><meta name=twitter:description content="篇幅过长，为了更好的阅读体验可以前往我的文档-k8s Debian12 二进制安装 或者我的备用博客地址 .
一、预先准备
1.1 服务器角色
环境信息：

k8s版本：v1.25.12
Debian12(bookworm)：内核6.1.0-9-amd64




角色
IP
组件列表




master
172.19.82.157
kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、etcd、containerd


node01
172.19.82.158
kubelet、kube-proxy、containerd、etcd


node02
172.19.82.159
kubelet、kube-proxy、containerd、etcd"><meta name=application-name content="AGou's Blog-2."><meta name=apple-mobile-web-app-title content="AGou's Blog-2."><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/myBlog-2/favicon.png><link rel=icon type=image/png sizes=32x32 href=/myBlog-2/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/myBlog-2/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/><link rel=prev href=https://agou-ops.cn/myBlog-2/post/containerdharbor%E7%A7%81%E6%9C%89%E4%BB%93https/><link rel=next href=https://agou-ops.cn/myBlog-2/post/k8s%E4%B8%AD%E9%83%A8%E7%BD%B2apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/myBlog-2/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Debian12二进制安装k8s v1.25.12","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/agou-ops.cn\/myBlog-2\/post\/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"k8s, kubernetes, 二进制安装","wordcount":11821,"url":"https:\/\/agou-ops.cn\/myBlog-2\/post\/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85\/","datePublished":"2023-08-27T10:33:38+08:00","dateModified":"2023-08-27T10:33:38+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/myBlog-2/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/myBlog-2/posts/>所有文章 </a><a class=menu-item href=/myBlog-2/tags/>标签 </a><a class=menu-item href=/myBlog-2/categories/>分类 </a><a class=menu-item href=/myBlog-2/anime/>Anime </a><a class=menu-item href=/myBlog-2/about/>关于 </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/myBlog-2/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/myBlog-2/posts/>所有文章</a><a class=menu-item href=/myBlog-2/tags/>标签</a><a class=menu-item href=/myBlog-2/categories/>分类</a><a class=menu-item href=/myBlog-2/anime/>Anime</a><a class=menu-item href=/myBlog-2/about/>关于</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Debian12二进制安装k8s v1.25.12</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/myBlog-2/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>收录于 <a href=/myBlog-2/categories/k8s/><i class="far fa-folder fa-fw"></i>k8s</a>&nbsp;<a href=/myBlog-2/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-08-27>2023-08-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 11821 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 24 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#一预先准备>一、预先准备</a><ul><li><a href=#11-服务器角色>1.1 服务器角色</a></li><li><a href=#12-系统初始化>1.2 系统初始化</a></li><li><a href=#13-hosts设置>1.3 hosts设置</a><ul><li><a href=#131-通过hosts文件配置>1.3.1 通过hosts文件配置</a></li><li><a href=#132-使用bind9-dns工具>1.3.2 使用bind9 DNS工具</a></li></ul></li><li><a href=#14-可选安装supervisor>1.4 （可选）安装supervisor</a></li></ul></li><li><a href=#二安装cri容器运行时及harbor私有仓>二、安装CRI容器运行时及harbor私有仓</a><ul><li><a href=#21-安装containerd>2.1 安装containerd</a><ul><li><a href=#211-步骤一安装containerd>2.1.1 步骤一安装containerd</a></li><li><a href=#212-步骤二安装runc>2.1.2 步骤二安装runC</a></li><li><a href=#213-步骤三安装cni插件>2.1.3 步骤三安装CNI插件</a></li><li><a href=#214-配置containerd使用systemd-cgroup驱动>2.1.4 配置containerd使用systemd cgroup驱动</a></li><li><a href=#215-安装crictl客户端工具>2.1.5 安装crictl客户端工具</a></li></ul></li><li><a href=#22-安装harbor私有仓>2.2 安装harbor私有仓</a></li></ul></li><li><a href=#三使用cfssl生成证书>三、使用cfssl生成证书</a><ul><li><a href=#31-安装cfssl>3.1 安装cfssl</a></li><li><a href=#32-初始化及说明>3.2 初始化及说明</a></li></ul></li><li><a href=#四部署master节点>四、部署master节点</a><ul><li><a href=#41-部署etcd集群>4.1 部署etcd集群</a><ul><li><a href=#411-下载安装etcd和etcdctl二进制文件>4.1.1 下载安装etcd和etcdctl二进制文件</a></li><li><a href=#412-为etcd制作证书>4.1.2 为etcd制作证书</a></li><li><a href=#413-配置及启动etcd集群>4.1.3 配置及启动etcd集群</a></li></ul></li><li><a href=#42-部署api-server>4.2 部署API server</a><ul><li><a href=#421-使用cfssl生成证书>4.2.1 使用cfssl生成证书</a></li><li><a href=#422-部署api-server>4.2.2 部署api-server</a></li></ul></li><li><a href=#43-部署controller-manager>4.3 部署controller-manager</a></li><li><a href=#44-部署kube-scheduler>4.4 部署kube-scheduler</a></li><li><a href=#45-配置kubectl所需要的kubeconfig>4.5 配置kubectl所需要的kubeconfig</a></li><li><a href=#46-部署node相关组件kube-proxykubelet>4.6 部署node相关组件kube-proxy、kubelet</a><ul><li><a href=#461-bootstrap自动认证kubelet>4.6.1 bootstrap自动认证kubelet</a></li><li><a href=#462-部署kubelet>4.6.2 部署kubelet</a></li><li><a href=#463-将master节点作为node加入到集群内部>4.6.3 将master节点作为node加入到集群内部</a></li><li><a href=#463-部署kube-proxy>4.6.3 部署kube-proxy</a></li><li><a href=#464-授权apiserver访问kubelet>4.6.4 授权apiserver访问kubelet</a></li><li><a href=#465-部署flannel网络组件>4.6.5 部署flannel网络组件</a></li></ul></li><li><a href=#47-检查master节点部署结果>4.7 检查master节点部署结果</a><ul><li><a href=#471-检查服务运行状态>4.7.1 检查服务运行状态</a></li><li><a href=#472-附文件列表及简介>4.7.2 附：文件列表及简介</a></li></ul></li></ul></li><li><a href=#五部署node节点>五、部署node节点</a><ul><li><a href=#51-部署kubelet>5.1 部署kubelet</a></li><li><a href=#52-部署kube-proxy>5.2 部署kube-proxy</a></li><li><a href=#53-检查node节点部署结果>5.3 检查node节点部署结果</a><ul><li><a href=#531-检查服务运行状态>5.3.1 检查服务运行状态</a></li><li><a href=#532-附文件列表及简介>5.3.2 附：文件列表及简介</a></li></ul></li></ul></li><li><a href=#六其他可选组件安装>六、其他可选组件安装</a><ul><li><a href=#61-coredns>6.1 coredns</a><ul><li><a href=#611-部署coredns>6.1.1 部署coredns</a></li><li><a href=#测试coredns>测试coredns</a></li></ul></li><li><a href=#62-nginx-ingress>6.2 nginx ingress</a></li><li><a href=#63-面板>6.3 面板</a><ul><li><a href=#631-dashboard>6.3.1 dashboard</a></li><li><a href=#632-rancher>6.3.2 rancher</a></li></ul></li></ul></li><li><a href=#七未完待续>七、未完待续</a></li></ul></nav></div></div><div class=content id=content><p>篇幅过长，为了更好的阅读体验可以前往<a href=https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/k8s%20Debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85 target=_blank rel="noopener noreffer">我的文档-k8s Debian12 二进制安装</a> 或者我的<a href=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ target=_blank rel="noopener noreffer">备用博客地址</a> .</p><h2 id=一预先准备>一、预先准备</h2><h3 id=11-服务器角色>1.1 服务器角色</h3><p>环境信息：</p><ul><li>k8s版本：v1.25.12</li><li>Debian12(bookworm)：内核6.1.0-9-amd64</li></ul><table><thead><tr><th>角色</th><th>IP</th><th>组件列表</th></tr></thead><tbody><tr><td>master</td><td>172.19.82.157</td><td>kube-apiserver、kube-controller-manage、kube-scheduler、kubelet、kube-proxy、etcd、containerd</td></tr><tr><td>node01</td><td>172.19.82.158</td><td>kubelet、kube-proxy、containerd、etcd</td></tr><tr><td>node02</td><td>172.19.82.159</td><td>kubelet、kube-proxy、containerd、etcd</td></tr></tbody></table><p>ℹ由于手上资源有限，所以搭建一个一主两从的集群，如果后续想要扩展的话，仅需要再添加master或者node节点即可，此外etcd可以部署到集群之外并做高可用。</p><h3 id=12-系统初始化>1.2 系统初始化</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 禁用防火墙</span>
systemctl stop ufw
systemctl disable ufw
<span class=c1># 关闭SELinux，我这里cloudint安装的系统，没有防火墙和selinux</span>
sed -i <span class=s1>&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config
setenforce <span class=m>0</span>
<span class=c1># 关闭交换分区swap</span>
swap -a
sed -ri <span class=s1>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
<span class=c1># 同步时区与时间，**非常重要**</span>
timedatectl set-timezone Asia/Shanghai
ntpdate ntp.aliyun.com    <span class=c1># 没有ntpdate的话，需要安装一下，apt install ntpdate -y</span>
<span class=c1># 配置ulimit，最大文件打开数，优化linux性能，重新退出登录当前shell即可生效</span>
<span class=nb>ulimit</span> -SHn <span class=m>65535</span>
cat &gt;&gt; /etc/security/limits.conf <span class=s>&lt;&lt; EOF
</span><span class=s>root soft nofile 65536
</span><span class=s>root hard nofile 131072
</span><span class=s>root soft nproc 65535
</span><span class=s>root hard nproc 655350
</span><span class=s>root soft memlock unlimited
</span><span class=s>root hard memlock unlimited
</span><span class=s>EOF</span>
<span class=c1># 安装ipvs</span>
apt install ipvsadm ipset sysstat conntrack -y
<span class=c1># 加载</span>
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
<span class=c1># 写入配置文件永久生效</span>
cat &gt;&gt; /etc/modules-load.d/ipvs.conf <span class=s>&lt;&lt;EOF
</span><span class=s>ip_vs
</span><span class=s>ip_vs_rr
</span><span class=s>ip_vs_wrr
</span><span class=s>ip_vs_sh
</span><span class=s>nf_conntrack
</span><span class=s>ip_tables
</span><span class=s>ip_set
</span><span class=s>xt_set
</span><span class=s>ipt_set
</span><span class=s>ipt_rpfilter
</span><span class=s>ipt_REJECT
</span><span class=s>ipip
</span><span class=s>EOF</span>
<span class=c1># 重启服务以加载模块</span>
systemctl restart systemd-modules-load.service
<span class=c1># 检查模块是否加载，这里可以reboot一下</span>
lsmod <span class=p>|</span> grep -e ip_vs -e nf_conntrack
<span class=c1># 修改内核参数，按需修改即可</span>
cat &gt; /etc/sysctl.d/k8s.conf <span class=s>&lt;&lt;EOF
</span><span class=s>net.ipv4.ip_forward = 1
</span><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span><span class=s>fs.may_detach_mounts = 1
</span><span class=s>vm.overcommit_memory=1
</span><span class=s>vm.panic_on_oom=0
</span><span class=s>fs.inotify.max_user_watches=89100
</span><span class=s>fs.file-max=52706963
</span><span class=s>fs.nr_open=52706963
</span><span class=s>net.netfilter.nf_conntrack_max=2310720
</span><span class=s>
</span><span class=s>net.ipv4.tcp_keepalive_time = 600
</span><span class=s>net.ipv4.tcp_keepalive_probes = 3
</span><span class=s>net.ipv4.tcp_keepalive_intvl =15
</span><span class=s>net.ipv4.tcp_max_tw_buckets = 36000
</span><span class=s>net.ipv4.tcp_tw_reuse = 1
</span><span class=s>net.ipv4.tcp_max_orphans = 327680
</span><span class=s>net.ipv4.tcp_orphan_retries = 3
</span><span class=s>net.ipv4.tcp_syncookies = 1
</span><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span><span class=s>net.ipv4.ip_conntrack_max = 65536
</span><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span><span class=s>net.ipv4.tcp_timestamps = 0
</span><span class=s>net.core.somaxconn = 16384
</span><span class=s>
</span><span class=s>net.ipv6.conf.all.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.default.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.lo.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.all.forwarding = 0
</span><span class=s>EOF</span>
<span class=c1># 使其生效</span>
sysctl --system
</code></pre></td></tr></table></div></div><h3 id=13-hosts设置>1.3 hosts设置</h3><h4 id=131-通过hosts文件配置>1.3.1 通过hosts文件配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>cat &gt;&gt; /etc/hosts <span class=s>&lt;&lt; EOF
</span><span class=s>172.19.82.157 master.k8s.local master
</span><span class=s>172.19.82.158 node01.k8s.local node01
</span><span class=s>172.19.82.159 node02.k8s.local node02
</span><span class=s>EOF</span>

<span class=c1># 测试网络连通</span>
<span class=k>for</span> i in master node01 node02<span class=p>;</span> <span class=k>do</span> ping -c <span class=m>2</span> <span class=nv>$i</span><span class=p>;</span> <span class=k>done</span>
</code></pre></td></tr></table></div></div><h4 id=132-使用bind9-dns工具>1.3.2 使用bind9 DNS工具</h4><p>ℹ仅在一台机器上安装bind9即可，我这里选择master节点，如果有高可用需求的话可以安装多个bind做集群。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 安装bind9 DNS工具</span>
apt install bind9 dnsutils -y
</code></pre></td></tr></table></div></div><p>修改配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/bind/named.conf.options
<span class=c1># 内容如下(删掉了部分注释)</span>
options <span class=o>{</span>
        directory <span class=s2>&#34;/var/cache/bind&#34;</span><span class=p>;</span>
        // 当DNS解析不到时，转发给其他DNS服务器
        forwarders <span class=o>{</span>
                8.8.8.8<span class=p>;</span>
        <span class=o>}</span><span class=p>;</span>
        dnssec-validation auto<span class=p>;</span>

        listen-on-v6 <span class=o>{</span> any<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822111122.png data-srcset="https://cdn.agou-ops.cn/others/20230822111122.png, https://cdn.agou-ops.cn/others/20230822111122.png 1.5x, https://cdn.agou-ops.cn/others/20230822111122.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822111122.png title=image.png>
配置解析域以及模板文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 配置解析域</span>
vim /etc/bind/named.conf.default-zones
// 正向解析域
zone <span class=s2>&#34;k8s.local&#34;</span> IN <span class=o>{</span>
        <span class=nb>type</span> master<span class=p>;</span>
        file <span class=s2>&#34;/etc/bind/db.k8s.local&#34;</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
// 反向解析域
zone <span class=s2>&#34;82.19.172.in-addr.zrpa&#34;</span> IN <span class=o>{</span>
        <span class=nb>type</span> master<span class=p>;</span>
        file <span class=s2>&#34;/etc/bind/db.in-addr.k8s.local&#34;</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
<span class=c1># 复制模版文件</span>
cp -a /etc/bind/db.local /etc/bind/db.k8s.local
cp -a /etc/bind/db.127 /etc/bind/db.in-addr.k8s.local
<span class=c1># 配置正向解析文件</span>
vim /etc/bind/db.k8s.local
<span class=nv>$TTL</span>    <span class=m>604800</span>
@       IN      SOA     dns.k8s.local. k8s.local. <span class=o>(</span>
                              <span class=m>2</span>         <span class=p>;</span> Serial
                         <span class=m>604800</span>         <span class=p>;</span> Refresh
                          <span class=m>86400</span>         <span class=p>;</span> Retry
                        <span class=m>2419200</span>         <span class=p>;</span> Expire
                         <span class=m>604800</span> <span class=o>)</span>       <span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
@       IN      NS      dns.k8s.local.
dns     IN      A       172.19.82.157
master  IN      A       172.19.82.157
node01  IN      A       172.19.82.158
node02  IN      A       172.19.82.159
<span class=c1># 配置反向解析文件</span>
vim /etc/bind/db.in-addr.k8s.local
<span class=nv>$TTL</span>    <span class=m>604800</span>
@       IN      SOA     dns.k8s.local. k8s.local. <span class=o>(</span>
                              <span class=m>1</span>         <span class=p>;</span> Serial
                         <span class=m>604800</span>         <span class=p>;</span> Refresh
                          <span class=m>86400</span>         <span class=p>;</span> Retry
                        <span class=m>2419200</span>         <span class=p>;</span> Expire
                         <span class=m>604800</span> <span class=o>)</span>       <span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
@       IN      NS      dns.k8s.local.
<span class=m>157</span>     IN      PTR     k8s.local.
<span class=m>157</span>     IN      PTR     master.k8s.local.
<span class=m>158</span>     IN      PTR     node01.k8s.local.
<span class=m>159</span>     IN      PTR     node02.k8s.local.
</code></pre></td></tr></table></div></div><p>重启服务及测试：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>systemctl restart bind9
<span class=c1># 修改主机的首选DNS地址为172.19.82.157</span>
cat /etc/resolv.conf
nameserver 172.19.82.157
nameserver 8.8.8.8
<span class=c1># 测试</span>
<span class=k>for</span> i in master node01 node02<span class=p>;</span> <span class=k>do</span> dig +short <span class=nv>$i</span>.k8s.local<span class=p>;</span> <span class=k>done</span>
<span class=c1># 应当输出，截图如下</span>
172.19.82.157
172.19.82.158
172.19.82.159
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822114543.png data-srcset="https://cdn.agou-ops.cn/others/20230822114543.png, https://cdn.agou-ops.cn/others/20230822114543.png 1.5x, https://cdn.agou-ops.cn/others/20230822114543.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822114543.png title=image.png></p><h3 id=14-可选安装supervisor>1.4 （可选）安装supervisor</h3><p>安装supervisor简单实现服务“高可用”.
ℹ非必须，使用systemd来管理也可以.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> apt install supervisor -y
 <span class=c1># 设置为开机自启，并启动</span>
 systemctl <span class=nb>enable</span> supervisor --now
</code></pre></td></tr></table></div></div><h2 id=二安装cri容器运行时及harbor私有仓>二、安装CRI容器运行时及harbor私有仓</h2><h3 id=21-安装containerd>2.1 安装containerd</h3><p>安装方式有好几种，二进制安装，仓库安装以及编译安装。</p><p>这里我使用二进制进行安装，仓库安装参考：<a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf target=_blank rel="noopener noreffer">https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf</a>
😄 let&rsquo;s go~</p><h4 id=211-步骤一安装containerd>2.1.1 步骤一安装containerd</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 从https://github.com/containerd/containerd/releases，下载containerd的二进制包，注意软件包架构.</span>
wget https://github.com/containerd/containerd/releases/download/v1.6.23/containerd-1.6.23-linux-amd64.tar.gz

tar Cxzvf /usr/local containerd-1.6.23-linux-amd64.tar.gz

<span class=c1># 安装service服务</span>
wget -O /lib/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
<span class=c1># 重载并启动服务，设置为开机自启动</span>
systemctl daemon-reload
systemctl <span class=nb>enable</span> containerd --now
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822131441.png data-srcset="https://cdn.agou-ops.cn/others/20230822131441.png, https://cdn.agou-ops.cn/others/20230822131441.png 1.5x, https://cdn.agou-ops.cn/others/20230822131441.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822131441.png title=image.png></p><h4 id=212-步骤二安装runc>2.1.2 步骤二安装runC</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> wget https://github.com/opencontainers/runc/releases/download/v1.1.9/runc.amd64
install -m <span class=m>755</span> runc.amd64 /usr/local/sbin/runc
</code></pre></td></tr></table></div></div><h4 id=213-步骤三安装cni插件>2.1.3 步骤三安装CNI插件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz
<span class=c1># tar Cxzvf /usr/local/bin cni-plugins-linux-amd64-v1.3.0.tgz</span>
tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.3.0.tgz
</code></pre></td></tr></table></div></div><h4 id=214-配置containerd使用systemd-cgroup驱动>2.1.4 配置containerd使用systemd cgroup驱动</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 生成默认的配置文件</span>
containerd config default <span class=p>|</span> tee /etc/containerd/config.toml
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132245.png data-srcset="https://cdn.agou-ops.cn/others/20230822132245.png, https://cdn.agou-ops.cn/others/20230822132245.png 1.5x, https://cdn.agou-ops.cn/others/20230822132245.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132245.png title=image.png>
大概第125行，修改 <code>SystemdCgroup</code> 为<code>true</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/containerd/config.toml
<span class=c1># 修改默认的pause容器镜像地址为阿里云国内源</span>
<span class=nv>sandbox_image</span> <span class=o>=</span> <span class=s2>&#34;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9&#34;</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132616.png data-srcset="https://cdn.agou-ops.cn/others/20230822132616.png, https://cdn.agou-ops.cn/others/20230822132616.png 1.5x, https://cdn.agou-ops.cn/others/20230822132616.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132616.png title=image.png>
大概第61行。
修改完保存之后，重启<code>systemctl restart containerd</code>.
检查运行状态：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132807.png data-srcset="https://cdn.agou-ops.cn/others/20230822132807.png, https://cdn.agou-ops.cn/others/20230822132807.png 1.5x, https://cdn.agou-ops.cn/others/20230822132807.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132807.png title=image.png></p><h4 id=215-安装crictl客户端工具>2.1.5 安装crictl客户端工具</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz
tar xf crictl-v1.28.0-linux-amd64.tar.gz -C /usr/local/bin
<span class=c1># 编写默认配置文件，方便客户端使用</span>
bash -c <span class=s2>&#34;cat &gt; /etc/crictl.yaml&#34;</span>  <span class=s>&lt;&lt;EOF
</span><span class=s>runtime-endpoint: unix:///run/containerd/containerd.sock
</span><span class=s>image-endpoint: unix:///run/containerd/containerd.sock
</span><span class=s>timeout: 10
</span><span class=s>debug: false
</span><span class=s>EOF</span>
</code></pre></td></tr></table></div></div><p>检查是否安装成功<code>crictl ps</code>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822133349.png data-srcset="https://cdn.agou-ops.cn/others/20230822133349.png, https://cdn.agou-ops.cn/others/20230822133349.png 1.5x, https://cdn.agou-ops.cn/others/20230822133349.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822133349.png title=image.png></p><h3 id=22-安装harbor私有仓>2.2 安装harbor私有仓</h3><p>harbor建议部署在其他主机上，比如说主控机，与k8s集群分割开来，这个随便，看你自己。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 下载离线安装包</span>
wget https://github.com/goharbor/harbor/releases/download/v2.8.4/harbor-offline-installer-v2.8.4.tgz
tar xzvf harbor-offline-installer-v2.8.4.tgz
<span class=c1># 运行安装程序即可</span>
sudo ./install.sh
</code></pre></td></tr></table></div></div><p>后续步骤略.</p><h2 id=三使用cfssl生成证书>三、使用cfssl生成证书</h2><h3 id=31-安装cfssl>3.1 安装cfssl</h3><p>ℹ在master节点或者主控机（如果有的话）上安装cfssl即可，其他主机不需要。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl-certinfo_1.6.4_linux_amd64
install -m <span class=m>755</span> cfssl_1.6.4_linux_amd64 /usr/local/bin/cfssl
install -m <span class=m>755</span> cfssljson_1.6.4_linux_amd64 /usr/local/bin/cfssl-json
install -m <span class=m>755</span> cfssl-certinfo_1.6.4_linux_amd64 /usr/local/bin/cfssl-certinfo
</code></pre></td></tr></table></div></div><p>检查安装：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822134549.png data-srcset="https://cdn.agou-ops.cn/others/20230822134549.png, https://cdn.agou-ops.cn/others/20230822134549.png 1.5x, https://cdn.agou-ops.cn/others/20230822134549.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822134549.png title=image.png></p><h3 id=32-初始化及说明>3.2 初始化及说明</h3><p>创建k8s集群及etcd所需要的证书目录：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 下面一个命令三个主机都执行一下。</span>
mkdir -pv /etc/kubernetes/TLS/<span class=o>{</span>etcd,k8s<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>说明：一共创建了三个CA，分别用于：</p><ul><li>etcd集群</li><li>apiserver、controller manager、kubelet、kube-scheduler等</li><li>front-proxy</li></ul><h2 id=四部署master节点>四、部署master节点</h2><h3 id=41-部署etcd集群>4.1 部署etcd集群</h3><h4 id=411-下载安装etcd和etcdctl二进制文件>4.1.1 下载安装etcd和etcdctl二进制文件</h4><p>我们需要在157，158和159三台机器中都装上etcd，以组成etcd集群，保证etcd的高可用。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 157，158，159机器上，也就是master和node01、node02节点执行以下命令</span>
<span class=c1># 创建etcd用户</span>
useradd -s /sbin/nologin -M etcd
wget https://github.com/etcd-io/etcd/releases/download/v3.4.27/etcd-v3.4.27-linux-amd64.tar.gz
tar xf etcd-v3.4.27-linux-amd64.tar.gz -C /usr/local
mv /usr/local/etcd-v3.4.27-linux-amd64 /usr/local/etcd-v3.4.27
<span class=c1># 创建软连接方便使用</span>
ln -sv /usr/local/etcd-v3.4.27/etcd /usr/local/bin
ln -sv /usr/local/etcd-v3.4.27/etcdctl /usr/local/bin
</code></pre></td></tr></table></div></div><p>检查etcd安装结果：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822141125.png data-srcset="https://cdn.agou-ops.cn/others/20230822141125.png, https://cdn.agou-ops.cn/others/20230822141125.png 1.5x, https://cdn.agou-ops.cn/others/20230822141125.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822141125.png title=image.png></p><h4 id=412-为etcd制作证书>4.1.2 为etcd制作证书</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 仅在master主机上执行</span>
<span class=nb>cd</span> /etc/kubernetes/TLS/etcd
vim ca-config.json
<span class=o>{</span>
  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;etcd&#34;</span>: <span class=o>{</span>
         <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>,
         <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span>
            <span class=s2>&#34;signing&#34;</span>,
            <span class=s2>&#34;key encipherment&#34;</span>,
            <span class=s2>&#34;server auth&#34;</span>,
            <span class=s2>&#34;client auth&#34;</span>
        <span class=o>]</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>


vim ca-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;etcd CA&#34;</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssl-json -bare ca
<span class=c1># 检查ca生成结果，见下图</span>

<span class=nb>cd</span> /etc/kubernetes/TLS/etcd
<span class=c1># 将可能用到的IP加到hosts字段里面。</span>
vim etcd-server-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;etcd&#34;</span>,
    <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;172.19.82.157&#34;</span>,
        <span class=s2>&#34;172.19.82.158&#34;</span>,
        <span class=s2>&#34;172.19.82.159&#34;</span>,
        <span class=s2>&#34;192.168.3.28&#34;</span>,
        <span class=s2>&#34;127.0.0.1&#34;</span>,
        <span class=s2>&#34;10.96.0.1&#34;</span>
    <span class=o>]</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>
<span class=c1># 使用上面的自签CA签发etcd证书</span>
cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>etcd etcd-server-csr.json <span class=p>|</span> cfssl-json -bare etcd-server
</code></pre></td></tr></table></div></div><p>配置文件字段解释：</p><blockquote><ul><li>CN：Common Name，浏览器使用该字段验证网址是否合法，一般写域名，非常重要</li><li>ST：State，省</li><li>L：Locality，地区</li><li>O：Organization Name，组织名称</li><li>OU：Organization Unit Name，组织单位名称</li></ul></blockquote><p>检查CA生成结果：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823104905.png data-srcset="https://cdn.agou-ops.cn/others/20230823104905.png, https://cdn.agou-ops.cn/others/20230823104905.png 1.5x, https://cdn.agou-ops.cn/others/20230823104905.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823104905.png title=image.png></p><pre><code>ca-config.json解析：
</code></pre><blockquote><p>expiry：有效期为200年
profiles-server：启动server的时候需要配置证书
profiles-client：client去连接server的时候需要证书
profiles-peer：双向证书，服务端找客户端需要证书，客户端找服务端需要证书
etcd-peer-csr解析：</p><p>hosts：etcd有可能部署到哪些组件的IP都要填进来
cfssl gencert：生成证书
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823105545.png data-srcset="https://cdn.agou-ops.cn/others/20230823105545.png, https://cdn.agou-ops.cn/others/20230823105545.png 1.5x, https://cdn.agou-ops.cn/others/20230823105545.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823105545.png title=image.png></p></blockquote><h4 id=413-配置及启动etcd集群>4.1.3 配置及启动etcd集群</h4><p>复制证书文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 复制3.3中生成的证书到certs目录，注意，三个主机都要执行</span>
<span class=c1># node01，自己做免密哦，这里就不教了。</span>
scp -r master:/etc/kubernetes/TLS/etcd/*.pem /etc/kubernetes/TLS/etcd
<span class=c1># node02</span>
scp -r master:/etc/kubernetes/TLS/etcd/*.pem /etc/kubernetes/TLS/etcd
</code></pre></td></tr></table></div></div><p>编写启动脚本：
⚠注意以下脚本中，node01（158），node02（159）主机上都要修改对应的监听地址，不能照搬.
需要修改的地方有以下五处：</p><ul><li><code>--name</code></li><li><code>--advertise-client-urls</code></li><li><code>--initial-advertise-peer-urls</code></li><li><code>--listen-peer-urls</code></li><li><code>--listen-client-urls</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 在157 master主机上</span>
vim /usr/local/etcd-v3.4.27/etcd-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./etcd --name<span class=o>=</span>etcd-server-157 <span class=se>\
</span><span class=se></span>  --advertise-client-urls<span class=o>=</span>https://172.19.82.157:2379 <span class=se>\
</span><span class=se></span>  --cert-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --client-cert-auth<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --data-dir<span class=o>=</span>/data/etcd <span class=se>\
</span><span class=se></span>  --experimental-initial-corrupt-check<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --experimental-watch-progress-notify-interval<span class=o>=</span>5s <span class=se>\
</span><span class=se></span>  --initial-advertise-peer-urls<span class=o>=</span>https://172.19.82.157:2380 <span class=se>\
</span><span class=se></span>  --initial-cluster<span class=o>=</span>etcd-server-157<span class=o>=</span>https://172.19.82.157:2380,etcd-server-158<span class=o>=</span>https://172.19.82.158:2380,etcd-server-159<span class=o>=</span>https://172.19.82.159:2380 <span class=se>\
</span><span class=se></span>  --key-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --listen-client-urls<span class=o>=</span>https://127.0.0.1:2379,https://172.19.82.157:2379 <span class=se>\
</span><span class=se></span>  --listen-metrics-urls<span class=o>=</span>http://127.0.0.1:2381 <span class=se>\
</span><span class=se></span>  --listen-peer-urls<span class=o>=</span>https://172.19.82.157:2380 <span class=se>\
</span><span class=se></span>  --peer-cert-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --peer-client-cert-auth<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --peer-key-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --peer-trusted-ca-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem <span class=se>\
</span><span class=se></span>  --snapshot-count<span class=o>=</span><span class=m>10000</span> <span class=se>\
</span><span class=se></span>  --trusted-ca-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111335.png data-srcset="https://cdn.agou-ops.cn/others/20230823111335.png, https://cdn.agou-ops.cn/others/20230823111335.png 1.5x, https://cdn.agou-ops.cn/others/20230823111335.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111335.png title=image.png>
修改脚本及目录权限：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>chmod +x /usr/local/etcd-v3.4.27/etcd-startup.sh
chown -R etcd:etcd /usr/local/etcd-v3.4.27/
chown -R etcd:etcd /data/etcd/
chown -R etcd:etcd /data/logs/etcd-server/
chown -R etcd:etcd /etc/kubernetes/TLS/etcd/
</code></pre></td></tr></table></div></div><p>创建supervisor配置文件：
三个主机都得执行，不同主机只需要修改下<code>[program:etcd-server-157]</code>这个即可，换成158和159.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/supervisor/conf.d/etcd-server.conf
<span class=o>[</span>program:etcd-server-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/etcd-v3.4.27/etcd-startup.sh                 <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                      <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/etcd-v3.4.27                               <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                  <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                    <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                  <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                   <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                 <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                 <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>etcd                                                       <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                            <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/etcd-server/etcd.stdout.log           <span class=p>;</span> stdout log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                    <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                        <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                     <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                     <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
</code></pre></td></tr></table></div></div><p>重载supervisor配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>supervisorctl update
supervisorctl status
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822151410.png data-srcset="https://cdn.agou-ops.cn/others/20230822151410.png, https://cdn.agou-ops.cn/others/20230822151410.png 1.5x, https://cdn.agou-ops.cn/others/20230822151410.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822151410.png title=image.png>
使用以下命令可以查看集群状态（leader是谁？）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>etcdctl -w table --cacert<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem --cert<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem --key<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem --endpoints https://172.19.82.157:2379 endpoint status --cluster

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111655.png data-srcset="https://cdn.agou-ops.cn/others/20230823111655.png, https://cdn.agou-ops.cn/others/20230823111655.png 1.5x, https://cdn.agou-ops.cn/others/20230823111655.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111655.png title=image.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>etcdctl -w table --cacert<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem --cert<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem --key<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem --endpoints https://172.19.82.157:2379 member list
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111723.png data-srcset="https://cdn.agou-ops.cn/others/20230823111723.png, https://cdn.agou-ops.cn/others/20230823111723.png 1.5x, https://cdn.agou-ops.cn/others/20230823111723.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111723.png title=image.png></p><h3 id=42-部署api-server>4.2 部署API server</h3><p>API server我就不做集群了（单节点），方法其实和etcd大差不差.</p><h4 id=421-使用cfssl生成证书>4.2.1 使用cfssl生成证书</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 这里直接使用上面etcd的自建CA，如果etcd部署到集群之外的话，可以重新建个CA以作区分。</span>
<span class=c1># master主机上</span>
<span class=nb>cd</span> /etc/kubernetes/TLS/k8s/
vim ca-config.json
<span class=o>{</span>
  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;kubernetes&#34;</span>: <span class=o>{</span>
         <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>,
         <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span>
            <span class=s2>&#34;signing&#34;</span>,
            <span class=s2>&#34;key encipherment&#34;</span>,
            <span class=s2>&#34;server auth&#34;</span>,
            <span class=s2>&#34;client auth&#34;</span>
        <span class=o>]</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>


vim ca-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
            <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;k8s&#34;</span>,
            <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>


cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssl-json -bare ca -

vim kube-apiserver-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
    <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;127.0.0.1&#34;</span>,
        <span class=s2>&#34;kubernetes&#34;</span>,
        <span class=s2>&#34;kubernetes.default&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc.cluster&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc.cluster.local&#34;</span>,
        <span class=s2>&#34;172.19.82.157&#34;</span>,
        <span class=s2>&#34;172.19.82.158&#34;</span>,
        <span class=s2>&#34;172.19.82.159&#34;</span>,
        <span class=s2>&#34;192.168.3.28&#34;</span>,
        <span class=s2>&#34;10.96.0.1&#34;</span>
    <span class=o>]</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
            <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;k8s&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-apiserver-csr.json <span class=p>|</span> cfssl-json -bare kube-apiserver

<span class=c1># 生成sa key，后面会用到</span>
openssl genrsa -out sa.key <span class=m>2048</span>
openssl rsa -in sa.key -pubout -out sa.pub

mkdir proxy-client
<span class=nb>cd</span> proxy-client

vim front-proxy-ca-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CA&#34;</span>:<span class=o>{</span>
	  <span class=s2>&#34;expiry&#34;</span>:<span class=s2>&#34;87600h&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
     <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
     <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>
<span class=o>}</span>

cfssl gencert -initca front-proxy-ca-csr.json <span class=p>|</span> cfssl-json -bare front-proxy-ca

vim front-proxy-client-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;front-proxy-client&#34;</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
     <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
     <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>
<span class=o>}</span>

cfssl gencert <span class=se>\
</span><span class=se></span>-ca<span class=o>=</span>front-proxy-ca.pem <span class=se>\
</span><span class=se></span>-ca-key<span class=o>=</span>front-proxy-ca-key.pem  <span class=se>\
</span><span class=se></span>-config<span class=o>=</span>../ca-config.json   <span class=se>\
</span><span class=se></span>-profile<span class=o>=</span>kubernetes front-proxy-client-csr.json <span class=p>|</span> cfssl-json -bare front-proxy-client

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823114325.png data-srcset="https://cdn.agou-ops.cn/others/20230823114325.png, https://cdn.agou-ops.cn/others/20230823114325.png 1.5x, https://cdn.agou-ops.cn/others/20230823114325.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823114325.png title=image.png></p><h4 id=422-部署api-server>4.2.2 部署api-server</h4><p>仓库地址：<a href=https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#v12512 target=_blank rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#v12512</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://dl.k8s.io/v1.25.12/kubernetes-server-linux-amd64.tar.gz
tar xf kubernetes-server-linux-amd64.tar.gz -C /usr/local/
<span class=nb>cd</span> /usr/local/kubernetes
<span class=c1># 删除不必要的源码和文件</span>
rm -f kubernetes-src.tar.gz
rm -rf server/bin/*.tar
rm -rf server/bin/*_tag
<span class=c1># 添加软连接方便使用</span>
ln -sv /usr/local/kubernetes/server/bin/* /usr/local/bin/
</code></pre></td></tr></table></div></div><p>启动脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>mkdir /etc/kubernetes/config
vim /usr/local/kubernetes/server/bin/kube-apiserver-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
<span class=c1># 下面的cert和key统统用一套就好了。</span>
<span class=c1>#!/usr/bin/env sh</span>
./kube-apiserver <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span>  <span class=se>\
</span><span class=se></span>  --logtostderr<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --allow-privileged<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --bind-address<span class=o>=</span>172.19.82.157  <span class=se>\
</span><span class=se></span>  --secure-port<span class=o>=</span><span class=m>6443</span>  <span class=se>\
</span><span class=se></span>  --advertise-address<span class=o>=</span><span class=m>157</span> <span class=se>\
</span><span class=se></span>  --service-cluster-ip-range<span class=o>=</span>10.244.0.0/12 <span class=se>\
</span><span class=se></span>  --service-node-port-range<span class=o>=</span>30000-40000  <span class=se>\
</span><span class=se></span>  --etcd-servers<span class=o>=</span>https://172.19.82.157:2379,https://172.19.82.158:2379,https://172.19.82.159:2379 <span class=se>\
</span><span class=se></span>  --etcd-cafile<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem <span class=se>\
</span><span class=se></span>  --etcd-certfile<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --etcd-keyfile<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --tls-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver.pem <span class=se>\
</span><span class=se></span>  --tls-private-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver-key.pem
  --kubelet-client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver.pem <span class=se>\
</span><span class=se></span>  --kubelet-client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver-key.pem <span class=se>\
</span><span class=se></span>  --service-account-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.pub  <span class=se>\
</span><span class=se></span>  --service-account-signing-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.key  <span class=se>\
</span><span class=se></span>  --service-account-issuer<span class=o>=</span>https://kubernetes.default.svc.cluster.local <span class=se>\
</span><span class=se></span>  --kubelet-preferred-address-types<span class=o>=</span>InternalIP,ExternalIP,Hostname  <span class=se>\
</span><span class=se></span>  --enable-admission-plugins<span class=o>=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=se>\
</span><span class=se></span>  --authorization-mode<span class=o>=</span>Node,RBAC  <span class=se>\
</span><span class=se></span>  --enable-bootstrap-token-auth<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --requestheader-client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-ca.pem  <span class=se>\
</span><span class=se></span>  --proxy-client-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-client.pem  <span class=se>\
</span><span class=se></span>  --proxy-client-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-client-key.pem  <span class=se>\
</span><span class=se></span>  --requestheader-allowed-names<span class=o>=</span>front-proxy-client  <span class=se>\
</span><span class=se></span>  --requestheader-group-headers<span class=o>=</span>X-Remote-Group  <span class=se>\
</span><span class=se></span>  --requestheader-extra-headers-prefix<span class=o>=</span>X-Remote-Extra-  <span class=se>\
</span><span class=se></span>  --requestheader-username-headers<span class=o>=</span>X-Remote-User

chmod +x /usr/local/kubernetes/server/bin/kube-apiserver-startup.sh
mkdir -pv /data/logs/kubernetes/kube-apiserver
</code></pre></td></tr></table></div></div><p>配置supervisor：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/supervisor/conf.d/apiserver.conf
<span class=o>[</span>program:apiserver-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-apiserver-startup.sh                 <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                      <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                               <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                  <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                     <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                  <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                   <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                 <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                 <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                       <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                            <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log           <span class=p>;</span> stdout log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                    <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                        <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                     <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                     <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>


<span class=c1># 重载supervisor配置文件</span>
supervisorctl update
ss -tnulp  <span class=p>|</span> grep <span class=m>6443</span>
<span class=c1># output</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                                *:6443             *:*    users:<span class=o>((</span><span class=s2>&#34;kube-apiserver&#34;</span>,pid<span class=o>=</span>5989,fd<span class=o>=</span>7<span class=o>))</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822170053.png data-srcset="https://cdn.agou-ops.cn/others/20230822170053.png, https://cdn.agou-ops.cn/others/20230822170053.png 1.5x, https://cdn.agou-ops.cn/others/20230822170053.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822170053.png title=image.png></p><h3 id=43-部署controller-manager>4.3 部署controller-manager</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kube-controller-manager-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;system:kube-controller-manager&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:kube-controller-manager&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-controller-manager-csr.json <span class=p>|</span> cfssl-json -bare kube-controller-manager

<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># 添加证书文件信息</span>
kubectl config set-credentials system:kube-controller-manager <span class=se>\
</span><span class=se></span>	--client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-controller-manager.pem <span class=se>\
</span><span class=se></span>	--client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-controller-manager-key.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># 添加用户</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-controller-manager <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># 指定默认的集群</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig


vim /usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-controller-manager <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span> <span class=se>\
</span><span class=se></span>  --root-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --cluster-signing-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --cluster-signing-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca-key.pem <span class=se>\
</span><span class=se></span>  --service-account-private-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.key <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig <span class=se>\
</span><span class=se></span>  --leader-elect<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --use-service-account-credentials<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --node-monitor-grace-period<span class=o>=</span>40s <span class=se>\
</span><span class=se></span>  --node-monitor-period<span class=o>=</span>5s <span class=se>\
</span><span class=se></span>  --pod-eviction-timeout<span class=o>=</span>2m0s <span class=se>\
</span><span class=se></span>  --controllers<span class=o>=</span>*,bootstrapsigner,tokencleaner <span class=se>\
</span><span class=se></span>  --allocate-node-cidrs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --cluster-cidr<span class=o>=</span>10.244.0.0/12 <span class=se>\
</span><span class=se></span>  --requestheader-client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-ca.pem <span class=se>\
</span><span class=se></span>  --node-cidr-mask-size<span class=o>=</span><span class=m>24</span>

chmod +x /usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh
mkdir -pv /data/logs/kubernetes/kube-controller-manager/

vim /etc/supervisor/conf.d/controller-manager.conf
<span class=o>[</span>program:kube-controller-manager-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh                     <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                                        <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                              <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                                    <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                                  <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>30</span>                                                                      <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                                    <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                                     <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                                   <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                                   <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                         <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                              <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                                      <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                          <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                                       <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                                       <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823134408.png data-srcset="https://cdn.agou-ops.cn/others/20230823134408.png, https://cdn.agou-ops.cn/others/20230823134408.png 1.5x, https://cdn.agou-ops.cn/others/20230823134408.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823134408.png title=image.png></p><h3 id=44-部署kube-scheduler>4.4 部署kube-scheduler</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kube-scheduler-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;system:kube-scheduler&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:kube-scheduler&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-scheduler-csr.json <span class=p>|</span> cfssl-json -bare kube-scheduler

<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># 添加证书文件信息</span>
kubectl config set-credentials system:kube-scheduler <span class=se>\
</span><span class=se></span>  --client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-scheduler.pem <span class=se>\
</span><span class=se></span>  --client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-scheduler-key.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># 添加用户</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-scheduler <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># 指定默认的集群</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig


vim /usr/local/kubernetes/server/bin/kube-scheduler-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-scheduler <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span> <span class=se>\
</span><span class=se></span>  --leader-elect<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig

chmod +x /usr/local/kubernetes/server/bin/kube-scheduler-startup.sh
mkdir -pv /data/logs/kubernetes/kube-scheduler/

vim /etc/supervisor/conf.d/scheduler.conf
<span class=o>[</span>program:kube-scheduler-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-scheduler-startup.sh                   <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p>至此，master节点的核心组件基本安装完成了，使用ss命令查看服务监听状态：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>&gt; ss -tnulp <span class=p>|</span> grep kube
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                        127.0.0.1:10259      0.0.0.0:*    users:<span class=o>((</span><span class=s2>&#34;kube-scheduler&#34;</span>,pid<span class=o>=</span>9385,fd<span class=o>=</span>7<span class=o>))</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                        127.0.0.1:10257      0.0.0.0:*    users:<span class=o>((</span><span class=s2>&#34;kube-controller&#34;</span>,pid<span class=o>=</span>9370,fd<span class=o>=</span>7<span class=o>))</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                                *:6443             *:*    users:<span class=o>((</span><span class=s2>&#34;kube-apiserver&#34;</span>,pid<span class=o>=</span>5989,fd<span class=o>=</span>7<span class=o>))</span>
</code></pre></td></tr></table></div></div><h3 id=45-配置kubectl所需要的kubeconfig>4.5 配置kubectl所需要的kubeconfig</h3><p>步骤大体和上面都是一致的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kubectl-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubectl&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:masters&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kubectl-csr.json <span class=p>|</span> cfssl-json -bare kubectl

<span class=c1># 这个你放到和上面同样的位置，然后复制到~/.kube里面也行，这里我图个方便</span>
<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>--certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># 添加证书文件信息</span>
kubectl config set-credentials cluster-admin <span class=se>\
</span><span class=se></span>--client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kubectl.pem <span class=se>\
</span><span class=se></span>--client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kubectl-key.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># 添加用户</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>--cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>--user<span class=o>=</span>cluster-admin <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># 指定默认的集群</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/root/.kube/config
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823163202.png data-srcset="https://cdn.agou-ops.cn/others/20230823163202.png, https://cdn.agou-ops.cn/others/20230823163202.png 1.5x, https://cdn.agou-ops.cn/others/20230823163202.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823163202.png title=image.png></p><h3 id=46-部署node相关组件kube-proxykubelet>4.6 部署node相关组件kube-proxy、kubelet</h3><h4 id=461-bootstrap自动认证kubelet>4.6.1 bootstrap自动认证kubelet</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
<span class=c1># 生成随机认证tokenid和secret，并赋予权限，下面直到EOF一块执行。</span>
<span class=nv>TOKEN_ID</span><span class=o>=</span><span class=sb>`</span>head -c <span class=m>16</span> /dev/urandom <span class=p>|</span> od -An -t x <span class=p>|</span> tr -d <span class=s1>&#39; &#39;</span> <span class=p>|</span> head -c6<span class=sb>`</span>
<span class=nv>TOKEN_SECRET</span><span class=o>=</span><span class=sb>`</span>head -c <span class=m>16</span> /dev/urandom <span class=p>|</span> od -An -t x <span class=p>|</span> tr -d <span class=s1>&#39; &#39;</span> <span class=p>|</span> head -c16<span class=sb>`</span>
cat &gt; bootstrap.secret.yaml <span class=s>&lt;&lt;EOF
</span><span class=s>apiVersion: v1
</span><span class=s>kind: Secret
</span><span class=s>metadata:
</span><span class=s>  name: bootstrap-token-$a
</span><span class=s>  namespace: kube-system
</span><span class=s>type: bootstrap.kubernetes.io/token
</span><span class=s>stringData:
</span><span class=s>  description: &#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;
</span><span class=s>  token-id: &#34;$TOKEN_ID&#34;
</span><span class=s>  token-secret: &#34;$TOKEN_SECRET&#34;
</span><span class=s>  usage-bootstrap-authentication: &#34;true&#34;
</span><span class=s>  usage-bootstrap-signing: &#34;true&#34;
</span><span class=s>  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: kubelet-bootstrap
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:node-bootstrapper
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:bootstrappers:default-node-token
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: node-autoapprove-bootstrap
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:bootstrappers:default-node-token
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: node-autoapprove-certificate-rotation
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:nodes
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRole
</span><span class=s>metadata:
</span><span class=s>  annotations:
</span><span class=s>    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span><span class=s>  labels:
</span><span class=s>    kubernetes.io/bootstrapping: rbac-defaults
</span><span class=s>  name: system:kube-apiserver-to-kubelet
</span><span class=s>rules:
</span><span class=s>  - apiGroups:
</span><span class=s>      - &#34;&#34;
</span><span class=s>    resources:
</span><span class=s>      - nodes/proxy
</span><span class=s>      - nodes/stats
</span><span class=s>      - nodes/log
</span><span class=s>      - nodes/spec
</span><span class=s>      - nodes/metrics
</span><span class=s>    verbs:
</span><span class=s>      - &#34;*&#34;
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: system:kube-apiserver
</span><span class=s>  namespace: &#34;&#34;
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:kube-apiserver-to-kubelet
</span><span class=s>subjects:
</span><span class=s>  - apiGroup: rbac.authorization.k8s.io
</span><span class=s>    kind: User
</span><span class=s>    name: kube-apiserver
</span><span class=s>EOF</span>

<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes  <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span>   <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 添加证书文件信息</span>
kubectl config set-credentials kubelet-bootstrap-user  <span class=se>\
</span><span class=se></span>  --token<span class=o>=</span><span class=nv>$TOKEN_ID</span>.<span class=nv>$TOKEN_SECRET</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 添加用户</span>
kubectl config set-context kubelet-bootstrap-user@kubernetes <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes   <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>kubelet-bootstrap-user <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 指定默认的集群</span>
kubectl config use-context kubelet-bootstrap-user@kubernetes  <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
</code></pre></td></tr></table></div></div><h4 id=462-部署kubelet>4.6.2 部署kubelet</h4><p>⚠ 由于master节点同样要运行一些pod，比如flannel、calico网络组件等，所以在master节点也需要安装Kubelet和Kube-proxy组件。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 参考：https://kubernetes.io/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/</span>
vim /etc/kubernetes/config/kubelet-conf.yml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 172.19.82.157
port: <span class=m>10250</span>
readOnlyPort: <span class=m>10255</span>
authentication:
  anonymous:
    enabled: <span class=nb>false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class=nb>true</span>
  x509:
    clientCAFile: /etc/kubernetes/TLS/k8s/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: <span class=nb>true</span>
clusterDNS:
- 10.100.0.2
clusterDomain: cluster.local
containerLogMaxFiles: <span class=m>5</span>
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: <span class=nb>true</span>
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: <span class=nb>true</span>
enableDebuggingHandlers: <span class=nb>true</span>
enforceNodeAllocatable:
- pods
eventBurst: <span class=m>10</span>
eventRecordQPS: <span class=m>5</span>
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: <span class=nb>true</span>
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: <span class=m>10248</span>
httpCheckFrequency: 20s
imageGCHighThresholdPercent: <span class=m>85</span>
imageGCLowThresholdPercent: <span class=m>80</span>
imageMinimumGCAge: 2m0s
iptablesDropBit: <span class=m>15</span>
iptablesMasqueradeBit: <span class=m>14</span>
kubeAPIBurst: <span class=m>10</span>
kubeAPIQPS: <span class=m>5</span>
makeIPTablesUtilChains: <span class=nb>true</span>
maxOpenFiles: <span class=m>1000000</span>
maxPods: <span class=m>110</span>
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: <span class=m>10</span>
registryPullQPS: <span class=m>5</span>
resolvConf: /etc/resolv.conf
rotateCertificates: <span class=nb>true</span>
runtimeRequestTimeout: 2m0s
serializeImagePulls: <span class=nb>true</span>
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s


vim /usr/local/kubernetes/server/bin/kubelet-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kubelet <span class=se>\
</span><span class=se></span>  --bootstrap-kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet.kubeconfig <span class=se>\
</span><span class=se></span>  --config<span class=o>=</span>/etc/kubernetes/config/kubelet-conf.yml <span class=se>\
</span><span class=se></span>  --hostname-override<span class=o>=</span>master0 <span class=se>\
</span><span class=se></span>  --node-labels<span class=o>=</span>node.kubernetes.io/node<span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=se>\
</span><span class=se></span>  --container-runtime-endpoint<span class=o>=</span>unix:///var/run/containerd/containerd.sock


<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>--certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 添加证书文件信息，下面这个token是之前生成的，也就是/etc/kubernetes/config/token.csv</span>
kubectl config set-credentials kubelet-bootstrap <span class=se>\
</span><span class=se></span>--token<span class=o>=</span>8d435b925863119020c4da4d16e064c8 <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 添加用户</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>--cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>--user<span class=o>=</span>kubelet-bootstrap <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># 指定默认的集群</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig


chmod +x /usr/local/kubernetes/server/bin/kubelet-startup.sh
mkdir -pv /data/logs/kubernetes/kubelet/ /etc/kubernetes/manifests/

vim /etc/supervisor/conf.d/kubelet.conf
<span class=o>[</span>program:kubelet-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kubelet-startup.sh
                  <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kubelet/kubelet.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824111121.png data-srcset="https://cdn.agou-ops.cn/others/20230824111121.png, https://cdn.agou-ops.cn/others/20230824111121.png 1.5x, https://cdn.agou-ops.cn/others/20230824111121.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824111121.png title=image.png></p><h4 id=463-将master节点作为node加入到集群内部>4.6.3 将master节点作为node加入到集群内部</h4><p><strong>⚠ 注意：这个步骤如果做了bootstrap kubelet，则不需要手动授权，可直接忽略改步骤。</strong></p><blockquote><p>以下来源于网络：
当kubelet组件启动成功后，就会想apiserver发送一个请求加入集群的信息，只有当master节点授权同意后，才可以正常加入，虽然是master节点部署的node组件，> 但是也会发生一个加入集群的信息，需要master同意。</p><p>当kubelet启动之后，首先会在证书目录生成一个kubelet-client.key.tmp这个文件，当使用kubectl certificate approve命令授权成功node的请求之后，kubele> t-client.key.tmp小时，随之会生成一个kubelet-client-current.pem的证书文件，用于与apiserver建立连接，此时再使用kubectl get > node就会看到节点信息了。</p><p>扩展：如果后期想要修改node的名称，那么就把生成的kubelet证书文件全部删除，然后使用kubectl delete > node删除该节点，在修改kubelet配置文件中该节点的名称，然后使用kubectl delete > csr删除授权信息，再重启kubelet生成新的授权信息，然后授权通过即可看到新的名字的node节点。</p><p>只有当授权通过后，kubelet生成了证书文件，kubelet的端口才会被启动</p><p>注意：当kubelet的授权被master请求通后，kube-proxy启动成功后，节点才会正真的加入集群，即使kubectl get > node看到的节点是Ready，该节点也是不可用的，必须当kube-proxy启动完毕后，这个节点才算正真的启动完毕.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># master节点上，获取请求列表</span>
&gt; kubectl get csr
<span class=c1># output</span>
NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION
node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending


<span class=c1># 准许该节点加入集群</span>
&gt; kubectl certificate approve node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I
<span class=c1># output</span>
certificatesigningrequest.certificates.k8s.io/node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I approved
</code></pre></td></tr></table></div></div><p>节点加入结果<code>kubectl get nodes</code>：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824113851.png data-srcset="https://cdn.agou-ops.cn/others/20230824113851.png, https://cdn.agou-ops.cn/others/20230824113851.png 1.5x, https://cdn.agou-ops.cn/others/20230824113851.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824113851.png title=image.png></p><h4 id=463-部署kube-proxy>4.6.3 部署kube-proxy</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>cat &gt; kube-proxy.yml <span class=s>&lt;&lt; EOF
</span><span class=s>apiVersion: v1
</span><span class=s>kind: ServiceAccount
</span><span class=s>metadata:
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: system:kube-proxy
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:node-proxier
</span><span class=s>subjects:
</span><span class=s>- kind: ServiceAccount
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>---
</span><span class=s>apiVersion: v1
</span><span class=s>kind: Secret
</span><span class=s>metadata:
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>  annotations:
</span><span class=s>    kubernetes.io/service-account.name: &#34;kube-proxy&#34;
</span><span class=s>type: kubernetes.io/service-account-token
</span><span class=s>EOF</span>

kubectl apply -f kube-proxy.yml
<span class=c1># 获取token</span>
<span class=nv>JWT_TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl -n kube-system get secret/kube-proxy <span class=se>\
</span><span class=se></span>--output<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.token}&#39;</span> <span class=p>|</span> base64 -d<span class=k>)</span>

<span class=c1># 添加集群apiserver信息</span>
kubectl config set-cluster kubernetes   <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span>    <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># 添加token</span>
kubectl config set-credentials system:kube-proxy    <span class=se>\
</span><span class=se></span>  --token<span class=o>=</span><span class=si>${</span><span class=nv>JWT_TOKEN</span><span class=si>}</span>   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># 添加用户</span>
kubectl config set-context default    <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes   <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-proxy   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># 指定默认的集群</span>
kubectl config use-context default   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig


<span class=c1># 参考：https://kubernetes.io/zh-cn/docs/reference/config-api/kube-proxy-config.v1alpha1/</span>
vim /etc/kubernetes/config/kube-proxy-conf.yml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 172.19.82.157
clientConnection:
  acceptContentTypes: <span class=s2>&#34;&#34;</span>
  burst: <span class=m>10</span>
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/config/kube-proxy.kubeconfig
  qps: <span class=m>5</span>
clusterCIDR: 10.244.0.0/16
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: <span class=m>32768</span>
  min: <span class=m>131072</span>
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: <span class=nb>false</span>
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: <span class=s2>&#34;</span><span class=nv>$a</span><span class=s2>&#34;</span>
iptables:
  masqueradeAll: <span class=nb>false</span>
  masqueradeBit: <span class=m>14</span>
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: <span class=nb>true</span>
  minSyncPeriod: 5s
  scheduler: <span class=s2>&#34;rr&#34;</span>
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: <span class=s2>&#34;ipvs&#34;</span>
nodePortAddresses: null
oomScoreAdj: -999
portRange: <span class=s2>&#34;&#34;</span>
udpIdleTimeout: 250ms


vim /usr/local/kubernetes/server/bin/kube-proxy-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-proxy <span class=se>\
</span><span class=se></span>  --config<span class=o>=</span>/etc/kubernetes/config/kube-proxy-conf.yml <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span>

chmod +x /usr/local/kubernetes/server/bin/kube-proxy-startup.sh
mkdir -pv /data/logs/kubernetes/kube-proxy/

vim /etc/supervisor/conf.d/kube-proxy.conf
<span class=o>[</span>program:kube-proxy-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-proxy-startup.sh     <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-proxy/kube-proxy.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824115519.png data-srcset="https://cdn.agou-ops.cn/others/20230824115519.png, https://cdn.agou-ops.cn/others/20230824115519.png 1.5x, https://cdn.agou-ops.cn/others/20230824115519.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824115519.png title=image.png></p><h4 id=464-授权apiserver访问kubelet>4.6.4 授权apiserver访问kubelet</h4><p>如果不做该授权的话，会导致kubectl无法获取到集群的一些信息，比如logs.
创建一个RBAC资源使得apiserver能够访问kubelet：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
vim apiserver2kubelet-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class=s2>&#34;true&#34;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - <span class=s2>&#34;&#34;</span>
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - <span class=s2>&#34;*&#34;</span>
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: <span class=s2>&#34;&#34;</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes


kubectl apply -f apiserver2kubelet-rbac.yaml
<span class=c1># output</span>
clusterrole.rbac.authorization.k8s.io/system:apiserver2kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre></td></tr></table></div></div><h4 id=465-部署flannel网络组件>4.6.5 部署flannel网络组件</h4><p>部署完以上组件之后，使用<code>kubectl get nodes</code>发现新加进来的master节点处于<code>NotReady</code>状态，原因是没有网络组件，一旦安装好网络组件会立即变为<code>Ready</code>状态。</p><p>配置containerd使用代理和私有仓（不然镜像拉不下来喔）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 配置代理</span>
vim /lib/systemd/system/containerd.service
<span class=c1># 在Services配置段添加</span>
<span class=o>[</span>Service<span class=o>]</span>
...
<span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTP_PROXY=172.19.82.100:7891&#34;</span>
<span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTPS_PROXY=172.19.82.100:7891&#34;</span>
...

systemctl daemon-reload

<span class=c1># 配置私有仓</span>
vim /etc/containerd/config.toml
<span class=c1># 大概第149行开始</span>
...
      <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class=o>]</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;harbor.xxx.local&#34;</span>.auth<span class=o>]</span>
        <span class=nv>username</span> <span class=o>=</span> <span class=s2>&#34;al-admin&#34;</span>
        <span class=nv>password</span> <span class=o>=</span> <span class=s2>&#34;52PXZ2IDNWzk&#34;</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;harbor.xxx.local&#34;</span>.tls<span class=o>]</span>
        <span class=nv>insecure_skip_verify</span> <span class=o>=</span> <span class=nb>true</span>
      <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;harbor.xxx.local&#34;</span><span class=o>]</span>
         <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://harbor.xxx.local&#34;</span><span class=o>]</span>

...

systemctl restart containerd
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824134826.png data-srcset="https://cdn.agou-ops.cn/others/20230824134826.png, https://cdn.agou-ops.cn/others/20230824134826.png 1.5x, https://cdn.agou-ops.cn/others/20230824134826.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824134826.png title=image.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
<span class=c1># 如果你用的不是10.244.0.0/16这个网段，则需要手动修改kube-flannel.yml资源配置文件。</span>
<span class=c1># 如</span>
vim kube-flannel.yml
...
  net-conf.json: <span class=p>|</span>
    <span class=o>{</span>
      <span class=s2>&#34;Network&#34;</span>: <span class=s2>&#34;10.96.0.0/16&#34;</span>,   <span class=c1># 改这里</span>
      <span class=s2>&#34;Backend&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;Type&#34;</span>: <span class=s2>&#34;vxlan&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>
...

kubectl apply -f kube-flannel.yml
</code></pre></td></tr></table></div></div><p>检查flannel运行状态<code>kubectl get po -n kube-flannel</code>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141026.png data-srcset="https://cdn.agou-ops.cn/others/20230825141026.png, https://cdn.agou-ops.cn/others/20230825141026.png 1.5x, https://cdn.agou-ops.cn/others/20230825141026.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141026.png title=image.png></p><h3 id=47-检查master节点部署结果>4.7 检查master节点部署结果</h3><h4 id=471-检查服务运行状态>4.7.1 检查服务运行状态</h4><ul><li>服务运行状态（<code>supervisorctl status</code>）：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141505.png data-srcset="https://cdn.agou-ops.cn/others/20230825141505.png, https://cdn.agou-ops.cn/others/20230825141505.png 1.5x, https://cdn.agou-ops.cn/others/20230825141505.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141505.png title=image.png></li><li>组件状态（<code>kubectl get cs</code>）：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141536.png data-srcset="https://cdn.agou-ops.cn/others/20230825141536.png, https://cdn.agou-ops.cn/others/20230825141536.png 1.5x, https://cdn.agou-ops.cn/others/20230825141536.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141536.png title=image.png></li><li>master节点状态(<code>kubectl get node -owide</code>)
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141605.png data-srcset="https://cdn.agou-ops.cn/others/20230825141605.png, https://cdn.agou-ops.cn/others/20230825141605.png 1.5x, https://cdn.agou-ops.cn/others/20230825141605.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141605.png title=image.png>
如果以上有报错，就回头检查或者重新部署一下有问题的服务即可。</li></ul><h4 id=472-附文件列表及简介>4.7.2 附：文件列表及简介</h4><ul><li>证书及配置文件一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> tree /etc/kubernetes/
/etc/kubernetes/             <span class=c1># 该目录为k8s集群的所有证书和配置文件存放目录</span>
├── TLS                      <span class=c1># 证书存放目录</span>
│   ├── etcd                 <span class=c1># etcd证书存放目录，单独的一个CA</span>
│   │   ├── ca-config.json   <span class=c1># ca配置文件</span>
│   │   ├── ca-csr.json      <span class=c1># ca请求配置文件</span>
│   │   ├── ca-key.pem       <span class=c1># ca私钥</span>
│   │   ├── ca.csr
│   │   ├── ca.pem
│   │   ├── etcd-server-csr.json
│   │   ├── etcd-server-key.pem
│   │   ├── etcd-server.csr
│   │   └── etcd-server.pem
│   └── k8s                  <span class=c1># k8s集群组件证书目录</span>
│       ├── ca-config.json
│       ├── ca-csr.json
│       ├── ca-key.pem
│       ├── ca.csr
│       ├── ca.pem
│       ├── kube-apiserver-csr.json
│       ├── kube-apiserver-key.pem
│       ├── kube-apiserver.csr
│       ├── kube-apiserver.pem
│       ├── kube-controller-manager-csr.json
│       ├── kube-controller-manager-key.pem
│       ├── kube-controller-manager.csr
│       ├── kube-controller-manager.pem
│       ├── kube-scheduler-csr.json
│       ├── kube-scheduler-key.pem
│       ├── kube-scheduler.csr
│       ├── kube-scheduler.pem
│       ├── kubectl-csr.json
│       ├── kubectl-key.pem
│       ├── kubectl.csr
│       ├── kubectl.pem
│       ├── proxy-client
│       │   ├── front-proxy-ca-csr.json
│       │   ├── front-proxy-ca-key.pem
│       │   ├── front-proxy-ca.csr
│       │   ├── front-proxy-ca.pem
│       │   ├── front-proxy-client-csr.json
│       │   ├── front-proxy-client-key.pem
│       │   ├── front-proxy-client.csr
│       │   └── front-proxy-client.pem
│       ├── sa.key
│       └── sa.pub
├── config               <span class=c1># 所有配置，包括认证和各种kubeconfig</span>
│   ├── apiserver2kubelet-rbac.yaml
│   ├── bootstrap.secret.yaml
│   ├── kube-controller-manager.kubeconfig
│   ├── kube-flannel.yml
│   ├── kube-proxy-config.yml
│   ├── kube-proxy-scret.yml
│   ├── kube-proxy.kubeconfig
│   ├── kube-scheduler.kubeconfig
│   ├── kubelet-bootstrap.kubeconfig
│   ├── kubelet-conf.yml
│   └── kubelet.kubeconfig
└── manifests

<span class=m>7</span> directories, <span class=m>51</span> files

</code></pre></td></tr></table></div></div><ul><li>k8s二进制程序以及启动脚本一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 以.sh结尾的就是对应服务的启动脚本</span>
 tree /usr/local/kubernetes/server/bin/
/usr/local/kubernetes/server/bin/
├── apiextensions-apiserver
├── kube-aggregator
├── kube-apiserver
├── kube-apiserver-startup.sh
├── kube-controller-manager
├── kube-controller-manager-startup.sh
├── kube-log-runner
├── kube-proxy
├── kube-proxy-startup.sh
├── kube-scheduler
├── kube-scheduler-startup.sh
├── kubeadm
├── kubectl
├── kubectl-convert
├── kubelet
├── kubelet-startup.sh
└── mounter

<span class=m>1</span> directory, <span class=m>17</span> files
</code></pre></td></tr></table></div></div><ul><li>supervisor配置文件一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># k8s各组件的supervisor配置</span>
 tree /etc/supervisor/conf.d/
/etc/supervisor/conf.d/
├── apiserver.conf
├── controller-manager.conf
├── etcd-server.conf
├── kube-proxy.conf
├── kubelet.conf
└── scheduler.conf

<span class=m>1</span> directory, <span class=m>6</span> files
</code></pre></td></tr></table></div></div><h2 id=五部署node节点>五、部署node节点</h2><p><strong>其实完全可以合并成一个，但是为了条理清晰，所以拆开单独弄。</strong>
在master上将kubelet和kube-proxy二进制文件分发下去：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># 创建程序目录</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /usr/local/kubernetes/server/bin&#34;</span>
  <span class=c1># 分发bootstrap认证文件</span>
 scp -r /usr/local/kubernetes/server/bin/kubelet* /usr/local/kubernetes/server/bin/kube-proxy* <span class=nv>$i</span>:/usr/local/kubernetes/server/bin
  <span class=c1># 增加可执行权限</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;chmod +x /usr/local/kubernetes/server/bin/*&#34;</span>
<span class=k>done</span>
</code></pre></td></tr></table></div></div><h3 id=51-部署kubelet>5.1 部署kubelet</h3><p>在master节点上分发认证文件及kubelet配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># 配置证书及配置文件目录</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /etc/kubernetes/{TLS,config,manifests}&#34;</span>
  <span class=c1># 分发bootstrap认证文件</span>
  scp /etc/kubernetes/config/kubelet-bootstrap.kubeconfig <span class=nv>$i</span>:/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
  <span class=c1># 复制配置文件</span>
  scp /etc/kubernetes/config/kubelet-conf.yml <span class=nv>$i</span>:/etc/kubernetes/config/kubelet-conf.yml
  scp /etc/kubernetes/TLS/k8s/ca.pem <span class=nv>$i</span>:/etc/kubernetes/TLS/k8s/ca.pem
<span class=k>done</span>
</code></pre></td></tr></table></div></div><p>配置supervisor（和master节点类似，所以直接复制过去好了）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># 创建日志目录</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /data/logs/kubernetes/kubelet&#34;</span>
  <span class=c1># 复制kubelet的supervisor配置文件</span>
  scp /etc/supervisor/conf.d/kubelet.conf <span class=nv>$i</span>:/etc/supervisor/conf.d/kubelet.conf
  <span class=c1># 修改id，方便区分，这里不知为何下面命令不能用。。（手动改一下吧</span>
  <span class=c1># ssh $i &#34;id=`ip a show dev eth0 | grep -w inet | awk &#39;{print $2}&#39; | sed -e &#39;s/.*\.\([0-9]\+\)\/.*/\1/&#39;` ; sed -i &#34;s/157/$id/&#34; /etc/supervisor/conf.d/kubelet.conf&#34;</span>
<span class=k>done</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825150503.png data-srcset="https://cdn.agou-ops.cn/others/20230825150503.png, https://cdn.agou-ops.cn/others/20230825150503.png 1.5x, https://cdn.agou-ops.cn/others/20230825150503.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825150503.png title=image.png>
改完之后在node01和node02分别执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># node01</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kubelet-conf.yml
sed -i <span class=s2>&#34;s/master0/node01/&#34;</span> /usr/local/kubernetes/server/bin/kubelet-startup.sh
supervisor update

<span class=c1># node02</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>&#34;</span> /etc/kubernetes/config/kubelet-conf.yml
sed -i <span class=s2>&#34;s/master0/node02/&#34;</span> /usr/local/kubernetes/server/bin/kubelet-startup.sh
supervisor update
</code></pre></td></tr></table></div></div><p>启动完成之后在master节点上可以看到：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl get nodes
<span class=c1># output</span>
NAME      STATUS     ROLES    AGE     VERSION
master0   Ready      &lt;none&gt;   125m    v1.25.12
node01    NotReady   &lt;none&gt;   12s     v1.25.12
node02    NotReady   &lt;none&gt;   3m27s   v1.25.12
</code></pre></td></tr></table></div></div><h3 id=52-部署kube-proxy>5.2 部署kube-proxy</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 在master节点上执行</span>
<span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /data/logs/kubernetes/kube-proxy/&#34;</span>
  <span class=c1># 拷贝kube-proxy配置到node节点</span>
  scp /etc/kubernetes/config/kube-proxy.kubeconfig <span class=nv>$i</span>:/etc/kubernetes/config/kube-proxy.kubeconfig
  scp /etc/kubernetes/config/kube-proxy-conf.yml <span class=nv>$i</span>:/etc/kubernetes/config/kube-proxy-conf.yml
  scp /etc/supervisor/conf.d/kube-proxy.conf <span class=nv>$i</span>:/etc/supervisor/conf.d/kube-proxy.conf
<span class=k>done</span>

<span class=c1># 在node01节点上执行</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kube-proxy-conf.yml
supervisor update

<span class=c1># 在node02节点上执行</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kube-proxy-conf.yml
supervisor update

</code></pre></td></tr></table></div></div><h3 id=53-检查node节点部署结果>5.3 检查node节点部署结果</h3><h4 id=531-检查服务运行状态>5.3.1 检查服务运行状态</h4><ul><li>supervisor服务运行状态（<code>sueprvisorctl status</code>）：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825154847.png data-srcset="https://cdn.agou-ops.cn/others/20230825154847.png, https://cdn.agou-ops.cn/others/20230825154847.png 1.5x, https://cdn.agou-ops.cn/others/20230825154847.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825154847.png title=image.png></li><li>网络组件以及节点状态：(<code>kubectl get node -owide/kubectl get po -A -owide</code>)：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825155014.png data-srcset="https://cdn.agou-ops.cn/others/20230825155014.png, https://cdn.agou-ops.cn/others/20230825155014.png 1.5x, https://cdn.agou-ops.cn/others/20230825155014.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825155014.png title=image.png></li></ul><h4 id=532-附文件列表及简介>5.3.2 附：文件列表及简介</h4><p>以node01节点为例，其他node节点都一样。</p><ul><li>证书及配置文件一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> tree /etc/kubernetes/
/etc/kubernetes/
├── TLS
│   ├── etcd
│   │   ├── ca-key.pem
│   │   ├── ca.pem
│   │   ├── etcd-server-key.pem
│   │   └── etcd-server.pem
│   └── k8s
│       └── ca.pem
├── config
│   ├── kube-proxy-conf.yml
│   ├── kube-proxy-config.yml
│   ├── kube-proxy.kubeconfig
│   ├── kubelet-bootstrap.kubeconfig
│   ├── kubelet-conf.yml
│   └── kubelet.kubeconfig
└── manifests

<span class=m>6</span> directories, <span class=m>11</span> files
</code></pre></td></tr></table></div></div><ul><li>supervisor配置文件一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>tree /etc/supervisor/conf.d/
/etc/supervisor/conf.d/
├── etcd-server.conf
├── kube-proxy.conf
└── kubelet.conf

<span class=m>1</span> directory, <span class=m>3</span> files
</code></pre></td></tr></table></div></div><ul><li>k8s组件二进制程序及对应启动脚本一览：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>tree /usr/local/kubernetes/server/bin/
/usr/local/kubernetes/server/bin/
├── kube-proxy
├── kube-proxy-startup.sh
├── kubelet
└── kubelet-startup.sh

<span class=m>1</span> directory, <span class=m>4</span> files
</code></pre></td></tr></table></div></div><h2 id=六其他可选组件安装>六、其他可选组件安装</h2><h3 id=61-coredns>6.1 coredns</h3><h4 id=611-部署coredns>6.1.1 部署coredns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 在master节点上执行</span>
<span class=nb>cd</span> /etc/kubernetes/config
wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed -O coredns.yaml

<span class=c1># 修改资源清单里面的Corefile和clusterIP</span>
vim coredns.yaml
<span class=c1># 第一处</span>
...
  Corefile: <span class=p>|</span>
    .:53 <span class=o>{</span>
        errors
        health <span class=o>{</span>
          lameduck 5s
        <span class=o>}</span>
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=o>{</span>  <span class=c1># 修改反向解析</span>
          fallthrough in-addr.arpa ip6.arpa
        <span class=o>}</span>
        prometheus :9153
        forward . 8.8.8.8 <span class=o>{</span>          <span class=c1># 修改为外部dns解析地址，当coredns解析不到时会传给该dns</span>
          max_concurrent <span class=m>1000</span>
        <span class=o>}</span>
        cache <span class=m>30</span>
        loop
        reload
        loadbalance
    <span class=o>}</span>                           <span class=c1># 这后面有个STUBDOMAINS去掉</span>
...

<span class=c1># 第二处，大概191行</span>
...
  clusterIP: 10.100.0.2
...

<span class=c1># 修改完成之后</span>
kubectl apply -f coredns.yaml
</code></pre></td></tr></table></div></div><p>检查coredns运行状态：
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825162329.png data-srcset="https://cdn.agou-ops.cn/others/20230825162329.png, https://cdn.agou-ops.cn/others/20230825162329.png 1.5x, https://cdn.agou-ops.cn/others/20230825162329.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825162329.png title=image.png></p><h4 id=测试coredns>测试coredns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim helloworld.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: helloworld
spec:
  selector:
    matchLabels:
      app: helloworld
  replicas: <span class=m>1</span>
  template:
    metadata:
      labels:
        app: helloworld
    spec:
      containers:
      - name: helloworld
        image: karthequian/helloworld:latest
        ports:
        - containerPort: <span class=m>80</span>
---
apiVersion: v1
kind: Service
metadata:
  name: helloworld-service
spec:
  selector:
    app: helloworld
  ports:
    - protocol: TCP
      port: <span class=m>80</span>
      targetPort: <span class=m>80</span>
  type: ClusterIP

kubectl apply -f helloworld.yaml

<span class=c1># 运行网络测试容器</span>
kubectl run tmp-shell --rm -i --tty --image nicolaka/netshoot
tmp-shell  ~  dig kubernetes.default.svc.cluster.local +short
10.96.0.1
tmp-shell2  ~  dig helloworld-service.default.svc.cluster.local +short
10.105.77.246
</code></pre></td></tr></table></div></div><h3 id=62-nginx-ingress>6.2 nginx ingress</h3><p>参考链接：<a href=https://kubernetes.github.io/ingress-nginx/ target=_blank rel="noopener noreffer">https://kubernetes.github.io/ingress-nginx/</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml -O nginx-ingress.yaml

kubectl apply -f nginx-ingress.yaml
</code></pre></td></tr></table></div></div><h3 id=63-面板>6.3 面板</h3><h4 id=631-dashboard>6.3.1 dashboard</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/kubernetes/dashboard/v3.0.0-alpha0/charts/kubernetes-dashboard.yaml

kubectl apply -f kubernetes-dashboard.yaml

<span class=c1># 修改dashboard的Services类型为nodeport，方便访问</span>
kubectl --namespace kubernetes-dashboard patch svc kubernetes-dashboard -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825180332.png data-srcset="https://cdn.agou-ops.cn/others/20230825180332.png, https://cdn.agou-ops.cn/others/20230825180332.png 1.5x, https://cdn.agou-ops.cn/others/20230825180332.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825180332.png title=image.png>
安装完成之后，使用一下命令获取自动分配的nodeport：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl get svc/kubernetes-dashboard -n kubernetes-dashboard -owide
<span class=c1># output</span>
NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>         AGE     SELECTOR
kubernetes-dashboard   NodePort   10.99.165.217   &lt;none&gt;        443:36046/TCP   3m54s   k8s-app<span class=o>=</span>kubernetes-dashboard
</code></pre></td></tr></table></div></div><p>访问任一节点的IP加上面的nodeport即可，比如：<a href=https://172.19.82.157:36046/#/login target=_blank rel="noopener noreffer">https://172.19.82.157:36046/#/login</a>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230827094647.png data-srcset="https://cdn.agou-ops.cn/others/20230827094647.png, https://cdn.agou-ops.cn/others/20230827094647.png 1.5x, https://cdn.agou-ops.cn/others/20230827094647.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230827094647.png title=image.png>
创建sa使用token登录dashboard：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim dashboard-sa.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dashboard-admin
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: dashboard-admin
  namespace: kubernetes-dashboard
---
<span class=c1># 注意较新版本的k8s不会自动创建secret</span>
apiVersion: v1
kind: Secret
metadata:
  name: dashboard-admin-secret
  namespace: kubernetes-dashboard
  annotations:
    kubernetes.io/service-account.name: dashboard-admin
type: kubernetes.io/service-account-token

kubectl apply -f dashboard-sa.yaml

<span class=c1># 获取token</span>
 kubectl describe secret dashboard-admin-secret -n kubernetes-dashboard
<span class=c1># output</span>

Name:         dashboard-admin-secret
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 80bf284e-06e7-4ea4-b747-0a2e77f0ed1f

Type:  kubernetes.io/service-account-token

<span class=nv>Data</span>
<span class=o>====</span>
ca.crt:     <span class=m>1314</span> bytes
namespace:  <span class=m>20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlhYRkQ2bmRNc0s2WktiWHYxT044M1ZfWTQ2UWRxZk81U3Q4TFJnRFo2QncifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tc2VjcmV0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjgwYmYyODRlLTA2ZTctNGVhNC1iNzQ3LTBhMmU3N2YwZWQxZiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDpkYXNoYm9hcmQtYWRtaW4ifQ.RN82A652pjg5PSoIfVCrzj6b6irTQAaHP4Sr-ROf2LCA3A-GttYaH3Tq0pNQx3x2lfhEK2wqWjmKUtcP7yCfoemkXNdAHV_XOnM1qJ86crv-DHkbaqc8JikwyPOucwex8pZ-EeblDpNUyD-QKbImWRmE3XF09g3tBgRrqANFBKbJd82ABKg_BZyQV1iLEz0wN1Int3uk4f8nm19_YoPfjJPE1UcmKcI0m44aqqANSYNU4e6gej4d-YkBHvaIUZ0-9j9r7t_dKS1qVQiqcAwxdFlt0Tjxbi2KurOIAtazQriHaSbe7VhDJa_v-WYfzcZuHgoWpAELyAR9rbcyScgMbw
</code></pre></td></tr></table></div></div><p>使用上面输出的token即可登录dashboard.
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230827100314.png data-srcset="https://cdn.agou-ops.cn/others/20230827100314.png, https://cdn.agou-ops.cn/others/20230827100314.png 1.5x, https://cdn.agou-ops.cn/others/20230827100314.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230827100314.png title=image.png></p><h4 id=632-rancher>6.3.2 rancher</h4><p>略，参考：<a href=https://ranchermanager.docs.rancher.com/pages-for-subheaders/install-upgrade-on-a-kubernetes-cluster#install-the-rancher-helm-chart target=_blank rel="noopener noreffer">使用helm快速安装rancher</a></p><h2 id=七未完待续>七、未完待续</h2><p>To Be Continued&mldr;</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2023-08-27</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12二进制安装k8s v1.25.12" data-hashtags=k8s,kubernetes,二进制安装><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-hashtag=k8s><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12二进制安装k8s v1.25.12"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12二进制安装k8s v1.25.12"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12二进制安装k8s v1.25.12" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12二进制安装k8s v1.25.12"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/myBlog-2/tags/k8s/>k8s</a>,&nbsp;<a href=/myBlog-2/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/myBlog-2/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/>二进制安装</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/myBlog-2/>主页</a></span></section></div><div class=post-nav><a href=/myBlog-2/post/containerdharbor%E7%A7%81%E6%9C%89%E4%BB%93https/ class=prev rel=prev title=Containerd＋Harbor私有仓（https）><i class="fas fa-angle-left fa-fw"></i>Containerd＋Harbor私有仓（https）</a>
<a href=/myBlog-2/post/k8s%E4%B8%AD%E9%83%A8%E7%BD%B2apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/ class=next rel=next title=K8s中部署Apollo配置中心>K8s中部署Apollo配置中心<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://agou-ops.github.io/-/ target=_blank rel="noopener noreferrer" style=color:red>【AGou-ops.cn】</a> 备份站点</div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.75.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/myBlog-2/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>鲁ICP备19050296号-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"AGou-ops/comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/myBlog-2/js/theme.min.js></script></body></html>