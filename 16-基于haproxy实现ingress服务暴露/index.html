<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>16 基于haproxy实现ingress服务暴露 - AGou's Blog-2</title><meta name=Description content="关于 LoveIt 主题"><meta property="og:title" content="16 基于haproxy实现ingress服务暴露"><meta property="og:description" content="写在前面 前面文章介绍了基于nginx实现ingress controller的功能，本章节接续介绍kubernetes系列教程中另外一个姐妹开"><meta property="og:type" content="article"><meta property="og:url" content="http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2019-08-04T10:36:48+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:48+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="16 基于haproxy实现ingress服务暴露"><meta name=twitter:description content="写在前面 前面文章介绍了基于nginx实现ingress controller的功能，本章节接续介绍kubernetes系列教程中另外一个姐妹开"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/><link rel=prev href=http://x.agou-ops.top/17-%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9hpa%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/><link rel=next href=http://x.agou-ops.top/15-tke%E4%B8%AD%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"16 基于haproxy实现ingress服务暴露","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/x.agou-ops.top\/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"kubernetes, tutorial","wordcount":8044,"url":"http:\/\/x.agou-ops.top\/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2\/","datePublished":"2019-08-04T10:36:48+08:00","dateModified":"2019-08-04T10:36:48+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>所有文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/categories/documentation/>文档</a><a class=menu-item href=/about/>关于</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">16 基于haproxy实现ingress服务暴露</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%BD%AC%E8%BD%BD/><i class="far fa-folder fa-fw"></i>转载</a>&nbsp;<a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a>&nbsp;<a href=/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><i class="far fa-folder fa-fw"></i>基础教程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-08-04>2019-08-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8044 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#11-haproxy-ingress简介>1.1 HAproxy Ingress简介</a></li><li><a href=#12-haproxy控制器安装>1.2 HAproxy控制器安装</a></li></ul><ul><li><a href=#21-haproxy-ingress基础>2.1 haproxy ingress基础</a></li><li><a href=#22-动态更新和负载均衡>2.2 动态更新和负载均衡</a></li><li><a href=#23-基于名称虚拟主机>2.3 基于名称虚拟主机</a></li><li><a href=#24-url自动跳转>2.4 URL自动跳转</a></li><li><a href=#24-基于tls加密>2.4 基于TLS加密</a></li></ul></nav></div></div><div class=content id=content><h1 id=写在前面>写在前面</h1><p>前面文章介绍了基于nginx实现ingress controller的功能，本章节接续介绍kubernetes系列教程中另外一个姐妹开源负载均衡的控制器：haproxy ingress controller。</p><h1 id=1-haproxy-ingress控制器>1. HAproxy Ingress控制器</h1><h2 id=11-haproxy-ingress简介>1.1 HAproxy Ingress简介</h2><blockquote><p>HAProxy Ingress watches in the k8s cluster and how it builds HAProxy configuration</p></blockquote><p>和Nginx相类似，HAproxy通过监视kubernetes api获取到service后端pod的状态，动态更新haproxy配置文件，以实现七层的<a href="https://cloud.tencent.com/document/product/214?from=10680" target=_blank rel="noopener noreffer">负载均衡。</a></p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/1%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/1%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/1%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/1%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B8%83)%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/1%20-%201620.jpg title="HAproxy Ingress简介"></p><p>HAproxy Ingress控制器具备的特性如下：</p><ul><li>Fast，Carefully built on top of the battle-tested HAProxy load balancer. 基于haproxy性能有保障</li><li>Reliable，Trusted by sysadmins on clusters as big as 1,000 namespaces, 2,000 domains and 3,000 ingress objects. 可靠，支持1000最多1000个命名空间和2000多个域名</li><li>Highly customizable，100+ configuration options and growing. 可定制化强，支持100多个配置选项</li></ul><p>HAproxy ingress控制器版本</p><ul><li>社区版，基于haproxy社区高度定制符合ingress的控制器，功能相对有限</li><li>企业版，haproxy企业版本，支持很多高级特性和功能，大部分高级功能在企业版本中实现</li></ul><h2 id=12-haproxy控制器安装>1.2 HAproxy控制器安装</h2><p>haproxy ingress安装相对简单，官方提供了安装的yaml文件，先将文件下载查看一下kubernetes资源配置，包含的资源类型有：</p><ul><li>ServiceAccount 和RBAC认证授权关联</li><li>RBAC认证 Role、ClusterRole、 ClusterRoleBinding</li><li>Deployment 默认包含的一个后端backend应用服务器，与之关联一个Service</li><li>Service 后端的一个service</li><li>DaemonSet HAproxy最核心的一个控制器，关联认证ServiceAccount和配置ConfigMap，定义了一个nodeSelector，label为role: ingress-controller，将运行在特定的节点上</li><li>ConfigMap 实现haproxy ingress自定义配置</li></ul><p>安装文件路径https://haproxy-ingress.github.io/resources/haproxy-ingress.yaml</p><p>1、创建命名空间，haproxy ingress部署在ingress-controller这个命名空间，先创建ns</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>create</span> <span class=nx>namespace</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>namespace</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>namespaces</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>yaml</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Namespace</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=s2>&#34;2019-12-27T09:56:04Z&#34;</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=nx>resourceVersion</span><span class=o>:</span> <span class=s2>&#34;13946553&#34;</span>
  <span class=nx>selfLink</span><span class=o>:</span> <span class=err>/api/v1/namespaces/ingress-controller</span>
  <span class=nx>uid</span><span class=o>:</span> <span class=nx>ea70b2f7</span><span class=o>-</span><span class=nx>efe4</span><span class=o>-</span><span class=mi>43</span><span class=nx>fd</span><span class=o>-</span><span class=mi>8</span><span class=nx>ce9</span><span class=o>-</span><span class=mi>3</span><span class=nx>b917b09b533</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>finalizers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>kubernetes</span>
<span class=nx>status</span><span class=o>:</span>
  <span class=nx>phase</span><span class=o>:</span> <span class=nx>Active</span>
</code></pre></td></tr></table></div></div><p>2、安装haproxy ingress控制器</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>wget</span>  <span class=nx>https</span><span class=o>:</span><span class=c1>//haproxy-ingress.github.io/resources/haproxy-ingress.yaml
</span><span class=c1></span><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>serviceaccount</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>
<span class=nx>clusterrole</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>
<span class=nx>role</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>
<span class=nx>clusterrolebinding</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>
<span class=nx>rolebinding</span><span class=p>.</span><span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=nx>created</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span> <span class=nx>created</span>
<span class=nx>service</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span> <span class=nx>created</span>
<span class=nx>configmap</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span> <span class=nx>created</span>
<span class=nx>daemonset</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>3、 检查haproxy ingress安装情况，检查haproxy ingress核心的DaemonSets，发现DS并未部署Pod，原因是配置文件中定义了nodeSelector节点标签选择器，因此需要给node设置合理的标签</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> 
<span class=nx>NAME</span>              <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>NODE</span> <span class=nx>SELECTOR</span>             <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>   <span class=mi>0</span>         <span class=mi>0</span>         <span class=mi>0</span>       <span class=mi>0</span>            <span class=mi>0</span>           <span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>   <span class=mi>5</span><span class=nx>m51s</span>
</code></pre></td></tr></table></div></div><p>4、 给node设置标签，让DaemonSets管理的Pod能调度到node节点上，生产环境中根据情况定义，将实现haproxy ingress功能的节点定义到特定的节点，对个node节点的访问，需要借助于负载均衡实现统一接入，本文主要以探究haproxy ingress功能，因此未部署负载均衡调度器，读者可根据实际的情况部署。以node-1和node-2为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>label</span> <span class=nx>node</span> <span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>node</span><span class=o>/</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>labeled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>label</span> <span class=nx>node</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span> <span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>node</span><span class=o>/</span><span class=nx>node</span><span class=o>-</span><span class=mi>2</span> <span class=nx>labeled</span>

<span class=err>#</span><span class=nx>查看labels的情况</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>nodes</span> <span class=o>--</span><span class=nx>show</span><span class=o>-</span><span class=nx>labels</span> 
<span class=nx>NAME</span>     <span class=nx>STATUS</span>   <span class=nx>ROLES</span>    <span class=nx>AGE</span>    <span class=nx>VERSION</span>   <span class=nx>LABELS</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=nx>Ready</span>    <span class=nx>master</span>   <span class=mi>104</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>node</span><span class=o>-</span><span class=nx>role</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>master</span><span class=o>=</span><span class=p>,</span><span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>104</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>app</span><span class=o>=</span><span class=nx>web</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>label</span><span class=o>=</span><span class=nx>test</span><span class=p>,</span><span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>104</span><span class=nx>d</span>   <span class=nx>v1</span><span class=mf>.15.3</span>   <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span><span class=p>,</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>
</code></pre></td></tr></table></div></div><p>5、再次查看ingress部署情况，已完成部署，并调度至node-1和node-2节点上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>daemonsets</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> 
<span class=nx>NAME</span>              <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>NODE</span> <span class=nx>SELECTOR</span>             <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>   <span class=mi>2</span>         <span class=mi>2</span>         <span class=mi>2</span>       <span class=mi>2</span>            <span class=mi>2</span>           <span class=nx>role</span><span class=o>=</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>   <span class=mi>15</span><span class=nx>m</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                                       <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>     <span class=nx>IP</span>               <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>bdns8</span>                      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>2</span><span class=nx>m27s</span>   <span class=mf>10.254.100.102</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>d5rnl</span>                      <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>2</span><span class=nx>m31s</span>   <span class=mf>10.254.100.101</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>haproxy ingress部署时候也通过deployments部署了一个后端backend服务，这是部署haproxy ingress必须部署服务，否则ingress controller无法启动，可以通过查看Deployments列表确认</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> 
<span class=nx>NAME</span>                      <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=mi>1</span>            <span class=mi>1</span>           <span class=mi>18</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>6、 查看haproxy ingress的日志，通过查询日志可知，多个haproxy ingress是通过选举实现高可用HA机制。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/2%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/2%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/2%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/2%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B8%83)%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/2%20-%201620.jpg title="haprox ingress日志"></p><p>其他资源包括ServiceAccount，ClusterRole，ConfigMaps请单独确认，至此HAproxy ingress controller部署完毕。另外两种部署方式：</p><ul><li><a href=https://github.com/jcmoraisjr/haproxy-ingress/tree/master/examples/deployment target=_blank rel="noopener noreffer">Deployment部署方式</a></li><li><a href=https://github.com/helm/charts/tree/master/incubator/haproxy-ingress target=_blank rel="noopener noreffer">Helm部署方式</a></li></ul><h1 id=2-haproxy-ingress使用>2. haproxy ingress使用</h1><h2 id=21-haproxy-ingress基础>2.1 haproxy ingress基础</h2><p>Ingress控制器部署完毕后需要定义Ingress规则，以方便Ingress控制器能够识别到service后端Pod的资源，这个章节我们将来介绍在HAproxy Ingress Controller环境下Ingress的使用。</p><p>1、环境准备，创建一个deployments并暴露其端口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=err>#</span><span class=nx>创建应用并暴露端口</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>image</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span> <span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>1</span> <span class=o>--</span><span class=nx>expose</span>
<span class=nx>kubectl</span> <span class=nx>run</span> <span class=o>--</span><span class=nx>generator</span><span class=o>=</span><span class=nx>deployment</span><span class=o>/</span><span class=nx>apps</span><span class=p>.</span><span class=nx>v1</span> <span class=nx>is</span> <span class=nx>DEPRECATED</span> <span class=nx>and</span> <span class=nx>will</span> <span class=nx>be</span> <span class=nx>removed</span> <span class=k>in</span> <span class=nx>a</span> <span class=nx>future</span> <span class=nx>version</span><span class=p>.</span> <span class=nx>Use</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=o>--</span><span class=nx>generator</span><span class=o>=</span><span class=nx>run</span><span class=o>-</span><span class=nx>pod</span><span class=o>/</span><span class=nx>v1</span> <span class=nx>or</span> <span class=nx>kubectl</span> <span class=nx>create</span> <span class=nx>instead</span><span class=p>.</span>
<span class=nx>service</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=err>#</span><span class=nx>查看应用</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=mi>1</span>            <span class=mi>1</span>           <span class=mi>10</span><span class=nx>s</span>

<span class=err>#</span><span class=nx>查看service情况</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>services</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                   <span class=nx>TYPE</span>        <span class=nx>CLUSTER</span><span class=o>-</span><span class=nx>IP</span>       <span class=nx>EXTERNAL</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>PORT</span><span class=p>(</span><span class=nx>S</span><span class=p>)</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span>   <span class=nx>ClusterIP</span>   <span class=mf>10.106.199.102</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>    <span class=mi>17</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>2、创建ingress规则,如果有多个ingress控制器，可以通过ingress.class指定类型为haproxy</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>ingresscontroller</span><span class=o>:</span> <span class=nx>haproxy</span> 
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>haproxy</span> 
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>www</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span> 
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>3、应用ingress规则，并查看ingress详情，查看Events日志发现控制器已正常更新</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>ingress</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=err>#</span><span class=nx>查看详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>ingresses</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>             <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>        <span class=k>default</span>
<span class=nx>Address</span><span class=o>:</span>          
<span class=nx>Default</span> <span class=nx>backend</span><span class=o>:</span>  <span class=k>default</span><span class=o>-</span><span class=nx>http</span><span class=o>-</span><span class=nx>backend</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span><span class=p>)</span>
<span class=nx>Rules</span><span class=o>:</span>
  <span class=nx>Host</span>             <span class=nx>Path</span>  <span class=nx>Backends</span>
  <span class=o>----</span>             <span class=o>----</span>  <span class=o>--------</span>
  <span class=nx>www</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>  
                   <span class=o>/</span>   <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=mf>10.244.2.166</span><span class=o>:</span><span class=mi>80</span><span class=p>)</span>
<span class=nx>Annotations</span><span class=o>:</span>
  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>  <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;extensions/v1beta1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Ingress&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/ingress.class&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy&#34;</span><span class=p>},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;ingresscontroller&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-ingress-demo&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;rules&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;host&#34;</span><span class=o>:</span><span class=s2>&#34;www.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;http&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;paths&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;backend&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;serviceName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-ingress-demo&#34;</span><span class=p>,</span><span class=s2>&#34;servicePort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>},</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/&#34;</span><span class=p>}]}}]}}</span>

  <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span>  <span class=nx>haproxy</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>  <span class=nx>Age</span>   <span class=nx>From</span>                <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>  <span class=o>----</span>  <span class=o>----</span>                <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>27</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-demo</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>27</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-demo</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>20</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-demo</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>20</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-demo</span>
</code></pre></td></tr></table></div></div><p>4、测试验证ingress规则，可以将域名写入到hosts文件中，我们直接使用gcurl测试，地址指向node-1或node-2均可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span>  <span class=nx>http</span><span class=o>:</span><span class=c1>//www.happylau.cn --resolve www.happylau.cn:80:10.254.100.101
</span><span class=c1></span><span class=o>&lt;!</span><span class=nx>DOCTYPE</span> <span class=nx>html</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>html</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>head</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>title</span><span class=o>&gt;</span><span class=nx>Welcome</span> <span class=nx>to</span> <span class=nx>nginx</span><span class=o>!&lt;</span><span class=err>/title&gt;</span>
<span class=o>&lt;</span><span class=nx>style</span><span class=o>&gt;</span>
    <span class=nx>body</span> <span class=p>{</span>
        <span class=nx>width</span><span class=o>:</span> <span class=mi>35</span><span class=nx>em</span><span class=p>;</span>
        <span class=nx>margin</span><span class=o>:</span> <span class=mi>0</span> <span class=nx>auto</span><span class=p>;</span>
        <span class=nx>font</span><span class=o>-</span><span class=nx>family</span><span class=o>:</span> <span class=nx>Tahoma</span><span class=p>,</span> <span class=nx>Verdana</span><span class=p>,</span> <span class=nx>Arial</span><span class=p>,</span> <span class=nx>sans</span><span class=o>-</span><span class=nx>serif</span><span class=p>;</span>
    <span class=p>}</span>
<span class=o>&lt;</span><span class=err>/style&gt;</span>
<span class=o>&lt;</span><span class=err>/head&gt;</span>
<span class=o>&lt;</span><span class=nx>body</span><span class=o>&gt;</span>
<span class=o>&lt;</span><span class=nx>h1</span><span class=o>&gt;</span><span class=nx>Welcome</span> <span class=nx>to</span> <span class=nx>nginx</span><span class=o>!&lt;</span><span class=err>/h1&gt;</span>
<span class=o>&lt;</span><span class=nx>p</span><span class=o>&gt;</span><span class=nx>If</span> <span class=nx>you</span> <span class=nx>see</span> <span class=k>this</span> <span class=nx>page</span><span class=p>,</span> <span class=nx>the</span> <span class=nx>nginx</span> <span class=nx>web</span> <span class=nx>server</span> <span class=nx>is</span> <span class=nx>successfully</span> <span class=nx>installed</span> <span class=nx>and</span>
<span class=nx>working</span><span class=p>.</span> <span class=nx>Further</span> <span class=nx>configuration</span> <span class=nx>is</span> <span class=nx>required</span><span class=p>.</span><span class=o>&lt;</span><span class=err>/p&gt;</span>

<span class=o>&lt;</span><span class=nx>p</span><span class=o>&gt;</span><span class=nx>For</span> <span class=nx>online</span> <span class=nx>documentation</span> <span class=nx>and</span> <span class=nx>support</span> <span class=nx>please</span> <span class=nx>refer</span> <span class=nx>to</span>
<span class=o>&lt;</span><span class=nx>a</span> <span class=nx>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.org/&#34;</span><span class=o>&gt;</span><span class=nx>nginx</span><span class=p>.</span><span class=nx>org</span><span class=o>&lt;</span><span class=sr>/a&gt;.&lt;br/</span><span class=o>&gt;</span>
<span class=nx>Commercial</span> <span class=nx>support</span> <span class=nx>is</span> <span class=nx>available</span> <span class=nx>at</span>
<span class=o>&lt;</span><span class=nx>a</span> <span class=nx>href</span><span class=o>=</span><span class=s2>&#34;http://nginx.com/&#34;</span><span class=o>&gt;</span><span class=nx>nginx</span><span class=p>.</span><span class=nx>com</span><span class=o>&lt;</span><span class=err>/a&gt;.&lt;/p&gt;</span>

<span class=o>&lt;</span><span class=nx>p</span><span class=o>&gt;&lt;</span><span class=nx>em</span><span class=o>&gt;</span><span class=nx>Thank</span> <span class=nx>you</span> <span class=k>for</span> <span class=nx>using</span> <span class=nx>nginx</span><span class=p>.</span><span class=o>&lt;</span><span class=err>/em&gt;&lt;/p&gt;</span>
<span class=o>&lt;</span><span class=err>/body&gt;</span>
<span class=o>&lt;</span><span class=err>/html&gt;</span>
</code></pre></td></tr></table></div></div><p>5、测试正常，接下来到haproxy ingress controller中刚查看对应生成规则配置文件</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>bdns8</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>sh</span>

<span class=err>#</span><span class=nx>查看配置文件</span>
<span class=err>/etc/haproxy # cat /etc/haproxy/haproxy.cfg </span>
  <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>HAProxy</span> <span class=nx>Ingress</span> <span class=nx>Controller</span>
<span class=err>#</span> <span class=err>#</span>   <span class=o>--------------------------</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>This</span> <span class=nx>file</span> <span class=nx>is</span> <span class=nx>automatically</span> <span class=nx>updated</span><span class=p>,</span> <span class=k>do</span> <span class=nx>not</span> <span class=nx>edit</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=nx>全局配置文件内容</span>
<span class=nx>global</span>
    <span class=nx>daemon</span>
    <span class=nx>nbthread</span> <span class=mi>2</span>
    <span class=nx>cpu</span><span class=o>-</span><span class=nx>map</span> <span class=nx>auto</span><span class=o>:</span><span class=mi>1</span><span class=o>/</span><span class=mi>1</span><span class=o>-</span><span class=mi>2</span> <span class=mi>0</span><span class=o>-</span><span class=mi>1</span>
    <span class=nx>stats</span> <span class=nx>socket</span> <span class=o>/</span><span class=kd>var</span><span class=err>/run/haproxy-stats.sock level admin expose-fd listeners</span>
    <span class=nx>maxconn</span> <span class=mi>2000</span>
    <span class=nx>hard</span><span class=o>-</span><span class=nx>stop</span><span class=o>-</span><span class=nx>after</span> <span class=mi>10</span><span class=nx>m</span>
    <span class=nx>lua</span><span class=o>-</span><span class=nx>load</span> <span class=o>/</span><span class=nx>usr</span><span class=o>/</span><span class=nx>local</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>lua</span><span class=o>/</span><span class=nx>send</span><span class=o>-</span><span class=nx>response</span><span class=p>.</span><span class=nx>lua</span>
    <span class=nx>lua</span><span class=o>-</span><span class=nx>load</span> <span class=o>/</span><span class=nx>usr</span><span class=o>/</span><span class=nx>local</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>lua</span><span class=o>/</span><span class=nx>auth</span><span class=o>-</span><span class=nx>request</span><span class=p>.</span><span class=nx>lua</span>
    <span class=nx>tune</span><span class=p>.</span><span class=nx>ssl</span><span class=p>.</span><span class=k>default</span><span class=o>-</span><span class=nx>dh</span><span class=o>-</span><span class=nx>param</span> <span class=mi>2048</span>
    <span class=nx>ssl</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>bind</span><span class=o>-</span><span class=nx>ciphers</span> <span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA384</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA384</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>DSS</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>GCM</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>kEDH</span><span class=o>+</span><span class=nx>AESGCM</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA384</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA384</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>ECDHE</span><span class=o>-</span><span class=nx>ECDSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>DSS</span><span class=o>-</span><span class=nx>AES128</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA256</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>DSS</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:</span><span class=nx>DHE</span><span class=o>-</span><span class=nx>RSA</span><span class=o>-</span><span class=nx>AES256</span><span class=o>-</span><span class=nx>SHA</span><span class=o>:!</span><span class=nx>aNULL</span><span class=o>:!</span><span class=nx>eNULL</span><span class=o>:!</span><span class=nx>EXPORT</span><span class=o>:!</span><span class=nx>DES</span><span class=o>:!</span><span class=nx>RC4</span><span class=o>:!</span><span class=mi>3</span><span class=nx>DES</span><span class=o>:!</span><span class=nx>MD5</span><span class=o>:!</span><span class=nx>PSK</span>
    <span class=nx>ssl</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>bind</span><span class=o>-</span><span class=nx>options</span> <span class=nx>no</span><span class=o>-</span><span class=nx>sslv3</span> <span class=nx>no</span><span class=o>-</span><span class=nx>tls</span><span class=o>-</span><span class=nx>tickets</span>

<span class=err>#</span><span class=nx>默认配置内容</span>
<span class=nx>defaults</span>
    <span class=nx>log</span> <span class=nx>global</span>
    <span class=nx>maxconn</span> <span class=mi>2000</span>
    <span class=nx>option</span> <span class=nx>redispatch</span>
    <span class=nx>option</span> <span class=nx>dontlognull</span>
    <span class=nx>option</span> <span class=nx>http</span><span class=o>-</span><span class=nx>server</span><span class=o>-</span><span class=nx>close</span>
    <span class=nx>option</span> <span class=nx>http</span><span class=o>-</span><span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span>
    <span class=nx>timeout</span> <span class=nx>client</span>          <span class=mi>50</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>client</span><span class=o>-</span><span class=nx>fin</span>      <span class=mi>50</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>connect</span>         <span class=mi>5</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>http</span><span class=o>-</span><span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span> <span class=mi>1</span><span class=nx>m</span>
    <span class=nx>timeout</span> <span class=nx>http</span><span class=o>-</span><span class=nx>request</span>    <span class=mi>5</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>queue</span>           <span class=mi>5</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>server</span>          <span class=mi>50</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>server</span><span class=o>-</span><span class=nx>fin</span>      <span class=mi>50</span><span class=nx>s</span>
    <span class=nx>timeout</span> <span class=nx>tunnel</span>          <span class=mi>1</span><span class=nx>h</span>

<span class=err>#</span><span class=nx>后端服务器</span><span class=err>，</span><span class=nx>即通过service服务发现机制</span><span class=err>，</span><span class=nx>和后端的Pod关联</span>
<span class=nx>backend</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo_80</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>balance</span> <span class=nx>roundrobin</span>
    <span class=nx>acl</span> <span class=nx>https</span><span class=o>-</span><span class=nx>request</span> <span class=nx>ssl_fc</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Original</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>For</span> <span class=o>%</span><span class=p>[</span><span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)]</span> <span class=k>if</span> <span class=p>{</span> <span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)</span> <span class=o>-</span><span class=nx>m</span> <span class=nx>found</span> <span class=p>}</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span>
    <span class=nx>option</span> <span class=nx>forwardfor</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>response</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>Strict</span><span class=o>-</span><span class=nx>Transport</span><span class=o>-</span><span class=nx>Security</span> <span class=s2>&#34;max-age=15768000&#34;</span>
    <span class=nx>server</span> <span class=nx>srv001</span> <span class=mf>10.244.2.166</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>   <span class=err>#</span><span class=nx>后端Pod的地址</span>
    <span class=nx>server</span> <span class=nx>srv002</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv003</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv004</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv005</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv006</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv007</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>

<span class=err>#</span><span class=nx>默认安装时创建的backend服务</span> <span class=err>，</span><span class=nx>初始安装时需要使用到</span>
<span class=nx>backend</span> <span class=nx>_default_backend</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>balance</span> <span class=nx>roundrobin</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Original</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>For</span> <span class=o>%</span><span class=p>[</span><span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)]</span> <span class=k>if</span> <span class=p>{</span> <span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)</span> <span class=o>-</span><span class=nx>m</span> <span class=nx>found</span> <span class=p>}</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span>
    <span class=nx>option</span> <span class=nx>forwardfor</span>
    <span class=nx>server</span> <span class=nx>srv001</span> <span class=mf>10.244.2.165</span><span class=o>:</span><span class=mi>8080</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv002</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv003</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv004</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv005</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv006</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv007</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>

<span class=nx>backend</span> <span class=nx>_error413</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>errorfile</span> <span class=mi>400</span> <span class=o>/</span><span class=nx>usr</span><span class=o>/</span><span class=nx>local</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>errors</span><span class=o>/</span><span class=mf>413.</span><span class=nx>http</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>deny</span> <span class=nx>deny_status</span> <span class=mi>400</span>
<span class=nx>backend</span> <span class=nx>_error495</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>errorfile</span> <span class=mi>400</span> <span class=o>/</span><span class=nx>usr</span><span class=o>/</span><span class=nx>local</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>errors</span><span class=o>/</span><span class=mf>495.</span><span class=nx>http</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>deny</span> <span class=nx>deny_status</span> <span class=mi>400</span>
<span class=nx>backend</span> <span class=nx>_error496</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>errorfile</span> <span class=mi>400</span> <span class=o>/</span><span class=nx>usr</span><span class=o>/</span><span class=nx>local</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>errors</span><span class=o>/</span><span class=mf>496.</span><span class=nx>http</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>deny</span> <span class=nx>deny_status</span> <span class=mi>400</span>

<span class=err>#</span><span class=nx>前端监听的80端口转发规则</span><span class=err>，</span><span class=nx>并配置有https跳转</span><span class=err>，</span><span class=nx>对应的主机配置在</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>maps</span><span class=o>/</span><span class=nx>_global_http_front</span><span class=p>.</span><span class=nx>map文件中定义</span>
<span class=nx>frontend</span> <span class=nx>_front_http</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>bind</span> <span class=o>*:</span><span class=mi>80</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>base</span><span class=p>)</span> <span class=nx>base</span><span class=p>,</span><span class=nx>lower</span><span class=p>,</span><span class=nx>regsub</span><span class=p>(</span><span class=o>:</span><span class=p>[</span><span class=mi>0</span><span class=o>-</span><span class=mi>9</span><span class=p>]</span><span class=o>+</span><span class=sr>/,/</span><span class=p>)</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>redirect</span> <span class=nx>scheme</span> <span class=nx>https</span> <span class=k>if</span> <span class=p>{</span> <span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>base</span><span class=p>),</span><span class=nx>map_beg</span><span class=p>(</span><span class=err>/etc/haproxy/maps/_global_https_redir.map,_nomatch) yes }</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>Proto</span> <span class=nx>http</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>CN</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>DN</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>SHA1</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>Cert</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>backend</span><span class=p>)</span> <span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>base</span><span class=p>),</span><span class=nx>map_beg</span><span class=p>(</span><span class=err>/etc/haproxy/maps/_global_http_front.map,_nomatch)</span>
    <span class=nx>use_backend</span> <span class=o>%</span><span class=p>[</span><span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>backend</span><span class=p>)]</span> <span class=nx>unless</span> <span class=p>{</span> <span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>backend</span><span class=p>)</span> <span class=nx>_nomatch</span> <span class=p>}</span>
    <span class=nx>default_backend</span> <span class=nx>_default_backend</span>

<span class=err>#</span><span class=nx>前端监听的443转发规则</span><span class=err>，</span><span class=nx>对应域名在</span><span class=o>/</span><span class=nx>etc</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>/</span><span class=nx>maps</span><span class=o>/</span> <span class=nx>_front001_host</span><span class=p>.</span><span class=nx>map文件中</span>
<span class=nx>frontend</span> <span class=nx>_front001</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>bind</span> <span class=o>*:</span><span class=mi>443</span> <span class=nx>ssl</span> <span class=nx>alpn</span> <span class=nx>h2</span><span class=p>,</span><span class=nx>http</span><span class=o>/</span><span class=mf>1.1</span> <span class=nx>crt</span> <span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span><span class=o>/</span><span class=nx>ssl</span><span class=o>/</span><span class=k>default</span><span class=o>-</span><span class=nx>fake</span><span class=o>-</span><span class=nx>certificate</span><span class=p>.</span><span class=nx>pem</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>hostbackend</span><span class=p>)</span> <span class=nx>base</span><span class=p>,</span><span class=nx>lower</span><span class=p>,</span><span class=nx>regsub</span><span class=p>(</span><span class=o>:</span><span class=p>[</span><span class=mi>0</span><span class=o>-</span><span class=mi>9</span><span class=p>]</span><span class=o>+</span><span class=sr>/,/</span><span class=p>),</span><span class=nx>map_beg</span><span class=p>(</span><span class=err>/etc/haproxy/maps/_front001_host.map,_nomatch)</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>Proto</span> <span class=nx>https</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>CN</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>DN</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>SHA1</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>SSL</span><span class=o>-</span><span class=nx>Client</span><span class=o>-</span><span class=nx>Cert</span>
    <span class=nx>use_backend</span> <span class=o>%</span><span class=p>[</span><span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>hostbackend</span><span class=p>)]</span> <span class=nx>unless</span> <span class=p>{</span> <span class=kd>var</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>hostbackend</span><span class=p>)</span> <span class=nx>_nomatch</span> <span class=p>}</span>
    <span class=nx>default_backend</span> <span class=nx>_default_backend</span>

<span class=err>#</span><span class=nx>状态监听器</span>
<span class=nx>listen</span> <span class=nx>stats</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>bind</span> <span class=o>*:</span><span class=mi>1936</span>
    <span class=nx>stats</span> <span class=nx>enable</span>
    <span class=nx>stats</span> <span class=nx>uri</span> <span class=o>/</span>
    <span class=nx>no</span> <span class=nx>log</span>
    <span class=nx>option</span> <span class=nx>forceclose</span>
    <span class=nx>stats</span> <span class=nx>show</span><span class=o>-</span><span class=nx>legends</span>

<span class=err>#</span><span class=nx>监控健康检查</span>
<span class=nx>frontend</span> <span class=nx>healthz</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>bind</span> <span class=o>*:</span><span class=mi>10253</span>
    <span class=nx>monitor</span><span class=o>-</span><span class=nx>uri</span> <span class=o>/</span><span class=nx>healthz</span>
</code></pre></td></tr></table></div></div><p>查看主机名隐射文件，包含有前端主机名和转发到后端backend的名称</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=err>/etc/haproxy/maps # cat /etc/haproxy/maps/_global_http_front.map </span>
<span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>HAProxy</span> <span class=nx>Ingress</span> <span class=nx>Controller</span>
<span class=err>#</span> <span class=err>#</span>   <span class=o>--------------------------</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>This</span> <span class=nx>file</span> <span class=nx>is</span> <span class=nx>automatically</span> <span class=nx>updated</span><span class=p>,</span> <span class=k>do</span> <span class=nx>not</span> <span class=nx>edit</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span>
<span class=nx>www</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span><span class=o>/</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo_80</span>
</code></pre></td></tr></table></div></div><p>通过上面的基础配置可以实现基于haproxy的七层负载均衡实现，haproxy ingress controller通过kubernetes api动态识别到service后端规则配置并更新至haproxy.cfg配置文件中，从而实现负载均衡功能实现。</p><h2 id=22-动态更新和负载均衡>2.2 动态更新和负载均衡</h2><p>后端Pod是实时动态变化的，haproxy ingress通过service的服务发现机制，动态识别到后端Pod的变化情况，并动态更新haproxy.cfg配置文件，并重载配置（实际不需要重启haproxy服务），本章节将演示haproxy ingress动态更新和<a href="https://cloud.tencent.com/document/product/214?from=10680" target=_blank rel="noopener noreffer">负载均衡</a>功能。</p><p>1、动态更新，我们以扩容pod的副本为例，将副本数从replicas=1扩容至3个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>3</span> <span class=nx>deployment</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>3</span><span class=o>/</span><span class=mi>3</span>     <span class=mi>3</span>            <span class=mi>3</span>           <span class=mi>43</span><span class=nx>m</span>

<span class=err>#</span><span class=nx>查看扩容后Pod的IP地址</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span>
<span class=nx>NAME</span>                                   <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>     <span class=nx>IP</span>             <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=mi>5</span><span class=nx>pgjt</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>43</span><span class=nx>m</span>     <span class=mf>10.244.2.166</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>pst2q</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>18</span><span class=nx>s</span>     <span class=mf>10.244.0.52</span>    <span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>sr8tm</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>18</span><span class=nx>s</span>     <span class=mf>10.244.1.149</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>2、查看haproxy配置文件内容,可以看到backend后端主机列表已动态发现新增的pod地址</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>backend</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo_80</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>balance</span> <span class=nx>roundrobin</span>
    <span class=nx>acl</span> <span class=nx>https</span><span class=o>-</span><span class=nx>request</span> <span class=nx>ssl_fc</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Original</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>For</span> <span class=o>%</span><span class=p>[</span><span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)]</span> <span class=k>if</span> <span class=p>{</span> <span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)</span> <span class=o>-</span><span class=nx>m</span> <span class=nx>found</span> <span class=p>}</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span>
    <span class=nx>option</span> <span class=nx>forwardfor</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>response</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>Strict</span><span class=o>-</span><span class=nx>Transport</span><span class=o>-</span><span class=nx>Security</span> <span class=s2>&#34;max-age=15768000&#34;</span>
    <span class=nx>server</span> <span class=nx>srv001</span> <span class=mf>10.244.2.166</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>   <span class=err>#</span><span class=nx>新增的pod地址</span>
    <span class=nx>server</span> <span class=nx>srv002</span> <span class=mf>10.244.0.52</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv003</span> <span class=mf>10.244.1.149</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv004</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv005</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv006</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv007</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>4、查看haproxy ingress日志，日志中提示HAProxy updated without needing to reload，即配置动态识别，不需要重启haproxy服务就能够识别，自从1.8后haproxy能支持动态配置更新的能力，以适应微服务的场景，详情查看<a href=https://www.haproxy.com/blog/truly-seamless-reloads-with-haproxy-no-more-hacks/ target=_blank rel="noopener noreffer">文章说明</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>logs</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>bdns8</span> <span class=o>-</span><span class=nx>n</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span> <span class=o>-</span><span class=nx>f</span>
<span class=nx>I1227</span> <span class=mi>12</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=mf>11.523066</span>       <span class=mi>6</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>274</span><span class=p>]</span> <span class=nx>Starting</span> <span class=nx>HAProxy</span> <span class=nx>update</span> <span class=nx>id</span><span class=o>=</span><span class=mi>20</span>
<span class=nx>I1227</span> <span class=mi>12</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=mf>11.561001</span>       <span class=mi>6</span> <span class=nx>instance</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>162</span><span class=p>]</span> <span class=nx>HAProxy</span> <span class=nx>updated</span> <span class=nx>without</span> <span class=nx>needing</span> <span class=nx>to</span> <span class=nx>reload</span><span class=p>.</span> <span class=nx>Commands</span> <span class=nx>sent</span><span class=o>:</span> <span class=mi>3</span>
<span class=nx>I1227</span> <span class=mi>12</span><span class=o>:</span><span class=mi>21</span><span class=o>:</span><span class=mf>11.561057</span>       <span class=mi>6</span> <span class=nx>controller</span><span class=p>.</span><span class=nx>go</span><span class=o>:</span><span class=mi>325</span><span class=p>]</span> <span class=nx>Finish</span> <span class=nx>HAProxy</span> <span class=nx>update</span> <span class=nx>id</span><span class=o>=</span><span class=mi>20</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>=</span><span class=mf>0.149764</span><span class=nx>ms</span> <span class=nx>writeTmpl</span><span class=o>=</span><span class=mf>37.738947</span><span class=nx>ms</span> <span class=nx>total</span><span class=o>=</span><span class=mf>37.888711</span><span class=nx>ms</span>
</code></pre></td></tr></table></div></div><p>5、接下来测试负载均衡的功能，为了验证测试效果，往pod中写入不同的内容，以测试负载均衡的效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=mi>5</span><span class=nx>pgjt</span> <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>bash</span>
<span class=nx>root</span><span class=err>@</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=mi>5</span><span class=nx>pgjt</span><span class=o>:</span><span class=err>/# echo &#34;web-1&#34; &gt; /usr/share/nginx/html/index.html</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>pst2q</span> <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>bash</span>
<span class=nx>root</span><span class=err>@</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>pst2q</span><span class=o>:</span><span class=err>/# echo &#34;web-2&#34; &gt; /usr/share/nginx/html/index.html</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>sr8tm</span> <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>bash</span>
<span class=nx>root</span><span class=err>@</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>d487d4fc</span><span class=o>-</span><span class=nx>sr8tm</span><span class=o>:</span><span class=err>/# echo &#34;web-3&#34; &gt; /usr/share/nginx/html/index.html</span>
</code></pre></td></tr></table></div></div><p>6、测试验证负载均衡效果,haproxy采用轮询的调度算法，因此可以明显看到轮询效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span>  <span class=nx>http</span><span class=o>:</span><span class=c1>//www.happylau.cn --resolve www.happylau.cn:80:10.254.100.102
</span><span class=c1></span><span class=nx>web</span><span class=o>-</span><span class=mi>1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span>  <span class=nx>http</span><span class=o>:</span><span class=c1>//www.happylau.cn --resolve www.happylau.cn:80:10.254.100.102
</span><span class=c1></span><span class=nx>web</span><span class=o>-</span><span class=mi>2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span>  <span class=nx>http</span><span class=o>:</span><span class=c1>//www.happylau.cn --resolve www.happylau.cn:80:10.254.100.102
</span><span class=c1></span><span class=nx>web</span><span class=o>-</span><span class=mi>3</span>
</code></pre></td></tr></table></div></div><p>这个章节验证了haproxy ingress控制器动态配置更新的能力，相比于nginx ingress控制器而言，haproxy ingress控制器不需要重载服务进程就能够动态识别到配置，在微服务场景下将具有非常大的优势；并通过一个实例验证了ingress负载均衡调度能力。</p><h2 id=23-基于名称虚拟主机>2.3 基于名称虚拟主机</h2><p>这个小节将演示haproxy ingress基于虚拟云主机功能的实现，定义两个虚拟主机news.happylau.cn和sports.happylau.cn，将请求各自转发至haproxy-1和haproxy-2</p><p>1、 准备环境测试环境，创建两个应用haproxy-1和haproxy并暴露服务端口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span> <span class=o>--</span><span class=nx>image</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span> <span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>1</span> <span class=o>--</span><span class=nx>expose</span><span class=o>=</span><span class=kc>true</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span> <span class=o>--</span><span class=nx>image</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span> <span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>1</span> <span class=o>--</span><span class=nx>expose</span><span class=o>=</span><span class=kc>true</span>

<span class=nx>查看应用</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> 
<span class=nx>NAME</span>                   <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=mi>1</span>            <span class=mi>1</span>           <span class=mi>39</span><span class=nx>s</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=mi>1</span>            <span class=mi>1</span>           <span class=mi>36</span><span class=nx>s</span>

<span class=nx>查看service</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>services</span> 
<span class=nx>NAME</span>                   <span class=nx>TYPE</span>        <span class=nx>CLUSTER</span><span class=o>-</span><span class=nx>IP</span>       <span class=nx>EXTERNAL</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>PORT</span><span class=p>(</span><span class=nx>S</span><span class=p>)</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span>              <span class=nx>ClusterIP</span>   <span class=mf>10.100.239.114</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>    <span class=mi>55</span><span class=nx>s</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span>              <span class=nx>ClusterIP</span>   <span class=mf>10.100.245.28</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>    <span class=mi>52</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>3、定义ingress规则，定义不同的主机并将请求转发至不同的service中</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>haproxy</span> 
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>    
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span> 
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>

<span class=err>#</span><span class=nx>应用ingress规则并查看列表</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>ingress</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span> <span class=nx>created</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>ingresses</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span> 
<span class=nx>NAME</span>                          <span class=nx>HOSTS</span>                                 <span class=nx>ADDRESS</span>   <span class=nx>PORTS</span>   <span class=nx>AGE</span>
<span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>   <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span><span class=p>,</span><span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>             <span class=mi>80</span>      <span class=mi>8</span><span class=nx>s</span>

<span class=nx>查看ingress规则详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>ingresses</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span> 
<span class=nx>Name</span><span class=o>:</span>             <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>
<span class=nx>Namespace</span><span class=o>:</span>        <span class=k>default</span>
<span class=nx>Address</span><span class=o>:</span>          
<span class=nx>Default</span> <span class=nx>backend</span><span class=o>:</span>  <span class=k>default</span><span class=o>-</span><span class=nx>http</span><span class=o>-</span><span class=nx>backend</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span><span class=p>)</span>
<span class=nx>Rules</span><span class=o>:</span>
  <span class=nx>Host</span>                <span class=nx>Path</span>  <span class=nx>Backends</span>
  <span class=o>----</span>                <span class=o>----</span>  <span class=o>--------</span>
  <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>    
                      <span class=o>/</span>   <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=mf>10.244.2.168</span><span class=o>:</span><span class=mi>80</span><span class=p>)</span>
  <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>  
                      <span class=o>/</span>   <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=mf>10.244.2.169</span><span class=o>:</span><span class=mi>80</span><span class=p>)</span>
<span class=nx>Annotations</span><span class=o>:</span>
  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>  <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;extensions/v1beta1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Ingress&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/ingress.class&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-ingress-virtualhost&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;rules&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;host&#34;</span><span class=o>:</span><span class=s2>&#34;news.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;http&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;paths&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;backend&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;serviceName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-1&#34;</span><span class=p>,</span><span class=s2>&#34;servicePort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>},</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/&#34;</span><span class=p>}]}},{</span><span class=s2>&#34;host&#34;</span><span class=o>:</span><span class=s2>&#34;sports.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;http&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;paths&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;backend&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;serviceName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-2&#34;</span><span class=p>,</span><span class=s2>&#34;servicePort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>},</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/&#34;</span><span class=p>}]}}]}}</span>

  <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span>  <span class=nx>haproxy</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>  <span class=nx>Age</span>   <span class=nx>From</span>                <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>  <span class=o>----</span>  <span class=o>----</span>                <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>37</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>37</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>20</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>20</span><span class=nx>s</span>   <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
</code></pre></td></tr></table></div></div><p>4、测试验证虚拟机主机配置，通过curl直接解析的方式，或者通过写hosts文件</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/3%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/3%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/3%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/3%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B8%83)%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/3%20-%201620.jpg title="haproxy ingress虚拟主机验证"></p><p>5、查看配置配置文件内容，配置中更新了haproxy.cfg的front段和backend段的内容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=err>/etc/haproxy/haproxy.cfg 配置文件内容</span>
<span class=nx>backend</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=mi>1</span><span class=nx>_80</span>    <span class=err>#</span><span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span><span class=nx>后端</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>balance</span> <span class=nx>roundrobin</span>
    <span class=nx>acl</span> <span class=nx>https</span><span class=o>-</span><span class=nx>request</span> <span class=nx>ssl_fc</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Original</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>For</span> <span class=o>%</span><span class=p>[</span><span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)]</span> <span class=k>if</span> <span class=p>{</span> <span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)</span> <span class=o>-</span><span class=nx>m</span> <span class=nx>found</span> <span class=p>}</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span>
    <span class=nx>option</span> <span class=nx>forwardfor</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>response</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>Strict</span><span class=o>-</span><span class=nx>Transport</span><span class=o>-</span><span class=nx>Security</span> <span class=s2>&#34;max-age=15768000&#34;</span>
    <span class=nx>server</span> <span class=nx>srv001</span> <span class=mf>10.244.2.168</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv002</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv003</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv004</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv005</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv006</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv007</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>

<span class=err>#</span><span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span><span class=nx>后端</span>
<span class=nx>backend</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=mi>2</span><span class=nx>_80</span>
    <span class=nx>mode</span> <span class=nx>http</span>
    <span class=nx>balance</span> <span class=nx>roundrobin</span>
    <span class=nx>acl</span> <span class=nx>https</span><span class=o>-</span><span class=nx>request</span> <span class=nx>ssl_fc</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>X</span><span class=o>-</span><span class=nx>Original</span><span class=o>-</span><span class=nx>Forwarded</span><span class=o>-</span><span class=nx>For</span> <span class=o>%</span><span class=p>[</span><span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)]</span> <span class=k>if</span> <span class=p>{</span> <span class=nx>hdr</span><span class=p>(</span><span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span><span class=p>)</span> <span class=o>-</span><span class=nx>m</span> <span class=nx>found</span> <span class=p>}</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>request</span> <span class=nx>del</span><span class=o>-</span><span class=nx>header</span> <span class=nx>x</span><span class=o>-</span><span class=nx>forwarded</span><span class=o>-</span><span class=k>for</span>
    <span class=nx>option</span> <span class=nx>forwardfor</span>
    <span class=nx>http</span><span class=o>-</span><span class=nx>response</span> <span class=nx>set</span><span class=o>-</span><span class=nx>header</span> <span class=nx>Strict</span><span class=o>-</span><span class=nx>Transport</span><span class=o>-</span><span class=nx>Security</span> <span class=s2>&#34;max-age=15768000&#34;</span>
    <span class=nx>server</span> <span class=nx>srv001</span> <span class=mf>10.244.2.169</span><span class=o>:</span><span class=mi>80</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv002</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv003</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv004</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv005</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv006</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>
    <span class=nx>server</span> <span class=nx>srv007</span> <span class=mf>127.0.0.1</span><span class=o>:</span><span class=mi>1023</span> <span class=nx>disabled</span> <span class=nx>weight</span> <span class=mi>1</span> <span class=nx>check</span> <span class=nx>inter</span> <span class=mi>2</span><span class=nx>s</span>

<span class=nx>配置关联内容</span>
<span class=err>/ # cat /etc/haproxy/maps/_global_http_front.map </span>
<span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>HAProxy</span> <span class=nx>Ingress</span> <span class=nx>Controller</span>
<span class=err>#</span> <span class=err>#</span>   <span class=o>--------------------------</span>
<span class=err>#</span> <span class=err>#</span>   <span class=nx>This</span> <span class=nx>file</span> <span class=nx>is</span> <span class=nx>automatically</span> <span class=nx>updated</span><span class=p>,</span> <span class=k>do</span> <span class=nx>not</span> <span class=nx>edit</span>
<span class=err>#</span> <span class=err>#</span>
<span class=err>#</span>
<span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span><span class=o>/</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=mi>1</span><span class=nx>_80</span>
<span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span><span class=o>/</span> <span class=nx>default_haproxy</span><span class=o>-</span><span class=mi>2</span><span class=nx>_80</span>
</code></pre></td></tr></table></div></div><h2 id=24-url自动跳转>2.4 URL自动跳转</h2><p>haproxy ingress支持自动跳转的能力，需要通过annotations定义，通过ingress.kubernetes.io/ssl-redirect设置即可，默认为false，设置为true即可实现http往https跳转的能力，当然可以将配置写入到ConfigMap中实现默认跳转的能力，本文以编写annotations为例，实现访问http跳转https的能力。</p><p>1、定义ingress规则，设置ingress.kubernetes.io/ssl-redirect实现跳转功能</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>haproxy</span> 
    <span class=nx>ingress</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ssl</span><span class=o>-</span><span class=nx>redirect</span><span class=o>:</span> <span class=kc>true</span>    <span class=err>#</span><span class=nx>实现跳转功能</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span> 
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>按照上图测试了一下功能，未能实现跳转实现跳转的功能，开源版本中未能找到更多文档说明，企业版由于镜像需要认证授权下载，未能进一步做测试验证。</p><h2 id=24-基于tls加密>2.4 基于TLS加密</h2><p>haproxy ingress默认集成了一个</p><p>1、生成自签名证书和私钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span>  <span class=nx>openssl</span> <span class=nx>req</span> <span class=o>-</span><span class=nx>x509</span> <span class=o>-</span><span class=nx>newkey</span> <span class=nx>rsa</span><span class=o>:</span><span class=mi>2048</span> <span class=o>-</span><span class=nx>nodes</span> <span class=o>-</span><span class=nx>days</span> <span class=mi>365</span> <span class=o>-</span><span class=nx>keyout</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>key</span> <span class=o>-</span><span class=nx>out</span> <span class=nx>tls</span><span class=p>.</span><span class=nx>crt</span>
<span class=nx>Generating</span> <span class=nx>a</span> <span class=mi>2048</span> <span class=nx>bit</span> <span class=nx>RSA</span> <span class=kr>private</span> <span class=nx>key</span>
<span class=p>...........</span><span class=o>+++</span>
<span class=p>.......</span><span class=o>+++</span>
<span class=nx>writing</span> <span class=k>new</span> <span class=kr>private</span> <span class=nx>key</span> <span class=nx>to</span> <span class=s1>&#39;tls.key&#39;</span>
<span class=o>-----</span>
<span class=nx>You</span> <span class=nx>are</span> <span class=nx>about</span> <span class=nx>to</span> <span class=nx>be</span> <span class=nx>asked</span> <span class=nx>to</span> <span class=nx>enter</span> <span class=nx>information</span> <span class=nx>that</span> <span class=nx>will</span> <span class=nx>be</span> <span class=nx>incorporated</span>
<span class=nx>into</span> <span class=nx>your</span> <span class=nx>certificate</span> <span class=nx>request</span><span class=p>.</span>
<span class=nx>What</span> <span class=nx>you</span> <span class=nx>are</span> <span class=nx>about</span> <span class=nx>to</span> <span class=nx>enter</span> <span class=nx>is</span> <span class=nx>what</span> <span class=nx>is</span> <span class=nx>called</span> <span class=nx>a</span> <span class=nx>Distinguished</span> <span class=nx>Name</span> <span class=nx>or</span> <span class=nx>a</span> <span class=nx>DN</span><span class=p>.</span>
<span class=nx>There</span> <span class=nx>are</span> <span class=nx>quite</span> <span class=nx>a</span> <span class=nx>few</span> <span class=nx>fields</span> <span class=nx>but</span> <span class=nx>you</span> <span class=nx>can</span> <span class=nx>leave</span> <span class=nx>some</span> <span class=nx>blank</span>
<span class=nx>For</span> <span class=nx>some</span> <span class=nx>fields</span> <span class=nx>there</span> <span class=nx>will</span> <span class=nx>be</span> <span class=nx>a</span> <span class=k>default</span> <span class=nx>value</span><span class=p>,</span>
<span class=nx>If</span> <span class=nx>you</span> <span class=nx>enter</span> <span class=s1>&#39;.&#39;</span><span class=p>,</span> <span class=nx>the</span> <span class=nx>field</span> <span class=nx>will</span> <span class=nx>be</span> <span class=nx>left</span> <span class=nx>blank</span><span class=p>.</span>
<span class=o>-----</span>
<span class=nx>Country</span> <span class=nx>Name</span> <span class=p>(</span><span class=mi>2</span> <span class=nx>letter</span> <span class=nx>code</span><span class=p>)</span> <span class=p>[</span><span class=nx>XX</span><span class=p>]</span><span class=o>:</span><span class=nx>CN</span>
<span class=nx>State</span> <span class=nx>or</span> <span class=nx>Province</span> <span class=nx>Name</span> <span class=p>(</span><span class=nx>full</span> <span class=nx>name</span><span class=p>)</span> <span class=p>[]</span><span class=o>:</span><span class=nx>GD</span>
<span class=nx>Locality</span> <span class=nx>Name</span> <span class=p>(</span><span class=nx>eg</span><span class=p>,</span> <span class=nx>city</span><span class=p>)</span> <span class=p>[</span><span class=nx>Default</span> <span class=nx>City</span><span class=p>]</span><span class=o>:</span><span class=nx>ShenZhen</span>
<span class=nx>Organization</span> <span class=nx>Name</span> <span class=p>(</span><span class=nx>eg</span><span class=p>,</span> <span class=nx>company</span><span class=p>)</span> <span class=p>[</span><span class=nx>Default</span> <span class=nx>Company</span> <span class=nx>Ltd</span><span class=p>]</span><span class=o>:</span><span class=nx>Tencent</span>
<span class=nx>Organizational</span> <span class=nx>Unit</span> <span class=nx>Name</span> <span class=p>(</span><span class=nx>eg</span><span class=p>,</span> <span class=nx>section</span><span class=p>)</span> <span class=p>[]</span><span class=o>:</span><span class=nx>HappyLau</span>
<span class=nx>Common</span> <span class=nx>Name</span> <span class=p>(</span><span class=nx>eg</span><span class=p>,</span> <span class=nx>your</span> <span class=nx>name</span> <span class=nx>or</span> <span class=nx>your</span> <span class=nx>server</span><span class=err>&#39;</span><span class=nx>s</span> <span class=nx>hostname</span><span class=p>)</span> <span class=p>[]</span><span class=o>:</span><span class=nx>www</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
<span class=nx>Email</span> <span class=nx>Address</span> <span class=p>[]</span><span class=o>:</span><span class=mi>573302346</span><span class=err>@</span><span class=nx>qq</span><span class=p>.</span><span class=nx>com</span>
</code></pre></td></tr></table></div></div><p>2、创建Secrets，关联证书和私钥</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>create</span> <span class=nx>secret</span> <span class=nx>tls</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span> <span class=o>--</span><span class=nx>cert</span><span class=o>=</span><span class=nx>tls</span><span class=p>.</span><span class=nx>crt</span> <span class=o>--</span><span class=nx>key</span><span class=o>=</span><span class=nx>tls</span><span class=p>.</span><span class=nx>key</span> 
<span class=nx>secret</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>secrets</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span> 
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>

<span class=nx>Type</span><span class=o>:</span>  <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>tls</span>

<span class=nx>Data</span>
<span class=o>====</span>
<span class=nx>tls</span><span class=p>.</span><span class=nx>crt</span><span class=o>:</span>  <span class=mi>1424</span> <span class=nx>bytes</span>
<span class=nx>tls</span><span class=p>.</span><span class=nx>key</span><span class=o>:</span>  <span class=mi>1704</span> <span class=nx>bytes</span>
</code></pre></td></tr></table></div></div><p>3、编写ingress规则，通过tls关联Secrets</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Ingress</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span> <span class=nx>haproxy</span> 
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>tls</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>hosts</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
    <span class=o>-</span> <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
    <span class=nx>secretName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span>
  <span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
  <span class=o>-</span> <span class=nx>host</span><span class=o>:</span> <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span> 
    <span class=nx>http</span><span class=o>:</span>
      <span class=nx>paths</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>path</span><span class=o>:</span> <span class=err>/</span>
        <span class=nx>backend</span><span class=o>:</span>
          <span class=nx>serviceName</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span>
          <span class=nx>servicePort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>4、应用配置并查看详情,在TLS中可以看到TLS关联的证书</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>ingress</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span> <span class=nx>configured</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>ingresses</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span> 
<span class=nx>Name</span><span class=o>:</span>             <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span><span class=o>-</span><span class=nx>virtualhost</span>
<span class=nx>Namespace</span><span class=o>:</span>        <span class=k>default</span>
<span class=nx>Address</span><span class=o>:</span>          
<span class=nx>Default</span> <span class=nx>backend</span><span class=o>:</span>  <span class=k>default</span><span class=o>-</span><span class=nx>http</span><span class=o>-</span><span class=nx>backend</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span><span class=p>)</span>
<span class=nx>TLS</span><span class=o>:</span>
  <span class=nx>haproxy</span><span class=o>-</span><span class=nx>tls</span> <span class=nx>terminates</span> <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span><span class=p>,</span><span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>
<span class=nx>Rules</span><span class=o>:</span>
  <span class=nx>Host</span>                <span class=nx>Path</span>  <span class=nx>Backends</span>
  <span class=o>----</span>                <span class=o>----</span>  <span class=o>--------</span>
  <span class=nx>news</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>    
                      <span class=o>/</span>   <span class=nx>haproxy</span><span class=o>-</span><span class=mi>1</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=mf>10.244.2.168</span><span class=o>:</span><span class=mi>80</span><span class=p>)</span>
  <span class=nx>sports</span><span class=p>.</span><span class=nx>happylau</span><span class=p>.</span><span class=nx>cn</span>  
                      <span class=o>/</span>   <span class=nx>haproxy</span><span class=o>-</span><span class=mi>2</span><span class=o>:</span><span class=mi>80</span> <span class=p>(</span><span class=mf>10.244.2.169</span><span class=o>:</span><span class=mi>80</span><span class=p>)</span>
<span class=nx>Annotations</span><span class=o>:</span>
  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>  <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;extensions/v1beta1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Ingress&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/ingress.class&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-ingress-virtualhost&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;rules&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;host&#34;</span><span class=o>:</span><span class=s2>&#34;news.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;http&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;paths&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;backend&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;serviceName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-1&#34;</span><span class=p>,</span><span class=s2>&#34;servicePort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>},</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/&#34;</span><span class=p>}]}},{</span><span class=s2>&#34;host&#34;</span><span class=o>:</span><span class=s2>&#34;sports.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;http&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;paths&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;backend&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;serviceName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-2&#34;</span><span class=p>,</span><span class=s2>&#34;servicePort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>},</span><span class=s2>&#34;path&#34;</span><span class=o>:</span><span class=s2>&#34;/&#34;</span><span class=p>}]}}],</span><span class=s2>&#34;tls&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;hosts&#34;</span><span class=o>:</span><span class=p>[</span><span class=s2>&#34;news.happylau.cn&#34;</span><span class=p>,</span><span class=s2>&#34;sports.happylau.cn&#34;</span><span class=p>],</span><span class=s2>&#34;secretName&#34;</span><span class=o>:</span><span class=s2>&#34;haproxy-tls&#34;</span><span class=p>}]}}</span>

  <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ingress</span><span class=p>.</span><span class=kr>class</span><span class=o>:</span>  <span class=nx>haproxy</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>  <span class=nx>Age</span>               <span class=nx>From</span>                <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>  <span class=o>----</span>              <span class=o>----</span>                <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>37</span><span class=nx>m</span>               <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>CREATE</span>  <span class=mi>37</span><span class=nx>m</span>               <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>7</span><span class=nx>s</span> <span class=p>(</span><span class=nx>x2</span> <span class=nx>over</span> <span class=mi>37</span><span class=nx>m</span><span class=p>)</span>  <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
  <span class=nx>Normal</span>  <span class=nx>UPDATE</span>  <span class=mi>7</span><span class=nx>s</span> <span class=p>(</span><span class=nx>x2</span> <span class=nx>over</span> <span class=mi>37</span><span class=nx>m</span><span class=p>)</span>  <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Ingress</span> <span class=k>default</span><span class=err>/haproxy-ingress-virtualhost</span>
</code></pre></td></tr></table></div></div><p>5、测试https站点访问，可以看到安全的https访问</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/4%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/4%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/4%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%8D%81%E4%B8%83%29%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/4%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%8D%81%E4%B8%83)%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/4%20-%201620.jpg title="haproxy ingress https测试"></p><h1 id=写在最后>写在最后</h1><p>haproxy实现ingress实际是通过配置更新haproxy.cfg配置，结合service的服务发现机制动态完成ingress接入，相比于nginx来说，haproxy不需要重载实现配置变更。在测试haproxy ingress过程中，有部分功能配置验证没有达到预期，更丰富的功能支持在haproxy ingress企业版中支持，社区版能支持蓝绿发布和WAF安全扫描功能，详情可以参考社区文档<a href=https://haproxy-ingress.github.io/docs/examples/blue-green/ target=_blank rel="noopener noreffer">haproxy蓝绿发布</a>和<a href=https://haproxy-ingress.github.io/docs/examples/modsecurity/ target=_blank rel="noopener noreffer">WAF安全支持</a>。</p><p>haproxy ingress控制器目前在社区活跃度一般，相比于nginx，traefik，istio还有一定的差距，实际环境中不建议使用社区版的haproxy ingress。</p><h1 id=参考文档><strong>参考文档</strong></h1><p>官方安装文档：https://haproxy-ingress.github.io/docs/getting-started/</p><p>haproxy ingress官方配置：https://www.haproxy.com/documentation/hapee/1-7r2/traffic-management/k8s-image-controller/</p><hr><p><strong>当你的才华撑不起你的野心时，你就应该静下心来学习</strong></p><p><strong>返回</strong><a href rel><strong>kubernetes系列教程目录</strong></a></p><p><strong>如果觉得文章对您有帮助，请订阅专栏，分享给有需要的朋友吧😊</strong></p><blockquote><p>关于作者 刘海平（HappyLau ）云计算高级顾问 目前在腾讯云从事公有云相关工作，曾就职于酷狗，EasyStack，拥有多年公有云+私有云计算架构设计，运维，交付相关经验，参与了酷狗，南方电网，国泰君安等大型私有云平台建设，精通Linux，Kubernetes，OpenStack，Ceph等开源技术，在云计算领域具有丰富实战经验，拥有RHCA/OpenStack/Linux授课经验。</p></blockquote><h1 id=附录>附录</h1><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=err>#</span><span class=nx>RBAC认证账号</span><span class=err>，</span><span class=nx>和角色关联</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ServiceAccount</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=o>---</span>
<span class=err>#</span> <span class=nx>集群角色</span><span class=err>，</span><span class=nx>访问资源对象和具体访问权限</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ClusterRole</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>configmaps</span>
      <span class=o>-</span> <span class=nx>endpoints</span>
      <span class=o>-</span> <span class=nx>nodes</span>
      <span class=o>-</span> <span class=nx>pods</span>
      <span class=o>-</span> <span class=nx>secrets</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>list</span>
      <span class=o>-</span> <span class=nx>watch</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>nodes</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>services</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
      <span class=o>-</span> <span class=nx>list</span>
      <span class=o>-</span> <span class=nx>watch</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;extensions&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>ingresses</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
      <span class=o>-</span> <span class=nx>list</span>
      <span class=o>-</span> <span class=nx>watch</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>events</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>create</span>
      <span class=o>-</span> <span class=nx>patch</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;extensions&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>ingresses</span><span class=o>/</span><span class=nx>status</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>update</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>角色定义</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Role</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>rules</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>configmaps</span>
      <span class=o>-</span> <span class=nx>pods</span>
      <span class=o>-</span> <span class=nx>secrets</span>
      <span class=o>-</span> <span class=nx>namespaces</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>configmaps</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
      <span class=o>-</span> <span class=nx>update</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>configmaps</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>create</span>
  <span class=o>-</span> <span class=nx>apiGroups</span><span class=o>:</span>
      <span class=o>-</span> <span class=s2>&#34;&#34;</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>endpoints</span>
    <span class=nx>verbs</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>get</span>
      <span class=o>-</span> <span class=nx>create</span>
      <span class=o>-</span> <span class=nx>update</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>集群角色绑定ServiceAccount和ClusterRole关联</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ClusterRoleBinding</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>roleRef</span><span class=o>:</span>
  <span class=nx>apiGroup</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span>
  <span class=nx>kind</span><span class=o>:</span> <span class=nx>ClusterRole</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>subjects</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>kind</span><span class=o>:</span> <span class=nx>ServiceAccount</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
    <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=o>-</span> <span class=nx>apiGroup</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span>
    <span class=nx>kind</span><span class=o>:</span> <span class=nx>User</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>角色绑定</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>RoleBinding</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>roleRef</span><span class=o>:</span>
  <span class=nx>apiGroup</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span>
  <span class=nx>kind</span><span class=o>:</span> <span class=nx>Role</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>subjects</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>kind</span><span class=o>:</span> <span class=nx>ServiceAccount</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
    <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
  <span class=o>-</span> <span class=nx>apiGroup</span><span class=o>:</span> <span class=nx>rbac</span><span class=p>.</span><span class=nx>authorization</span><span class=p>.</span><span class=nx>k8s</span><span class=p>.</span><span class=nx>io</span>
    <span class=nx>kind</span><span class=o>:</span> <span class=nx>User</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>后端服务应用</span><span class=err>，</span><span class=nx>haproxy</span> <span class=nx>ingress默认需要一个关联的应用</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>run</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>run</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>gcr</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>google_containers</span><span class=o>/</span><span class=nx>defaultbackend</span><span class=o>:</span><span class=mf>1.0</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>8080</span>
        <span class=nx>resources</span><span class=o>:</span>
          <span class=nx>limits</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>10</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>20</span><span class=nx>Mi</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>后端应用的service定义</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Service</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>ports</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>port</span><span class=o>:</span> <span class=mi>8080</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>haproxy</span> <span class=nx>ingress配置</span><span class=err>，</span><span class=nx>实现自定义配置功能</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ConfigMap</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>

<span class=o>---</span>
<span class=err>#</span><span class=nx>haproxy</span> <span class=nx>ingress核心的DaemonSet</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>DaemonSet</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>updateStrategy</span><span class=o>:</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>RollingUpdate</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>run</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>run</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>hostNetwork</span><span class=o>:</span> <span class=kc>true</span>         <span class=err>#</span><span class=nx>网络模式为hostNetwork</span><span class=p>,</span><span class=nx>即使用宿主机的网络</span>
      <span class=nx>nodeSelector</span><span class=o>:</span>               <span class=err>#</span><span class=nx>节点选择器</span><span class=err>，</span><span class=nx>将调度至包含特定标签的节点</span>
        <span class=nx>role</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>
      <span class=nx>serviceAccountName</span><span class=o>:</span> <span class=nx>ingress</span><span class=o>-</span><span class=nx>controller</span>    <span class=err>#</span><span class=nx>实现RBAC认证授权</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>quay</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>jcmoraisjr</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
        <span class=nx>args</span><span class=o>:</span>
        <span class=o>-</span> <span class=o>--</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span><span class=o>-</span><span class=nx>service</span><span class=o>=</span><span class=nx>$</span><span class=p>(</span><span class=nx>POD_NAMESPACE</span><span class=p>)</span><span class=o>/</span><span class=nx>ingress</span><span class=o>-</span><span class=k>default</span><span class=o>-</span><span class=nx>backend</span>
        <span class=o>-</span> <span class=o>--</span><span class=nx>configmap</span><span class=o>=</span><span class=nx>$</span><span class=p>(</span><span class=nx>POD_NAMESPACE</span><span class=p>)</span><span class=o>/</span><span class=nx>haproxy</span><span class=o>-</span><span class=nx>ingress</span>
        <span class=o>-</span> <span class=o>--</span><span class=nx>sort</span><span class=o>-</span><span class=nx>backends</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>http</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>https</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>443</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>stat</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>1936</span>
        <span class=nx>livenessProbe</span><span class=o>:</span>
          <span class=nx>httpGet</span><span class=o>:</span>
            <span class=nx>path</span><span class=o>:</span> <span class=err>/healthz</span>
            <span class=nx>port</span><span class=o>:</span> <span class=mi>10253</span>
        <span class=nx>env</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>POD_NAME</span>
          <span class=nx>valueFrom</span><span class=o>:</span>
            <span class=nx>fieldRef</span><span class=o>:</span>
              <span class=nx>fieldPath</span><span class=o>:</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>name</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>POD_NAMESPACE</span>
          <span class=nx>valueFrom</span><span class=o>:</span>
            <span class=nx>fieldRef</span><span class=o>:</span>
              <span class=nx>fieldPath</span><span class=o>:</span> <span class=nx>metadata</span><span class=p>.</span><span class=nx>namespace</span>
</code></pre></td></tr></table></div></div><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-08-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ data-title="16 基于haproxy实现ingress服务暴露" data-hashtags=kubernetes,tutorial><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ data-title="16 基于haproxy实现ingress服务暴露"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ data-title="16 基于haproxy实现ingress服务暴露"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://x.agou-ops.top/16-%E5%9F%BA%E4%BA%8Ehaproxy%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ data-title="16 基于haproxy实现ingress服务暴露" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/tutorial/>tutorial</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/17-%E4%BD%BF%E7%94%A8metric-server%E8%AE%A9hpa%E5%BC%B9%E6%80%A7%E4%BC%B8%E7%BC%A9%E6%84%89%E5%BF%AB%E8%BF%90%E8%A1%8C/ class=prev rel=prev title="17 使用metric Server让HPA弹性伸缩愉快运行"><i class="fas fa-angle-left fa-fw"></i>17 使用metric Server让HPA弹性伸缩愉快运行</a>
<a href=/15-tke%E4%B8%AD%E5%AE%9E%E7%8E%B0ingress%E6%9C%8D%E5%8A%A1%E6%9A%B4%E9%9C%B2/ class=next rel=next title="15 TKE中实现ingress服务暴露">15 TKE中实现ingress服务暴露<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.69.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>鲁ICP备19050296号-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>