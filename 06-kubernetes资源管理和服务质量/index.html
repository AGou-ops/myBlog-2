<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>06 Kubernetes资源管理和服务质量 - AGou's Blog-2</title><meta name=Description content="关于博主"><meta property="og:title" content="06 Kubernetes资源管理和服务质量"><meta property="og:description" content="写在前面 上一篇文章中kubernetes系列教程（五）深入掌握核心概念pod初步介绍了yaml学习kubernetes中重要的一个概念pod"><meta property="og:type" content="article"><meta property="og:url" content="http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2019-08-04T10:36:47+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:47+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="06 Kubernetes资源管理和服务质量"><meta name=twitter:description content="写在前面 上一篇文章中kubernetes系列教程（五）深入掌握核心概念pod初步介绍了yaml学习kubernetes中重要的一个概念pod"><meta name=application-name content="AGou's Blog-2."><meta name=apple-mobile-web-app-title content="AGou's Blog-2."><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/><link rel=prev href=http://x.agou-ops.top/07-%E6%B7%B1%E5%85%A5%E7%8E%A9%E8%BD%ACpod%E8%B0%83%E5%BA%A6/><link rel=next href=http://x.agou-ops.top/05-%E5%88%9D%E8%AF%86%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5pod/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"06 Kubernetes资源管理和服务质量","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/x.agou-ops.top\/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"kubernetes","wordcount":6208,"url":"http:\/\/x.agou-ops.top\/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F\/","datePublished":"2019-08-04T10:36:47+08:00","dateModified":"2019-08-04T10:36:47+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/anime/>Anime </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>所有文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/anime/>Anime</a><a class=menu-item href=/about/>关于</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">06 Kubernetes资源管理和服务质量</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%BD%AC%E8%BD%BD/><i class="far fa-folder fa-fw"></i>转载</a>&nbsp;<a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a>&nbsp;<a href=/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><i class="far fa-folder fa-fw"></i>基础教程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-08-04>2019-08-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6208 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#11-resource定义>1.1 resource定义</a></li><li><a href=#12-资源分配原理>1.2 资源分配原理</a></li><li><a href=#13-cpu资源测试>1.3. cpu资源测试</a></li><li><a href=#14-memory资源测试>1.4 memory资源测试</a></li></ul><ul><li><a href=#21-besteffort最大努力>2.1 BestEffort最大努力</a></li><li><a href=#22-burstable可波动>2.2 Burstable可波动</a></li><li><a href=#23-guaranteed完全保障>2.3 Guaranteed完全保障</a></li></ul></nav></div></div><div class=content id=content><h1 id=写在前面>写在前面</h1><p>上一篇文章中<a href=# rel>kubernetes系列教程（五）深入掌握核心概念pod</a>初步介绍了yaml学习kubernetes中重要的一个概念pod，接下来介绍<a href=# rel>kubernetes系列教程</a>pod的resource资源管理和pod的Quality of service服务质量。</p><h1 id=1-pod资源管理>1. Pod资源管理</h1><h2 id=11-resource定义>1.1 resource定义</h2><p>容器运行过程中需要分配所需的资源，如何与cggroup联动配合呢？答案是通过定义resource来实现资源的分配，资源的分配单位主要是cpu和memory，资源的定义分两种：requests和limits，requests表示请求资源，主要用于初始kubernetes调度pod时的依据，表示必须满足的分配资源;limits表示资源的限制，即pod不能超过limits定义的限制大小，超过则通过cggroup限制，pod中定义资源可以通过下面四个字段定义：</p><ul><li>spec.container[].resources.requests.cpu 请求cpu资源的大小，如0.1个cpu和100m表示分配1/10个cpu；</li><li>spec.container[].resources.requests.memory 请求内存大小，单位可用M，Mi，G，Gi表示；</li><li>spec.container[].resources.limits.cpu 限制cpu的大小，不能超过阀值，cggroup中限制的值；</li><li>spec.container[].resources.limits.memory 限制内存的大小，不能超过阀值，超过会发生OOM；</li></ul><p>1、开始学习如何定义pod的resource资源,如下以定义nginx-demo为例，容器请求cpu资源为250m，限制为500m，请求内存资源为128Mi，限制内存资源为256Mi，当然也可以定义多个容器的资源，多个容器相加就是pod的资源总资源，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span><span class=nx>cat</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>resource</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
    <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>port</span><span class=o>-</span><span class=mi>80</span>
      <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mf>0.25</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>128</span><span class=nx>Mi</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>500</span><span class=nx>m</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>256</span><span class=nx>Mi</span>
</code></pre></td></tr></table></div></div><p>2、应用pod的配置定义(如之前的pod还存在，先将其删除kubectl delete pod <pod-name>),或pod命名为另外一个名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>resource</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>3、查看pod资源的分配详情</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span>
<span class=nx>NAME</span>                    <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>b86696648</span><span class=o>-</span><span class=mi>8</span><span class=nx>bq7h</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>12</span><span class=nx>d</span>
<span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>b86696648</span><span class=o>-</span><span class=mi>8</span><span class=nx>qp46</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>12</span><span class=nx>d</span>
<span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>b86696648</span><span class=o>-</span><span class=nx>d6hfw</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>12</span><span class=nx>d</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>              <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>94</span><span class=nx>s</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>  
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>     <span class=mi>0</span>
<span class=nx>Node</span><span class=o>:</span>         <span class=nx>node</span><span class=o>-</span><span class=mi>3</span><span class=o>/</span><span class=mf>10.254.100.103</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>12</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=mi>49</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=nx>name</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-demo&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-demo&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=err>&#34;</span><span class=nx>sp</span><span class=p>...</span>
<span class=nx>Status</span><span class=o>:</span>       <span class=nx>Running</span>
<span class=nx>IP</span><span class=o>:</span>           <span class=mf>10.244.2.13</span>
<span class=nx>Containers</span><span class=o>:</span>
  <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Container</span> <span class=nx>ID</span><span class=o>:</span>   <span class=nx>docker</span><span class=o>:</span><span class=c1>//55d28fdc992331c5c58a51154cd072cd6ae37e03e05ae829a97129f85eb5ed79
</span><span class=c1></span>    <span class=nx>Image</span><span class=o>:</span>          <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>Image</span> <span class=nx>ID</span><span class=o>:</span>       <span class=nx>docker</span><span class=o>-</span><span class=nx>pullable</span><span class=o>:</span><span class=c1>//nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
</span><span class=c1></span>    <span class=nx>Port</span><span class=o>:</span>           <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>      <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>State</span><span class=o>:</span>          <span class=nx>Running</span>
      <span class=nx>Started</span><span class=o>:</span>      <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>12</span><span class=o>:</span><span class=mi>10</span><span class=o>:</span><span class=mi>51</span> <span class=o>+</span><span class=mi>0800</span>
    <span class=nx>Ready</span><span class=o>:</span>          <span class=nx>True</span>
    <span class=nx>Restart</span> <span class=nx>Count</span><span class=o>:</span>  <span class=mi>0</span>
    <span class=nx>Limits</span><span class=o>:</span>        <span class=err>#</span><span class=nx>限制资源</span>
      <span class=nx>cpu</span><span class=o>:</span>     <span class=mi>500</span><span class=nx>m</span>
      <span class=nx>memory</span><span class=o>:</span>  <span class=mi>256</span><span class=nx>Mi</span>
    <span class=nx>Requests</span><span class=o>:</span>      <span class=err>#</span><span class=nx>请求资源</span>
      <span class=nx>cpu</span><span class=o>:</span>        <span class=mi>250</span><span class=nx>m</span>
      <span class=nx>memory</span><span class=o>:</span>     <span class=mi>128</span><span class=nx>Mi</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=p>...</span><span class=nx>省略</span><span class=p>...</span>
</code></pre></td></tr></table></div></div><p>4、Pod的资源如何分配呢？毫无疑问是从node上分配的，当我们创建一个pod的时候如果设置了requests，kubernetes的调度器kube-scheduler会执行两个调度过程：filter过滤和weight称重，kube-scheduler会根据请求的资源过滤，把符合条件的node筛选出来，然后再进行排序，把最满足运行pod的node筛选出来，然后再特定的node上运行pod。调度算法和细节可以参考下<a href="https://my.oschina.net/u/1378920/blog/1550452?spm=a2c4e.10696291.0.0.57b419a4kAHXRs" target=_blank rel="noopener noreffer">kubernetes调度算法介绍</a>。如下是node-3节点资源的分配详情：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>node</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
<span class=p>...</span><span class=nx>省略</span><span class=p>...</span>
<span class=nx>Capacity</span><span class=o>:</span>    <span class=err>#</span><span class=nx>节点上资源的总资源情况</span><span class=err>，</span><span class=mi>1</span><span class=nx>个cpu</span><span class=err>，</span><span class=mi>2</span><span class=nx>g内存</span><span class=err>，</span><span class=mi>110</span><span class=nx>个pod</span>
 <span class=nx>cpu</span><span class=o>:</span>                <span class=mi>1</span>
 <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span><span class=o>:</span>  <span class=mi>51473888</span><span class=nx>Ki</span>
 <span class=nx>hugepages</span><span class=o>-</span><span class=mi>2</span><span class=nx>Mi</span><span class=o>:</span>      <span class=mi>0</span>
 <span class=nx>memory</span><span class=o>:</span>             <span class=mi>1882352</span><span class=nx>Ki</span>
 <span class=nx>pods</span><span class=o>:</span>               <span class=mi>110</span>
<span class=nx>Allocatable</span><span class=o>:</span> <span class=err>#</span><span class=nx>节点容许分配的资源情况</span><span class=err>，</span><span class=nx>部分预留的资源会排出在Allocatable范畴</span>
 <span class=nx>cpu</span><span class=o>:</span>                <span class=mi>1</span>
 <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span><span class=o>:</span>  <span class=mi>47438335103</span>
 <span class=nx>hugepages</span><span class=o>-</span><span class=mi>2</span><span class=nx>Mi</span><span class=o>:</span>      <span class=mi>0</span>
 <span class=nx>memory</span><span class=o>:</span>             <span class=mi>1779952</span><span class=nx>Ki</span>
 <span class=nx>pods</span><span class=o>:</span>               <span class=mi>110</span>
<span class=nx>System</span> <span class=nx>Info</span><span class=o>:</span>
 <span class=nx>Machine</span> <span class=nx>ID</span><span class=o>:</span>                 <span class=mi>0</span><span class=nx>ea734564f9a4e2881b866b82d679dfc</span>
 <span class=nx>System</span> <span class=nx>UUID</span><span class=o>:</span>                <span class=nx>FFCD2939</span><span class=o>-</span><span class=mi>1</span><span class=nx>BF2</span><span class=o>-</span><span class=mi>4200</span><span class=o>-</span><span class=nx>B4FD</span><span class=o>-</span><span class=mi>8822</span><span class=nx>EBFFF904</span>
 <span class=nx>Boot</span> <span class=nx>ID</span><span class=o>:</span>                    <span class=mi>293</span><span class=nx>f49fd</span><span class=o>-</span><span class=mi>8</span><span class=nx>a7c</span><span class=o>-</span><span class=mi>49</span><span class=nx>e2</span><span class=o>-</span><span class=mi>8945</span><span class=o>-</span><span class=mi>7</span><span class=nx>a4addbd88ca</span>
 <span class=nx>Kernel</span> <span class=nx>Version</span><span class=o>:</span>             <span class=mf>3.10.0</span><span class=o>-</span><span class=mf>957.21.3</span><span class=p>.</span><span class=nx>el7</span><span class=p>.</span><span class=nx>x86_64</span>
 <span class=nx>OS</span> <span class=nx>Image</span><span class=o>:</span>                   <span class=nx>CentOS</span> <span class=nx>Linux</span> <span class=mi>7</span> <span class=p>(</span><span class=nx>Core</span><span class=p>)</span>
 <span class=nx>Operating</span> <span class=nx>System</span><span class=o>:</span>           <span class=nx>linux</span>
 <span class=nx>Architecture</span><span class=o>:</span>               <span class=nx>amd64</span>
 <span class=nx>Container</span> <span class=nx>Runtime</span> <span class=nx>Version</span><span class=o>:</span>  <span class=nx>docker</span><span class=o>:</span><span class=c1>//18.6.3
</span><span class=c1></span> <span class=nx>Kubelet</span> <span class=nx>Version</span><span class=o>:</span>            <span class=nx>v1</span><span class=mf>.15.3</span>
 <span class=nx>Kube</span><span class=o>-</span><span class=nb>Proxy</span> <span class=nx>Version</span><span class=o>:</span>         <span class=nx>v1</span><span class=mf>.15.3</span>
<span class=nx>PodCIDR</span><span class=o>:</span>                     <span class=mf>10.244.2.0</span><span class=o>/</span><span class=mi>24</span>
<span class=nx>Non</span><span class=o>-</span><span class=nx>terminated</span> <span class=nx>Pods</span><span class=o>:</span>         <span class=p>(</span><span class=mi>3</span> <span class=k>in</span> <span class=nx>total</span><span class=p>)</span> <span class=err>#</span><span class=nx>节点上运行pod的资源的情况</span><span class=err>，</span><span class=nx>除了nginx</span><span class=o>-</span><span class=nx>demo之外还有多个pod</span>
  <span class=nx>Namespace</span>                  <span class=nx>Name</span>                           <span class=nx>CPU</span> <span class=nx>Requests</span>  <span class=nx>CPU</span> <span class=nx>Limits</span>  <span class=nx>Memory</span> <span class=nx>Requests</span>  <span class=nx>Memory</span> <span class=nx>Limits</span>  <span class=nx>AGE</span>
  <span class=o>---------</span>                  <span class=o>----</span>                           <span class=o>------------</span>  <span class=o>----------</span>  <span class=o>---------------</span>  <span class=o>-------------</span>  <span class=o>---</span>
  <span class=k>default</span>                    <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>                     <span class=mi>250</span><span class=nx>m</span> <span class=p>(</span><span class=mi>25</span><span class=o>%</span><span class=p>)</span>    <span class=mi>500</span><span class=nx>m</span> <span class=p>(</span><span class=mi>50</span><span class=o>%</span><span class=p>)</span>  <span class=mi>128</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>7</span><span class=o>%</span><span class=p>)</span>       <span class=mi>256</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>14</span><span class=o>%</span><span class=p>)</span>    <span class=mi>63</span><span class=nx>m</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>kube</span><span class=o>-</span><span class=nx>flannel</span><span class=o>-</span><span class=nx>ds</span><span class=o>-</span><span class=nx>amd64</span><span class=o>-</span><span class=nx>jp594</span>    <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>10</span><span class=o>%</span><span class=p>)</span>    <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>10</span><span class=o>%</span><span class=p>)</span>  <span class=mi>50</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>2</span><span class=o>%</span><span class=p>)</span>        <span class=mi>50</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>2</span><span class=o>%</span><span class=p>)</span>      <span class=mi>14</span><span class=nx>d</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span><span class=o>-</span><span class=nx>mh2gq</span>               <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>        <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>      <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>           <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>         <span class=mi>12</span><span class=nx>d</span>
<span class=nx>Allocated</span> <span class=nx>resources</span><span class=o>:</span>  <span class=err>#</span><span class=nx>已经分配的cpu和memory的资源情况</span>
  <span class=p>(</span><span class=nx>Total</span> <span class=nx>limits</span> <span class=nx>may</span> <span class=nx>be</span> <span class=nx>over</span> <span class=mi>100</span> <span class=nx>percent</span><span class=p>,</span> <span class=nx>i</span><span class=p>.</span><span class=nx>e</span><span class=p>.,</span> <span class=nx>overcommitted</span><span class=p>.)</span>
  <span class=nx>Resource</span>           <span class=nx>Requests</span>     <span class=nx>Limits</span>
  <span class=o>--------</span>           <span class=o>--------</span>     <span class=o>------</span>
  <span class=nx>cpu</span>                <span class=mi>350</span><span class=nx>m</span> <span class=p>(</span><span class=mi>35</span><span class=o>%</span><span class=p>)</span>   <span class=mi>600</span><span class=nx>m</span> <span class=p>(</span><span class=mi>60</span><span class=o>%</span><span class=p>)</span>
  <span class=nx>memory</span>             <span class=mi>178</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>10</span><span class=o>%</span><span class=p>)</span>  <span class=mi>306</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>17</span><span class=o>%</span><span class=p>)</span>
  <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span>  <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>       <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>
<span class=nx>Events</span><span class=o>:</span>              <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><h2 id=12-资源分配原理>1.2 资源分配原理</h2><p>Pod的定义的资源requests和limits作用于kubernetes的调度器kube-sheduler上，实际上cpu和内存定义的资源会应用在container上，通过容器上的cggroup实现资源的隔离作用，接下来我们介绍下资源分配的原理。</p><ul><li>spec.containers[].resources.requests.cpu 作用在CpuShares，表示分配cpu 的权重，争抢时的分配比例</li><li>spec.containers[].resources.requests.memory 主要用于kube-scheduler调度器，对容器没有设置意义</li><li>spec.containers[].resources.limits.cpu 作用CpuQuota和CpuPeriod，单位为微秒，计算方法为：CpuQuota/CpuPeriod，表示最大cpu最大可使用的百分比，如500m表示允许使用1个cpu中的50%资源</li><li>spec.containers[].resources.limits.memory 作用在Memory，表示容器最大可用内存大小，超过则会OOM</li></ul><p>以上面定义的nginx-demo为例，研究下pod中定义的requests和limits应用在docker生效的参数：</p><p>1、查看pod所在的node节点，nginx-demo调度到node-3节点上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>NAME</span>         <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>   <span class=nx>IP</span>            <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>96</span><span class=nx>m</span>   <span class=mf>10.244.2.13</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>2、获取容器的id号，可以通过kubectl describe pods nginx-demo的containerID获取到容器的id，或者登陆到node-3节点通过名称过滤获取到容器的id号，默认会有两个pod：一个通过pause镜像创建，另外一个通过应用镜像创建</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>docker</span> <span class=nx>container</span>  <span class=nx>list</span> <span class=o>|</span><span class=nx>grep</span> <span class=nx>nginx</span>
<span class=mi>55</span><span class=nx>d28fdc9923</span>        <span class=mi>84581</span><span class=nx>e99d807</span>           <span class=s2>&#34;nginx -g &#39;daemon of…&#34;</span>   <span class=mi>2</span> <span class=nx>hours</span> <span class=nx>ago</span>         <span class=nx>Up</span> <span class=mi>2</span> <span class=nx>hours</span>                                   <span class=nx>k8s_nginx</span><span class=o>-</span><span class=nx>demonginx</span><span class=o>-</span><span class=nx>demo_default_66958ef7</span><span class=o>-</span><span class=mi>507</span><span class=nx>a</span><span class=o>-</span><span class=mi>41</span><span class=nx>cd</span><span class=o>-</span><span class=nx>a688</span><span class=o>-</span><span class=mi>7</span><span class=nx>a4976c6a71e_0</span>
<span class=mi>2</span><span class=nx>fe0498ea9b5</span>        <span class=nx>k8s</span><span class=p>.</span><span class=nx>gcr</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>pause</span><span class=o>:</span><span class=mf>3.1</span>   <span class=s2>&#34;/pause&#34;</span>                 <span class=mi>2</span> <span class=nx>hours</span> <span class=nx>ago</span>         <span class=nx>Up</span> <span class=mi>2</span> <span class=nx>hours</span>                                   <span class=nx>k8s_POD_nginx</span><span class=o>-</span><span class=nx>demo_default_66958ef7</span><span class=o>-</span><span class=mi>507</span><span class=nx>a</span><span class=o>-</span><span class=mi>41</span><span class=nx>cd</span><span class=o>-</span><span class=nx>a688</span><span class=o>-</span><span class=mi>7</span><span class=nx>a4976c6a71e_0</span>
</code></pre></td></tr></table></div></div><p>3、查看docker容器详情信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>docker</span> <span class=nx>container</span> <span class=nx>inspect</span> <span class=mi>55</span><span class=nx>d28fdc9923</span>
<span class=p>[</span>
<span class=p>...</span><span class=nx>部分输出省略</span><span class=p>...</span>
    <span class=p>{</span>
        <span class=s2>&#34;Image&#34;</span><span class=o>:</span> <span class=s2>&#34;sha256:84581e99d807a703c9c03bd1a31cd9621815155ac72a7365fd02311264512656&#34;</span><span class=p>,</span>
        <span class=s2>&#34;ResolvConfPath&#34;</span><span class=o>:</span> <span class=s2>&#34;/var/lib/docker/containers/2fe0498ea9b5dfe1eb63eba09b1598a8dfd60ef046562525da4dcf7903a25250/resolv.conf&#34;</span><span class=p>,</span>
        <span class=s2>&#34;HostConfig&#34;</span><span class=o>:</span> <span class=p>{</span>
            <span class=s2>&#34;Binds&#34;</span><span class=o>:</span> <span class=p>[</span>
                <span class=s2>&#34;/var/lib/kubelet/pods/66958ef7-507a-41cd-a688-7a4976c6a71e/volumes/kubernetes.io~secret/default-token-5qwmc:/var/run/secrets/kubernetes.io/serviceaccount:ro&#34;</span><span class=p>,</span>
                <span class=s2>&#34;/var/lib/kubelet/pods/66958ef7-507a-41cd-a688-7a4976c6a71e/etc-hosts:/etc/hosts&#34;</span><span class=p>,</span>
                <span class=s2>&#34;/var/lib/kubelet/pods/66958ef7-507a-41cd-a688-7a4976c6a71e/containers/nginx-demo/1cc072ca:/dev/termination-log&#34;</span>
            <span class=p>],</span>
            <span class=s2>&#34;ContainerIDFile&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;LogConfig&#34;</span><span class=o>:</span> <span class=p>{</span>
                <span class=s2>&#34;Type&#34;</span><span class=o>:</span> <span class=s2>&#34;json-file&#34;</span><span class=p>,</span>
                <span class=s2>&#34;Config&#34;</span><span class=o>:</span> <span class=p>{</span>
                    <span class=s2>&#34;max-size&#34;</span><span class=o>:</span> <span class=s2>&#34;100m&#34;</span>
                <span class=p>}</span>
            <span class=p>},</span>
            <span class=s2>&#34;UTSMode&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;UsernsMode&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;ShmSize&#34;</span><span class=o>:</span> <span class=mi>67108864</span><span class=p>,</span>
            <span class=s2>&#34;Runtime&#34;</span><span class=o>:</span> <span class=s2>&#34;runc&#34;</span><span class=p>,</span>
            <span class=s2>&#34;ConsoleSize&#34;</span><span class=o>:</span> <span class=p>[</span>
                <span class=mi>0</span><span class=p>,</span>
                <span class=mi>0</span>
            <span class=p>],</span>
            <span class=s2>&#34;Isolation&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;CpuShares&#34;</span><span class=o>:</span> <span class=mi>256</span><span class=p>,</span>        <span class=nx>CPU分配的权重</span><span class=err>，</span><span class=nx>作用在requests</span><span class=p>.</span><span class=nx>cpu上</span>
            <span class=s2>&#34;Memory&#34;</span><span class=o>:</span> <span class=mi>268435456</span><span class=p>,</span>     <span class=nx>内存分配的大小</span><span class=err>，</span><span class=nx>作用在limits</span><span class=p>.</span><span class=nx>memory上</span>
            <span class=s2>&#34;NanoCpus&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;CgroupParent&#34;</span><span class=o>:</span> <span class=s2>&#34;kubepods-burstable-pod66958ef7_507a_41cd_a688_7a4976c6a71e.slice&#34;</span><span class=p>,</span>
            <span class=s2>&#34;BlkioWeight&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;BlkioWeightDevice&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;BlkioDeviceReadBps&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;BlkioDeviceWriteBps&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;BlkioDeviceReadIOps&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;BlkioDeviceWriteIOps&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;CpuPeriod&#34;</span><span class=o>:</span> <span class=mi>100000</span><span class=p>,</span>    <span class=nx>CPU分配的使用比例</span><span class=err>，</span><span class=nx>和CpuQuota一起作用在limits</span><span class=p>.</span><span class=nx>cpu上</span>
            <span class=s2>&#34;CpuQuota&#34;</span><span class=o>:</span> <span class=mi>50000</span><span class=p>,</span>
            <span class=s2>&#34;CpuRealtimePeriod&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;CpuRealtimeRuntime&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;CpusetCpus&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;CpusetMems&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>,</span>
            <span class=s2>&#34;Devices&#34;</span><span class=o>:</span> <span class=p>[],</span>
            <span class=s2>&#34;DeviceCgroupRules&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;DiskQuota&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;KernelMemory&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;MemoryReservation&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;MemorySwap&#34;</span><span class=o>:</span> <span class=mi>268435456</span><span class=p>,</span>
            <span class=s2>&#34;MemorySwappiness&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;OomKillDisable&#34;</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span>
            <span class=s2>&#34;PidsLimit&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;Ulimits&#34;</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
            <span class=s2>&#34;CpuCount&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;CpuPercent&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;IOMaximumIOps&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
            <span class=s2>&#34;IOMaximumBandwidth&#34;</span><span class=o>:</span> <span class=mi>0</span><span class=p>,</span>
        <span class=p>},</span>   
    <span class=p>}</span>
<span class=p>]</span>
</code></pre></td></tr></table></div></div><h2 id=13-cpu资源测试>1.3. cpu资源测试</h2><p>pod中cpu的限制主要通过requests.cpu和limits.cpu来定义，limits是不能超过的cpu大小，我们通过stress镜像来验证，stress是一个cpu和内存的压侧工具，通过指定args参数的定义压侧cpu的大小。监控pod的cpu和内存可通过kubectl top的方式来查看，依赖于监控组件如metric-server或promethus，当前没有安装，我们通过docker stats的方式来查看。</p><p>1、通过stress镜像定义一个pod，分配0.25个cores和最大限制0.5个core使用比例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=k>default</span>
  <span class=nx>annotations</span><span class=o>:</span> 
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;demo for cpu requests and&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>stress</span><span class=o>-</span><span class=nx>cpu</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>vish</span><span class=o>/</span><span class=nx>stress</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>250</span><span class=nx>m</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>500</span><span class=nx>m</span>
    <span class=nx>args</span><span class=o>:</span>
    <span class=o>-</span> <span class=o>-</span><span class=nx>cpus</span>
    <span class=o>-</span> <span class=s2>&#34;1&#34;</span>
</code></pre></td></tr></table></div></div><p>2、应用yaml文件生成pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>3、查看pod资源分配详情</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>pods</span> <span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>cpu</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>     <span class=mi>0</span>
<span class=nx>Node</span><span class=o>:</span>         <span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=o>/</span><span class=mf>10.254.100.102</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>14</span><span class=o>:</span><span class=mi>33</span><span class=o>:</span><span class=mi>12</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/description&#34;</span><span class=o>:</span><span class=s2>&#34;demo for cpu requests and&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;cpu-demo&#34;</span><span class=p>,</span><span class=err>&#34;</span><span class=nx>nam</span><span class=p>...</span>
              <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=nx>demo</span> <span class=k>for</span> <span class=nx>cpu</span> <span class=nx>requests</span> <span class=nx>and</span>
<span class=nx>Status</span><span class=o>:</span>       <span class=nx>Running</span>
<span class=nx>IP</span><span class=o>:</span>           <span class=mf>10.244.1.14</span>
<span class=nx>Containers</span><span class=o>:</span>
  <span class=nx>stress</span><span class=o>-</span><span class=nx>cpu</span><span class=o>:</span>
    <span class=nx>Container</span> <span class=nx>ID</span><span class=o>:</span>  <span class=nx>docker</span><span class=o>:</span><span class=c1>//14f93767ad37b92beb91e3792678f60c9987bbad3290ae8c29c35a2a80101836
</span><span class=c1></span>    <span class=nx>Image</span><span class=o>:</span>         <span class=nx>progrium</span><span class=o>/</span><span class=nx>stress</span>
    <span class=nx>Image</span> <span class=nx>ID</span><span class=o>:</span>      <span class=nx>docker</span><span class=o>-</span><span class=nx>pullable</span><span class=o>:</span><span class=c1>//progrium/stress@sha256:e34d56d60f5caae79333cee395aae93b74791d50e3841986420d23c2ee4697bf
</span><span class=c1></span>    <span class=nx>Port</span><span class=o>:</span>          <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>     <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Args</span><span class=o>:</span>
      <span class=o>-</span><span class=nx>cpus</span>
      <span class=mi>1</span>
    <span class=nx>State</span><span class=o>:</span>          <span class=nx>Waiting</span>
      <span class=nx>Reason</span><span class=o>:</span>       <span class=nx>CrashLoopBackOff</span>
    <span class=nx>Last</span> <span class=nx>State</span><span class=o>:</span>     <span class=nx>Terminated</span>
      <span class=nx>Reason</span><span class=o>:</span>       <span class=nb>Error</span>
      <span class=nx>Exit</span> <span class=nx>Code</span><span class=o>:</span>    <span class=mi>1</span>
      <span class=nx>Started</span><span class=o>:</span>      <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>14</span><span class=o>:</span><span class=mi>34</span><span class=o>:</span><span class=mi>28</span> <span class=o>+</span><span class=mi>0800</span>
      <span class=nx>Finished</span><span class=o>:</span>     <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>14</span><span class=o>:</span><span class=mi>34</span><span class=o>:</span><span class=mi>28</span> <span class=o>+</span><span class=mi>0800</span>
    <span class=nx>Ready</span><span class=o>:</span>          <span class=nx>False</span>
    <span class=nx>Restart</span> <span class=nx>Count</span><span class=o>:</span>  <span class=mi>3</span>
    <span class=nx>Limits</span><span class=o>:</span>         <span class=err>#</span><span class=nx>cpu限制使用的比例</span>
      <span class=nx>cpu</span><span class=o>:</span>  <span class=mi>500</span><span class=nx>m</span>
    <span class=nx>Requests</span><span class=o>:</span>       <span class=err>#</span><span class=nx>cpu请求的大小</span>
      <span class=nx>cpu</span><span class=o>:</span>  <span class=mi>250</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>4、登陆到特定的node节点，通过docker container stats查看容器的资源使用详情
<img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/1%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/1%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/1%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/1%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%85%AD)kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/1%20-%201620.jpg title=limits.cpu资源使用率></p><p>在pod所属的node上通过top查看，cpu的使用率限制百分比为50%。
<img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2kj7ydd8yr.png data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2kj7ydd8yr.png, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2kj7ydd8yr.png 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2kj7ydd8yr.png 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%85%AD)kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2kj7ydd8yr.png title=limits.cpu验证，宿主机上top查看cpu资源的使用率></p><p>通过上面的验证可以得出结论，我们在stress容器中定义使用1个core，通过limits.cpu限定可使用的cpu大小是500m，测试验证pod的资源已在容器内部或宿主机上都严格限制在50%（node机器上只有一个cpu，如果有2个cpu则会分摊为25%）。</p><h2 id=14-memory资源测试>1.4 memory资源测试</h2><p>1、通过stress镜像测试验证requests.memory和limits.memory的生效范围，limits.memory定义容器可使用的内存资源大小，当超过内存设定的大小后容器会发生OOM，如下定义一个测试的容器，最大内存不能超过512M,使用stress镜像&ndash;vm-bytes定义压侧内存大小为256Mi</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;stress demo for memory limits&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>limits</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>polinux</span><span class=o>/</span><span class=nx>stress</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>128</span><span class=nx>Mi</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>512</span><span class=nx>Mi</span>
    <span class=nx>command</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;stress&#34;</span><span class=p>]</span>
    <span class=nx>args</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;--vm&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;--vm-bytes&#34;</span><span class=p>,</span> <span class=s2>&#34;256M&#34;</span><span class=p>,</span> <span class=s2>&#34;--vm-hang&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>]</span>
</code></pre></td></tr></table></div></div><p>2、应用yaml文件生成pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                 <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>   <span class=nx>IP</span>            <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>41</span><span class=nx>s</span>   <span class=mf>10.244.1.19</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>3、查看资源的分配情况</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span>  <span class=nx>pods</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>     <span class=mi>0</span>
<span class=nx>Node</span><span class=o>:</span>         <span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=o>/</span><span class=mf>10.254.100.102</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>15</span><span class=o>:</span><span class=mi>13</span><span class=o>:</span><span class=mi>06</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/description&#34;</span><span class=o>:</span><span class=s2>&#34;stress demo for memory limits&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=err>&#34;</span><span class=nx>memory</span><span class=o>-</span><span class=nx>str</span><span class=p>...</span>
              <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=nx>stress</span> <span class=nx>demo</span> <span class=k>for</span> <span class=nx>memory</span> <span class=nx>limits</span>
<span class=nx>Status</span><span class=o>:</span>       <span class=nx>Running</span>
<span class=nx>IP</span><span class=o>:</span>           <span class=mf>10.244.1.16</span>
<span class=nx>Containers</span><span class=o>:</span>
  <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>limits</span><span class=o>:</span>
    <span class=nx>Container</span> <span class=nx>ID</span><span class=o>:</span>  <span class=nx>docker</span><span class=o>:</span><span class=c1>//c7408329cffab2f10dd860e50df87bd8671e65a0f8abb4dae96d059c0cb6bb2d
</span><span class=c1></span>    <span class=nx>Image</span><span class=o>:</span>         <span class=nx>polinux</span><span class=o>/</span><span class=nx>stress</span>
    <span class=nx>Image</span> <span class=nx>ID</span><span class=o>:</span>      <span class=nx>docker</span><span class=o>-</span><span class=nx>pullable</span><span class=o>:</span><span class=c1>//polinux/stress@sha256:6d1825288ddb6b3cec8d3ac8a488c8ec2449334512ecb938483fc2b25cbbdb9a
</span><span class=c1></span>    <span class=nx>Port</span><span class=o>:</span>          <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>     <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Command</span><span class=o>:</span>
      <span class=nx>stress</span>
    <span class=nx>Args</span><span class=o>:</span>
      <span class=o>--</span><span class=nx>vm</span>
      <span class=mi>1</span>
      <span class=o>--</span><span class=nx>vm</span><span class=o>-</span><span class=nx>bytes</span>
      <span class=mi>256</span><span class=nx>Mi</span>
      <span class=o>--</span><span class=nx>vm</span><span class=o>-</span><span class=nx>hang</span>
      <span class=mi>1</span>
    <span class=nx>State</span><span class=o>:</span>          <span class=nx>Waiting</span>
      <span class=nx>Reason</span><span class=o>:</span>       <span class=nx>CrashLoopBackOff</span>
    <span class=nx>Last</span> <span class=nx>State</span><span class=o>:</span>     <span class=nx>Terminated</span>
      <span class=nx>Reason</span><span class=o>:</span>       <span class=nb>Error</span>
      <span class=nx>Exit</span> <span class=nx>Code</span><span class=o>:</span>    <span class=mi>1</span>
      <span class=nx>Started</span><span class=o>:</span>      <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>15</span><span class=o>:</span><span class=mi>14</span><span class=o>:</span><span class=mi>08</span> <span class=o>+</span><span class=mi>0800</span>
      <span class=nx>Finished</span><span class=o>:</span>     <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>15</span><span class=o>:</span><span class=mi>14</span><span class=o>:</span><span class=mi>08</span> <span class=o>+</span><span class=mi>0800</span>
    <span class=nx>Ready</span><span class=o>:</span>          <span class=nx>False</span>
    <span class=nx>Restart</span> <span class=nx>Count</span><span class=o>:</span>  <span class=mi>3</span>
    <span class=nx>Limits</span><span class=o>:</span>          <span class=err>#</span><span class=nx>内存限制大小</span>
      <span class=nx>memory</span><span class=o>:</span>  <span class=mi>512</span><span class=nx>Mi</span>
    <span class=nx>Requests</span><span class=o>:</span>         <span class=err>#</span><span class=nx>内存请求大小</span>
      <span class=nx>memory</span><span class=o>:</span>     <span class=mi>128</span><span class=nx>Mi</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>
      <span class=err>/var/run/secrets/kubernetes.io/serviceaccount from default-token-5qwmc (ro)</span>
</code></pre></td></tr></table></div></div><p>4、查看容器内存资源的使用情况，分配256M内存，最大可使用为512Mi，利用率为50%，此时没有超过limits限制的大小，容器运行正常</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E5%85%AD%29kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E5%85%AD)kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/2%20-%201620.jpg title=limits.memory限制></p><p>5、当容器内部超过内存的大小会怎么样呢，我们将&ndash;vm-byte设置为513M，容器会尝试运行，超过内存后会OOM，kube-controller-manager会不停的尝试重启容器,RESTARTS的次数会不停的增加。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;stress demo for memory limits&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>limits</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>polinux</span><span class=o>/</span><span class=nx>stress</span>
    <span class=nx>resources</span><span class=o>:</span>
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>128</span><span class=nx>Mi</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>512</span><span class=nx>Mi</span>
    <span class=nx>command</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;stress&#34;</span><span class=p>]</span>
    <span class=nx>args</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;--vm&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>,</span> <span class=s2>&#34;--vm-bytes&#34;</span><span class=p>,</span> <span class=s2>&#34;520M&#34;</span><span class=p>,</span> <span class=s2>&#34;--vm-hang&#34;</span><span class=p>,</span> <span class=s2>&#34;1&#34;</span><span class=p>]</span> <span class=p>.</span> <span class=err>#</span><span class=nx>容器中使用内存为520M</span>
  
<span class=nx>查看容器的状态为OOMKilled</span><span class=err>，</span><span class=nx>RESTARTS的次数不断的增加</span><span class=err>，</span><span class=nx>不停的尝试重启</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                 <span class=nx>READY</span>   <span class=nx>STATUS</span>      <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>memory</span><span class=o>-</span><span class=nx>stress</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>OOMKilled</span>   <span class=mi>3</span>          <span class=mi>60</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><h1 id=2-pod服务质量>2. Pod服务质量</h1><p>服务质量QOS（Quality of Service）主要用于pod调度和驱逐时参考的重要因素，不同的QOS其服务质量不同，对应不同的优先级，主要分为三种类型的Qos：</p><ul><li>BestEffort 尽最大努力分配资源，默认没有指定resource分配的Qos，优先级最低；</li><li>Burstable 可波动的资源，至少需要分配到requests中的资源，常见的QOS；</li><li>Guaranteed 完全可保障资源，requests和limits定义的资源相同，优先级最高。</li></ul><h2 id=21-besteffort最大努力>2.1 BestEffort最大努力</h2><p>1、Pod中没有定义resource，默认的Qos策略为BestEffort,优先级别最低，当资源比较进展是需要驱逐evice时，优先驱逐BestEffort定义的Pod，如下定义一个BestEffort的Pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
    <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>port</span><span class=o>-</span><span class=mi>80</span>
      <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
    <span class=nx>resources</span><span class=o>:</span> <span class=p>{}</span>
</code></pre></td></tr></table></div></div><p>2、创建pod并查看Qos策略，qosClass为BestEffort</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span> <span class=nx>created</span>

<span class=nx>查看Qos策略</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>yaml</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span> <span class=o>|</span>
      <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-besteffort&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-besteffort&#34;</span><span class=p>,</span><span class=s2>&#34;namespace&#34;</span><span class=o>:</span><span class=s2>&#34;default&#34;</span><span class=p>},</span><span class=s2>&#34;spec&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;containers&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;image&#34;</span><span class=o>:</span><span class=s2>&#34;nginx:1.7.9&#34;</span><span class=p>,</span><span class=s2>&#34;imagePullPolicy&#34;</span><span class=o>:</span><span class=s2>&#34;IfNotPresent&#34;</span><span class=p>,</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-besteffort&#34;</span><span class=p>,</span><span class=s2>&#34;ports&#34;</span><span class=o>:</span><span class=p>[{</span><span class=s2>&#34;containerPort&#34;</span><span class=o>:</span><span class=mi>80</span><span class=p>,</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-port-80&#34;</span><span class=p>,</span><span class=s2>&#34;protocol&#34;</span><span class=o>:</span><span class=s2>&#34;TCP&#34;</span><span class=p>}],</span><span class=s2>&#34;resources&#34;</span><span class=o>:</span><span class=p>{}}]}}</span>
  <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=s2>&#34;2019-09-28T11:12:03Z&#34;</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=k>default</span>
  <span class=nx>resourceVersion</span><span class=o>:</span> <span class=s2>&#34;1802411&#34;</span>
  <span class=nx>selfLink</span><span class=o>:</span> <span class=err>/api/v1/namespaces/default/pods/nginx-qos-besteffort</span>
  <span class=nx>uid</span><span class=o>:</span> <span class=mi>56</span><span class=nx>e4a2d5</span><span class=o>-</span><span class=mi>8645</span><span class=o>-</span><span class=mi>485</span><span class=nx>d</span><span class=o>-</span><span class=mi>9362</span><span class=o>-</span><span class=nx>fe76aad76e74</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span>
    <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
      <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>port</span><span class=o>-</span><span class=mi>80</span>
      <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
    <span class=nx>resources</span><span class=o>:</span> <span class=p>{}</span>
    <span class=nx>terminationMessagePath</span><span class=o>:</span> <span class=err>/dev/termination-log</span>
<span class=p>...</span><span class=nx>省略</span><span class=p>...</span>
<span class=nx>status</span><span class=o>:</span>
  <span class=nx>hostIP</span><span class=o>:</span> <span class=mf>10.254.100.102</span>
  <span class=nx>phase</span><span class=o>:</span> <span class=nx>Running</span>
  <span class=nx>podIP</span><span class=o>:</span> <span class=mf>10.244.1.21</span>
  <span class=nx>qosClass</span><span class=o>:</span> <span class=nx>BestEffort</span>  <span class=err>#</span><span class=nx>Qos策略</span>
  <span class=nx>startTime</span><span class=o>:</span> <span class=s2>&#34;2019-09-28T11:12:03Z&#34;</span>
</code></pre></td></tr></table></div></div><p>3、删除测试Pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=k>delete</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>besteffort</span> 
<span class=nx>pod</span> <span class=s2>&#34;nginx-qos-besteffort&#34;</span> <span class=nx>deleted</span>
</code></pre></td></tr></table></div></div><h2 id=22-burstable可波动>2.2 Burstable可波动</h2><p>1、Pod的服务质量为Burstable，仅次于Guaranteed的服务质量，至少需要一个container定义了requests，且requests定义的资源小于limits资源</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
    <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>port</span><span class=o>-</span><span class=mi>80</span>
      <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
    <span class=nx>resources</span><span class=o>:</span> 
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>100</span><span class=nx>m</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>128</span><span class=nx>Mi</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>200</span><span class=nx>m</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>256</span><span class=nx>Mi</span>
</code></pre></td></tr></table></div></div><p>2、应用yaml文件生成pod并查看Qos类型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span> <span class=nx>created</span>

<span class=nx>查看Qos类型</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span> 
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>     <span class=mi>0</span>
<span class=nx>Node</span><span class=o>:</span>         <span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=o>/</span><span class=mf>10.254.100.102</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>19</span><span class=o>:</span><span class=mi>27</span><span class=o>:</span><span class=mi>37</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=nx>name</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-burstable&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-burstable&#34;</span><span class=p>,</span><span class=s2>&#34;namespa...
</span><span class=s2>Status:       Running
</span><span class=s2>IP:           10.244.1.22
</span><span class=s2>Containers:
</span><span class=s2>  nginx-qos-burstable:
</span><span class=s2>    Container ID:   docker://d1324b3953ba6e572bfc63244d4040fee047ed70138b5a4bad033899e818562f
</span><span class=s2>    Image:          nginx:1.7.9
</span><span class=s2>    Image ID:       docker-pullable://nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
</span><span class=s2>    Port:           80/TCP
</span><span class=s2>    Host Port:      0/TCP
</span><span class=s2>    State:          Running
</span><span class=s2>      Started:      Sat, 28 Sep 2019 19:27:39 +0800
</span><span class=s2>    Ready:          True
</span><span class=s2>    Restart Count:  0
</span><span class=s2>    Limits:
</span><span class=s2>      cpu:     200m
</span><span class=s2>      memory:  256Mi
</span><span class=s2>    Requests:
</span><span class=s2>      cpu:        100m
</span><span class=s2>      memory:     128Mi
</span><span class=s2>    Environment:  &lt;none&gt;
</span><span class=s2>    Mounts:
</span><span class=s2>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5qwmc (ro)
</span><span class=s2>Conditions:
</span><span class=s2>  Type              Status
</span><span class=s2>  Initialized       True 
</span><span class=s2>  Ready             True 
</span><span class=s2>  ContainersReady   True 
</span><span class=s2>  PodScheduled      True 
</span><span class=s2>Volumes:
</span><span class=s2>  default-token-5qwmc:
</span><span class=s2>    Type:        Secret (a volume populated by a Secret)
</span><span class=s2>    SecretName:  default-token-5qwmc
</span><span class=s2>    Optional:    false
</span><span class=s2>QoS Class:       Burstable  #服务质量是可波动的Burstable
</span><span class=s2>Node-Selectors:  &lt;none&gt;
</span><span class=s2>Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
</span><span class=s2>                 node.kubernetes.io/unreachable:NoExecute for 300s
</span><span class=s2>Events:
</span><span class=s2>  Type    Reason     Age   From               Message
</span><span class=s2>  ----    ------     ----  ----               -------
</span><span class=s2>  Normal  Scheduled  95s   default-scheduler  Successfully assigned default/nginx-qos-burstable to node-2
</span><span class=s2>  Normal  Pulled     94s   kubelet, node-2    Container image &#34;</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span><span class=err>&#34;</span> <span class=nx>already</span> <span class=nx>present</span> <span class=nx>on</span> <span class=nx>machine</span>
  <span class=nx>Normal</span>  <span class=nx>Created</span>    <span class=mi>94</span><span class=nx>s</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>    <span class=nx>Created</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
  <span class=nx>Normal</span>  <span class=nx>Started</span>    <span class=mi>93</span><span class=nx>s</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>    <span class=nx>Started</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>burstable</span>
</code></pre></td></tr></table></div></div><h2 id=23-guaranteed完全保障>2.3 Guaranteed完全保障</h2><p>1、resource中定义的cpu和memory必须包含有requests和limits，切requests和limits的值必须相同，其优先级别最高，当出现调度和驱逐时优先保障该类型的Qos,如下定义一个nginx-qos-guaranteed的容器，requests.cpu和limits.cpu相同，同理requests.memory和limits.memory.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Pod</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>containers</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
    <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
    <span class=nx>ports</span><span class=o>:</span>
    <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>port</span><span class=o>-</span><span class=mi>80</span>
      <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
      <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
    <span class=nx>resources</span><span class=o>:</span> 
      <span class=nx>requests</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>200</span><span class=nx>m</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>256</span><span class=nx>Mi</span>
      <span class=nx>limits</span><span class=o>:</span>
        <span class=nx>cpu</span><span class=o>:</span> <span class=mi>200</span><span class=nx>m</span>
        <span class=nx>memory</span><span class=o>:</span> <span class=mi>256</span><span class=nx>Mi</span>
</code></pre></td></tr></table></div></div><p>2、应用yaml文件生成pod并查看pod的Qos类型为可完全保障Guaranteed</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>pod</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>demo</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span> 
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>     <span class=mi>0</span>
<span class=nx>Node</span><span class=o>:</span>         <span class=nx>node</span><span class=o>-</span><span class=mi>2</span><span class=o>/</span><span class=mf>10.254.100.102</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Sep</span> <span class=mi>2019</span> <span class=mi>19</span><span class=o>:</span><span class=mi>37</span><span class=o>:</span><span class=mi>15</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=nx>name</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;Pod&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{},</span><span class=s2>&#34;labels&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-guaranteed&#34;</span><span class=p>},</span><span class=s2>&#34;name&#34;</span><span class=o>:</span><span class=s2>&#34;nginx-qos-guaranteed&#34;</span><span class=p>,</span><span class=s2>&#34;names...
</span><span class=s2>Status:       Running
</span><span class=s2>IP:           10.244.1.23
</span><span class=s2>Containers:
</span><span class=s2>  nginx-qos-guaranteed:
</span><span class=s2>    Container ID:   docker://cf533e0e331f49db4e9effb0fbb9249834721f8dba369d281c8047542b9f032c
</span><span class=s2>    Image:          nginx:1.7.9
</span><span class=s2>    Image ID:       docker-pullable://nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
</span><span class=s2>    Port:           80/TCP
</span><span class=s2>    Host Port:      0/TCP
</span><span class=s2>    State:          Running
</span><span class=s2>      Started:      Sat, 28 Sep 2019 19:37:16 +0800
</span><span class=s2>    Ready:          True
</span><span class=s2>    Restart Count:  0
</span><span class=s2>    Limits:
</span><span class=s2>      cpu:     200m
</span><span class=s2>      memory:  256Mi
</span><span class=s2>    Requests:
</span><span class=s2>      cpu:        200m
</span><span class=s2>      memory:     256Mi
</span><span class=s2>    Environment:  &lt;none&gt;
</span><span class=s2>    Mounts:
</span><span class=s2>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-5qwmc (ro)
</span><span class=s2>Conditions:
</span><span class=s2>  Type              Status
</span><span class=s2>  Initialized       True 
</span><span class=s2>  Ready             True 
</span><span class=s2>  ContainersReady   True 
</span><span class=s2>  PodScheduled      True 
</span><span class=s2>Volumes:
</span><span class=s2>  default-token-5qwmc:
</span><span class=s2>    Type:        Secret (a volume populated by a Secret)
</span><span class=s2>    SecretName:  default-token-5qwmc
</span><span class=s2>    Optional:    false
</span><span class=s2>QoS Class:       Guaranteed #服务质量为可完全保障Guaranteed
</span><span class=s2>Node-Selectors:  &lt;none&gt;
</span><span class=s2>Tolerations:     node.kubernetes.io/not-ready:NoExecute for 300s
</span><span class=s2>                 node.kubernetes.io/unreachable:NoExecute for 300s
</span><span class=s2>Events:
</span><span class=s2>  Type    Reason     Age   From               Message
</span><span class=s2>  ----    ------     ----  ----               -------
</span><span class=s2>  Normal  Scheduled  25s   default-scheduler  Successfully assigned default/nginx-qos-guaranteed to node-2
</span><span class=s2>  Normal  Pulled     24s   kubelet, node-2    Container image &#34;</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span><span class=err>&#34;</span> <span class=nx>already</span> <span class=nx>present</span> <span class=nx>on</span> <span class=nx>machine</span>
  <span class=nx>Normal</span>  <span class=nx>Created</span>    <span class=mi>24</span><span class=nx>s</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>    <span class=nx>Created</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
  <span class=nx>Normal</span>  <span class=nx>Started</span>    <span class=mi>24</span><span class=nx>s</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>    <span class=nx>Started</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>qos</span><span class=o>-</span><span class=nx>guaranteed</span>
</code></pre></td></tr></table></div></div><h1 id=写在最后>写在最后</h1><p>本章是<a href=# rel><strong>kubernetes系列教程</strong></a>第六篇文章，通过介绍resource资源的分配和服务质量Qos，关于resource有节点使用建议：</p><ul><li>requests和limits资源定义推荐不超过1:2，避免分配过多资源而出现资源争抢，发生OOM；</li><li>pod中默认没有定义resource，推荐给namespace定义一个limitrange，确保pod能分到资源；</li><li>防止node上资源过度而出现机器hang住或者OOM，建议node上设置保留和驱逐资源，如保留资源&ndash;system-reserved=cpu=200m,memory=1G，驱逐条件&ndash;eviction hard=memory.available&lt;500Mi。</li></ul><h1 id=附录>附录</h1><p>容器计算资源管理：https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/</p><p>pod内存资源管理：https://kubernetes.io/docs/tasks/configure-pod-container/assign-memory-resource/</p><p>pod cpu资源管理：https://kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/</p><p>服务质量QOS：https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/</p><p>Docker关于CPU的限制：https://www.cnblogs.com/sparkdev/p/8052522.html</p><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-08-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-title="06 Kubernetes资源管理和服务质量" data-hashtags=kubernetes><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-title="06 Kubernetes资源管理和服务质量"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-title="06 Kubernetes资源管理和服务质量"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-title="06 Kubernetes资源管理和服务质量" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=http://x.agou-ops.top/06-kubernetes%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%92%8C%E6%9C%8D%E5%8A%A1%E8%B4%A8%E9%87%8F/ data-title="06 Kubernetes资源管理和服务质量"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/07-%E6%B7%B1%E5%85%A5%E7%8E%A9%E8%BD%ACpod%E8%B0%83%E5%BA%A6/ class=prev rel=prev title="07 深入玩转pod调度"><i class="fas fa-angle-left fa-fw"></i>07 深入玩转pod调度</a>
<a href=/05-%E5%88%9D%E8%AF%86%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5pod/ class=next rel=next title="05 初识核心概念pod">05 初识核心概念pod<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://agou-ops.github.io target=_blank rel="noopener noreferrer" style=color:red>【AGou-ops.top】</a> 备份站点</div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.75.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>鲁ICP备19050296号-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"AGou-ops/comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>