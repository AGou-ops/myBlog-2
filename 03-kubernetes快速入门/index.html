<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>03 Kubernetes快速入门 - AGou's Blog-2</title><meta name=Description content="关于 LoveIt 主题"><meta property="og:title" content="03 Kubernetes快速入门"><meta property="og:description" content="写在前面 kubernetes中涉及很多概念，包含云生态社区中各类技术，学习成本比较高，k8s中通常以编写yaml文件完成资源的部署，对于较多"><meta property="og:type" content="article"><meta property="og:url" content="http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2019-08-04T10:36:47+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:47+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="03 Kubernetes快速入门"><meta name=twitter:description content="写在前面 kubernetes中涉及很多概念，包含云生态社区中各类技术，学习成本比较高，k8s中通常以编写yaml文件完成资源的部署，对于较多"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/><link rel=prev href=http://x.agou-ops.top/04-%E7%A6%BB%E7%BA%BF%E5%8D%87%E7%BA%A7kubernetes%E9%9B%86%E7%BE%A4/><link rel=next href=http://x.agou-ops.top/02-kubeadm%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B21.14.1%E9%9B%86%E7%BE%A4/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"03 Kubernetes快速入门","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/x.agou-ops.top\/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"kubernetes, tutorial","wordcount":10646,"url":"http:\/\/x.agou-ops.top\/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8\/","datePublished":"2019-08-04T10:36:47+08:00","dateModified":"2019-08-04T10:36:47+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>所有文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/categories/documentation/>文档</a><a class=menu-item href=/about/>关于</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">03 Kubernetes快速入门</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%BD%AC%E8%BD%BD/><i class="far fa-folder fa-fw"></i>转载</a>&nbsp;<a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a>&nbsp;<a href=/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><i class="far fa-folder fa-fw"></i>基础教程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-08-04>2019-08-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 10646 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 22 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#11-集群与节点>1.1 集群与节点</a></li><li><a href=#12-容器与应用>1.2 容器与应用</a></li><li><a href=#13-服务访问>1.3 服务访问</a></li></ul><ul><li><a href=#31-clusterip访问>3.1 ClusterIP访问</a></li><li><a href=#32-nodeport访问>3.2 NodePort访问</a></li></ul></nav></div></div><div class=content id=content><h1 id=写在前面>写在前面</h1><p>kubernetes中涉及很多概念，包含云生态社区中各类技术，学习成本比较高，k8s中通常以编写yaml文件完成资源的部署，对于较多入门的人来说是个较高的门坎，本文以命令行的形式带领大家快速入门，俯瞰kubernetes核心概念，快速入门。</p><h1 id=1-基础概念>1. 基础概念</h1><h2 id=11-集群与节点>1.1 集群与节点</h2><p>kubernetes是一个开源的容器引擎管理平台，实现容器化应用的自动化部署，任务调度，<a href=# rel>弹性伸缩</a>，<a href=# rel>负载均衡</a>等功能，cluster是由master和node两种角色组成</p><ul><li>master负责管理集群，master包含kube-apiserver，kube-controller-manager，kube-scheduler，etcd组件</li><li>node节点运行容器应用，由Container Runtime，kubelet和kube-proxy组成，其中Container Runtime可能是Docker，rke，containerd，node节点可由物理机或者虚拟机组成。</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1%20-%201620.jpg data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1%20-%201620.jpg, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1%20-%201620.jpg 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1%20-%201620.jpg 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/1%20-%201620.jpg title=img>kubernetes集群概念</p><p>1、查看master组件角色</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>componentstatuses</span> 
<span class=nx>NAME</span>                 <span class=nx>STATUS</span>    <span class=nx>MESSAGE</span>             <span class=nx>ERROR</span>
<span class=nx>scheduler</span>            <span class=nx>Healthy</span>   <span class=nx>ok</span>                  
<span class=nx>controller</span><span class=o>-</span><span class=nx>manager</span>   <span class=nx>Healthy</span>   <span class=nx>ok</span>                  
<span class=nx>etcd</span><span class=o>-</span><span class=mi>0</span>               <span class=nx>Healthy</span>   <span class=p>{</span><span class=s2>&#34;health&#34;</span><span class=o>:</span><span class=s2>&#34;true&#34;</span><span class=p>}</span>   
</code></pre></td></tr></table></div></div><p>2、 查看node节点列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>nodes</span>
<span class=nx>NAME</span>     <span class=nx>STATUS</span>   <span class=nx>ROLES</span>    <span class=nx>AGE</span>   <span class=nx>VERSION</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>1</span>   <span class=nx>Ready</span>    <span class=nx>master</span>   <span class=mi>26</span><span class=nx>h</span>   <span class=nx>v1</span><span class=mf>.14.1</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>26</span><span class=nx>h</span>   <span class=nx>v1</span><span class=mf>.14.1</span>
<span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=nx>Ready</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>   <span class=mi>26</span><span class=nx>h</span>   <span class=nx>v1</span><span class=mf>.14.1</span>
</code></pre></td></tr></table></div></div><p>3、查看node节点详情</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>node</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
<span class=nx>Name</span><span class=o>:</span>               <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
<span class=nx>Roles</span><span class=o>:</span>              <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Labels</span><span class=o>:</span>             <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span><span class=err>。#</span><span class=nx>标签和Annotations</span>
                    <span class=nx>beta</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>
                    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>arch</span><span class=o>=</span><span class=nx>amd64</span>
                    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>hostname</span><span class=o>=</span><span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
                    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>os</span><span class=o>=</span><span class=nx>linux</span>
<span class=nx>Annotations</span><span class=o>:</span>        <span class=nx>flannel</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>coreos</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>backend</span><span class=o>-</span><span class=nx>data</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;VtepMAC&#34;</span><span class=o>:</span><span class=s2>&#34;22:f8:75:bb:da:4e&#34;</span><span class=p>}</span>
                    <span class=nx>flannel</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>coreos</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>backend</span><span class=o>-</span><span class=nx>type</span><span class=o>:</span> <span class=nx>vxlan</span>
                    <span class=nx>flannel</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>coreos</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>subnet</span><span class=o>-</span><span class=nx>manager</span><span class=o>:</span> <span class=kc>true</span>
                    <span class=nx>flannel</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>coreos</span><span class=p>.</span><span class=nx>com</span><span class=o>/</span><span class=kr>public</span><span class=o>-</span><span class=nx>ip</span><span class=o>:</span> <span class=mf>10.254.100.103</span>
                    <span class=nx>kubeadm</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>cri</span><span class=o>-</span><span class=nx>socket</span><span class=o>:</span> <span class=err>/var/run/dockershim.sock</span>
                    <span class=nx>node</span><span class=p>.</span><span class=nx>alpha</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>ttl</span><span class=o>:</span> <span class=mi>0</span>
                    <span class=nx>volumes</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>controller</span><span class=o>-</span><span class=nx>managed</span><span class=o>-</span><span class=nx>attach</span><span class=o>-</span><span class=nx>detach</span><span class=o>:</span> <span class=kc>true</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>  <span class=nx>Sat</span><span class=p>,</span> <span class=mi>10</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>17</span><span class=o>:</span><span class=mi>50</span><span class=o>:</span><span class=mi>00</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Taints</span><span class=o>:</span>             <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Unschedulable</span><span class=o>:</span>      <span class=kc>false</span><span class=err>。#</span><span class=nx>是否禁用调度</span><span class=err>，</span><span class=nx>cordon命令控制的标识位</span><span class=err>。</span>
<span class=nx>Conditions</span><span class=o>:</span>     <span class=err>#</span><span class=nx>资源调度能力</span><span class=err>，</span><span class=nx>MemoryPressure内存是否有压力</span><span class=err>（</span><span class=nx>即内存不足</span><span class=err>）</span>
                <span class=err>#</span><span class=nx>DiskPressure磁盘压力</span>
                <span class=err>#</span><span class=nx>PIDPressure磁盘压力</span>
                <span class=err>#</span><span class=nx>Ready</span><span class=err>，</span><span class=nx>是否就绪</span><span class=err>，</span><span class=nx>表明节点是否处于正常工作状态</span><span class=err>，</span><span class=nx>表示资源充足</span><span class=o>+</span><span class=nx>相关进程状态正常</span>
  <span class=nx>Type</span>             <span class=nx>Status</span>  <span class=nx>LastHeartbeatTime</span>                 <span class=nx>LastTransitionTime</span>                <span class=nx>Reason</span>                       <span class=nx>Message</span>
  <span class=o>----</span>             <span class=o>------</span>  <span class=o>-----------------</span>                 <span class=o>------------------</span>                <span class=o>------</span>                       <span class=o>-------</span>
  <span class=nx>MemoryPressure</span>   <span class=nx>False</span>   <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>20</span><span class=o>:</span><span class=mi>32</span><span class=o>:</span><span class=mi>07</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>10</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>17</span><span class=o>:</span><span class=mi>50</span><span class=o>:</span><span class=mi>00</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>KubeletHasSufficientMemory</span>   <span class=nx>kubelet</span> <span class=nx>has</span> <span class=nx>sufficient</span> <span class=nx>memory</span> <span class=nx>available</span>
  <span class=nx>DiskPressure</span>     <span class=nx>False</span>   <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>20</span><span class=o>:</span><span class=mi>32</span><span class=o>:</span><span class=mi>07</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>10</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>17</span><span class=o>:</span><span class=mi>50</span><span class=o>:</span><span class=mi>00</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>KubeletHasNoDiskPressure</span>     <span class=nx>kubelet</span> <span class=nx>has</span> <span class=nx>no</span> <span class=nx>disk</span> <span class=nx>pressure</span>
  <span class=nx>PIDPressure</span>      <span class=nx>False</span>   <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>20</span><span class=o>:</span><span class=mi>32</span><span class=o>:</span><span class=mi>07</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>10</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>17</span><span class=o>:</span><span class=mi>50</span><span class=o>:</span><span class=mi>00</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>KubeletHasSufficientPID</span>      <span class=nx>kubelet</span> <span class=nx>has</span> <span class=nx>sufficient</span> <span class=nx>PID</span> <span class=nx>available</span>
  <span class=nx>Ready</span>            <span class=nx>True</span>    <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>20</span><span class=o>:</span><span class=mi>32</span><span class=o>:</span><span class=mi>07</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>Sat</span><span class=p>,</span> <span class=mi>10</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>18</span><span class=o>:</span><span class=mi>04</span><span class=o>:</span><span class=mi>20</span> <span class=o>+</span><span class=mi>0800</span>   <span class=nx>KubeletReady</span>                 <span class=nx>kubelet</span> <span class=nx>is</span> <span class=nx>posting</span> <span class=nx>ready</span> <span class=nx>status</span>
<span class=nx>Addresses</span><span class=o>:</span>     <span class=err>#</span><span class=nx>地址和主机名</span>
  <span class=nx>InternalIP</span><span class=o>:</span>  <span class=mf>10.254.100.103</span>
  <span class=nx>Hostname</span><span class=o>:</span>    <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>
<span class=nx>Capacity</span><span class=o>:</span>      <span class=err>#</span><span class=nx>容器的资源容量</span>
 <span class=nx>cpu</span><span class=o>:</span>                <span class=mi>2</span>
 <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span><span class=o>:</span>  <span class=mi>51473868</span><span class=nx>Ki</span>
 <span class=nx>hugepages</span><span class=o>-</span><span class=mi>2</span><span class=nx>Mi</span><span class=o>:</span>      <span class=mi>0</span>
 <span class=nx>memory</span><span class=o>:</span>             <span class=mi>3880524</span><span class=nx>Ki</span>
 <span class=nx>pods</span><span class=o>:</span>               <span class=mi>110</span>
<span class=nx>Allocatable</span><span class=o>:</span>    <span class=err>#</span><span class=nx>已分配资源情况</span>
 <span class=nx>cpu</span><span class=o>:</span>                <span class=mi>2</span>
 <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span><span class=o>:</span>  <span class=mi>47438316671</span>
 <span class=nx>hugepages</span><span class=o>-</span><span class=mi>2</span><span class=nx>Mi</span><span class=o>:</span>      <span class=mi>0</span>
 <span class=nx>memory</span><span class=o>:</span>             <span class=mi>3778124</span><span class=nx>Ki</span>
 <span class=nx>pods</span><span class=o>:</span>               <span class=mi>110</span>
<span class=nx>System</span> <span class=nx>Info</span><span class=o>:</span>     <span class=err>#</span><span class=nx>系统信息</span><span class=err>，</span><span class=nx>如内核版本</span><span class=err>，</span><span class=nx>操作系统版本</span><span class=err>，</span><span class=nx>cpu架构</span><span class=err>，</span><span class=nx>node节点软件版本</span>
 <span class=nx>Machine</span> <span class=nx>ID</span><span class=o>:</span>                 <span class=mi>0</span><span class=nx>ea734564f9a4e2881b866b82d679dfc</span>
 <span class=nx>System</span> <span class=nx>UUID</span><span class=o>:</span>                <span class=nx>D98ECAB1</span><span class=o>-</span><span class=mi>2</span><span class=nx>D9E</span><span class=o>-</span><span class=mi>41</span><span class=nx>CC</span><span class=o>-</span><span class=mi>9</span><span class=nx>A5E</span><span class=o>-</span><span class=mi>51</span><span class=nx>A44DC5BB97</span>
 <span class=nx>Boot</span> <span class=nx>ID</span><span class=o>:</span>                    <span class=mi>6</span><span class=nx>ec81f5b</span><span class=o>-</span><span class=nx>cb05</span><span class=o>-</span><span class=mi>4322</span><span class=o>-</span><span class=nx>b47a</span><span class=o>-</span><span class=nx>a8e046d9bf79</span>
 <span class=nx>Kernel</span> <span class=nx>Version</span><span class=o>:</span>             <span class=mf>3.10.0</span><span class=o>-</span><span class=mf>957.</span><span class=nx>el7</span><span class=p>.</span><span class=nx>x86_64</span>
 <span class=nx>OS</span> <span class=nx>Image</span><span class=o>:</span>                   <span class=nx>CentOS</span> <span class=nx>Linux</span> <span class=mi>7</span> <span class=p>(</span><span class=nx>Core</span><span class=p>)</span>
 <span class=nx>Operating</span> <span class=nx>System</span><span class=o>:</span>           <span class=nx>linux</span>
 <span class=nx>Architecture</span><span class=o>:</span>               <span class=nx>amd64</span>
 <span class=nx>Container</span> <span class=nx>Runtime</span> <span class=nx>Version</span><span class=o>:</span>  <span class=nx>docker</span><span class=o>:</span><span class=c1>//18.3.1 .     #Container Runtime为docker，版本为18.3.1
</span><span class=c1></span> <span class=nx>Kubelet</span> <span class=nx>Version</span><span class=o>:</span>            <span class=nx>v1</span><span class=mf>.14.1</span>               <span class=err>#</span><span class=nx>kubelet版本</span>
 <span class=nx>Kube</span><span class=o>-</span><span class=nb>Proxy</span> <span class=nx>Version</span><span class=o>:</span>         <span class=nx>v1</span><span class=mf>.14.1</span>               <span class=err>#</span><span class=nx>kube</span><span class=o>-</span><span class=nx>proxy版本</span>
<span class=nx>PodCIDR</span><span class=o>:</span>                     <span class=mf>10.244.2.0</span><span class=o>/</span><span class=mi>24</span>         <span class=err>#</span><span class=nx>pod使用的网络</span>
<span class=nx>Non</span><span class=o>-</span><span class=nx>terminated</span> <span class=nx>Pods</span><span class=o>:</span>         <span class=p>(</span><span class=mi>4</span> <span class=k>in</span> <span class=nx>total</span><span class=p>)</span><span class=err>。</span>        <span class=err>#</span><span class=nx>下面是每个pod资源占用情况</span>
  <span class=nx>Namespace</span>                  <span class=nx>Name</span>                           <span class=nx>CPU</span> <span class=nx>Requests</span>  <span class=nx>CPU</span> <span class=nx>Limits</span>  <span class=nx>Memory</span> <span class=nx>Requests</span>  <span class=nx>Memory</span> <span class=nx>Limits</span>  <span class=nx>AGE</span>
  <span class=o>---------</span>                  <span class=o>----</span>                           <span class=o>------------</span>  <span class=o>----------</span>  <span class=o>---------------</span>  <span class=o>-------------</span>  <span class=o>---</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>coredns</span><span class=o>-</span><span class=nx>fb8b8dccf</span><span class=o>-</span><span class=nx>hrqm8</span>        <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>     <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>      <span class=mi>70</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>1</span><span class=o>%</span><span class=p>)</span>        <span class=mi>170</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>4</span><span class=o>%</span><span class=p>)</span>     <span class=mi>26</span><span class=nx>h</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>coredns</span><span class=o>-</span><span class=nx>fb8b8dccf</span><span class=o>-</span><span class=nx>qwwks</span>        <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>     <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>      <span class=mi>70</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>1</span><span class=o>%</span><span class=p>)</span>        <span class=mi>170</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>4</span><span class=o>%</span><span class=p>)</span>     <span class=mi>26</span><span class=nx>h</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>kube</span><span class=o>-</span><span class=nx>flannel</span><span class=o>-</span><span class=nx>ds</span><span class=o>-</span><span class=nx>amd64</span><span class=o>-</span><span class=nx>zzm2g</span>    <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>     <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>   <span class=mi>50</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>1</span><span class=o>%</span><span class=p>)</span>        <span class=mi>50</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>1</span><span class=o>%</span><span class=p>)</span>      <span class=mi>26</span><span class=nx>h</span>
  <span class=nx>kube</span><span class=o>-</span><span class=nx>system</span>                <span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span><span class=o>-</span><span class=nx>x8zqh</span>               <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>        <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>      <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>           <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>         <span class=mi>26</span><span class=nx>h</span>
<span class=nx>Allocated</span> <span class=nx>resources</span><span class=o>:</span>   <span class=err>#</span><span class=nx>已分配资源情况</span>
  <span class=p>(</span><span class=nx>Total</span> <span class=nx>limits</span> <span class=nx>may</span> <span class=nx>be</span> <span class=nx>over</span> <span class=mi>100</span> <span class=nx>percent</span><span class=p>,</span> <span class=nx>i</span><span class=p>.</span><span class=nx>e</span><span class=p>.,</span> <span class=nx>overcommitted</span><span class=p>.)</span>
  <span class=nx>Resource</span>           <span class=nx>Requests</span>    <span class=nx>Limits</span>
  <span class=o>--------</span>           <span class=o>--------</span>    <span class=o>------</span>
  <span class=nx>cpu</span>                <span class=mi>300</span><span class=nx>m</span> <span class=p>(</span><span class=mi>15</span><span class=o>%</span><span class=p>)</span>  <span class=mi>100</span><span class=nx>m</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>
  <span class=nx>memory</span>             <span class=mi>190</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>5</span><span class=o>%</span><span class=p>)</span>  <span class=mi>390</span><span class=nx>Mi</span> <span class=p>(</span><span class=mi>10</span><span class=o>%</span><span class=p>)</span>
  <span class=nx>ephemeral</span><span class=o>-</span><span class=nx>storage</span>  <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>      <span class=mi>0</span> <span class=p>(</span><span class=mi>0</span><span class=o>%</span><span class=p>)</span>
<span class=nx>Events</span><span class=o>:</span>              <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><h2 id=12-容器与应用>1.2 容器与应用</h2><p>kubernetes是容器编排引擎，其负责容器的调度，管理和容器的运行，但kubernetes调度最小单位并非是container，而是pod，pod中可包含多个container，通常集群中不会直接运行pod，而是通过各种工作负载的控制器如Deployments，ReplicaSets，DaemonSets的方式运行，为啥？因为控制器能够保证pod状态的一致性，正如官方所描述的一样“make sure the current state match to the desire state”，确保当前状态和预期的一致，简单来说就是pod异常了，控制器会在其他节点重建，确保集群当前运行的pod和预期设定的一致。</p><ul><li>pod是kubernetes中运行的最小单元</li><li>pod中包含一个容器或者多个容器</li><li>pod不会单独使用，需要有工作负载来控制，如Deployments，StatefulSets，DaemonSets，CronJobs等</li></ul><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/2%20-%201620.jpg data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/2%20-%201620.jpg, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/2%20-%201620.jpg 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/2%20-%201620.jpg 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/2%20-%201620.jpg title=img>container与pod</p><ul><li>Container，容器是一种轻量化的虚拟化技术，通过将应用封装在镜像中，实现便捷部署，应用分发。</li><li>Pod，kubernetes中最小的调度单位，封装容器，包含一个pause容器和应用容器，容器之间共享相同的命名空间，网络，存储，共享进程。</li><li>Deployments，部署组也称应用，严格上来说是无状态化工作负载，另外一种由状态化工组负载是StatefulSets，Deployments是一种控制器，可以控制工作负载的副本数replicas，通过kube-controller-manager中的Deployments Controller实现副本数状态的控制。</li></ul><h2 id=13-服务访问>1.3 服务访问</h2><p>kubernetes中pod是实际运行的载体，pod依附于node中，node可能会出现故障，kubernetes的控制器如replicasets会在其他node上重新拉起一个pod，新的pod会分配一个新的IP；再者，应用部署时会包含多个副本replicas，如同个应用deployments部署了3个pod副本，pod相当于后端的Real Server，如何实现这三个应用访问呢？对于这种情况，我们一般会在Real Server前面加一个负载均衡Load Balancer，service就是pod的负载均衡调度器，service将动态的pod抽象为一个服务，应用程序直接访问service即可，service会自动将请求转发到后端的pod。负责service转发规则有两种机制：iptables和ipvs，iptables通过设置DNAT等规则实现负载均衡，ipvs通过ipvsadm设置转发规。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/3%20-%201620.jpg data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/3%20-%201620.jpg, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/3%20-%201620.jpg 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/3%20-%201620.jpg 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/3%20-%201620.jpg title=img>service概念</p><p>根据服务不同的访问方式，service分为如下几种类型：ClusterIP，NodePort，LoadBalancer和_ExternalName，可通过type设置。</p><ul><li>ClusterIP，集群内部互访，与DNS结合实现集群内部的服务发现；</li><li>NodePort，通过NAT将每个node节点暴露一个端口实现外部访问；</li><li>LoadBalancer，实现云厂商外部接入方式的接口，需要依赖云服务提供商实现具体技术细节，如腾讯云实现与CLB集成；</li><li>ExternalName，通过服务名字暴露服务名，当前可由ingress实现，将外部的请求以域名转发的形式转发到集群，需要依附具体的外部实现，如nginx，traefik,各大云计算厂商实现接入细节。</li></ul><p>pod是动态变化的，ip地址可能会变化（如node故障），副本数可能会变化，如应用扩展scale up，应用锁容scale down等，service如何识别到pod的动态变化呢？答案是labels，通过labels自动会过滤出某个应用的Endpoints，当pod变化时会自动更新Endpoints，不同的应用会有由不同的label组成。labels相关可以参考下https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/</p><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/4%20-%201620.jpg data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/4%20-%201620.jpg, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/4%20-%201620.jpg 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/4%20-%201620.jpg 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/4%20-%201620.jpg title=img>service与labels</p><h1 id=2-创建应用>2. 创建应用</h1><p>我们开始部署一个应用即deployments，kubernetes中包含各种workload如无状态话的Deployments，有状态化的StatefulSets，守护进程的DaemonSets，每种workload对应不同的应用场景，我们先以Deployments为例入门，其他workload均以此类似，一般而言，在kubernetes中部署应用均以yaml文件方式部署，对于初学者而言，编写yaml文件太冗长，不适合初学，我们先kubectl命令行方式实现API的接入。</p><p>1、部署nginx应用，部署三个副本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>image</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span> <span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>3</span> 
<span class=nx>kubectl</span> <span class=nx>run</span> <span class=o>--</span><span class=nx>generator</span><span class=o>=</span><span class=nx>deployment</span><span class=o>/</span><span class=nx>apps</span><span class=p>.</span><span class=nx>v1</span> <span class=nx>is</span> <span class=nx>DEPRECATED</span> <span class=nx>and</span> <span class=nx>will</span> <span class=nx>be</span> <span class=nx>removed</span> <span class=k>in</span> <span class=nx>a</span> <span class=nx>future</span> <span class=nx>version</span><span class=p>.</span> <span class=nx>Use</span> <span class=nx>kubectl</span> <span class=nx>run</span> <span class=o>--</span><span class=nx>generator</span><span class=o>=</span><span class=nx>run</span><span class=o>-</span><span class=nx>pod</span><span class=o>/</span><span class=nx>v1</span> <span class=nx>or</span> <span class=nx>kubectl</span> <span class=nx>create</span> <span class=nx>instead</span><span class=p>.</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>2、查看应用列表,可以看到当前pod的状态均已正常，Ready是当前状态，AVAILABLE是目标状态</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span>
<span class=nx>NAME</span>             <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>3</span><span class=o>/</span><span class=mi>3</span>     <span class=mi>3</span>            <span class=mi>3</span>           <span class=mi>72</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>3、查看应用的详细信息,如下我们可以知道Deployments是通过ReplicaSets控制副本数的，由Replicaset控制pod数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>deployments</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>                   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>     <span class=err>#</span><span class=nx>应用名称</span>
<span class=nx>Namespace</span><span class=o>:</span>              <span class=k>default</span>            <span class=err>#</span><span class=nx>命名空间</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>      <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>21</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>32</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>                 <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=err>#</span><span class=nx>labels</span><span class=err>，</span><span class=nx>很重要</span><span class=err>，</span><span class=nx>后续service通过labels实现访问</span>
<span class=nx>Annotations</span><span class=o>:</span>            <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>revision</span><span class=o>:</span> <span class=mi>1</span> <span class=err>#</span><span class=nx>滚动升级版本号</span>
<span class=nx>Selector</span><span class=o>:</span>               <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=err>#</span><span class=nx>labels的选择器selector</span>
<span class=nx>Replicas</span><span class=o>:</span>               <span class=mi>3</span> <span class=nx>desired</span> <span class=o>|</span> <span class=mi>3</span> <span class=nx>updated</span> <span class=o>|</span> <span class=mi>3</span> <span class=nx>total</span> <span class=o>|</span> <span class=mi>3</span> <span class=nx>available</span> <span class=o>|</span> <span class=mi>0</span> <span class=nx>unavailable</span> <span class=err>#</span><span class=nx>副本控制器</span>
<span class=nx>StrategyType</span><span class=o>:</span>           <span class=nx>RollingUpdate</span>     <span class=err>#</span><span class=nx>升级策略为RollingUpdate</span>
<span class=nx>MinReadySeconds</span><span class=o>:</span>        <span class=mi>0</span>
<span class=nx>RollingUpdateStrategy</span><span class=o>:</span>  <span class=mi>25</span><span class=o>%</span> <span class=nx>max</span> <span class=nx>unavailable</span><span class=p>,</span> <span class=mi>25</span><span class=o>%</span> <span class=nx>max</span> <span class=nx>surge</span> <span class=err>#</span><span class=nx>RollingUpdate升级策略</span><span class=err>，</span><span class=nx>即最大不超过25</span><span class=o>%</span><span class=nx>的pod</span>
<span class=nx>Pod</span> <span class=nx>Template</span><span class=o>:</span>   <span class=err>#</span><span class=nx>容器应用模版</span><span class=err>，</span><span class=nx>包含镜像</span><span class=err>，</span><span class=nx>port</span><span class=err>，</span><span class=nx>存储等</span>
  <span class=nx>Labels</span><span class=o>:</span>  <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>Containers</span><span class=o>:</span>
   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Image</span><span class=o>:</span>        <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>Port</span><span class=o>:</span>         <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>    <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
  <span class=nx>Volumes</span><span class=o>:</span>        <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Conditions</span><span class=o>:</span>  <span class=err>#</span><span class=nx>当前状态</span>
  <span class=nx>Type</span>           <span class=nx>Status</span>  <span class=nx>Reason</span>
  <span class=o>----</span>           <span class=o>------</span>  <span class=o>------</span>
  <span class=nx>Available</span>      <span class=nx>True</span>    <span class=nx>MinimumReplicasAvailable</span>
  <span class=nx>Progressing</span>    <span class=nx>True</span>    <span class=nx>NewReplicaSetAvailable</span>
<span class=nx>OldReplicaSets</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>NewReplicaSet</span><span class=o>:</span>   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=p>(</span><span class=mi>3</span><span class=o>/</span><span class=mi>3</span> <span class=nx>replicas</span> <span class=nx>created</span><span class=p>)</span> <span class=err>#</span><span class=nx>ReplicaSets控制器名称</span>
<span class=nx>Events</span><span class=o>:</span>  <span class=err>#</span><span class=nx>运行事件</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>             <span class=nx>Age</span>    <span class=nx>From</span>                   <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>             <span class=o>----</span>   <span class=o>----</span>                   <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>3</span><span class=nx>m24s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>3</span>
</code></pre></td></tr></table></div></div><p>4、查看replicasets情况，通过查看可知replicasets副本控制器生成了三个pod</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>查看replicasets列表</span>
  <span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span>
<span class=nx>NAME</span>                        <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span>   <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>9</span><span class=nx>m9s</span>

<span class=mf>2.</span> <span class=nx>查看replicasets详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>replicasets</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> 
<span class=nx>Name</span><span class=o>:</span>           <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span>
<span class=nx>Namespace</span><span class=o>:</span>      <span class=k>default</span>
<span class=nx>Selector</span><span class=o>:</span>       <span class=nx>pod</span><span class=o>-</span><span class=nx>template</span><span class=o>-</span><span class=nx>hash</span><span class=o>=</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=p>,</span><span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Labels</span><span class=o>:</span>         <span class=nx>pod</span><span class=o>-</span><span class=nx>template</span><span class=o>-</span><span class=nx>hash</span><span class=o>=</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=err>#</span><span class=nx>labels</span><span class=err>，</span><span class=nx>增加了一个hash的label识别replicasets</span>
                <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>    <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>desired</span><span class=o>-</span><span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span> <span class=err>#</span><span class=nx>滚动升级的信息</span><span class=err>，</span><span class=nx>副本树</span><span class=err>，</span><span class=nx>最大数</span><span class=err>，</span><span class=nx>应用版本</span>
                <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>max</span><span class=o>-</span><span class=nx>replicas</span><span class=o>:</span> <span class=mi>4</span>
                <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>revision</span><span class=o>:</span> <span class=mi>1</span>
<span class=nx>Controlled</span> <span class=nx>By</span><span class=o>:</span>  <span class=nx>Deployment</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=err>#</span><span class=nx>副本的父控制</span><span class=err>，</span><span class=nx>为nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo这个Deployments</span>
<span class=nx>Replicas</span><span class=o>:</span>       <span class=mi>3</span> <span class=nx>current</span> <span class=o>/</span> <span class=mi>3</span> <span class=nx>desired</span>
<span class=nx>Pods</span> <span class=nx>Status</span><span class=o>:</span>    <span class=mi>3</span> <span class=nx>Running</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Waiting</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Succeeded</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Failed</span>
<span class=nx>Pod</span> <span class=nx>Template</span><span class=o>:</span>  <span class=err>#</span><span class=nx>容器模板</span><span class=err>，</span><span class=nx>继承于deployments</span>
  <span class=nx>Labels</span><span class=o>:</span>  <span class=nx>pod</span><span class=o>-</span><span class=nx>template</span><span class=o>-</span><span class=nx>hash</span><span class=o>=</span><span class=mi>7</span><span class=nx>bdfd97dcd</span>
           <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>Containers</span><span class=o>:</span>
   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Image</span><span class=o>:</span>        <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>Port</span><span class=o>:</span>         <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>    <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
  <span class=nx>Volumes</span><span class=o>:</span>        <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Events</span><span class=o>:</span> <span class=err>#</span><span class=nx>事件日志</span><span class=err>，</span><span class=nx>生成了三个不同的pod</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>            <span class=nx>Age</span>    <span class=nx>From</span>                   <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>            <span class=o>----</span>   <span class=o>----</span>                   <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>9</span><span class=nx>m25s</span>  <span class=nx>replicaset</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>9</span><span class=nx>m25s</span>  <span class=nx>replicaset</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>9</span><span class=nx>m25s</span>  <span class=nx>replicaset</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>
</code></pre></td></tr></table></div></div><p>5、查看pod的情况,实际应用部署的载体，pod中部署了一个nginx的容器并分配了一个ip，可通过该ip直接访问应用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>查看pod的列表</span><span class=err>，</span><span class=nx>和replicasets生成的名称一致</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span>
<span class=nx>NAME</span>                              <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>13</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>13</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>13</span><span class=nx>m</span>

<span class=nx>查看pod的详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>pods</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span> 
<span class=nx>Name</span><span class=o>:</span>               <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>
<span class=nx>Namespace</span><span class=o>:</span>          <span class=k>default</span>
<span class=nx>Priority</span><span class=o>:</span>           <span class=mi>0</span>
<span class=nx>PriorityClassName</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Node</span><span class=o>:</span>               <span class=nx>node</span><span class=o>-</span><span class=mi>3</span><span class=o>/</span><span class=mf>10.254.100.103</span>
<span class=nx>Start</span> <span class=nx>Time</span><span class=o>:</span>         <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>21</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>32</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>             <span class=nx>pod</span><span class=o>-</span><span class=nx>template</span><span class=o>-</span><span class=nx>hash</span><span class=o>=</span><span class=mi>7</span><span class=nx>bdfd97dcd</span>  <span class=err>#</span><span class=nx>labels名称</span>
                    <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>        <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Status</span><span class=o>:</span>             <span class=nx>Running</span>
<span class=nx>IP</span><span class=o>:</span>                 <span class=mf>10.244.2.4</span> <span class=err>#</span><span class=nx>pod的ip地址</span>
<span class=nx>Controlled</span> <span class=nx>By</span><span class=o>:</span>      <span class=nx>ReplicaSet</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=err>#</span><span class=nx>副本控制器为replicasets</span>
<span class=nx>Containers</span><span class=o>:</span>   <span class=err>#</span><span class=nx>容器的信息</span><span class=err>，</span><span class=nx>包括容器id</span><span class=err>，</span><span class=nx>镜像</span><span class=err>，</span><span class=nx>丢按扣</span><span class=err>，</span><span class=nx>状态</span><span class=err>，</span><span class=nx>环境变量等信息</span>
  <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Container</span> <span class=nx>ID</span><span class=o>:</span>   <span class=nx>docker</span><span class=o>:</span><span class=c1>//5a0e5560583c5929e9768487cef43b045af4c6d3b7b927d9daf181cb28867766
</span><span class=c1></span>    <span class=nx>Image</span><span class=o>:</span>          <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>Image</span> <span class=nx>ID</span><span class=o>:</span>       <span class=nx>docker</span><span class=o>-</span><span class=nx>pullable</span><span class=o>:</span><span class=c1>//nginx@sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451
</span><span class=c1></span>    <span class=nx>Port</span><span class=o>:</span>           <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>      <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>State</span><span class=o>:</span>          <span class=nx>Running</span>
      <span class=nx>Started</span><span class=o>:</span>      <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>21</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>40</span> <span class=o>+</span><span class=mi>0800</span>
    <span class=nx>Ready</span><span class=o>:</span>          <span class=nx>True</span>
    <span class=nx>Restart</span> <span class=nx>Count</span><span class=o>:</span>  <span class=mi>0</span>
    <span class=nx>Environment</span><span class=o>:</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>
      <span class=err>/var/run/secrets/kubernetes.io/serviceaccount from default-token-txhkc (ro)</span>
<span class=nx>Conditions</span><span class=o>:</span> <span class=err>#</span><span class=nx>容器的状态条件</span>
  <span class=nx>Type</span>              <span class=nx>Status</span>
  <span class=nx>Initialized</span>       <span class=nx>True</span> 
  <span class=nx>Ready</span>             <span class=nx>True</span> 
  <span class=nx>ContainersReady</span>   <span class=nx>True</span> 
  <span class=nx>PodScheduled</span>      <span class=nx>True</span> 
<span class=nx>Volumes</span><span class=o>:</span>    <span class=err>#</span><span class=nx>容器卷</span>
  <span class=k>default</span><span class=o>-</span><span class=nx>token</span><span class=o>-</span><span class=nx>txhkc</span><span class=o>:</span>
    <span class=nx>Type</span><span class=o>:</span>        <span class=nx>Secret</span> <span class=p>(</span><span class=nx>a</span> <span class=nx>volume</span> <span class=nx>populated</span> <span class=nx>by</span> <span class=nx>a</span> <span class=nx>Secret</span><span class=p>)</span>
    <span class=nx>SecretName</span><span class=o>:</span>  <span class=k>default</span><span class=o>-</span><span class=nx>token</span><span class=o>-</span><span class=nx>txhkc</span>
    <span class=nx>Optional</span><span class=o>:</span>    <span class=kc>false</span>
<span class=nx>QoS</span> <span class=nx>Class</span><span class=o>:</span>       <span class=nx>BestEffort</span> <span class=err>#</span><span class=nx>QOS类型</span>
<span class=nx>Node</span><span class=o>-</span><span class=nx>Selectors</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span> <span class=err>#</span><span class=nx>污点类型</span>
<span class=nx>Tolerations</span><span class=o>:</span>     <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>not</span><span class=o>-</span><span class=nx>ready</span><span class=o>:</span><span class=nx>NoExecute</span> <span class=k>for</span> <span class=mi>300</span><span class=nx>s</span>
                 <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>unreachable</span><span class=o>:</span><span class=nx>NoExecute</span> <span class=k>for</span> <span class=mi>300</span><span class=nx>s</span>
<span class=nx>Events</span><span class=o>:</span>  <span class=err>#</span><span class=nx>事件状态</span><span class=err>，</span><span class=nx>拉镜像</span><span class=err>，</span><span class=nx>启动容器</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>     <span class=nx>Age</span>   <span class=nx>From</span>               <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>     <span class=o>----</span>  <span class=o>----</span>               <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>Scheduled</span>  <span class=mi>14</span><span class=nx>m</span>   <span class=k>default</span><span class=o>-</span><span class=nx>scheduler</span>  <span class=nx>Successfully</span> <span class=nx>assigned</span> <span class=k>default</span><span class=err>/nginx-app-demo-7bdfd97dcd-7t72x to node-3</span>
  <span class=nx>Normal</span>  <span class=nx>Pulling</span>    <span class=mi>14</span><span class=nx>m</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>    <span class=nx>Pulling</span> <span class=nx>image</span> <span class=s2>&#34;nginx:1.7.9&#34;</span>
  <span class=nx>Normal</span>  <span class=nx>Pulled</span>     <span class=mi>14</span><span class=nx>m</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>    <span class=nx>Successfully</span> <span class=nx>pulled</span> <span class=nx>image</span> <span class=s2>&#34;nginx:1.7.9&#34;</span>
  <span class=nx>Normal</span>  <span class=nx>Created</span>    <span class=mi>14</span><span class=nx>m</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>    <span class=nx>Created</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>Normal</span>  <span class=nx>Started</span>    <span class=mi>14</span><span class=nx>m</span>   <span class=nx>kubelet</span><span class=p>,</span> <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>    <span class=nx>Started</span> <span class=nx>container</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
</code></pre></td></tr></table></div></div><h1 id=3-访问应用>3. 访问应用</h1><p>kubernetes为每个pod都分配了一个ip地址，可通过该地址直接访问应用，相当于访问RS，但一个应用是一个整体，由多个副本数组成，需要依赖于service来实现应用的负载均衡，service我们探讨ClusterIP和NodePort的访问方式。</p><p>1、设置pod的内容，为了方便区分，我们将三个pod的nginx站点内容设置为不同，以观察负载均衡的效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>查看pod列表</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span>
<span class=nx>NAME</span>                              <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>28</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>28</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>28</span><span class=nx>m</span>

<span class=nx>进入pod容器中</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>exec</span> <span class=o>-</span><span class=nx>it</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span> <span class=o>/</span><span class=nx>bin</span><span class=o>/</span><span class=nx>bash</span>

<span class=nx>设置站点内容</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span><span class=o>:</span><span class=err>/# echo &#34;web1&#34; &gt;/usr/share/nginx/html/index.html</span>
 
<span class=nx>以此类推设置另外两个pod的内容为web2和web3</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span><span class=o>:</span><span class=err>/# echo web2 &gt;/usr/share/nginx/html/index.html</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span><span class=o>:</span><span class=err>/# echo web3 &gt;/usr/share/nginx/html/index.html</span>
</code></pre></td></tr></table></div></div><p>2、获取pod的ip地址，如何快速获取pod的ip地址呢，可以通过-o wide参数显示更多的内容,会包含pod所属node和ip</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                              <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>   <span class=nx>IP</span>           <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>34</span><span class=nx>m</span>   <span class=mf>10.244.2.4</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>34</span><span class=nx>m</span>   <span class=mf>10.244.1.2</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>34</span><span class=nx>m</span>   <span class=mf>10.244.1.3</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>3、访问pod的ip，查看站点内容,不同的pod站点内容和上述步骤设置一致。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.244.2.4
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.244.1.2
</span><span class=c1></span><span class=nx>web2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.244.1.3
</span><span class=c1></span><span class=nx>web3</span>
</code></pre></td></tr></table></div></div><h2 id=31-clusterip访问>3.1 ClusterIP访问</h2><p>通过pod的ip直接访问应用，对于单个pod的应用可以实现，对于多个副本replicas的应用则不符合要求，需要通过service来实现负载均衡，service需要设置不同的type，默认为ClusterIP即集群内部访问，如下通过expose子命令将服务暴露到service。</p><p>1、暴露service,其中port表示代理监听端口，target-port代表是容器的端口，type设置的是service的类型</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>expose</span> <span class=nx>deployment</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>name</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> <span class=o>\</span>
<span class=o>--</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>\</span>
<span class=o>--</span><span class=nx>protocol</span><span class=o>=</span><span class=nx>TCP</span> <span class=o>\</span>
<span class=o>--</span><span class=nx>target</span><span class=o>-</span><span class=nx>port</span><span class=o>=</span><span class=mi>80</span> <span class=o>\</span>
<span class=o>--</span><span class=nx>type</span> <span class=nx>ClusterIP</span> 
<span class=nx>service</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>exposed</span>
</code></pre></td></tr></table></div></div><p>2、查看service的详情，可以看到service通过labels选择器selector自动将pod的ip生成endpoints</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>查看service列表</span><span class=err>，</span><span class=nx>显示有两个</span><span class=err>，</span><span class=nx>kubernetes为默认集群创建的service</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>services</span>
<span class=nx>NAME</span>                 <span class=nx>TYPE</span>        <span class=nx>CLUSTER</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>EXTERNAL</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>PORT</span><span class=p>(</span><span class=nx>S</span><span class=p>)</span>   <span class=nx>AGE</span>
<span class=nx>kubernetes</span>           <span class=nx>ClusterIP</span>   <span class=mf>10.96.0.1</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>443</span><span class=o>/</span><span class=nx>TCP</span>   <span class=mi>29</span><span class=nx>h</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>   <span class=nx>ClusterIP</span>   <span class=mf>10.102.1.1</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>    <span class=mi>2</span><span class=nx>m54s</span>

<span class=nx>查看service详情</span><span class=err>，</span><span class=nx>可以看到Labels的Seletor和前面Deployments设置一致</span><span class=err>，</span><span class=nx>Endpoints将pod组成一个列表</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>services</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>              <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>   <span class=err>#</span><span class=nx>名称</span>
<span class=nx>Namespace</span><span class=o>:</span>         <span class=k>default</span>              <span class=err>#</span><span class=nx>命名空间</span>
<span class=nx>Labels</span><span class=o>:</span>            <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>   <span class=err>#</span><span class=nx>标签名称</span>
<span class=nx>Annotations</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Selector</span><span class=o>:</span>          <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>   <span class=err>#</span><span class=nx>标签选择器</span>
<span class=nx>Type</span><span class=o>:</span>              <span class=nx>ClusterIP</span>            <span class=err>#</span><span class=nx>service类型为ClusterIP</span>
<span class=nx>IP</span><span class=o>:</span>                <span class=mf>10.102.1.1</span>           <span class=err>#</span><span class=nx>服务的ip</span><span class=err>，</span><span class=nx>即vip</span><span class=err>，</span><span class=nx>集群内部会自动分配一个</span>
<span class=nx>Port</span><span class=o>:</span>              <span class=o>&lt;</span><span class=nx>unset</span><span class=o>&gt;</span>  <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>      <span class=err>#</span><span class=nx>服务端口</span><span class=err>，</span><span class=nx>即ClusterIP对外访问的端口</span>
<span class=nx>TargetPort</span><span class=o>:</span>        <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>               <span class=err>#</span><span class=nx>容器端口</span>
<span class=nx>Endpoints</span><span class=o>:</span>         <span class=mf>10.244.1.2</span><span class=o>:</span><span class=mi>80</span><span class=p>,</span><span class=mf>10.244.1.3</span><span class=o>:</span><span class=mi>80</span><span class=p>,</span><span class=mf>10.244.2.4</span><span class=o>:</span><span class=mi>80</span> <span class=err>#</span><span class=nx>访问地址列表</span>
<span class=nx>Session</span> <span class=nx>Affinity</span><span class=o>:</span>  <span class=nx>None</span>                 <span class=err>#</span><span class=nx>负载均衡调度算法</span>
<span class=nx>Events</span><span class=o>:</span>            <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>3、访问service的地址，可以访问的内容可知，service自动实现了pods的负载均衡，调度策略为轮询，为何？因为service默认的调度策略Session Affinity为None，即是轮训，可以设置为ClientIP，实现会话保持，相同客户端IP的请求会调度到相同的pod上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web3</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span></code></pre></td></tr></table></div></div><p>4、ClusterIP原理深入剖析，service后端实现有两种机制：iptables和ipvs，环境安装采用iptables，iptables通过nat的链生成访问规则，KUBE-SVC-R5Y5DZHD7Q6DDTFZ为入站DNAT转发规则，KUBE-MARK-MASQ为出站转发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SERVICES</span> <span class=p>(</span><span class=mi>2</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>tcp</span>  <span class=o>--</span> <span class=o>!</span><span class=mf>10.244.0.0</span><span class=o>/</span><span class=mi>16</span>        <span class=mf>10.102.1.1</span>           <span class=cm>/* default/nginx-service-demo: cluster IP */</span> <span class=nx>tcp</span> <span class=nx>dpt</span><span class=o>:</span><span class=mi>80</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span>  <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>10.102.1.1</span>           <span class=cm>/* default/nginx-service-demo: cluster IP */</span> <span class=nx>tcp</span> <span class=nx>dpt</span><span class=o>:</span><span class=mi>80</span>

<span class=nx>出站</span><span class=err>：</span><span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ源地址段不是10</span><span class=mf>.244.0.0</span><span class=o>/</span><span class=mi>16</span><span class=nx>访问10</span><span class=mf>.102.1.1</span><span class=nx>的目标端口80时</span><span class=err>，</span><span class=nx>将请求转发给KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ链</span>
<span class=nx>入站</span><span class=err>：</span><span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ任意原地址访问目标10</span><span class=mf>.102.1.1</span><span class=nx>的目标端口80时将请求转发给KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ链</span>
</code></pre></td></tr></table></div></div><p>5、查看入站请求规则，入站请求规则将会映射到不同的链，不同链将会转发到不同pod的ip上。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>查看入站规则KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span><span class=err>，</span><span class=nx>请求将转发至三条链</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span> <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>statistic</span> <span class=nx>mode</span> <span class=nx>random</span> <span class=nx>probability</span> <span class=mf>0.33332999982</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>statistic</span> <span class=nx>mode</span> <span class=nx>random</span> <span class=nx>probability</span> <span class=mf>0.50000000000</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span> 

<span class=mf>2.</span> <span class=nx>查看实际转发的三条链的规则</span><span class=p>,</span><span class=nx>实际映射到不同的pod的ip地址上</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span>  <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.1.2</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.1.2</span><span class=o>:</span><span class=mi>80</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span>  <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.1.3</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.1.3</span><span class=o>:</span><span class=mi>80</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span>   <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.2.4</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.2.4</span><span class=o>:</span><span class=mi>80</span>     
</code></pre></td></tr></table></div></div><h2 id=32-nodeport访问>3.2 NodePort访问</h2><p>Service通过ClusterIP只能提供集群内部的应用访问，外部无法直接访问应用，如果需要外部访问有如下几种方式：NodePort，LoadBalancer和Ingress，其中LoadBalancer需要由云服务提供商实现，Ingress需要安装单独的Ingress Controller，日常测试可以通过NodePort的方式实现，NodePort可以将node的某个端口暴露给外部网络访问。</p><p>1、修改type的类型由ClusterIP修改为NodePort类型（或者重新创建，指定type的类型为NodePort）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>通过patch修改type的类型</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>patch</span> <span class=nx>services</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> <span class=o>-</span><span class=nx>p</span> <span class=s1>&#39;{&#34;spec&#34;:{&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>
<span class=nx>service</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>patched</span>

<span class=mf>2.</span> <span class=nx>确认yaml文件配置</span><span class=err>，</span><span class=nx>分配了一个NodePort端口</span><span class=err>，</span><span class=nx>即每个node上都会监听该端口</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>services</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>yaml</span>
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Service</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>creationTimestamp</span><span class=o>:</span> <span class=s2>&#34;2019-08-11T14:35:59Z&#34;</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>namespace</span><span class=o>:</span> <span class=k>default</span>
  <span class=nx>resourceVersion</span><span class=o>:</span> <span class=s2>&#34;157676&#34;</span>
  <span class=nx>selfLink</span><span class=o>:</span> <span class=err>/api/v1/namespaces/default/services/nginx-service-demo</span>
  <span class=nx>uid</span><span class=o>:</span> <span class=mi>55</span><span class=nx>e29b78</span><span class=o>-</span><span class=nx>bc45</span><span class=o>-</span><span class=mi>11</span><span class=nx>e9</span><span class=o>-</span><span class=nx>b073</span><span class=o>-</span><span class=mi>525400490421</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>clusterIP</span><span class=o>:</span> <span class=mf>10.102.1.1</span>
  <span class=nx>externalTrafficPolicy</span><span class=o>:</span> <span class=nx>Cluster</span>
  <span class=nx>ports</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>nodePort</span><span class=o>:</span> <span class=mi>32416</span> <span class=err>#</span><span class=nx>自动分配了一个NodePort端口</span>
    <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
    <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
    <span class=nx>targetPort</span><span class=o>:</span> <span class=mi>80</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>sessionAffinity</span><span class=o>:</span> <span class=nx>None</span>
  <span class=nx>type</span><span class=o>:</span> <span class=nx>NodePort</span> <span class=err>#</span><span class=nx>类型修改为NodePort</span>
<span class=nx>status</span><span class=o>:</span>
  <span class=nx>loadBalancer</span><span class=o>:</span> <span class=p>{}</span>
  
<span class=mf>3.</span> <span class=nx>查看service列表</span><span class=err>，</span><span class=nx>可以知道service的type已经修改为NodePort</span><span class=p>,</span><span class=nx>同时还保留ClusterIP的访问IP</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>services</span>
<span class=nx>NAME</span>                 <span class=nx>TYPE</span>        <span class=nx>CLUSTER</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>EXTERNAL</span><span class=o>-</span><span class=nx>IP</span>   <span class=nx>PORT</span><span class=p>(</span><span class=nx>S</span><span class=p>)</span>        <span class=nx>AGE</span>
<span class=nx>kubernetes</span>           <span class=nx>ClusterIP</span>   <span class=mf>10.96.0.1</span>    <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>443</span><span class=o>/</span><span class=nx>TCP</span>        <span class=mi>30</span><span class=nx>h</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>   <span class=nx>NodePort</span>    <span class=mf>10.102.1.1</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>        <span class=mi>80</span><span class=o>:</span><span class=mi>32416</span><span class=o>/</span><span class=nx>TCP</span>   <span class=mi>68</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>2、通过NodePort访问应用程序,每个node的地址相当于vip，可以实现相同的负载均衡效果，同时CluserIP功能依可用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>NodePort的负载均衡</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//node-1:32416
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//node-2:32416
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//node-3:32416
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//node-3:32416
</span><span class=c1></span><span class=nx>web3</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//node-3:32416
</span><span class=c1></span><span class=nx>web2</span>

<span class=mf>2.</span> <span class=nx>ClusterIP的负载均衡</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web3</span>
</code></pre></td></tr></table></div></div><p>3、NodePort转发原理，每个node上通过kube-proxy监听NodePort的端口，由后端的iptables实现端口的转发</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=mf>1.</span> <span class=nx>NodePort监听端口</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>netstat</span> <span class=o>-</span><span class=nx>antupl</span> <span class=o>|</span><span class=nx>grep</span> <span class=mi>32416</span>
<span class=nx>tcp6</span>       <span class=mi>0</span>      <span class=mi>0</span> <span class=o>:::</span><span class=mi>32416</span>                <span class=o>:::*</span>                    <span class=nx>LISTEN</span>      <span class=mi>32052</span><span class=o>/</span><span class=nx>kube</span><span class=o>-</span><span class=nx>proxy</span> 

<span class=mf>2.</span> <span class=nx>查看nat表的转发规则</span><span class=err>，</span><span class=nx>有两条规则KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ出口和KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ入站方向</span><span class=err>。</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>NODEPORTS</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=cm>/* default/nginx-service-demo: */</span> <span class=nx>tcp</span> <span class=nx>dpt</span><span class=o>:</span><span class=mi>32416</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span>  <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=cm>/* default/nginx-service-demo: */</span> <span class=nx>tcp</span> <span class=nx>dpt</span><span class=o>:</span><span class=mi>32416</span>

<span class=mf>3.</span> <span class=nx>查看入站的请求规则链KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span> 
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span>  <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SVC</span><span class=o>-</span><span class=nx>R5Y5DZHD7Q6DDTFZ</span> <span class=p>(</span><span class=mi>2</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>statistic</span> <span class=nx>mode</span> <span class=nx>random</span> <span class=nx>probability</span> <span class=mf>0.33332999982</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>statistic</span> <span class=nx>mode</span> <span class=nx>random</span> <span class=nx>probability</span> <span class=mf>0.50000000000</span>
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>          

<span class=mf>4.</span> <span class=nx>继续查看转发链</span><span class=err>，</span><span class=nx>包含有DNAT转发和KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ和出站返回的规则</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span>  <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>DSWLUQNR4UPH24AX</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.1.2</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.1.2</span><span class=o>:</span><span class=mi>80</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span>  <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=mi>56</span><span class=nx>SLMGHHOILJT36K</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.1.3</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.1.3</span><span class=o>:</span><span class=mi>80</span>


<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>iptables</span> <span class=o>-</span><span class=nx>t</span> <span class=nx>nat</span> <span class=o>-</span><span class=nx>L</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span>   <span class=o>-</span><span class=nx>n</span>
<span class=nx>Chain</span> <span class=nx>KUBE</span><span class=o>-</span><span class=nx>SEP</span><span class=o>-</span><span class=nx>K6G4Z74HQYF6X7SI</span> <span class=p>(</span><span class=mi>1</span> <span class=nx>references</span><span class=p>)</span>
<span class=nx>target</span>     <span class=nx>prot</span> <span class=nx>opt</span> <span class=nx>source</span>               <span class=nx>destination</span>         
<span class=nx>KUBE</span><span class=o>-</span><span class=nx>MARK</span><span class=o>-</span><span class=nx>MASQ</span>  <span class=nx>all</span>  <span class=o>--</span>  <span class=mf>10.244.2.4</span>           <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>           
<span class=nx>DNAT</span>       <span class=nx>tcp</span>  <span class=o>--</span>  <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=mf>0.0.0.0</span><span class=o>/</span><span class=mi>0</span>            <span class=nx>tcp</span> <span class=nx>to</span><span class=o>:</span><span class=mf>10.244.2.4</span><span class=o>:</span><span class=mi>80</span>
</code></pre></td></tr></table></div></div><h1 id=4-扩展应用>4. 扩展应用</h1><p>当应用程序的负载比较高无法满足应用请求时，一般我们会通过扩展RS的数量来实现，在kubernetes中，扩展RS实际上通过扩展副本数replicas来实现，扩展RS非常便利，快速实现弹性伸缩。kubernets能提供两种方式的伸缩能力：1. 手动伸缩能力scale up和scale down，2. 动态的弹性伸缩horizontalpodautoscalers,基于CPU的利用率实现自动的弹性伸缩，需要依赖与监控组件如metrics server，当前未实现，后续再做深入探讨，本文以手动的scale的方式扩展应用的副本数。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/5%20-%20xhtrt4wou1.gif data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/5%20-%20xhtrt4wou1.gif, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/5%20-%20xhtrt4wou1.gif 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/5%20-%20xhtrt4wou1.gif 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/5%20-%20xhtrt4wou1.gif title=img>Deployments副本扩展</p><p>1、手动扩展副本数</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span>  <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>4</span> <span class=nx>deployment</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
</code></pre></td></tr></table></div></div><p>2、查看副本扩展情况,deployments自动部署一个应用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span>
<span class=nx>NAME</span>             <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>4</span><span class=o>/</span><span class=mi>4</span>     <span class=mi>4</span>            <span class=mi>4</span>           <span class=mi>133</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>3、此时service的情况会怎样呢？查看service详情,新扩展的pod会自动更新到service的endpoints中，自动服务发现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>查看service详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>services</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>                     <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>                <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>                   <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>              <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Selector</span><span class=o>:</span>                 <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Type</span><span class=o>:</span>                     <span class=nx>NodePort</span>
<span class=nx>IP</span><span class=o>:</span>                       <span class=mf>10.102.1.1</span>
<span class=nx>Port</span><span class=o>:</span>                     <span class=o>&lt;</span><span class=nx>unset</span><span class=o>&gt;</span>  <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
<span class=nx>TargetPort</span><span class=o>:</span>               <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
<span class=nx>NodePort</span><span class=o>:</span>                 <span class=o>&lt;</span><span class=nx>unset</span><span class=o>&gt;</span>  <span class=mi>32416</span><span class=o>/</span><span class=nx>TCP</span>
<span class=nx>Endpoints</span><span class=o>:</span>                <span class=mf>10.244.1.2</span><span class=o>:</span><span class=mi>80</span><span class=p>,</span><span class=mf>10.244.1.3</span><span class=o>:</span><span class=mi>80</span><span class=p>,</span><span class=mf>10.244.2.4</span><span class=o>:</span><span class=mi>80</span> <span class=o>+</span> <span class=mi>1</span> <span class=nx>more</span><span class=p>...</span><span class=err>#</span><span class=nx>地址已自动加入</span>
<span class=nx>Session</span> <span class=nx>Affinity</span><span class=o>:</span>         <span class=nx>None</span>
<span class=nx>External</span> <span class=nx>Traffic</span> <span class=nx>Policy</span><span class=o>:</span>  <span class=nx>Cluster</span>
<span class=nx>Events</span><span class=o>:</span>                   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>

<span class=nx>查看endpioints详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>endpoints</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>  
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>nginx</span><span class=o>-</span><span class=nx>service</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>endpoints</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>change</span><span class=o>-</span><span class=nx>trigger</span><span class=o>-</span><span class=nx>time</span><span class=o>:</span> <span class=mi>2019</span><span class=o>-</span><span class=mi>08</span><span class=o>-</span><span class=mi>11</span><span class=nx>T16</span><span class=o>:</span><span class=mi>04</span><span class=o>:</span><span class=mi>56</span><span class=nx>Z</span>
<span class=nx>Subsets</span><span class=o>:</span>
  <span class=nx>Addresses</span><span class=o>:</span>          <span class=mf>10.244.1.2</span><span class=p>,</span><span class=mf>10.244.1.3</span><span class=p>,</span><span class=mf>10.244.2.4</span><span class=p>,</span><span class=mf>10.244.2.5</span>
  <span class=nx>NotReadyAddresses</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
  <span class=nx>Ports</span><span class=o>:</span>
    <span class=nx>Name</span>     <span class=nx>Port</span>  <span class=nx>Protocol</span>
    <span class=o>----</span>     <span class=o>----</span>  <span class=o>--------</span>
    <span class=o>&lt;</span><span class=nx>unset</span><span class=o>&gt;</span>  <span class=mi>80</span>    <span class=nx>TCP</span>

<span class=nx>Events</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>4、测试，将新加入的pod站点内容设置为web4，参考前面的设置方法，测试service的ip，查看负载均衡效果</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web4</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web4</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web3</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web1</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web2</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>web1</span>
</code></pre></td></tr></table></div></div><p>由此可知，弹性伸缩会自动自动加入到service中实现服务自动发现和负载均衡，应用的扩展相比于传统应用快速非常多。此外，kubernetes还支持自动弹性扩展的能力，即Horizontal Pod AutoScaler，自动横向伸缩能力，配合监控系统根据CPU的利用率弹性扩展Pod个数，详情可以参考文档<a href=# rel>kubernetes系列教程(十九)使用metric-server让HPA弹性伸缩愉快运行</a></p><h1 id=5-滚动升级>5. 滚动升级</h1><p>在kubernetes中更新应用程序时可以将应用程序打包到镜像中，然后更新应用程序的镜像以实现升级。默认Deployments的升级策略为RollingUpdate，其每次会更新应用中的25%的pod，新建新的pod逐个替换，防止应用程序在升级过程中不可用。同时，如果应用程序升级过程中失败，还可以通过回滚的方式将应用程序回滚到之前的状态，回滚时通过replicasets的方式实现。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/6%20-%20p2mx04luj3.gif data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/6%20-%20p2mx04luj3.gif, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/6%20-%20p2mx04luj3.gif 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/6%20-%20p2mx04luj3.gif 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/6%20-%20p2mx04luj3.gif title=img>滚动更新</p><p>1、更换nginx的镜像，将应用升级至最新版本,打开另外一个窗口使用kubectl get pods -w观察升级过程</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=nx>latest</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>image</span> <span class=nx>updated</span>
</code></pre></td></tr></table></div></div><p>2、观察升级过程，通过查看可知，升级过程中是通过新建+删除的方式逐个替换pod的方式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>w</span>
<span class=nx>NAME</span>                              <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>145</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>145</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>j6lgd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>12</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>145</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>xsxz4</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span> <span class=err>#</span><span class=nx>新建一个pod</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>xsxz4</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>j6lgd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>   <span class=mi>0</span>          <span class=mi>14</span><span class=nx>m</span> <span class=err>#</span><span class=nx>删除旧的pod</span><span class=err>，</span><span class=nx>替换</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>xsxz4</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>ContainerCreating</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>s49nv</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span> <span class=err>#</span><span class=nx>新建第二个pod</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>s49nv</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>s49nv</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>ContainerCreating</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>j6lgd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>14</span><span class=nx>m</span> <span class=err>#</span><span class=nx>更换第二个pod</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>s49nv</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>             <span class=mi>0</span>          <span class=mi>7</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>146</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>txjqh</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>txjqh</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>txjqh</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>ContainerCreating</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>j6lgd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>14</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>j6lgd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>14</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>xsxz4</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>             <span class=mi>0</span>          <span class=mi>9</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>txjqh</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>             <span class=mi>0</span>          <span class=mi>1</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>146</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>146</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>rcpmw</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>rcpmw</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Pending</span>             <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>rcpmw</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>ContainerCreating</span>   <span class=mi>0</span>          <span class=mi>0</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>146</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span><span class=o>-</span><span class=nx>rcpmw</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>             <span class=mi>0</span>          <span class=mi>2</span><span class=nx>s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=mi>7</span><span class=nx>t72x</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>hsrft</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span><span class=o>-</span><span class=nx>qtbzd</span>   <span class=mi>0</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Terminating</span>         <span class=mi>0</span>          <span class=mi>147</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>3、再次查看deployments的详情可知道，deployments已经更换了新的replicasets，原来的replicasets的版本为1，可用于回滚。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>deployments</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>                   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>              <span class=k>default</span>
<span class=nx>CreationTimestamp</span><span class=o>:</span>      <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>21</span><span class=o>:</span><span class=mi>52</span><span class=o>:</span><span class=mi>32</span> <span class=o>+</span><span class=mi>0800</span>
<span class=nx>Labels</span><span class=o>:</span>                 <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Annotations</span><span class=o>:</span>            <span class=nx>deployment</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>revision</span><span class=o>:</span> <span class=mi>2</span> <span class=err>#</span><span class=nx>新的版本号</span><span class=err>，</span><span class=nx>用于回滚</span>
<span class=nx>Selector</span><span class=o>:</span>               <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Replicas</span><span class=o>:</span>               <span class=mi>4</span> <span class=nx>desired</span> <span class=o>|</span> <span class=mi>4</span> <span class=nx>updated</span> <span class=o>|</span> <span class=mi>4</span> <span class=nx>total</span> <span class=o>|</span> <span class=mi>4</span> <span class=nx>available</span> <span class=o>|</span> <span class=mi>0</span> <span class=nx>unavailable</span>
<span class=nx>StrategyType</span><span class=o>:</span>           <span class=nx>RollingUpdate</span>
<span class=nx>MinReadySeconds</span><span class=o>:</span>        <span class=mi>0</span>
<span class=nx>RollingUpdateStrategy</span><span class=o>:</span>  <span class=mi>25</span><span class=o>%</span> <span class=nx>max</span> <span class=nx>unavailable</span><span class=p>,</span> <span class=mi>25</span><span class=o>%</span> <span class=nx>max</span> <span class=nx>surge</span>
<span class=nx>Pod</span> <span class=nx>Template</span><span class=o>:</span>
  <span class=nx>Labels</span><span class=o>:</span>  <span class=nx>run</span><span class=o>=</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>Containers</span><span class=o>:</span>
   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Image</span><span class=o>:</span>        <span class=nx>nginx</span><span class=o>:</span><span class=nx>latest</span>
    <span class=nx>Port</span><span class=o>:</span>         <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>    <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
  <span class=nx>Volumes</span><span class=o>:</span>        <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Conditions</span><span class=o>:</span>
  <span class=nx>Type</span>           <span class=nx>Status</span>  <span class=nx>Reason</span>
  <span class=o>----</span>           <span class=o>------</span>  <span class=o>------</span>
  <span class=nx>Available</span>      <span class=nx>True</span>    <span class=nx>MinimumReplicasAvailable</span>
  <span class=nx>Progressing</span>    <span class=nx>True</span>    <span class=nx>NewReplicaSetAvailable</span>
<span class=nx>OldReplicaSets</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>NewReplicaSet</span><span class=o>:</span>   <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span> <span class=p>(</span><span class=mi>4</span><span class=o>/</span><span class=mi>4</span> <span class=nx>replicas</span> <span class=nx>created</span><span class=p>)</span> <span class=err>#</span><span class=nx>新的replicaset</span><span class=err>，</span><span class=nx>实际是替换新的replicasets</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>             <span class=nx>Age</span>    <span class=nx>From</span>                   <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>             <span class=o>----</span>   <span class=o>----</span>                   <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>19</span><span class=nx>m</span>    <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>4</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m51s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span> <span class=nx>to</span> <span class=mi>1</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m51s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>down</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>3</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m51s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span> <span class=nx>to</span> <span class=mi>2</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m43s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>down</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>2</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m43s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span> <span class=nx>to</span> <span class=mi>3</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m42s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>down</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>1</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m42s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>up</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span> <span class=nx>to</span> <span class=mi>4</span>
  <span class=nx>Normal</span>  <span class=nx>ScalingReplicaSet</span>  <span class=mi>4</span><span class=nx>m42s</span>  <span class=nx>deployment</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Scaled</span> <span class=nx>down</span> <span class=nx>replica</span> <span class=nx>set</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span> <span class=nx>to</span> <span class=mi>0</span>
</code></pre></td></tr></table></div></div><p>4、查看滚动升级的版本，可以看到有两个版本，分别对应的两个不同的replicasets</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>history</span> <span class=nx>deployment</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>REVISION</span>  <span class=nx>CHANGE</span><span class=o>-</span><span class=nx>CAUSE</span>
<span class=mi>1</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=mi>2</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>

<span class=nx>查看replicasets列表</span><span class=p>,</span><span class=nx>旧的包含pod为0</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span>
<span class=nx>NAME</span>                        <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>5</span><span class=nx>cc8746f96</span>   <span class=mi>4</span>         <span class=mi>4</span>         <span class=mi>4</span>       <span class=mi>9</span><span class=nx>m2s</span>
<span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>7</span><span class=nx>bdfd97dcd</span>   <span class=mi>0</span>         <span class=mi>0</span>         <span class=mi>0</span>       <span class=mi>155</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>5、测试应用的升级情况,发现nginx已经升级到最新nginx/1.17.2版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=o>-</span><span class=nx>I</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=nx>OK</span>
<span class=nx>Server</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>/</span><span class=mf>1.17.2</span> <span class=err>#</span><span class=nx>nginx版本信息</span>
<span class=nb>Date</span><span class=o>:</span> <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>16</span><span class=o>:</span><span class=mi>30</span><span class=o>:</span><span class=mi>03</span> <span class=nx>GMT</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Type</span><span class=o>:</span> <span class=nx>text</span><span class=o>/</span><span class=nx>html</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Length</span><span class=o>:</span> <span class=mi>612</span>
<span class=nx>Last</span><span class=o>-</span><span class=nx>Modified</span><span class=o>:</span> <span class=nx>Tue</span><span class=p>,</span> <span class=mi>23</span> <span class=nx>Jul</span> <span class=mi>2019</span> <span class=mi>11</span><span class=o>:</span><span class=mi>45</span><span class=o>:</span><span class=mi>37</span> <span class=nx>GMT</span>
<span class=nx>Connection</span><span class=o>:</span> <span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span>
<span class=nx>ETag</span><span class=o>:</span> <span class=s2>&#34;5d36f361-264&#34;</span>
<span class=nx>Accept</span><span class=o>-</span><span class=nx>Ranges</span><span class=o>:</span> <span class=nx>bytes</span>
</code></pre></td></tr></table></div></div><p>6、回滚到旧的版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>undo</span> <span class=nx>deployment</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>to</span><span class=o>-</span><span class=nx>revision</span><span class=o>=</span><span class=mi>1</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>app</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>rolled</span> <span class=nx>back</span>

<span class=nx>再次测应用</span><span class=p>,</span><span class=nx>已经回滚到旧版本</span><span class=err>。</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=o>-</span><span class=nx>I</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.102.1.1
</span><span class=c1></span><span class=nx>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=nx>OK</span>
<span class=nx>Server</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>/</span><span class=mf>1.7.9</span>
<span class=nb>Date</span><span class=o>:</span> <span class=nx>Sun</span><span class=p>,</span> <span class=mi>11</span> <span class=nx>Aug</span> <span class=mi>2019</span> <span class=mi>16</span><span class=o>:</span><span class=mi>34</span><span class=o>:</span><span class=mi>33</span> <span class=nx>GMT</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Type</span><span class=o>:</span> <span class=nx>text</span><span class=o>/</span><span class=nx>html</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Length</span><span class=o>:</span> <span class=mi>612</span>
<span class=nx>Last</span><span class=o>-</span><span class=nx>Modified</span><span class=o>:</span> <span class=nx>Tue</span><span class=p>,</span> <span class=mi>23</span> <span class=nx>Dec</span> <span class=mi>2014</span> <span class=mi>16</span><span class=o>:</span><span class=mi>25</span><span class=o>:</span><span class=mi>09</span> <span class=nx>GMT</span>
<span class=nx>Connection</span><span class=o>:</span> <span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span>
<span class=nx>ETag</span><span class=o>:</span> <span class=s2>&#34;54999765-264&#34;</span>
<span class=nx>Accept</span><span class=o>-</span><span class=nx>Ranges</span><span class=o>:</span> <span class=nx>bytes</span>
</code></pre></td></tr></table></div></div><h1 id=6-故障迁移>6. 故障迁移</h1><p><img class=lazyload src=/svg/loading.min.svg data-src=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/7%20-%201620.jpg data-srcset="http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/7%20-%201620.jpg, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/7%20-%201620.jpg 1.5x, http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%28%E4%B8%89%29kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/7%20-%201620.jpg 2x" data-sizes=auto alt=http://agou-ops-file.oss-cn-shanghai.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B(%E4%B8%89)kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/7%20-%201620.jpg title=img>故障迁移</p><p>集群中的node节点物理服务器可能会因为各种原因导致机器不可用，如硬件故障，软件故障，网络故障等原因，当发生故障时容器可能会出现不可用，进而影响业务的使用。kubernetes内置已提供了应用的容错能力，通过工作负载Workload如Deployments，StatefulSets来控制，当node节点异常时会自动将其上的pod迁移至其他node节点上，保障应用的高可用。</p><p>Kubeadm默认部署的集群，默认当节点异常时，需要5min后才能迁移，因为默认pod中设置了污点容忍tolerations，当检测到节点状态是not-ready或者unreachable时，容忍tolerationSeconds时长300s后才做驱逐，如下是看pod详情中设置的污点容忍信息</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js>  <span class=nx>tolerations</span><span class=o>:</span>
  <span class=o>-</span> <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoExecute</span>
    <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>not</span><span class=o>-</span><span class=nx>ready</span>
    <span class=nx>operator</span><span class=o>:</span> <span class=nx>Exists</span>
    <span class=nx>tolerationSeconds</span><span class=o>:</span> <span class=mi>300</span>
  <span class=o>-</span> <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoExecute</span>
    <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>unreachable</span>
    <span class=nx>operator</span><span class=o>:</span> <span class=nx>Exists</span>
    <span class=nx>tolerationSeconds</span><span class=o>:</span> <span class=mi>300</span>
</code></pre></td></tr></table></div></div><p>如下是手动创建的yaml文件，通过调整污点容忍的时长为2s，当节点异常时，其上的pod能够实现快速迁移到其他node节点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>run</span><span class=o>:</span> <span class=nx>test</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>test</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>run</span><span class=o>:</span> <span class=nx>test</span>
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>run</span><span class=o>:</span> <span class=nx>test</span>
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
        <span class=nx>name</span><span class=o>:</span> <span class=nx>test</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>3</span>
        <span class=nx>resources</span><span class=o>:</span> <span class=p>{}</span>
      <span class=nx>tolerations</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoExecute</span>
        <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>not</span><span class=o>-</span><span class=nx>ready</span>
        <span class=nx>operator</span><span class=o>:</span> <span class=nx>Exists</span>
        <span class=nx>tolerationSeconds</span><span class=o>:</span> <span class=mi>2</span> 
      <span class=o>-</span> <span class=nx>effect</span><span class=o>:</span> <span class=nx>NoExecute</span>
        <span class=nx>key</span><span class=o>:</span> <span class=nx>node</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>unreachable</span>
        <span class=nx>operator</span><span class=o>:</span> <span class=nx>Exists</span>
        <span class=nx>tolerationSeconds</span><span class=o>:</span> <span class=mi>2</span> 
</code></pre></td></tr></table></div></div><h1 id=写在最后><strong>写在最后</strong></h1><p>本文以命令行的方式实践探索kubernetes中涉及的最重要的几个概念：应用部署，负载均衡，弹性伸缩和滚动升级，故障迁移，并以命令行的形式实际操作，读者可以参照文档实现快速入门，后续会大部分以yaml文件的形式部署和kubernets交互。</p><h1 id=参考文档><strong>参考文档</strong></h1><p>基础概念：https://kubernetes.io/docs/tutorials/kubernetes-basics/</p><p>部署应用：https://kubernetes.io/docs/tutorials/kubernetes-basics/deploy-app/deploy-intro/</p><p>访问应用：https://kubernetes.io/docs/tutorials/kubernetes-basics/explore/explore-intro/</p><p>外部访问：https://kubernetes.io/docs/tutorials/kubernetes-basics/expose/expose-intro/</p><p>访问应用：https://kubernetes.io/docs/tutorials/kubernetes-basics/scale/scale-intro/</p><p>滚动升级：https://kubernetes.io/docs/tutorials/kubernetes-basics/update/update-intro/</p><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-08-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ data-title="03 Kubernetes快速入门" data-hashtags=kubernetes,tutorial><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ data-title="03 Kubernetes快速入门"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ data-title="03 Kubernetes快速入门"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://x.agou-ops.top/03-kubernetes%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/ data-title="03 Kubernetes快速入门" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/tutorial/>tutorial</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/04-%E7%A6%BB%E7%BA%BF%E5%8D%87%E7%BA%A7kubernetes%E9%9B%86%E7%BE%A4/ class=prev rel=prev title="04 离线升级kubernetes集群"><i class="fas fa-angle-left fa-fw"></i>04 离线升级kubernetes集群</a>
<a href=/02-kubeadm%E7%A6%BB%E7%BA%BF%E9%83%A8%E7%BD%B21.14.1%E9%9B%86%E7%BE%A4/ class=next rel=next title="02 Kubeadm离线部署1.14">02 Kubeadm离线部署1.14<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.69.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>鲁ICP备19050296号-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>