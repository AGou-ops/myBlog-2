<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>11 深入学习Deployment控制器 - AGou's Blog-2</title><meta name=Description content="关于 LoveIt 主题"><meta property="og:title" content="11 深入学习Deployment控制器"><meta property="og:description" content="写在前面 前面的文章我们深入介绍了Pod的使用，包括Pod定义，Pod资源管理和服务质量，Pod健康检查，Pod存储管理，Pod调度，当Pod"><meta property="og:type" content="article"><meta property="og:url" content="http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2019-08-04T10:36:48+08:00"><meta property="article:modified_time" content="2019-08-04T10:36:48+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="11 深入学习Deployment控制器"><meta name=twitter:description content="写在前面 前面的文章我们深入介绍了Pod的使用，包括Pod定义，Pod资源管理和服务质量，Pod健康检查，Pod存储管理，Pod调度，当Pod"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/><link rel=prev href=http://x.agou-ops.top/12-%E8%AF%A6%E8%A7%A3daemonset%E6%8E%A7%E5%88%B6%E5%99%A8/><link rel=next href=http://x.agou-ops.top/10-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8pv%E5%92%8Cpvc/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"11 深入学习Deployment控制器","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"http:\/\/x.agou-ops.top\/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"kubernetes, tutorial","wordcount":6224,"url":"http:\/\/x.agou-ops.top\/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8\/","datePublished":"2019-08-04T10:36:48+08:00","dateModified":"2019-08-04T10:36:48+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ selected>简体中文</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/>所有文章</a><a class=menu-item href=/tags/>标签</a><a class=menu-item href=/categories/>分类</a><a class=menu-item href=/categories/documentation/>文档</a><a class=menu-item href=/about/>关于</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=选择语言>简体中文<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">11 深入学习Deployment控制器</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E8%BD%AC%E8%BD%BD/><i class="far fa-folder fa-fw"></i>转载</a>&nbsp;<a href=/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a>&nbsp;<a href=/categories/%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/><i class="far fa-folder fa-fw"></i>基础教程</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2019-08-04>2019-08-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6224 字&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#11-控制器概述>1.1 控制器概述</a></li><li><a href=#12-deployment>1.2 Deployment</a><ul><li><a href=#121-deployment定义>1.2.1 Deployment定义</a></li><li><a href=#122-deployment扩容>1.2.2 Deployment扩容</a></li><li><a href=#123-滚动更新>1.2.3 滚动更新</a></li><li><a href=#124-版本回退>1.2.4 版本回退</a></li></ul></li><li><a href=#13-replicaset>1.3 ReplicaSet</a></li><li><a href=#14-replicationcontroller>1.4 ReplicationController</a></li></ul></nav></div></div><div class=content id=content><h1 id=写在前面>写在前面</h1><p>前面的文章我们深入介绍了Pod的使用，包括<a href=# rel>Pod定义</a>，<a href=# rel>Pod资源管理和服务质量</a>，<a href=# rel>Pod健康检查</a>，<a href=# rel>Pod存储管理</a>，<a href=# rel>Pod调度</a>，当Pod所在的node异常时，Pod无法自动恢复，因此Pod很少单独使用，一般以template的形式嵌套在控制器中使用，下来介绍<a href=# rel>kubernetes系列教程</a>副本控制器Deployment，ReplicaSet，ReplicationController的使用。</p><h1 id=1-深入学习控制器>1. 深入学习控制器</h1><h2 id=11-控制器概述>1.1 控制器概述</h2><p>Pod是kubernetes所有运行应用或部署服务的基础，可以看作是k8s中运行的机器人，应用单独运行在Pod中不具备高级的特性，比如节点故障时Pod无法自动迁移，Pod多副本横向扩展，应用滚动升级RollingUpdate等，因此Pod一般不会单独使用，需要使用控制器来实现。</p><p>我们先看一个概念ReplicationController副本控制器，简称RC，副本控制是实现Pod高可用的基础，其通过定义副本的副本数replicas，当运行的Pod数量少于replicas时RC会自动创建Pod，当Pod数量多于replicas时RC会自动删除多余的Pod，确保当前运行的Pod和RC定义的副本数保持一致。</p><p>副本控制器包括Deployment，ReplicaSet，ReplicationController，StatefulSet等。其中常用有两个：Deployment和StatefulSet，Deployment用于无状态服务，StatefulSet用于有状态服务，ReplicaSet作为Deployment后端副本控制器，ReplicationController则是旧使用的副本控制器。</p><p>为了实现不同的功能，kubernetes中提供多种不同的控制器满足不同的业务场景，可以分为四类：</p><ul><li>Stateless application无状态化应用，如Deployment，ReplicaSet，RC等；</li><li>Stateful application有状态化应用，需要保存数据状态，如数据库，数据库集群；</li><li>Node daemon节点支撑守护，适用于在所有或部分节点运行Daemon，如日志，监控采集；</li><li>Batch批处理任务，非长期运行服务，分为一次性运行Job和计划运行CronJob两种。</li></ul><p>本文我们主要介绍无状态服务副本控制器的使用，包括Deployment，ReplicaSet和ReplicationController。</p><h2 id=12-deployment>1.2 Deployment</h2><p>Deployment是实现无状态应用副本控制器，其通过declarative申明式的方式定义Pod的副本数，Deployment的副本机制是通过ReplicaSet实现，replicas副本的管理通过在ReplicaSet中添加和删除Pod，RollingUpdate通过新建ReplicaSet，然后逐步移除和添加ReplicaSet中的Pod数量，从而实现滚动更新，使用Deployment的场景如下：</p><ul><li>滚动升级RollingUpdate，后台通过ReplicaSet实现</li><li>多副本replicas实现，增加副本(高负载)或减少副本(低负载)</li><li>应用回滚Rollout，版本更新支持回退</li></ul><h3 id=121-deployment定义>1.2.1 Deployment定义</h3><p>\1. 我们定义一个Deployment，副本数为3，Pod以模版Template的形式封装在Deployment中，为了结合之前Pod学习内容，我们增加了resource和健康检查的定义，具体实现参考前面介绍的文章。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>apps</span><span class=o>/</span><span class=nx>v1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>Deployment</span>
<span class=nx>metadata</span><span class=o>:</span>            <span class=err>#</span><span class=nx>Deployment的元数据信息</span><span class=err>，</span><span class=nx>包含名字</span><span class=err>，</span><span class=nx>标签</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
    <span class=nx>rc</span><span class=o>:</span> <span class=nx>deployment</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>replicationcontroller</span><span class=o>:</span> <span class=nx>Deployment</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;ReplicationController Deployment Demo&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>          <span class=err>#</span><span class=nx>副本数量</span><span class=err>，</span><span class=nx>包含有3个Pod副本</span>
  <span class=nx>selector</span><span class=o>:</span>            <span class=err>#</span><span class=nx>标签选择器</span><span class=err>，</span><span class=nx>选择管理包含指定标签的Pod</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
      <span class=nx>rc</span><span class=o>:</span> <span class=nx>deployment</span>
  <span class=nx>template</span><span class=o>:</span>       <span class=err>#</span><span class=nx>如下是Pod的模板定义</span><span class=err>，</span><span class=nx>没有apiVersion</span><span class=err>，</span><span class=nx>Kind属性</span><span class=err>，</span><span class=nx>需包含metadata定义</span>
    <span class=nx>metadata</span><span class=o>:</span>          <span class=err>#</span><span class=nx>Pod的元数据信息</span><span class=err>，</span><span class=nx>必须包含有labels</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
        <span class=nx>rc</span><span class=o>:</span> <span class=nx>deployment</span> 
    <span class=nx>spec</span><span class=o>:</span>              <span class=err>#</span><span class=nx>spec指定容器的属性信息</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
        <span class=nx>ports</span><span class=o>:</span>          <span class=err>#</span><span class=nx>容器端口信息</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>http</span><span class=o>-</span><span class=mi>80</span><span class=o>-</span><span class=nx>port</span>
          <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
        <span class=nx>resources</span><span class=o>:</span>      <span class=err>#</span><span class=nx>资源管理</span><span class=p>,</span><span class=nx>requests请求资源</span><span class=err>，</span><span class=nx>limits限制资源</span>
          <span class=nx>requests</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>100</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>128</span><span class=nx>Mi</span>
          <span class=nx>limits</span><span class=o>:</span>
            <span class=nx>cpu</span><span class=o>:</span> <span class=mi>200</span><span class=nx>m</span>
            <span class=nx>memory</span><span class=o>:</span> <span class=mi>256</span><span class=nx>Mi</span>
        <span class=nx>livenessProbe</span><span class=o>:</span>  <span class=err>#</span><span class=nx>健康检查器livenessProbe</span><span class=err>，</span><span class=nx>存活检查</span>
          <span class=nx>httpGet</span><span class=o>:</span>
            <span class=nx>path</span><span class=o>:</span> <span class=err>/index.html</span>
            <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
            <span class=nx>scheme</span><span class=o>:</span> <span class=nx>HTTP</span>
          <span class=nx>initialDelaySeconds</span><span class=o>:</span> <span class=mi>3</span>
          <span class=nx>periodSeconds</span><span class=o>:</span> <span class=mi>5</span>
          <span class=nx>timeoutSeconds</span><span class=o>:</span> <span class=mi>2</span>
        <span class=nx>readinessProbe</span><span class=o>:</span>  <span class=err>#</span><span class=nx>健康检查器readinessProbe</span><span class=err>，</span><span class=nx>就绪检查</span>
          <span class=nx>httpGet</span><span class=o>:</span>
            <span class=nx>path</span><span class=o>:</span> <span class=err>/index.html</span>
            <span class=nx>port</span><span class=o>:</span> <span class=mi>80</span>
            <span class=nx>scheme</span><span class=o>:</span> <span class=nx>HTTP</span>
          <span class=nx>initialDelaySeconds</span><span class=o>:</span> <span class=mi>3</span>
          <span class=nx>periodSeconds</span><span class=o>:</span> <span class=mi>5</span>
          <span class=nx>timeoutSeconds</span><span class=o>:</span> <span class=mi>2</span>
</code></pre></td></tr></table></div></div><p>Deployment字段说明：</p><ul><li>deployment基本属性，包括apiVersion,Kind,metadata和spec，其中，deployment.metdata指定名称和标签内容，deployment.spec指定部署组的属性信息；</li><li>deployment属性信息包含有replicas，Selector和template，其中replicas指定副本数目，Selector指定管理的Pod标签，template为定义Pod的模板，Deployment通过模板创建Pod；</li><li>deployment.spec.template为Pod定义的模板，和Pod定义不太一样，template中不包含apiVersion和Kind属性，要求必须有metadata，deployment.spec.template.spec为容器的属性信息，其他定义内容和Pod一致。</li></ul><p>\2. 生成Deployment，创建时加一个&ndash;record参数,会在annotation中记录deployment.kubernetes.io/revision版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> <span class=o>--</span><span class=nx>record</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>apps</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>
</code></pre></td></tr></table></div></div><p>\3. 查看Deployment列表，运行时自动下载镜像，如下已运行了3个副本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                    <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>3</span><span class=o>/</span><span class=mi>3</span>     <span class=mi>3</span>            <span class=mi>3</span>           <span class=mi>2</span><span class=nx>m37s</span>

<span class=nx>NAME代表名称</span><span class=p>,</span><span class=nx>metadata</span><span class=p>.</span><span class=nx>name字段定义</span>
<span class=nx>READY代表Pod的健康状态</span><span class=err>，</span><span class=nx>前面值是readiness</span><span class=err>，</span><span class=nx>后面是liveness</span>
<span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE代表更新</span><span class=err>，</span><span class=nx>用于滚动升级</span>
<span class=nx>AVAILABLE代表可用</span>
<span class=nx>AGE创建至今运行的时长</span>
</code></pre></td></tr></table></div></div><p>\4. 查看Deployment的详情，可以看到Deployment通过一个deployment-nginx-demo-866bb6cf78 replicaset副本控制器控制Pod的副本数量</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/1%20-%201620.jpg title=Deployment详情信息></p><p>\5. 查看replicaset的详情信息，通过Events可查看到deployment-nginx-demo-866bb6cf78创建了三个Pod</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/2%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/2%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/2%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/2%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/2%20-%201620.jpg title=ReplicaSet详情信息></p><p>\6. 查看Pod详情，最终通过Pod定义的模版创建container，资源定义，健康检查等包含在Pod定义的模版中</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/3%20-%201620.jpg title=Pod详情信息></p><p>通过上面的实战演练我们可得知Deployment的副本控制功能是由replicaset实现，replicaset生成Deployment中定义的replicas副本的数量，即创建多个副本，如下图所示：</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/4%20-%201620.jpg title=Deployment创建结构示意图></p><h3 id=122-deployment扩容>1.2.2 Deployment扩容</h3><p>当业务比较繁忙时可以通过增加副本数，增加副本数是通过yaml文件中的replicas控制的，当设置了replias后，Deployment控制器会自动根据当前副本数目创建所需的Pod数，这些pod会自动加入到service中实现负载均衡，相反减少副本数，这些pod会自动从service中删除。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/5%20-%201620.jpg title=Deployment扩容></p><p>\1. 将deployment的副本数扩容至4个，可通过修改yaml文件的replicas个数或者通过scale命令扩展。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>4</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
</code></pre></td></tr></table></div></div><p>\2. 查看Deployment副本数量,已增加至4个副本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span>
<span class=nx>NAME</span>                    <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>4</span><span class=o>/</span><span class=mi>4</span>     <span class=mi>4</span>            <span class=mi>4</span>           <span class=mi>77</span><span class=nx>m</span>
</code></pre></td></tr></table></div></div><p>\3. 副本的扩容是如何实现的呢？我们查看replicaset的详情信息观察，增加副本的个数是通过replicaset来扩容，通过模版复制新的Pod</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/6%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/6%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/6%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/6%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/6%20-%201620.jpg title=Deployment扩展></p><p>\4. 副本缩容</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>2</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>                    <span class=nx>READY</span>   <span class=nx>UP</span><span class=o>-</span><span class=nx>TO</span><span class=o>-</span><span class=nx>DATE</span>   <span class=nx>AVAILABLE</span>   <span class=nx>AGE</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>2</span><span class=o>/</span><span class=mi>2</span>     <span class=mi>2</span>            <span class=mi>2</span>           <span class=mi>7</span><span class=nx>h41m</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/7%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/7%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/7%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/7%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/7%20-%201620.jpg title=Deployment减少副本></p><p>通过上面的操作演练我们可以得知:Deployment的扩容是通过ReplicaSet的模版创建Pod或删除Pod实现，scale是手动扩展实现副本的机制，kubernetes还提供了另外一种副本自动扩容机制horizontalpodautoscalers(Horizontal Pod Autoscaling),即通过定义CPU的利用率实现自动的横向扩展，由于需要依赖于监控组件，后续我们再做介绍。</p><h3 id=123-滚动更新>1.2.3 滚动更新</h3><p>Deployment支持滚动更新，默认创建Deployment后会增加滚动更新的策略，通过逐步替代replicas中的pod实现更新无服务中断（需要结合service），如下图所示：将一个deployment副本数为3的应用更新，先更新10.0.0.6 pod，更新pod应用，替换新的ip，然后加入到service中，以此类推再继续更新其他pod，从而实现滚动更新，不影响服务的升级。</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/8%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/8%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/8%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/8%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/8%20-%201620.jpg title=滚动更新></p><p>通过类型为：RollingUpdate，每次更新最大的数量maxSurge是replicas总数的25%,最大不可用的数量maxUnavailable为25%，如下是通过kubectl get deployments deployment-nginx-demo -o yaml查看滚动更新相关的策略。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=nx>spec</span><span class=o>:</span>
  <span class=nx>progressDeadlineSeconds</span><span class=o>:</span> <span class=mi>600</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>revisionHistoryLimit</span><span class=o>:</span> <span class=mi>10</span>
  <span class=nx>selector</span><span class=o>:</span>
    <span class=nx>matchLabels</span><span class=o>:</span>
      <span class=nx>app</span><span class=o>:</span> <span class=nx>nginx</span>
      <span class=nx>rc</span><span class=o>:</span> <span class=nx>deployment</span>
  <span class=nx>strategy</span><span class=o>:</span>  <span class=err>#</span><span class=nx>strategy定义的是升级的策略</span><span class=err>，</span><span class=nx>类型为RollingUpdate</span>
    <span class=nx>rollingUpdate</span><span class=o>:</span> 
      <span class=nx>maxSurge</span><span class=o>:</span> <span class=mi>25</span><span class=o>%</span>
      <span class=nx>maxUnavailable</span><span class=o>:</span> <span class=mi>25</span><span class=o>%</span>
    <span class=nx>type</span><span class=o>:</span> <span class=nx>RollingUpdate</span>
</code></pre></td></tr></table></div></div><p>\1. 滚动更新是当pod.template中定义的相关属性变化，如下将镜像更新到1.9.1，通过&ndash;record会记录操作命令</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.9.1</span> <span class=o>--</span><span class=nx>record</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>image</span> <span class=nx>updated</span>
</code></pre></td></tr></table></div></div><p>\2. 查看滚动升级的状态（由于第一次nginx的镜像写错了，容器下载镜像失败，写成nignx，导致修改后有两次record）</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>status</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span> <span class=s2>&#34;deployment-nginx-demo&#34;</span> <span class=nx>successfully</span> <span class=nx>rolled</span> <span class=nx>out</span>

<span class=nx>查看滚动升级版本</span><span class=err>，</span><span class=nx>REVSISION代表版本号</span><span class=err>：</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>history</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>REVISION</span>  <span class=nx>CHANGE</span><span class=o>-</span><span class=nx>CAUSE</span>
<span class=mi>1</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=mi>2</span>         <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span><span class=o>=</span><span class=nx>nignx</span><span class=o>:</span><span class=mf>1.9.1</span> <span class=o>--</span><span class=nx>record</span><span class=o>=</span><span class=kc>true</span>
<span class=mi>3</span>         <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span><span class=o>=</span><span class=nx>nignx</span><span class=o>:</span><span class=mf>1.9.1</span> <span class=o>--</span><span class=nx>record</span><span class=o>=</span><span class=kc>true</span>
</code></pre></td></tr></table></div></div><p>\3. 观察Deployment的升级过程，新创建一个RS deployment-nginx-demo-65c8c98c7b，逐渐将旧RS中的pod替换，直至旧的RS deployment-nginx-demo-866bb6cf78上的副本数为0.</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/9%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/9%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/9%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/9%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/9%20-%201620.jpg title=滚动升级原理></p><p>\4. 查看RS的列表，可以看到新的RS的副本数为2，其他RS副本数为0</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span> 
<span class=nx>NAME</span>                               <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>65</span><span class=nx>c8c98c7b</span>   <span class=mi>2</span>         <span class=mi>2</span>         <span class=mi>2</span>       <span class=mi>21</span><span class=nx>m</span>  <span class=err>#</span><span class=nx>新的RS</span><span class=err>，</span><span class=nx>REVSION为3</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>6</span><span class=nx>cb65f58c6</span>   <span class=mi>0</span>         <span class=mi>0</span>         <span class=mi>0</span>       <span class=mi>22</span><span class=nx>m</span>  <span class=err>#</span><span class=nx>镜像写错的RS</span><span class=err>，</span><span class=nx>REVISON为2</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>866</span><span class=nx>bb6cf78</span>   <span class=mi>0</span>         <span class=mi>0</span>         <span class=mi>0</span>       <span class=mi>40</span><span class=nx>m</span>  <span class=err>#</span><span class=nx>旧的RS</span><span class=err>，</span><span class=nx>对应REVSION为1</span>
</code></pre></td></tr></table></div></div><p>\5. 测试版本升级是否成功</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                                     <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>   <span class=nx>IP</span>            <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>65</span><span class=nx>c8c98c7b</span><span class=o>-</span><span class=nx>bzql9</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>25</span><span class=nx>m</span>   <span class=mf>10.244.1.58</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>65</span><span class=nx>c8c98c7b</span><span class=o>-</span><span class=nx>vrjhp</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>25</span><span class=nx>m</span>   <span class=mf>10.244.2.72</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=o>-</span><span class=nx>I</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.244.2.72 
</span><span class=c1></span><span class=nx>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=nx>OK</span>
<span class=nx>Server</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>/</span><span class=mf>1.9.1</span> <span class=err>#</span><span class=nx>镜像的版本成功更新</span>
<span class=nb>Date</span><span class=o>:</span> <span class=nx>Mon</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Oct</span> <span class=mi>2019</span> <span class=mi>15</span><span class=o>:</span><span class=mi>28</span><span class=o>:</span><span class=mi>49</span> <span class=nx>GMT</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Type</span><span class=o>:</span> <span class=nx>text</span><span class=o>/</span><span class=nx>html</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Length</span><span class=o>:</span> <span class=mi>612</span>
<span class=nx>Last</span><span class=o>-</span><span class=nx>Modified</span><span class=o>:</span> <span class=nx>Tue</span><span class=p>,</span> <span class=mi>26</span> <span class=nx>May</span> <span class=mi>2015</span> <span class=mi>15</span><span class=o>:</span><span class=mi>02</span><span class=o>:</span><span class=mi>09</span> <span class=nx>GMT</span>
<span class=nx>Connection</span><span class=o>:</span> <span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span>
<span class=nx>ETag</span><span class=o>:</span> <span class=s2>&#34;55648af1-264&#34;</span>
<span class=nx>Accept</span><span class=o>-</span><span class=nx>Ranges</span><span class=o>:</span> <span class=nx>bytes</span>
</code></pre></td></tr></table></div></div><h3 id=124-版本回退>1.2.4 版本回退</h3><p>如果版本不符合预期，kubernetes提供回退的功能，和滚动更新一样，回退的功能Deployment将替换到原始的RS上，即逐步将Pod的副本替换到旧的RS上.</p><p>\1. 执行回滚，回退到REVISON版本为1</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>undo</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=o>--</span><span class=nx>to</span><span class=o>-</span><span class=nx>revision</span><span class=o>=</span><span class=mi>1</span>
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>rolled</span> <span class=nx>back</span>
</code></pre></td></tr></table></div></div><p>\2. 查看Deployment的回退状态和历史版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>status</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span> <span class=s2>&#34;deployment-nginx-demo&#34;</span> <span class=nx>successfully</span> <span class=nx>rolled</span> <span class=nx>out</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>rollout</span> <span class=nx>history</span> <span class=nx>deployment</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>deployment</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>REVISION</span>  <span class=nx>CHANGE</span><span class=o>-</span><span class=nx>CAUSE</span>
<span class=mi>2</span>         <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span><span class=o>=</span><span class=nx>nignx</span><span class=o>:</span><span class=mf>1.9.1</span> <span class=o>--</span><span class=nx>record</span><span class=o>=</span><span class=kc>true</span>
<span class=mi>3</span>         <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>deployments</span> <span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>deployment</span><span class=o>=</span><span class=nx>nignx</span><span class=o>:</span><span class=mf>1.9.1</span> <span class=o>--</span><span class=nx>record</span><span class=o>=</span><span class=kc>true</span>
<span class=mi>4</span>         <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
</code></pre></td></tr></table></div></div><p>\3. 查看Deployment的详情，可以看到RS已经会退到原始的RS了</p><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/10%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/10%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/10%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/10%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/10%20-%201620.jpg title=版本回退></p><p>\4. 测试nginx的版本</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>pods</span> <span class=o>-</span><span class=nx>o</span> <span class=nx>wide</span> 
<span class=nx>NAME</span>                                     <span class=nx>READY</span>   <span class=nx>STATUS</span>    <span class=nx>RESTARTS</span>   <span class=nx>AGE</span>     <span class=nx>IP</span>            <span class=nx>NODE</span>     <span class=nx>NOMINATED</span> <span class=nx>NODE</span>   <span class=nx>READINESS</span> <span class=nx>GATES</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>866</span><span class=nx>bb6cf78</span><span class=o>-</span><span class=mi>9</span><span class=nx>thtn</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m42s</span>   <span class=mf>10.244.1.59</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>2</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>deployment</span><span class=o>-</span><span class=nx>nginx</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=mi>866</span><span class=nx>bb6cf78</span><span class=o>-</span><span class=nx>ws2hx</span>   <span class=mi>1</span><span class=o>/</span><span class=mi>1</span>     <span class=nx>Running</span>   <span class=mi>0</span>          <span class=mi>3</span><span class=nx>m48s</span>   <span class=mf>10.244.2.73</span>   <span class=nx>node</span><span class=o>-</span><span class=mi>3</span>   <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>           <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>


<span class=err>#</span><span class=nx>测试版本</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=o>~</span><span class=p>]</span><span class=err>#</span> <span class=nx>curl</span> <span class=o>-</span><span class=nx>I</span> <span class=nx>http</span><span class=o>:</span><span class=c1>//10.244.1.59 
</span><span class=c1></span><span class=nx>HTTP</span><span class=o>/</span><span class=mf>1.1</span> <span class=mi>200</span> <span class=nx>OK</span>
<span class=nx>Server</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>/</span><span class=mf>1.7.9</span> <span class=err>#</span><span class=nx>回退到1</span><span class=mf>.7.9</span><span class=nx>版本</span>
<span class=nb>Date</span><span class=o>:</span> <span class=nx>Mon</span><span class=p>,</span> <span class=mi>28</span> <span class=nx>Oct</span> <span class=mi>2019</span> <span class=mi>15</span><span class=o>:</span><span class=mi>36</span><span class=o>:</span><span class=mi>07</span> <span class=nx>GMT</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Type</span><span class=o>:</span> <span class=nx>text</span><span class=o>/</span><span class=nx>html</span>
<span class=nx>Content</span><span class=o>-</span><span class=nx>Length</span><span class=o>:</span> <span class=mi>612</span>
<span class=nx>Last</span><span class=o>-</span><span class=nx>Modified</span><span class=o>:</span> <span class=nx>Tue</span><span class=p>,</span> <span class=mi>23</span> <span class=nx>Dec</span> <span class=mi>2014</span> <span class=mi>16</span><span class=o>:</span><span class=mi>25</span><span class=o>:</span><span class=mi>09</span> <span class=nx>GMT</span>
<span class=nx>Connection</span><span class=o>:</span> <span class=nx>keep</span><span class=o>-</span><span class=nx>alive</span>
<span class=nx>ETag</span><span class=o>:</span> <span class=s2>&#34;54999765-264&#34;</span>
<span class=nx>Accept</span><span class=o>-</span><span class=nx>Ranges</span><span class=o>:</span> <span class=nx>bytes</span>
</code></pre></td></tr></table></div></div><p><strong>小结</strong>：通过上面的操作演练可知，Deployment是通过ReplicaSet实现Pod副本数的管理（扩容或减少副本数），滚动更新是通过新建RS，将Pod从旧的RS逐步更新到新的RS上；相反，回滚版本将会退到指定版本的ReplicaSet上。</p><h2 id=13-replicaset>1.3 ReplicaSet</h2><p>ReplicaSet副本集简称RS，用于实现副本数的控制，通过上面的学习我们可以知道Deployment实际是调用ReplicaSet实现副本的控制，RS不具备滚动升级和回滚的特性，一般推荐使用Deployment，ReplicaSet的定义和Deployment差不多，如下：</p><p>\1. 定义ReplicaSet</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>extensions</span><span class=o>/</span><span class=nx>v1beta1</span>
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ReplicaSet</span>
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span>
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicaset</span>
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kubernetes Replication Controller Replication&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>    <span class=err>#</span><span class=nx>副本数</span>
  <span class=nx>selector</span><span class=o>:</span>      <span class=err>#</span><span class=nx>Pod标签选择器</span>
    <span class=nx>matchLabels</span><span class=o>:</span>  
      <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicaset</span>
  <span class=nx>template</span><span class=o>:</span>      <span class=err>#</span><span class=nx>创建Pod的模板</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicaset</span>
    <span class=nx>spec</span><span class=o>:</span>        <span class=err>#</span><span class=nx>容器信息</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span>
        <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>http</span><span class=o>-</span><span class=mi>80</span><span class=o>-</span><span class=nx>port</span>
          <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>\2. 创建RS并查看RS列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>replicaset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>              <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>15</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>\3. 扩展副本数至4个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>4</span> <span class=nx>replicaset</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>replicaset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>              <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>4</span>         <span class=mi>4</span>         <span class=mi>4</span>       <span class=mi>76</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>\4. 减少副本数至2个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>2</span> <span class=nx>replicaset</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>replicaset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicasets</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>NAME</span>              <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>2</span>         <span class=mi>2</span>         <span class=mi>2</span>       <span class=mi>114</span><span class=nx>s</span>
</code></pre></td></tr></table></div></div><p>\5. 镜像版本升级，验证得知不具备版本升级的能力</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>set</span> <span class=nx>image</span> <span class=nx>replicasets</span> <span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span><span class=o>=</span><span class=nx>nginx</span><span class=o>:</span><span class=mf>1.9.1</span>
<span class=nx>replicaset</span><span class=p>.</span><span class=nx>extensions</span><span class=o>/</span><span class=nx>replicaset</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>image</span> <span class=nx>updated</span>  <span class=err>#</span><span class=nx>命令执行成功了</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/svg/loading.min.svg data-src=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/11%20-%201620.jpg data-srcset="https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/11%20-%201620.jpg, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/11%20-%201620.jpg 1.5x, https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/11%20-%201620.jpg 2x" data-sizes=auto alt=https://agou-images.oss-cn-qingdao.aliyuncs.com/blog-images/k8s%E5%9F%BA%E7%A1%80/kubernetes%E7%B3%BB%E5%88%97%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%B8%80%EF%BC%89%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0Deployment%E6%8E%A7%E5%88%B6%E5%99%A8/11%20-%201620.jpg title=ReplicaSet验证版本更新></p><p>ReplicaSet小结：通过上面的演示可以知道，RS定义和Deployment类似，能实现副本的控制，扩展和缩减，Deployment是更高层次的副本控制器，ReplicaSet主要为Deployment的副本控制器和滚动更新机制，ReplicaSet本身无法提供滚动更新的能力。</p><h2 id=14-replicationcontroller>1.4 ReplicationController</h2><p>ReplicationController副本控制器简称RC，是kubernetes中最早的副本控制器，RC是ReplicaSet之前的版本，ReplicationController提供副本控制能力，其定义方式和Deployment，ReplicaSet相类似，如下：</p><p>\1. 定义ReplicationController</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>cat</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>apiVersion</span><span class=o>:</span> <span class=nx>v1</span> 
<span class=nx>kind</span><span class=o>:</span> <span class=nx>ReplicationController</span> 
<span class=nx>metadata</span><span class=o>:</span>
  <span class=nx>name</span><span class=o>:</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> 
  <span class=nx>labels</span><span class=o>:</span>
    <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicationcontroller</span> 
  <span class=nx>annotations</span><span class=o>:</span>
    <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=s2>&#34;Kubernetes Replication Controller Replication&#34;</span>
<span class=nx>spec</span><span class=o>:</span>
  <span class=nx>replicas</span><span class=o>:</span> <span class=mi>3</span>
  <span class=nx>selector</span><span class=o>:</span>     <span class=err>#</span><span class=nx>不能使用matchLables字符集模式</span>
    <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicationcontroller</span> 
  <span class=nx>template</span><span class=o>:</span>
    <span class=nx>metadata</span><span class=o>:</span>
      <span class=nx>labels</span><span class=o>:</span>
        <span class=nx>controller</span><span class=o>:</span> <span class=nx>replicationcontroller</span>   
    <span class=nx>spec</span><span class=o>:</span>
      <span class=nx>containers</span><span class=o>:</span>
      <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>-</span><span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> 
        <span class=nx>image</span><span class=o>:</span> <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
        <span class=nx>imagePullPolicy</span><span class=o>:</span> <span class=nx>IfNotPresent</span>
        <span class=nx>ports</span><span class=o>:</span>
        <span class=o>-</span> <span class=nx>name</span><span class=o>:</span> <span class=nx>http</span><span class=o>-</span><span class=mi>80</span><span class=o>-</span><span class=nx>port</span>
          <span class=nx>protocol</span><span class=o>:</span> <span class=nx>TCP</span>
          <span class=nx>containerPort</span><span class=o>:</span> <span class=mi>80</span>
</code></pre></td></tr></table></div></div><p>\2. 生成RC并查看列表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>apply</span> <span class=o>-</span><span class=nx>f</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=p>.</span><span class=nx>yaml</span> 
<span class=nx>replicationcontroller</span><span class=o>/</span><span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>created</span>

<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicationcontrollers</span> 
<span class=nx>NAME</span>      <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>3</span>         <span class=mi>3</span>         <span class=mi>3</span>       <span class=mi>103</span><span class=nx>s</span>

<span class=err>#</span><span class=nx>查看详情</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>describe</span> <span class=nx>replicationcontrollers</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>Name</span><span class=o>:</span>         <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span>
<span class=nx>Namespace</span><span class=o>:</span>    <span class=k>default</span>
<span class=nx>Selector</span><span class=o>:</span>     <span class=nx>controller</span><span class=o>=</span><span class=nx>replicationcontroller</span>
<span class=nx>Labels</span><span class=o>:</span>       <span class=nx>controller</span><span class=o>=</span><span class=nx>replicationcontroller</span>
<span class=nx>Annotations</span><span class=o>:</span>  <span class=nx>kubectl</span><span class=p>.</span><span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>last</span><span class=o>-</span><span class=nx>applied</span><span class=o>-</span><span class=nx>configuration</span><span class=o>:</span>
                <span class=p>{</span><span class=s2>&#34;apiVersion&#34;</span><span class=o>:</span><span class=s2>&#34;v1&#34;</span><span class=p>,</span><span class=s2>&#34;kind&#34;</span><span class=o>:</span><span class=s2>&#34;ReplicationController&#34;</span><span class=p>,</span><span class=s2>&#34;metadata&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;annotations&#34;</span><span class=o>:</span><span class=p>{</span><span class=s2>&#34;kubernetes.io/description&#34;</span><span class=o>:</span><span class=err>&#34;</span><span class=nx>Kubernetes</span> <span class=nx>Replication</span> <span class=nx>Controlle</span><span class=p>...</span>
              <span class=nx>kubernetes</span><span class=p>.</span><span class=nx>io</span><span class=o>/</span><span class=nx>description</span><span class=o>:</span> <span class=nx>Kubernetes</span> <span class=nx>Replication</span> <span class=nx>Controller</span> <span class=nx>Replication</span>
<span class=nx>Replicas</span><span class=o>:</span>     <span class=mi>3</span> <span class=nx>current</span> <span class=o>/</span> <span class=mi>3</span> <span class=nx>desired</span>
<span class=nx>Pods</span> <span class=nx>Status</span><span class=o>:</span>  <span class=mi>3</span> <span class=nx>Running</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Waiting</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Succeeded</span> <span class=o>/</span> <span class=mi>0</span> <span class=nx>Failed</span>
<span class=nx>Pod</span> <span class=nx>Template</span><span class=o>:</span>
  <span class=nx>Labels</span><span class=o>:</span>  <span class=nx>controller</span><span class=o>=</span><span class=nx>replicationcontroller</span>
  <span class=nx>Containers</span><span class=o>:</span>
   <span class=nx>nginx</span><span class=o>-</span><span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=o>:</span>
    <span class=nx>Image</span><span class=o>:</span>        <span class=nx>nginx</span><span class=o>:</span><span class=mf>1.7.9</span>
    <span class=nx>Port</span><span class=o>:</span>         <span class=mi>80</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Host</span> <span class=nx>Port</span><span class=o>:</span>    <span class=mi>0</span><span class=o>/</span><span class=nx>TCP</span>
    <span class=nx>Environment</span><span class=o>:</span>  <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
    <span class=nx>Mounts</span><span class=o>:</span>       <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
  <span class=nx>Volumes</span><span class=o>:</span>        <span class=o>&lt;</span><span class=nx>none</span><span class=o>&gt;</span>
<span class=nx>Events</span><span class=o>:</span>
  <span class=nx>Type</span>    <span class=nx>Reason</span>            <span class=nx>Age</span>   <span class=nx>From</span>                    <span class=nx>Message</span>
  <span class=o>----</span>    <span class=o>------</span>            <span class=o>----</span>  <span class=o>----</span>                    <span class=o>-------</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>113</span><span class=nx>s</span>  <span class=nx>replication</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>hm8s9</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>113</span><span class=nx>s</span>  <span class=nx>replication</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>xnfht</span>
  <span class=nx>Normal</span>  <span class=nx>SuccessfulCreate</span>  <span class=mi>113</span><span class=nx>s</span>  <span class=nx>replication</span><span class=o>-</span><span class=nx>controller</span>  <span class=nx>Created</span> <span class=nx>pod</span><span class=o>:</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span><span class=o>-</span><span class=nx>lfhc9</span>
</code></pre></td></tr></table></div></div><p>3.副本扩容至4个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>4</span> <span class=nx>replicationcontroller</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>replicationcontroller</span><span class=o>/</span><span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicationcontrollers</span> 
<span class=nx>NAME</span>      <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>4</span>         <span class=mi>4</span>         <span class=mi>4</span>       <span class=mi>3</span><span class=nx>m23s</span> 
</code></pre></td></tr></table></div></div><p>\4. 副本缩容至2个</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-js data-lang=js><span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>scale</span> <span class=o>--</span><span class=nx>replicas</span><span class=o>=</span><span class=mi>2</span> <span class=nx>replicationcontroller</span> <span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> 
<span class=nx>replicationcontroller</span><span class=o>/</span><span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span> <span class=nx>scaled</span>
<span class=p>[</span><span class=nx>root</span><span class=err>@</span><span class=nx>node</span><span class=o>-</span><span class=mi>1</span> <span class=nx>happylau</span><span class=p>]</span><span class=err>#</span> <span class=nx>kubectl</span> <span class=nx>get</span> <span class=nx>replicationcontrollers</span> 
<span class=nx>NAME</span>      <span class=nx>DESIRED</span>   <span class=nx>CURRENT</span>   <span class=nx>READY</span>   <span class=nx>AGE</span>
<span class=nx>rc</span><span class=o>-</span><span class=nx>demo</span>   <span class=mi>2</span>         <span class=mi>2</span>         <span class=mi>2</span>       <span class=mi>3</span><span class=nx>m51s</span>
</code></pre></td></tr></table></div></div><h1 id=写在最后>写在最后</h1><p>本文介绍了kubernetes中三个副本控制器：Deployment，ReplicaSet和ReplicationController，当前使用最广泛的是Deployment，ReplicaSet为Deployment提供滚动更新机制，RC当前是旧版的副本控制器，当前已废弃，推荐使用Deployment控制器，具备副本控制器，扩展副本，缩减副本，滚动升级和回滚等高级能力。</p><h1 id=参考文献>参考文献</h1><p>Deployment：https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</p><p>ReplicaSet：https://kubernetes.io/docs/concepts/workloads/controllers/replicaset/</p><p>ReplicationController：[https://kubernetes.io/docs/concepts/workloads/controllers/</p><blockquote><p>『 转载 』该文章来源于网络，侵删。</p></blockquote></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-08-04</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ data-title="11 深入学习Deployment控制器" data-hashtags=kubernetes,tutorial><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ data-hashtag=kubernetes><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ data-title="11 深入学习Deployment控制器"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ data-title="11 深入学习Deployment控制器"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=http://x.agou-ops.top/11-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0deployment%E6%8E%A7%E5%88%B6%E5%99%A8/ data-title="11 深入学习Deployment控制器" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/tutorial/>tutorial</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/12-%E8%AF%A6%E8%A7%A3daemonset%E6%8E%A7%E5%88%B6%E5%99%A8/ class=prev rel=prev title="12 详解DaemonSet控制器"><i class="fas fa-angle-left fa-fw"></i>12 详解DaemonSet控制器</a>
<a href=/10-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8pv%E5%92%8Cpvc/ class=next rel=next title="10 深入学习持久化存储PV和PVC">10 深入学习持久化存储PV和PVC<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.69.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2019 - 2020</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>鲁ICP备19050296号-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type=text/javascript src=/js/theme.min.js></script></body></html>