<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12 - AGou's Blog-2</title><meta name=Description content="å…³äºåšä¸»"><meta property="og:title" content="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12"><meta property="og:description" content="ç¯‡å¹…è¿‡é•¿ï¼Œä¸ºäº†æ›´å¥½çš„é˜…è¯»ä½“éªŒå¯ä»¥å‰å¾€æˆ‘çš„æ–‡æ¡£-k8s Debian12 äºŒè¿›åˆ¶å®‰è£… æˆ–è€…æˆ‘çš„å¤‡ç”¨åšå®¢åœ°å€ .
ä¸€ã€é¢„å…ˆå‡†å¤‡
1.1 æœåŠ¡å™¨è§’è‰²
ç¯å¢ƒä¿¡æ¯ï¼š

k8sç‰ˆæœ¬ï¼šv1.25.12
Debian12(bookworm)ï¼šå†…æ ¸6.1.0-9-amd64




è§’è‰²
IP
ç»„ä»¶åˆ—è¡¨




master
172.19.82.157
kube-apiserverã€kube-controller-manageã€kube-schedulerã€kubeletã€kube-proxyã€etcdã€containerd


node01
172.19.82.158
kubeletã€kube-proxyã€containerdã€etcd


node02
172.19.82.159
kubeletã€kube-proxyã€containerdã€etcd"><meta property="og:type" content="article"><meta property="og:url" content="https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/"><meta property="og:image" content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta property="article:published_time" content="2023-08-27T10:33:38+08:00"><meta property="article:modified_time" content="2023-08-27T10:33:38+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://agou-images.oss-cn-qingdao.aliyuncs.com/BaseIMG/tuoer.jpg"><meta name=twitter:title content="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12"><meta name=twitter:description content="ç¯‡å¹…è¿‡é•¿ï¼Œä¸ºäº†æ›´å¥½çš„é˜…è¯»ä½“éªŒå¯ä»¥å‰å¾€æˆ‘çš„æ–‡æ¡£-k8s Debian12 äºŒè¿›åˆ¶å®‰è£… æˆ–è€…æˆ‘çš„å¤‡ç”¨åšå®¢åœ°å€ .
ä¸€ã€é¢„å…ˆå‡†å¤‡
1.1 æœåŠ¡å™¨è§’è‰²
ç¯å¢ƒä¿¡æ¯ï¼š

k8sç‰ˆæœ¬ï¼šv1.25.12
Debian12(bookworm)ï¼šå†…æ ¸6.1.0-9-amd64




è§’è‰²
IP
ç»„ä»¶åˆ—è¡¨




master
172.19.82.157
kube-apiserverã€kube-controller-manageã€kube-schedulerã€kubeletã€kube-proxyã€etcdã€containerd


node01
172.19.82.158
kubeletã€kube-proxyã€containerdã€etcd


node02
172.19.82.159
kubeletã€kube-proxyã€containerdã€etcd"><meta name=application-name content="AGou's Blog-2."><meta name=apple-mobile-web-app-title content="AGou's Blog-2."><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/myBlog-2/favicon.png><link rel=icon type=image/png sizes=32x32 href=/myBlog-2/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/myBlog-2/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/><link rel=prev href=https://agou-ops.cn/myBlog-2/post/containerdharbor%E7%A7%81%E6%9C%89%E4%BB%93https/><link rel=next href=https://agou-ops.cn/myBlog-2/post/k8s%E4%B8%AD%E9%83%A8%E7%BD%B2apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/myBlog-2/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/agou-ops.cn\/myBlog-2\/post\/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85\/"},"image":["https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"],"genre":"posts","keywords":"k8s, kubernetes, äºŒè¿›åˆ¶å®‰è£…","wordcount":11821,"url":"https:\/\/agou-ops.cn\/myBlog-2\/post\/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85\/","datePublished":"2023-08-27T10:33:38+08:00","dateModified":"2023-08-27T10:33:38+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"AGou-ops","logo":"https:\/\/agou-images.oss-cn-qingdao.aliyuncs.com\/BaseIMG\/tuoer.jpg"},"author":{"@type":"Person","name":"AGou-ops"},"description":""}</script></head><body header-desktop=auto header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/myBlog-2/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/myBlog-2/posts/>æ‰€æœ‰æ–‡ç«  </a><a class=menu-item href=/myBlog-2/tags/>æ ‡ç­¾ </a><a class=menu-item href=/myBlog-2/categories/>åˆ†ç±» </a><a class=menu-item href=/myBlog-2/anime/>Anime </a><a class=menu-item href=/myBlog-2/about/>å…³äº </a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item language" title=é€‰æ‹©è¯­è¨€>ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select id=language-select-desktop onchange="location=this.value;"><option value=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ selected>ç®€ä½“ä¸­æ–‡</option></select>
</a><span class="menu-item search" id=search-desktop><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=æœç´¢><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin"></i></span></span><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/myBlog-2/ title="AGou's Blog-2"><span class=header-title-pre><i class="far fa-kiss-wink-heart fa-fw"></i></span>AGou-ops</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=æœç´¢><i class="fas fa-search fa-fw"></i></a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=æ¸…ç©º><i class="fas fa-times-circle fa-fw"></i></a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin"></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>å–æ¶ˆ</a></div><a class=menu-item href=/myBlog-2/posts/>æ‰€æœ‰æ–‡ç« </a><a class=menu-item href=/myBlog-2/tags/>æ ‡ç­¾</a><a class=menu-item href=/myBlog-2/categories/>åˆ†ç±»</a><a class=menu-item href=/myBlog-2/anime/>Anime</a><a class=menu-item href=/myBlog-2/about/>å…³äº</a><a class=menu-item href=https://github.com/AGou-ops title=GitHub rel="noopener noreffer" target=_blank><i class="fab fa-github fa-fw"></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=åˆ‡æ¢ä¸»é¢˜>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class=menu-item title=é€‰æ‹©è¯­è¨€>ç®€ä½“ä¸­æ–‡<i class="fas fa-chevron-right fa-fw"></i>
<select class=language-select onchange="location=this.value;"><option value=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ selected>ç®€ä½“ä¸­æ–‡</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>ç›®å½•</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/myBlog-2/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>AGou-ops</a></span>&nbsp;<span class=post-category>æ”¶å½•äº <a href=/myBlog-2/categories/k8s/><i class="far fa-folder fa-fw"></i>k8s</a>&nbsp;<a href=/myBlog-2/categories/kubernetes/><i class="far fa-folder fa-fw"></i>kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-08-27>2023-08-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;çº¦ 11821 å­—&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;é¢„è®¡é˜…è¯» 24 åˆ†é’Ÿ&nbsp;</div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>ç›®å½•</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#ä¸€é¢„å…ˆå‡†å¤‡>ä¸€ã€é¢„å…ˆå‡†å¤‡</a><ul><li><a href=#11-æœåŠ¡å™¨è§’è‰²>1.1 æœåŠ¡å™¨è§’è‰²</a></li><li><a href=#12-ç³»ç»Ÿåˆå§‹åŒ–>1.2 ç³»ç»Ÿåˆå§‹åŒ–</a></li><li><a href=#13-hostsè®¾ç½®>1.3 hostsè®¾ç½®</a><ul><li><a href=#131-é€šè¿‡hostsæ–‡ä»¶é…ç½®>1.3.1 é€šè¿‡hostsæ–‡ä»¶é…ç½®</a></li><li><a href=#132-ä½¿ç”¨bind9-dnså·¥å…·>1.3.2 ä½¿ç”¨bind9 DNSå·¥å…·</a></li></ul></li><li><a href=#14-å¯é€‰å®‰è£…supervisor>1.4 ï¼ˆå¯é€‰ï¼‰å®‰è£…supervisor</a></li></ul></li><li><a href=#äºŒå®‰è£…criå®¹å™¨è¿è¡Œæ—¶åŠharborç§æœ‰ä»“>äºŒã€å®‰è£…CRIå®¹å™¨è¿è¡Œæ—¶åŠharborç§æœ‰ä»“</a><ul><li><a href=#21-å®‰è£…containerd>2.1 å®‰è£…containerd</a><ul><li><a href=#211-æ­¥éª¤ä¸€å®‰è£…containerd>2.1.1 æ­¥éª¤ä¸€å®‰è£…containerd</a></li><li><a href=#212-æ­¥éª¤äºŒå®‰è£…runc>2.1.2 æ­¥éª¤äºŒå®‰è£…runC</a></li><li><a href=#213-æ­¥éª¤ä¸‰å®‰è£…cniæ’ä»¶>2.1.3 æ­¥éª¤ä¸‰å®‰è£…CNIæ’ä»¶</a></li><li><a href=#214-é…ç½®containerdä½¿ç”¨systemd-cgroupé©±åŠ¨>2.1.4 é…ç½®containerdä½¿ç”¨systemd cgroupé©±åŠ¨</a></li><li><a href=#215-å®‰è£…crictlå®¢æˆ·ç«¯å·¥å…·>2.1.5 å®‰è£…crictlå®¢æˆ·ç«¯å·¥å…·</a></li></ul></li><li><a href=#22-å®‰è£…harborç§æœ‰ä»“>2.2 å®‰è£…harborç§æœ‰ä»“</a></li></ul></li><li><a href=#ä¸‰ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦>ä¸‰ã€ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦</a><ul><li><a href=#31-å®‰è£…cfssl>3.1 å®‰è£…cfssl</a></li><li><a href=#32-åˆå§‹åŒ–åŠè¯´æ˜>3.2 åˆå§‹åŒ–åŠè¯´æ˜</a></li></ul></li><li><a href=#å››éƒ¨ç½²masterèŠ‚ç‚¹>å››ã€éƒ¨ç½²masterèŠ‚ç‚¹</a><ul><li><a href=#41-éƒ¨ç½²etcdé›†ç¾¤>4.1 éƒ¨ç½²etcdé›†ç¾¤</a><ul><li><a href=#411-ä¸‹è½½å®‰è£…etcdå’ŒetcdctläºŒè¿›åˆ¶æ–‡ä»¶>4.1.1 ä¸‹è½½å®‰è£…etcdå’ŒetcdctläºŒè¿›åˆ¶æ–‡ä»¶</a></li><li><a href=#412-ä¸ºetcdåˆ¶ä½œè¯ä¹¦>4.1.2 ä¸ºetcdåˆ¶ä½œè¯ä¹¦</a></li><li><a href=#413-é…ç½®åŠå¯åŠ¨etcdé›†ç¾¤>4.1.3 é…ç½®åŠå¯åŠ¨etcdé›†ç¾¤</a></li></ul></li><li><a href=#42-éƒ¨ç½²api-server>4.2 éƒ¨ç½²API server</a><ul><li><a href=#421-ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦>4.2.1 ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦</a></li><li><a href=#422-éƒ¨ç½²api-server>4.2.2 éƒ¨ç½²api-server</a></li></ul></li><li><a href=#43-éƒ¨ç½²controller-manager>4.3 éƒ¨ç½²controller-manager</a></li><li><a href=#44-éƒ¨ç½²kube-scheduler>4.4 éƒ¨ç½²kube-scheduler</a></li><li><a href=#45-é…ç½®kubectlæ‰€éœ€è¦çš„kubeconfig>4.5 é…ç½®kubectlæ‰€éœ€è¦çš„kubeconfig</a></li><li><a href=#46-éƒ¨ç½²nodeç›¸å…³ç»„ä»¶kube-proxykubelet>4.6 éƒ¨ç½²nodeç›¸å…³ç»„ä»¶kube-proxyã€kubelet</a><ul><li><a href=#461-bootstrapè‡ªåŠ¨è®¤è¯kubelet>4.6.1 bootstrapè‡ªåŠ¨è®¤è¯kubelet</a></li><li><a href=#462-éƒ¨ç½²kubelet>4.6.2 éƒ¨ç½²kubelet</a></li><li><a href=#463-å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥åˆ°é›†ç¾¤å†…éƒ¨>4.6.3 å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥åˆ°é›†ç¾¤å†…éƒ¨</a></li><li><a href=#463-éƒ¨ç½²kube-proxy>4.6.3 éƒ¨ç½²kube-proxy</a></li><li><a href=#464-æˆæƒapiserverè®¿é—®kubelet>4.6.4 æˆæƒapiserverè®¿é—®kubelet</a></li><li><a href=#465-éƒ¨ç½²flannelç½‘ç»œç»„ä»¶>4.6.5 éƒ¨ç½²flannelç½‘ç»œç»„ä»¶</a></li></ul></li><li><a href=#47-æ£€æŸ¥masterèŠ‚ç‚¹éƒ¨ç½²ç»“æœ>4.7 æ£€æŸ¥masterèŠ‚ç‚¹éƒ¨ç½²ç»“æœ</a><ul><li><a href=#471-æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€>4.7.1 æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€</a></li><li><a href=#472-é™„æ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹>4.7.2 é™„ï¼šæ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹</a></li></ul></li></ul></li><li><a href=#äº”éƒ¨ç½²nodeèŠ‚ç‚¹>äº”ã€éƒ¨ç½²nodeèŠ‚ç‚¹</a><ul><li><a href=#51-éƒ¨ç½²kubelet>5.1 éƒ¨ç½²kubelet</a></li><li><a href=#52-éƒ¨ç½²kube-proxy>5.2 éƒ¨ç½²kube-proxy</a></li><li><a href=#53-æ£€æŸ¥nodeèŠ‚ç‚¹éƒ¨ç½²ç»“æœ>5.3 æ£€æŸ¥nodeèŠ‚ç‚¹éƒ¨ç½²ç»“æœ</a><ul><li><a href=#531-æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€>5.3.1 æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€</a></li><li><a href=#532-é™„æ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹>5.3.2 é™„ï¼šæ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹</a></li></ul></li></ul></li><li><a href=#å…­å…¶ä»–å¯é€‰ç»„ä»¶å®‰è£…>å…­ã€å…¶ä»–å¯é€‰ç»„ä»¶å®‰è£…</a><ul><li><a href=#61-coredns>6.1 coredns</a><ul><li><a href=#611-éƒ¨ç½²coredns>6.1.1 éƒ¨ç½²coredns</a></li><li><a href=#æµ‹è¯•coredns>æµ‹è¯•coredns</a></li></ul></li><li><a href=#62-nginx-ingress>6.2 nginx ingress</a></li><li><a href=#63-é¢æ¿>6.3 é¢æ¿</a><ul><li><a href=#631-dashboard>6.3.1 dashboard</a></li><li><a href=#632-rancher>6.3.2 rancher</a></li></ul></li></ul></li><li><a href=#ä¸ƒæœªå®Œå¾…ç»­>ä¸ƒã€æœªå®Œå¾…ç»­</a></li></ul></nav></div></div><div class=content id=content><p>ç¯‡å¹…è¿‡é•¿ï¼Œä¸ºäº†æ›´å¥½çš„é˜…è¯»ä½“éªŒå¯ä»¥å‰å¾€<a href=https://docs.agou-ops.cn/docs/CloudNative/k8s/Installation/k8s%20Debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85 target=_blank rel="noopener noreffer">æˆ‘çš„æ–‡æ¡£-k8s Debian12 äºŒè¿›åˆ¶å®‰è£…</a> æˆ–è€…æˆ‘çš„<a href=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ target=_blank rel="noopener noreffer">å¤‡ç”¨åšå®¢åœ°å€</a> .</p><h2 id=ä¸€é¢„å…ˆå‡†å¤‡>ä¸€ã€é¢„å…ˆå‡†å¤‡</h2><h3 id=11-æœåŠ¡å™¨è§’è‰²>1.1 æœåŠ¡å™¨è§’è‰²</h3><p>ç¯å¢ƒä¿¡æ¯ï¼š</p><ul><li>k8sç‰ˆæœ¬ï¼šv1.25.12</li><li>Debian12(bookworm)ï¼šå†…æ ¸6.1.0-9-amd64</li></ul><table><thead><tr><th>è§’è‰²</th><th>IP</th><th>ç»„ä»¶åˆ—è¡¨</th></tr></thead><tbody><tr><td>master</td><td>172.19.82.157</td><td>kube-apiserverã€kube-controller-manageã€kube-schedulerã€kubeletã€kube-proxyã€etcdã€containerd</td></tr><tr><td>node01</td><td>172.19.82.158</td><td>kubeletã€kube-proxyã€containerdã€etcd</td></tr><tr><td>node02</td><td>172.19.82.159</td><td>kubeletã€kube-proxyã€containerdã€etcd</td></tr></tbody></table><p>â„¹ç”±äºæ‰‹ä¸Šèµ„æºæœ‰é™ï¼Œæ‰€ä»¥æ­å»ºä¸€ä¸ªä¸€ä¸»ä¸¤ä»çš„é›†ç¾¤ï¼Œå¦‚æœåç»­æƒ³è¦æ‰©å±•çš„è¯ï¼Œä»…éœ€è¦å†æ·»åŠ masteræˆ–è€…nodeèŠ‚ç‚¹å³å¯ï¼Œæ­¤å¤–etcdå¯ä»¥éƒ¨ç½²åˆ°é›†ç¾¤ä¹‹å¤–å¹¶åšé«˜å¯ç”¨ã€‚</p><h3 id=12-ç³»ç»Ÿåˆå§‹åŒ–>1.2 ç³»ç»Ÿåˆå§‹åŒ–</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ç¦ç”¨é˜²ç«å¢™</span>
systemctl stop ufw
systemctl disable ufw
<span class=c1># å…³é—­SELinuxï¼Œæˆ‘è¿™é‡Œcloudintå®‰è£…çš„ç³»ç»Ÿï¼Œæ²¡æœ‰é˜²ç«å¢™å’Œselinux</span>
sed -i <span class=s1>&#39;s/enforcing/disabled/&#39;</span> /etc/selinux/config
setenforce <span class=m>0</span>
<span class=c1># å…³é—­äº¤æ¢åˆ†åŒºswap</span>
swap -a
sed -ri <span class=s1>&#39;s/.*swap.*/#&amp;/&#39;</span> /etc/fstab
<span class=c1># åŒæ­¥æ—¶åŒºä¸æ—¶é—´ï¼Œ**éå¸¸é‡è¦**</span>
timedatectl set-timezone Asia/Shanghai
ntpdate ntp.aliyun.com    <span class=c1># æ²¡æœ‰ntpdateçš„è¯ï¼Œéœ€è¦å®‰è£…ä¸€ä¸‹ï¼Œapt install ntpdate -y</span>
<span class=c1># é…ç½®ulimitï¼Œæœ€å¤§æ–‡ä»¶æ‰“å¼€æ•°ï¼Œä¼˜åŒ–linuxæ€§èƒ½ï¼Œé‡æ–°é€€å‡ºç™»å½•å½“å‰shellå³å¯ç”Ÿæ•ˆ</span>
<span class=nb>ulimit</span> -SHn <span class=m>65535</span>
cat &gt;&gt; /etc/security/limits.conf <span class=s>&lt;&lt; EOF
</span><span class=s>root soft nofile 65536
</span><span class=s>root hard nofile 131072
</span><span class=s>root soft nproc 65535
</span><span class=s>root hard nproc 655350
</span><span class=s>root soft memlock unlimited
</span><span class=s>root hard memlock unlimited
</span><span class=s>EOF</span>
<span class=c1># å®‰è£…ipvs</span>
apt install ipvsadm ipset sysstat conntrack -y
<span class=c1># åŠ è½½</span>
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack
<span class=c1># å†™å…¥é…ç½®æ–‡ä»¶æ°¸ä¹…ç”Ÿæ•ˆ</span>
cat &gt;&gt; /etc/modules-load.d/ipvs.conf <span class=s>&lt;&lt;EOF
</span><span class=s>ip_vs
</span><span class=s>ip_vs_rr
</span><span class=s>ip_vs_wrr
</span><span class=s>ip_vs_sh
</span><span class=s>nf_conntrack
</span><span class=s>ip_tables
</span><span class=s>ip_set
</span><span class=s>xt_set
</span><span class=s>ipt_set
</span><span class=s>ipt_rpfilter
</span><span class=s>ipt_REJECT
</span><span class=s>ipip
</span><span class=s>EOF</span>
<span class=c1># é‡å¯æœåŠ¡ä»¥åŠ è½½æ¨¡å—</span>
systemctl restart systemd-modules-load.service
<span class=c1># æ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½ï¼Œè¿™é‡Œå¯ä»¥rebootä¸€ä¸‹</span>
lsmod <span class=p>|</span> grep -e ip_vs -e nf_conntrack
<span class=c1># ä¿®æ”¹å†…æ ¸å‚æ•°ï¼ŒæŒ‰éœ€ä¿®æ”¹å³å¯</span>
cat &gt; /etc/sysctl.d/k8s.conf <span class=s>&lt;&lt;EOF
</span><span class=s>net.ipv4.ip_forward = 1
</span><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span><span class=s>fs.may_detach_mounts = 1
</span><span class=s>vm.overcommit_memory=1
</span><span class=s>vm.panic_on_oom=0
</span><span class=s>fs.inotify.max_user_watches=89100
</span><span class=s>fs.file-max=52706963
</span><span class=s>fs.nr_open=52706963
</span><span class=s>net.netfilter.nf_conntrack_max=2310720
</span><span class=s>
</span><span class=s>net.ipv4.tcp_keepalive_time = 600
</span><span class=s>net.ipv4.tcp_keepalive_probes = 3
</span><span class=s>net.ipv4.tcp_keepalive_intvl =15
</span><span class=s>net.ipv4.tcp_max_tw_buckets = 36000
</span><span class=s>net.ipv4.tcp_tw_reuse = 1
</span><span class=s>net.ipv4.tcp_max_orphans = 327680
</span><span class=s>net.ipv4.tcp_orphan_retries = 3
</span><span class=s>net.ipv4.tcp_syncookies = 1
</span><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span><span class=s>net.ipv4.ip_conntrack_max = 65536
</span><span class=s>net.ipv4.tcp_max_syn_backlog = 16384
</span><span class=s>net.ipv4.tcp_timestamps = 0
</span><span class=s>net.core.somaxconn = 16384
</span><span class=s>
</span><span class=s>net.ipv6.conf.all.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.default.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.lo.disable_ipv6 = 0
</span><span class=s>net.ipv6.conf.all.forwarding = 0
</span><span class=s>EOF</span>
<span class=c1># ä½¿å…¶ç”Ÿæ•ˆ</span>
sysctl --system
</code></pre></td></tr></table></div></div><h3 id=13-hostsè®¾ç½®>1.3 hostsè®¾ç½®</h3><h4 id=131-é€šè¿‡hostsæ–‡ä»¶é…ç½®>1.3.1 é€šè¿‡hostsæ–‡ä»¶é…ç½®</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>cat &gt;&gt; /etc/hosts <span class=s>&lt;&lt; EOF
</span><span class=s>172.19.82.157 master.k8s.local master
</span><span class=s>172.19.82.158 node01.k8s.local node01
</span><span class=s>172.19.82.159 node02.k8s.local node02
</span><span class=s>EOF</span>

<span class=c1># æµ‹è¯•ç½‘ç»œè¿é€š</span>
<span class=k>for</span> i in master node01 node02<span class=p>;</span> <span class=k>do</span> ping -c <span class=m>2</span> <span class=nv>$i</span><span class=p>;</span> <span class=k>done</span>
</code></pre></td></tr></table></div></div><h4 id=132-ä½¿ç”¨bind9-dnså·¥å…·>1.3.2 ä½¿ç”¨bind9 DNSå·¥å…·</h4><p>â„¹ä»…åœ¨ä¸€å°æœºå™¨ä¸Šå®‰è£…bind9å³å¯ï¼Œæˆ‘è¿™é‡Œé€‰æ‹©masterèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰é«˜å¯ç”¨éœ€æ±‚çš„è¯å¯ä»¥å®‰è£…å¤šä¸ªbindåšé›†ç¾¤ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># å®‰è£…bind9 DNSå·¥å…·</span>
apt install bind9 dnsutils -y
</code></pre></td></tr></table></div></div><p>ä¿®æ”¹é…ç½®ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/bind/named.conf.options
<span class=c1># å†…å®¹å¦‚ä¸‹(åˆ æ‰äº†éƒ¨åˆ†æ³¨é‡Š)</span>
options <span class=o>{</span>
        directory <span class=s2>&#34;/var/cache/bind&#34;</span><span class=p>;</span>
        // å½“DNSè§£æä¸åˆ°æ—¶ï¼Œè½¬å‘ç»™å…¶ä»–DNSæœåŠ¡å™¨
        forwarders <span class=o>{</span>
                8.8.8.8<span class=p>;</span>
        <span class=o>}</span><span class=p>;</span>
        dnssec-validation auto<span class=p>;</span>

        listen-on-v6 <span class=o>{</span> any<span class=p>;</span> <span class=o>}</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822111122.png data-srcset="https://cdn.agou-ops.cn/others/20230822111122.png, https://cdn.agou-ops.cn/others/20230822111122.png 1.5x, https://cdn.agou-ops.cn/others/20230822111122.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822111122.png title=image.png>
é…ç½®è§£æåŸŸä»¥åŠæ¨¡æ¿æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># é…ç½®è§£æåŸŸ</span>
vim /etc/bind/named.conf.default-zones
// æ­£å‘è§£æåŸŸ
zone <span class=s2>&#34;k8s.local&#34;</span> IN <span class=o>{</span>
        <span class=nb>type</span> master<span class=p>;</span>
        file <span class=s2>&#34;/etc/bind/db.k8s.local&#34;</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
// åå‘è§£æåŸŸ
zone <span class=s2>&#34;82.19.172.in-addr.zrpa&#34;</span> IN <span class=o>{</span>
        <span class=nb>type</span> master<span class=p>;</span>
        file <span class=s2>&#34;/etc/bind/db.in-addr.k8s.local&#34;</span><span class=p>;</span>
<span class=o>}</span><span class=p>;</span>
<span class=c1># å¤åˆ¶æ¨¡ç‰ˆæ–‡ä»¶</span>
cp -a /etc/bind/db.local /etc/bind/db.k8s.local
cp -a /etc/bind/db.127 /etc/bind/db.in-addr.k8s.local
<span class=c1># é…ç½®æ­£å‘è§£ææ–‡ä»¶</span>
vim /etc/bind/db.k8s.local
<span class=nv>$TTL</span>    <span class=m>604800</span>
@       IN      SOA     dns.k8s.local. k8s.local. <span class=o>(</span>
                              <span class=m>2</span>         <span class=p>;</span> Serial
                         <span class=m>604800</span>         <span class=p>;</span> Refresh
                          <span class=m>86400</span>         <span class=p>;</span> Retry
                        <span class=m>2419200</span>         <span class=p>;</span> Expire
                         <span class=m>604800</span> <span class=o>)</span>       <span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
@       IN      NS      dns.k8s.local.
dns     IN      A       172.19.82.157
master  IN      A       172.19.82.157
node01  IN      A       172.19.82.158
node02  IN      A       172.19.82.159
<span class=c1># é…ç½®åå‘è§£ææ–‡ä»¶</span>
vim /etc/bind/db.in-addr.k8s.local
<span class=nv>$TTL</span>    <span class=m>604800</span>
@       IN      SOA     dns.k8s.local. k8s.local. <span class=o>(</span>
                              <span class=m>1</span>         <span class=p>;</span> Serial
                         <span class=m>604800</span>         <span class=p>;</span> Refresh
                          <span class=m>86400</span>         <span class=p>;</span> Retry
                        <span class=m>2419200</span>         <span class=p>;</span> Expire
                         <span class=m>604800</span> <span class=o>)</span>       <span class=p>;</span> Negative Cache TTL
<span class=p>;</span>
@       IN      NS      dns.k8s.local.
<span class=m>157</span>     IN      PTR     k8s.local.
<span class=m>157</span>     IN      PTR     master.k8s.local.
<span class=m>158</span>     IN      PTR     node01.k8s.local.
<span class=m>159</span>     IN      PTR     node02.k8s.local.
</code></pre></td></tr></table></div></div><p>é‡å¯æœåŠ¡åŠæµ‹è¯•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>systemctl restart bind9
<span class=c1># ä¿®æ”¹ä¸»æœºçš„é¦–é€‰DNSåœ°å€ä¸º172.19.82.157</span>
cat /etc/resolv.conf
nameserver 172.19.82.157
nameserver 8.8.8.8
<span class=c1># æµ‹è¯•</span>
<span class=k>for</span> i in master node01 node02<span class=p>;</span> <span class=k>do</span> dig +short <span class=nv>$i</span>.k8s.local<span class=p>;</span> <span class=k>done</span>
<span class=c1># åº”å½“è¾“å‡ºï¼Œæˆªå›¾å¦‚ä¸‹</span>
172.19.82.157
172.19.82.158
172.19.82.159
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822114543.png data-srcset="https://cdn.agou-ops.cn/others/20230822114543.png, https://cdn.agou-ops.cn/others/20230822114543.png 1.5x, https://cdn.agou-ops.cn/others/20230822114543.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822114543.png title=image.png></p><h3 id=14-å¯é€‰å®‰è£…supervisor>1.4 ï¼ˆå¯é€‰ï¼‰å®‰è£…supervisor</h3><p>å®‰è£…supervisorç®€å•å®ç°æœåŠ¡â€œé«˜å¯ç”¨â€.
â„¹éå¿…é¡»ï¼Œä½¿ç”¨systemdæ¥ç®¡ç†ä¹Ÿå¯ä»¥.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> apt install supervisor -y
 <span class=c1># è®¾ç½®ä¸ºå¼€æœºè‡ªå¯ï¼Œå¹¶å¯åŠ¨</span>
 systemctl <span class=nb>enable</span> supervisor --now
</code></pre></td></tr></table></div></div><h2 id=äºŒå®‰è£…criå®¹å™¨è¿è¡Œæ—¶åŠharborç§æœ‰ä»“>äºŒã€å®‰è£…CRIå®¹å™¨è¿è¡Œæ—¶åŠharborç§æœ‰ä»“</h2><h3 id=21-å®‰è£…containerd>2.1 å®‰è£…containerd</h3><p>å®‰è£…æ–¹å¼æœ‰å¥½å‡ ç§ï¼ŒäºŒè¿›åˆ¶å®‰è£…ï¼Œä»“åº“å®‰è£…ä»¥åŠç¼–è¯‘å®‰è£…ã€‚</p><p>è¿™é‡Œæˆ‘ä½¿ç”¨äºŒè¿›åˆ¶è¿›è¡Œå®‰è£…ï¼Œä»“åº“å®‰è£…å‚è€ƒï¼š<a href=https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf target=_blank rel="noopener noreffer">https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf</a>
ğŸ˜„ let&rsquo;s go~</p><h4 id=211-æ­¥éª¤ä¸€å®‰è£…containerd>2.1.1 æ­¥éª¤ä¸€å®‰è£…containerd</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ä»https://github.com/containerd/containerd/releasesï¼Œä¸‹è½½containerdçš„äºŒè¿›åˆ¶åŒ…ï¼Œæ³¨æ„è½¯ä»¶åŒ…æ¶æ„.</span>
wget https://github.com/containerd/containerd/releases/download/v1.6.23/containerd-1.6.23-linux-amd64.tar.gz

tar Cxzvf /usr/local containerd-1.6.23-linux-amd64.tar.gz

<span class=c1># å®‰è£…serviceæœåŠ¡</span>
wget -O /lib/systemd/system/containerd.service https://raw.githubusercontent.com/containerd/containerd/main/containerd.service
<span class=c1># é‡è½½å¹¶å¯åŠ¨æœåŠ¡ï¼Œè®¾ç½®ä¸ºå¼€æœºè‡ªå¯åŠ¨</span>
systemctl daemon-reload
systemctl <span class=nb>enable</span> containerd --now
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822131441.png data-srcset="https://cdn.agou-ops.cn/others/20230822131441.png, https://cdn.agou-ops.cn/others/20230822131441.png 1.5x, https://cdn.agou-ops.cn/others/20230822131441.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822131441.png title=image.png></p><h4 id=212-æ­¥éª¤äºŒå®‰è£…runc>2.1.2 æ­¥éª¤äºŒå®‰è£…runC</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> wget https://github.com/opencontainers/runc/releases/download/v1.1.9/runc.amd64
install -m <span class=m>755</span> runc.amd64 /usr/local/sbin/runc
</code></pre></td></tr></table></div></div><h4 id=213-æ­¥éª¤ä¸‰å®‰è£…cniæ’ä»¶>2.1.3 æ­¥éª¤ä¸‰å®‰è£…CNIæ’ä»¶</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/containernetworking/plugins/releases/download/v1.3.0/cni-plugins-linux-amd64-v1.3.0.tgz
<span class=c1># tar Cxzvf /usr/local/bin cni-plugins-linux-amd64-v1.3.0.tgz</span>
tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.3.0.tgz
</code></pre></td></tr></table></div></div><h4 id=214-é…ç½®containerdä½¿ç”¨systemd-cgroupé©±åŠ¨>2.1.4 é…ç½®containerdä½¿ç”¨systemd cgroupé©±åŠ¨</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ç”Ÿæˆé»˜è®¤çš„é…ç½®æ–‡ä»¶</span>
containerd config default <span class=p>|</span> tee /etc/containerd/config.toml
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132245.png data-srcset="https://cdn.agou-ops.cn/others/20230822132245.png, https://cdn.agou-ops.cn/others/20230822132245.png 1.5x, https://cdn.agou-ops.cn/others/20230822132245.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132245.png title=image.png>
å¤§æ¦‚ç¬¬125è¡Œï¼Œä¿®æ”¹ <code>SystemdCgroup</code> ä¸º<code>true</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/containerd/config.toml
<span class=c1># ä¿®æ”¹é»˜è®¤çš„pauseå®¹å™¨é•œåƒåœ°å€ä¸ºé˜¿é‡Œäº‘å›½å†…æº</span>
<span class=nv>sandbox_image</span> <span class=o>=</span> <span class=s2>&#34;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9&#34;</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132616.png data-srcset="https://cdn.agou-ops.cn/others/20230822132616.png, https://cdn.agou-ops.cn/others/20230822132616.png 1.5x, https://cdn.agou-ops.cn/others/20230822132616.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132616.png title=image.png>
å¤§æ¦‚ç¬¬61è¡Œã€‚
ä¿®æ”¹å®Œä¿å­˜ä¹‹åï¼Œé‡å¯<code>systemctl restart containerd</code>.
æ£€æŸ¥è¿è¡ŒçŠ¶æ€ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822132807.png data-srcset="https://cdn.agou-ops.cn/others/20230822132807.png, https://cdn.agou-ops.cn/others/20230822132807.png 1.5x, https://cdn.agou-ops.cn/others/20230822132807.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822132807.png title=image.png></p><h4 id=215-å®‰è£…crictlå®¢æˆ·ç«¯å·¥å…·>2.1.5 å®‰è£…crictlå®¢æˆ·ç«¯å·¥å…·</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.28.0/crictl-v1.28.0-linux-amd64.tar.gz
tar xf crictl-v1.28.0-linux-amd64.tar.gz -C /usr/local/bin
<span class=c1># ç¼–å†™é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œæ–¹ä¾¿å®¢æˆ·ç«¯ä½¿ç”¨</span>
bash -c <span class=s2>&#34;cat &gt; /etc/crictl.yaml&#34;</span>  <span class=s>&lt;&lt;EOF
</span><span class=s>runtime-endpoint: unix:///run/containerd/containerd.sock
</span><span class=s>image-endpoint: unix:///run/containerd/containerd.sock
</span><span class=s>timeout: 10
</span><span class=s>debug: false
</span><span class=s>EOF</span>
</code></pre></td></tr></table></div></div><p>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ<code>crictl ps</code>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822133349.png data-srcset="https://cdn.agou-ops.cn/others/20230822133349.png, https://cdn.agou-ops.cn/others/20230822133349.png 1.5x, https://cdn.agou-ops.cn/others/20230822133349.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822133349.png title=image.png></p><h3 id=22-å®‰è£…harborç§æœ‰ä»“>2.2 å®‰è£…harborç§æœ‰ä»“</h3><p>harborå»ºè®®éƒ¨ç½²åœ¨å…¶ä»–ä¸»æœºä¸Šï¼Œæ¯”å¦‚è¯´ä¸»æ§æœºï¼Œä¸k8sé›†ç¾¤åˆ†å‰²å¼€æ¥ï¼Œè¿™ä¸ªéšä¾¿ï¼Œçœ‹ä½ è‡ªå·±ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ä¸‹è½½ç¦»çº¿å®‰è£…åŒ…</span>
wget https://github.com/goharbor/harbor/releases/download/v2.8.4/harbor-offline-installer-v2.8.4.tgz
tar xzvf harbor-offline-installer-v2.8.4.tgz
<span class=c1># è¿è¡Œå®‰è£…ç¨‹åºå³å¯</span>
sudo ./install.sh
</code></pre></td></tr></table></div></div><p>åç»­æ­¥éª¤ç•¥.</p><h2 id=ä¸‰ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦>ä¸‰ã€ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦</h2><h3 id=31-å®‰è£…cfssl>3.1 å®‰è£…cfssl</h3><p>â„¹åœ¨masterèŠ‚ç‚¹æˆ–è€…ä¸»æ§æœºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ä¸Šå®‰è£…cfsslå³å¯ï¼Œå…¶ä»–ä¸»æœºä¸éœ€è¦ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl-certinfo_1.6.4_linux_amd64
install -m <span class=m>755</span> cfssl_1.6.4_linux_amd64 /usr/local/bin/cfssl
install -m <span class=m>755</span> cfssljson_1.6.4_linux_amd64 /usr/local/bin/cfssl-json
install -m <span class=m>755</span> cfssl-certinfo_1.6.4_linux_amd64 /usr/local/bin/cfssl-certinfo
</code></pre></td></tr></table></div></div><p>æ£€æŸ¥å®‰è£…ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822134549.png data-srcset="https://cdn.agou-ops.cn/others/20230822134549.png, https://cdn.agou-ops.cn/others/20230822134549.png 1.5x, https://cdn.agou-ops.cn/others/20230822134549.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822134549.png title=image.png></p><h3 id=32-åˆå§‹åŒ–åŠè¯´æ˜>3.2 åˆå§‹åŒ–åŠè¯´æ˜</h3><p>åˆ›å»ºk8sé›†ç¾¤åŠetcdæ‰€éœ€è¦çš„è¯ä¹¦ç›®å½•ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ä¸‹é¢ä¸€ä¸ªå‘½ä»¤ä¸‰ä¸ªä¸»æœºéƒ½æ‰§è¡Œä¸€ä¸‹ã€‚</span>
mkdir -pv /etc/kubernetes/TLS/<span class=o>{</span>etcd,k8s<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>è¯´æ˜ï¼šä¸€å…±åˆ›å»ºäº†ä¸‰ä¸ªCAï¼Œåˆ†åˆ«ç”¨äºï¼š</p><ul><li>etcdé›†ç¾¤</li><li>apiserverã€controller managerã€kubeletã€kube-schedulerç­‰</li><li>front-proxy</li></ul><h2 id=å››éƒ¨ç½²masterèŠ‚ç‚¹>å››ã€éƒ¨ç½²masterèŠ‚ç‚¹</h2><h3 id=41-éƒ¨ç½²etcdé›†ç¾¤>4.1 éƒ¨ç½²etcdé›†ç¾¤</h3><h4 id=411-ä¸‹è½½å®‰è£…etcdå’ŒetcdctläºŒè¿›åˆ¶æ–‡ä»¶>4.1.1 ä¸‹è½½å®‰è£…etcdå’ŒetcdctläºŒè¿›åˆ¶æ–‡ä»¶</h4><p>æˆ‘ä»¬éœ€è¦åœ¨157ï¼Œ158å’Œ159ä¸‰å°æœºå™¨ä¸­éƒ½è£…ä¸Šetcdï¼Œä»¥ç»„æˆetcdé›†ç¾¤ï¼Œä¿è¯etcdçš„é«˜å¯ç”¨ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># 157ï¼Œ158ï¼Œ159æœºå™¨ä¸Šï¼Œä¹Ÿå°±æ˜¯masterå’Œnode01ã€node02èŠ‚ç‚¹æ‰§è¡Œä»¥ä¸‹å‘½ä»¤</span>
<span class=c1># åˆ›å»ºetcdç”¨æˆ·</span>
useradd -s /sbin/nologin -M etcd
wget https://github.com/etcd-io/etcd/releases/download/v3.4.27/etcd-v3.4.27-linux-amd64.tar.gz
tar xf etcd-v3.4.27-linux-amd64.tar.gz -C /usr/local
mv /usr/local/etcd-v3.4.27-linux-amd64 /usr/local/etcd-v3.4.27
<span class=c1># åˆ›å»ºè½¯è¿æ¥æ–¹ä¾¿ä½¿ç”¨</span>
ln -sv /usr/local/etcd-v3.4.27/etcd /usr/local/bin
ln -sv /usr/local/etcd-v3.4.27/etcdctl /usr/local/bin
</code></pre></td></tr></table></div></div><p>æ£€æŸ¥etcdå®‰è£…ç»“æœï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822141125.png data-srcset="https://cdn.agou-ops.cn/others/20230822141125.png, https://cdn.agou-ops.cn/others/20230822141125.png 1.5x, https://cdn.agou-ops.cn/others/20230822141125.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822141125.png title=image.png></p><h4 id=412-ä¸ºetcdåˆ¶ä½œè¯ä¹¦>4.1.2 ä¸ºetcdåˆ¶ä½œè¯ä¹¦</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ä»…åœ¨masterä¸»æœºä¸Šæ‰§è¡Œ</span>
<span class=nb>cd</span> /etc/kubernetes/TLS/etcd
vim ca-config.json
<span class=o>{</span>
  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;etcd&#34;</span>: <span class=o>{</span>
         <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>,
         <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span>
            <span class=s2>&#34;signing&#34;</span>,
            <span class=s2>&#34;key encipherment&#34;</span>,
            <span class=s2>&#34;server auth&#34;</span>,
            <span class=s2>&#34;client auth&#34;</span>
        <span class=o>]</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>


vim ca-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;etcd CA&#34;</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssl-json -bare ca
<span class=c1># æ£€æŸ¥caç”Ÿæˆç»“æœï¼Œè§ä¸‹å›¾</span>

<span class=nb>cd</span> /etc/kubernetes/TLS/etcd
<span class=c1># å°†å¯èƒ½ç”¨åˆ°çš„IPåŠ åˆ°hostså­—æ®µé‡Œé¢ã€‚</span>
vim etcd-server-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;etcd&#34;</span>,
    <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;172.19.82.157&#34;</span>,
        <span class=s2>&#34;172.19.82.158&#34;</span>,
        <span class=s2>&#34;172.19.82.159&#34;</span>,
        <span class=s2>&#34;192.168.3.28&#34;</span>,
        <span class=s2>&#34;127.0.0.1&#34;</span>,
        <span class=s2>&#34;10.96.0.1&#34;</span>
    <span class=o>]</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>
<span class=c1># ä½¿ç”¨ä¸Šé¢çš„è‡ªç­¾CAç­¾å‘etcdè¯ä¹¦</span>
cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>etcd etcd-server-csr.json <span class=p>|</span> cfssl-json -bare etcd-server
</code></pre></td></tr></table></div></div><p>é…ç½®æ–‡ä»¶å­—æ®µè§£é‡Šï¼š</p><blockquote><ul><li>CNï¼šCommon Nameï¼Œæµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘å€æ˜¯å¦åˆæ³•ï¼Œä¸€èˆ¬å†™åŸŸåï¼Œéå¸¸é‡è¦</li><li>STï¼šStateï¼Œçœ</li><li>Lï¼šLocalityï¼Œåœ°åŒº</li><li>Oï¼šOrganization Nameï¼Œç»„ç»‡åç§°</li><li>OUï¼šOrganization Unit Nameï¼Œç»„ç»‡å•ä½åç§°</li></ul></blockquote><p>æ£€æŸ¥CAç”Ÿæˆç»“æœï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823104905.png data-srcset="https://cdn.agou-ops.cn/others/20230823104905.png, https://cdn.agou-ops.cn/others/20230823104905.png 1.5x, https://cdn.agou-ops.cn/others/20230823104905.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823104905.png title=image.png></p><pre><code>ca-config.jsonè§£æï¼š
</code></pre><blockquote><p>expiryï¼šæœ‰æ•ˆæœŸä¸º200å¹´
profiles-serverï¼šå¯åŠ¨serverçš„æ—¶å€™éœ€è¦é…ç½®è¯ä¹¦
profiles-clientï¼šclientå»è¿æ¥serverçš„æ—¶å€™éœ€è¦è¯ä¹¦
profiles-peerï¼šåŒå‘è¯ä¹¦ï¼ŒæœåŠ¡ç«¯æ‰¾å®¢æˆ·ç«¯éœ€è¦è¯ä¹¦ï¼Œå®¢æˆ·ç«¯æ‰¾æœåŠ¡ç«¯éœ€è¦è¯ä¹¦
etcd-peer-csrè§£æï¼š</p><p>hostsï¼šetcdæœ‰å¯èƒ½éƒ¨ç½²åˆ°å“ªäº›ç»„ä»¶çš„IPéƒ½è¦å¡«è¿›æ¥
cfssl gencertï¼šç”Ÿæˆè¯ä¹¦
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823105545.png data-srcset="https://cdn.agou-ops.cn/others/20230823105545.png, https://cdn.agou-ops.cn/others/20230823105545.png 1.5x, https://cdn.agou-ops.cn/others/20230823105545.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823105545.png title=image.png></p></blockquote><h4 id=413-é…ç½®åŠå¯åŠ¨etcdé›†ç¾¤>4.1.3 é…ç½®åŠå¯åŠ¨etcdé›†ç¾¤</h4><p>å¤åˆ¶è¯ä¹¦æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># å¤åˆ¶3.3ä¸­ç”Ÿæˆçš„è¯ä¹¦åˆ°certsç›®å½•ï¼Œæ³¨æ„ï¼Œä¸‰ä¸ªä¸»æœºéƒ½è¦æ‰§è¡Œ</span>
<span class=c1># node01ï¼Œè‡ªå·±åšå…å¯†å“¦ï¼Œè¿™é‡Œå°±ä¸æ•™äº†ã€‚</span>
scp -r master:/etc/kubernetes/TLS/etcd/*.pem /etc/kubernetes/TLS/etcd
<span class=c1># node02</span>
scp -r master:/etc/kubernetes/TLS/etcd/*.pem /etc/kubernetes/TLS/etcd
</code></pre></td></tr></table></div></div><p>ç¼–å†™å¯åŠ¨è„šæœ¬ï¼š
âš æ³¨æ„ä»¥ä¸‹è„šæœ¬ä¸­ï¼Œnode01ï¼ˆ158ï¼‰ï¼Œnode02ï¼ˆ159ï¼‰ä¸»æœºä¸Šéƒ½è¦ä¿®æ”¹å¯¹åº”çš„ç›‘å¬åœ°å€ï¼Œä¸èƒ½ç…§æ¬.
éœ€è¦ä¿®æ”¹çš„åœ°æ–¹æœ‰ä»¥ä¸‹äº”å¤„ï¼š</p><ul><li><code>--name</code></li><li><code>--advertise-client-urls</code></li><li><code>--initial-advertise-peer-urls</code></li><li><code>--listen-peer-urls</code></li><li><code>--listen-client-urls</code></li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># åœ¨157 masterä¸»æœºä¸Š</span>
vim /usr/local/etcd-v3.4.27/etcd-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./etcd --name<span class=o>=</span>etcd-server-157 <span class=se>\
</span><span class=se></span>  --advertise-client-urls<span class=o>=</span>https://172.19.82.157:2379 <span class=se>\
</span><span class=se></span>  --cert-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --client-cert-auth<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --data-dir<span class=o>=</span>/data/etcd <span class=se>\
</span><span class=se></span>  --experimental-initial-corrupt-check<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --experimental-watch-progress-notify-interval<span class=o>=</span>5s <span class=se>\
</span><span class=se></span>  --initial-advertise-peer-urls<span class=o>=</span>https://172.19.82.157:2380 <span class=se>\
</span><span class=se></span>  --initial-cluster<span class=o>=</span>etcd-server-157<span class=o>=</span>https://172.19.82.157:2380,etcd-server-158<span class=o>=</span>https://172.19.82.158:2380,etcd-server-159<span class=o>=</span>https://172.19.82.159:2380 <span class=se>\
</span><span class=se></span>  --key-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --listen-client-urls<span class=o>=</span>https://127.0.0.1:2379,https://172.19.82.157:2379 <span class=se>\
</span><span class=se></span>  --listen-metrics-urls<span class=o>=</span>http://127.0.0.1:2381 <span class=se>\
</span><span class=se></span>  --listen-peer-urls<span class=o>=</span>https://172.19.82.157:2380 <span class=se>\
</span><span class=se></span>  --peer-cert-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --peer-client-cert-auth<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --peer-key-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --peer-trusted-ca-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem <span class=se>\
</span><span class=se></span>  --snapshot-count<span class=o>=</span><span class=m>10000</span> <span class=se>\
</span><span class=se></span>  --trusted-ca-file<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111335.png data-srcset="https://cdn.agou-ops.cn/others/20230823111335.png, https://cdn.agou-ops.cn/others/20230823111335.png 1.5x, https://cdn.agou-ops.cn/others/20230823111335.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111335.png title=image.png>
ä¿®æ”¹è„šæœ¬åŠç›®å½•æƒé™ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>chmod +x /usr/local/etcd-v3.4.27/etcd-startup.sh
chown -R etcd:etcd /usr/local/etcd-v3.4.27/
chown -R etcd:etcd /data/etcd/
chown -R etcd:etcd /data/logs/etcd-server/
chown -R etcd:etcd /etc/kubernetes/TLS/etcd/
</code></pre></td></tr></table></div></div><p>åˆ›å»ºsupervisoré…ç½®æ–‡ä»¶ï¼š
ä¸‰ä¸ªä¸»æœºéƒ½å¾—æ‰§è¡Œï¼Œä¸åŒä¸»æœºåªéœ€è¦ä¿®æ”¹ä¸‹<code>[program:etcd-server-157]</code>è¿™ä¸ªå³å¯ï¼Œæ¢æˆ158å’Œ159.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/supervisor/conf.d/etcd-server.conf
<span class=o>[</span>program:etcd-server-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/etcd-v3.4.27/etcd-startup.sh                 <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                      <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/etcd-v3.4.27                               <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                  <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                    <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                  <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                   <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                 <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                 <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>etcd                                                       <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                            <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/etcd-server/etcd.stdout.log           <span class=p>;</span> stdout log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                    <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                        <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                     <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                     <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
</code></pre></td></tr></table></div></div><p>é‡è½½supervisoré…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>supervisorctl update
supervisorctl status
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822151410.png data-srcset="https://cdn.agou-ops.cn/others/20230822151410.png, https://cdn.agou-ops.cn/others/20230822151410.png 1.5x, https://cdn.agou-ops.cn/others/20230822151410.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822151410.png title=image.png>
ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼ˆleaderæ˜¯è°ï¼Ÿï¼‰</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>etcdctl -w table --cacert<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem --cert<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem --key<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem --endpoints https://172.19.82.157:2379 endpoint status --cluster

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111655.png data-srcset="https://cdn.agou-ops.cn/others/20230823111655.png, https://cdn.agou-ops.cn/others/20230823111655.png 1.5x, https://cdn.agou-ops.cn/others/20230823111655.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111655.png title=image.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>etcdctl -w table --cacert<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem --cert<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem --key<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem --endpoints https://172.19.82.157:2379 member list
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823111723.png data-srcset="https://cdn.agou-ops.cn/others/20230823111723.png, https://cdn.agou-ops.cn/others/20230823111723.png 1.5x, https://cdn.agou-ops.cn/others/20230823111723.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823111723.png title=image.png></p><h3 id=42-éƒ¨ç½²api-server>4.2 éƒ¨ç½²API server</h3><p>API serveræˆ‘å°±ä¸åšé›†ç¾¤äº†ï¼ˆå•èŠ‚ç‚¹ï¼‰ï¼Œæ–¹æ³•å…¶å®å’Œetcdå¤§å·®ä¸å·®.</p><h4 id=421-ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦>4.2.1 ä½¿ç”¨cfsslç”Ÿæˆè¯ä¹¦</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># è¿™é‡Œç›´æ¥ä½¿ç”¨ä¸Šé¢etcdçš„è‡ªå»ºCAï¼Œå¦‚æœetcdéƒ¨ç½²åˆ°é›†ç¾¤ä¹‹å¤–çš„è¯ï¼Œå¯ä»¥é‡æ–°å»ºä¸ªCAä»¥ä½œåŒºåˆ†ã€‚</span>
<span class=c1># masterä¸»æœºä¸Š</span>
<span class=nb>cd</span> /etc/kubernetes/TLS/k8s/
vim ca-config.json
<span class=o>{</span>
  <span class=s2>&#34;signing&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;default&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>
    <span class=o>}</span>,
    <span class=s2>&#34;profiles&#34;</span>: <span class=o>{</span>
      <span class=s2>&#34;kubernetes&#34;</span>: <span class=o>{</span>
         <span class=s2>&#34;expiry&#34;</span>: <span class=s2>&#34;87600h&#34;</span>,
         <span class=s2>&#34;usages&#34;</span>: <span class=o>[</span>
            <span class=s2>&#34;signing&#34;</span>,
            <span class=s2>&#34;key encipherment&#34;</span>,
            <span class=s2>&#34;server auth&#34;</span>,
            <span class=s2>&#34;client auth&#34;</span>
        <span class=o>]</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>


vim ca-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
            <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;k8s&#34;</span>,
            <span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>


cfssl gencert -initca ca-csr.json <span class=p>|</span> cfssl-json -bare ca -

vim kube-apiserver-csr.json
<span class=o>{</span>
    <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
    <span class=s2>&#34;hosts&#34;</span>: <span class=o>[</span>
        <span class=s2>&#34;127.0.0.1&#34;</span>,
        <span class=s2>&#34;kubernetes&#34;</span>,
        <span class=s2>&#34;kubernetes.default&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc.cluster&#34;</span>,
        <span class=s2>&#34;kubernetes.default.svc.cluster.local&#34;</span>,
        <span class=s2>&#34;172.19.82.157&#34;</span>,
        <span class=s2>&#34;172.19.82.158&#34;</span>,
        <span class=s2>&#34;172.19.82.159&#34;</span>,
        <span class=s2>&#34;192.168.3.28&#34;</span>,
        <span class=s2>&#34;10.96.0.1&#34;</span>
    <span class=o>]</span>,
    <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
        <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
    <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
            <span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;k8s&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-apiserver-csr.json <span class=p>|</span> cfssl-json -bare kube-apiserver

<span class=c1># ç”Ÿæˆsa keyï¼Œåé¢ä¼šç”¨åˆ°</span>
openssl genrsa -out sa.key <span class=m>2048</span>
openssl rsa -in sa.key -pubout -out sa.pub

mkdir proxy-client
<span class=nb>cd</span> proxy-client

vim front-proxy-ca-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CA&#34;</span>:<span class=o>{</span>
	  <span class=s2>&#34;expiry&#34;</span>:<span class=s2>&#34;87600h&#34;</span>
  <span class=o>}</span>,
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
     <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
     <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>
<span class=o>}</span>

cfssl gencert -initca front-proxy-ca-csr.json <span class=p>|</span> cfssl-json -bare front-proxy-ca

vim front-proxy-client-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;front-proxy-client&#34;</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
     <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
     <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>
<span class=o>}</span>

cfssl gencert <span class=se>\
</span><span class=se></span>-ca<span class=o>=</span>front-proxy-ca.pem <span class=se>\
</span><span class=se></span>-ca-key<span class=o>=</span>front-proxy-ca-key.pem  <span class=se>\
</span><span class=se></span>-config<span class=o>=</span>../ca-config.json   <span class=se>\
</span><span class=se></span>-profile<span class=o>=</span>kubernetes front-proxy-client-csr.json <span class=p>|</span> cfssl-json -bare front-proxy-client

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823114325.png data-srcset="https://cdn.agou-ops.cn/others/20230823114325.png, https://cdn.agou-ops.cn/others/20230823114325.png 1.5x, https://cdn.agou-ops.cn/others/20230823114325.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823114325.png title=image.png></p><h4 id=422-éƒ¨ç½²api-server>4.2.2 éƒ¨ç½²api-server</h4><p>ä»“åº“åœ°å€ï¼š<a href=https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#v12512 target=_blank rel="noopener noreffer">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.25.md#v12512</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://dl.k8s.io/v1.25.12/kubernetes-server-linux-amd64.tar.gz
tar xf kubernetes-server-linux-amd64.tar.gz -C /usr/local/
<span class=nb>cd</span> /usr/local/kubernetes
<span class=c1># åˆ é™¤ä¸å¿…è¦çš„æºç å’Œæ–‡ä»¶</span>
rm -f kubernetes-src.tar.gz
rm -rf server/bin/*.tar
rm -rf server/bin/*_tag
<span class=c1># æ·»åŠ è½¯è¿æ¥æ–¹ä¾¿ä½¿ç”¨</span>
ln -sv /usr/local/kubernetes/server/bin/* /usr/local/bin/
</code></pre></td></tr></table></div></div><p>å¯åŠ¨è„šæœ¬ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>mkdir /etc/kubernetes/config
vim /usr/local/kubernetes/server/bin/kube-apiserver-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
<span class=c1># ä¸‹é¢çš„certå’Œkeyç»Ÿç»Ÿç”¨ä¸€å¥—å°±å¥½äº†ã€‚</span>
<span class=c1>#!/usr/bin/env sh</span>
./kube-apiserver <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span>  <span class=se>\
</span><span class=se></span>  --logtostderr<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --allow-privileged<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --bind-address<span class=o>=</span>172.19.82.157  <span class=se>\
</span><span class=se></span>  --secure-port<span class=o>=</span><span class=m>6443</span>  <span class=se>\
</span><span class=se></span>  --advertise-address<span class=o>=</span><span class=m>157</span> <span class=se>\
</span><span class=se></span>  --service-cluster-ip-range<span class=o>=</span>10.244.0.0/12 <span class=se>\
</span><span class=se></span>  --service-node-port-range<span class=o>=</span>30000-40000  <span class=se>\
</span><span class=se></span>  --etcd-servers<span class=o>=</span>https://172.19.82.157:2379,https://172.19.82.158:2379,https://172.19.82.159:2379 <span class=se>\
</span><span class=se></span>  --etcd-cafile<span class=o>=</span>/etc/kubernetes/TLS/etcd/ca.pem <span class=se>\
</span><span class=se></span>  --etcd-certfile<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server.pem <span class=se>\
</span><span class=se></span>  --etcd-keyfile<span class=o>=</span>/etc/kubernetes/TLS/etcd/etcd-server-key.pem <span class=se>\
</span><span class=se></span>  --client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --tls-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver.pem <span class=se>\
</span><span class=se></span>  --tls-private-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver-key.pem
  --kubelet-client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver.pem <span class=se>\
</span><span class=se></span>  --kubelet-client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-apiserver-key.pem <span class=se>\
</span><span class=se></span>  --service-account-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.pub  <span class=se>\
</span><span class=se></span>  --service-account-signing-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.key  <span class=se>\
</span><span class=se></span>  --service-account-issuer<span class=o>=</span>https://kubernetes.default.svc.cluster.local <span class=se>\
</span><span class=se></span>  --kubelet-preferred-address-types<span class=o>=</span>InternalIP,ExternalIP,Hostname  <span class=se>\
</span><span class=se></span>  --enable-admission-plugins<span class=o>=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=se>\
</span><span class=se></span>  --authorization-mode<span class=o>=</span>Node,RBAC  <span class=se>\
</span><span class=se></span>  --enable-bootstrap-token-auth<span class=o>=</span><span class=nb>true</span>  <span class=se>\
</span><span class=se></span>  --requestheader-client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-ca.pem  <span class=se>\
</span><span class=se></span>  --proxy-client-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-client.pem  <span class=se>\
</span><span class=se></span>  --proxy-client-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-client-key.pem  <span class=se>\
</span><span class=se></span>  --requestheader-allowed-names<span class=o>=</span>front-proxy-client  <span class=se>\
</span><span class=se></span>  --requestheader-group-headers<span class=o>=</span>X-Remote-Group  <span class=se>\
</span><span class=se></span>  --requestheader-extra-headers-prefix<span class=o>=</span>X-Remote-Extra-  <span class=se>\
</span><span class=se></span>  --requestheader-username-headers<span class=o>=</span>X-Remote-User

chmod +x /usr/local/kubernetes/server/bin/kube-apiserver-startup.sh
mkdir -pv /data/logs/kubernetes/kube-apiserver
</code></pre></td></tr></table></div></div><p>é…ç½®supervisorï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim /etc/supervisor/conf.d/apiserver.conf
<span class=o>[</span>program:apiserver-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-apiserver-startup.sh                 <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                      <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                               <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                  <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                     <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                  <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                   <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                 <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                 <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                       <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                            <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log           <span class=p>;</span> stdout log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                    <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                        <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                     <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                     <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>


<span class=c1># é‡è½½supervisoré…ç½®æ–‡ä»¶</span>
supervisorctl update
ss -tnulp  <span class=p>|</span> grep <span class=m>6443</span>
<span class=c1># output</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                                *:6443             *:*    users:<span class=o>((</span><span class=s2>&#34;kube-apiserver&#34;</span>,pid<span class=o>=</span>5989,fd<span class=o>=</span>7<span class=o>))</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230822170053.png data-srcset="https://cdn.agou-ops.cn/others/20230822170053.png, https://cdn.agou-ops.cn/others/20230822170053.png 1.5x, https://cdn.agou-ops.cn/others/20230822170053.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230822170053.png title=image.png></p><h3 id=43-éƒ¨ç½²controller-manager>4.3 éƒ¨ç½²controller-manager</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kube-controller-manager-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;system:kube-controller-manager&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
    <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:kube-controller-manager&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
    <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-controller-manager-csr.json <span class=p>|</span> cfssl-json -bare kube-controller-manager

<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># æ·»åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯</span>
kubectl config set-credentials system:kube-controller-manager <span class=se>\
</span><span class=se></span>	--client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-controller-manager.pem <span class=se>\
</span><span class=se></span>	--client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-controller-manager-key.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-controller-manager <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig


vim /usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-controller-manager <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span> <span class=se>\
</span><span class=se></span>  --root-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --cluster-signing-cert-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --cluster-signing-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca-key.pem <span class=se>\
</span><span class=se></span>  --service-account-private-key-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/sa.key <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-controller-manager.kubeconfig <span class=se>\
</span><span class=se></span>  --leader-elect<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --use-service-account-credentials<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --node-monitor-grace-period<span class=o>=</span>40s <span class=se>\
</span><span class=se></span>  --node-monitor-period<span class=o>=</span>5s <span class=se>\
</span><span class=se></span>  --pod-eviction-timeout<span class=o>=</span>2m0s <span class=se>\
</span><span class=se></span>  --controllers<span class=o>=</span>*,bootstrapsigner,tokencleaner <span class=se>\
</span><span class=se></span>  --allocate-node-cidrs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --cluster-cidr<span class=o>=</span>10.244.0.0/12 <span class=se>\
</span><span class=se></span>  --requestheader-client-ca-file<span class=o>=</span>/etc/kubernetes/TLS/k8s/proxy-client/front-proxy-ca.pem <span class=se>\
</span><span class=se></span>  --node-cidr-mask-size<span class=o>=</span><span class=m>24</span>

chmod +x /usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh
mkdir -pv /data/logs/kubernetes/kube-controller-manager/

vim /etc/supervisor/conf.d/controller-manager.conf
<span class=o>[</span>program:kube-controller-manager-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-controller-manager-startup.sh                     <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                                        <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                              <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                                    <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                                  <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>30</span>                                                                      <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                                    <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                                     <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                                   <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                                   <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                         <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                              <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                                      <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                          <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                                       <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                                       <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823134408.png data-srcset="https://cdn.agou-ops.cn/others/20230823134408.png, https://cdn.agou-ops.cn/others/20230823134408.png 1.5x, https://cdn.agou-ops.cn/others/20230823134408.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823134408.png title=image.png></p><h3 id=44-éƒ¨ç½²kube-scheduler>4.4 éƒ¨ç½²kube-scheduler</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kube-scheduler-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;system:kube-scheduler&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:kube-scheduler&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kube-scheduler-csr.json <span class=p>|</span> cfssl-json -bare kube-scheduler

<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># æ·»åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯</span>
kubectl config set-credentials system:kube-scheduler <span class=se>\
</span><span class=se></span>  --client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-scheduler.pem <span class=se>\
</span><span class=se></span>  --client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kube-scheduler-key.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-scheduler <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig


vim /usr/local/kubernetes/server/bin/kube-scheduler-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-scheduler <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span> <span class=se>\
</span><span class=se></span>  --leader-elect<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-scheduler.kubeconfig

chmod +x /usr/local/kubernetes/server/bin/kube-scheduler-startup.sh
mkdir -pv /data/logs/kubernetes/kube-scheduler/

vim /etc/supervisor/conf.d/scheduler.conf
<span class=o>[</span>program:kube-scheduler-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-scheduler-startup.sh                   <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p>è‡³æ­¤ï¼ŒmasterèŠ‚ç‚¹çš„æ ¸å¿ƒç»„ä»¶åŸºæœ¬å®‰è£…å®Œæˆäº†ï¼Œä½¿ç”¨sså‘½ä»¤æŸ¥çœ‹æœåŠ¡ç›‘å¬çŠ¶æ€ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>&gt; ss -tnulp <span class=p>|</span> grep kube
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                        127.0.0.1:10259      0.0.0.0:*    users:<span class=o>((</span><span class=s2>&#34;kube-scheduler&#34;</span>,pid<span class=o>=</span>9385,fd<span class=o>=</span>7<span class=o>))</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                        127.0.0.1:10257      0.0.0.0:*    users:<span class=o>((</span><span class=s2>&#34;kube-controller&#34;</span>,pid<span class=o>=</span>9370,fd<span class=o>=</span>7<span class=o>))</span>
tcp   LISTEN <span class=m>0</span>      <span class=m>16384</span>                                *:6443             *:*    users:<span class=o>((</span><span class=s2>&#34;kube-apiserver&#34;</span>,pid<span class=o>=</span>5989,fd<span class=o>=</span>7<span class=o>))</span>
</code></pre></td></tr></table></div></div><h3 id=45-é…ç½®kubectlæ‰€éœ€è¦çš„kubeconfig>4.5 é…ç½®kubectlæ‰€éœ€è¦çš„kubeconfig</h3><p>æ­¥éª¤å¤§ä½“å’Œä¸Šé¢éƒ½æ˜¯ä¸€è‡´çš„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/TLS/k8s
vim kubectl-csr.json
<span class=o>{</span>
  <span class=s2>&#34;CN&#34;</span>: <span class=s2>&#34;kubectl&#34;</span>,
  <span class=s2>&#34;hosts&#34;</span>: <span class=o>[]</span>,
  <span class=s2>&#34;key&#34;</span>: <span class=o>{</span>
    <span class=s2>&#34;algo&#34;</span>: <span class=s2>&#34;rsa&#34;</span>,
    <span class=s2>&#34;size&#34;</span>: <span class=m>2048</span>
  <span class=o>}</span>,
  <span class=s2>&#34;names&#34;</span>: <span class=o>[</span>
        <span class=o>{</span>
            <span class=s2>&#34;C&#34;</span>: <span class=s2>&#34;CN&#34;</span>,
            <span class=s2>&#34;L&#34;</span>: <span class=s2>&#34;HangZhou&#34;</span>,
            <span class=s2>&#34;ST&#34;</span>: <span class=s2>&#34;ZheJiang&#34;</span>,
			<span class=s2>&#34;O&#34;</span>: <span class=s2>&#34;system:masters&#34;</span>,
			<span class=s2>&#34;OU&#34;</span>: <span class=s2>&#34;System&#34;</span>
        <span class=o>}</span>
  <span class=o>]</span>
<span class=o>}</span>

cfssl gencert -ca<span class=o>=</span>ca.pem -ca-key<span class=o>=</span>ca-key.pem -config<span class=o>=</span>ca-config.json -profile<span class=o>=</span>kubernetes kubectl-csr.json <span class=p>|</span> cfssl-json -bare kubectl

<span class=c1># è¿™ä¸ªä½ æ”¾åˆ°å’Œä¸Šé¢åŒæ ·çš„ä½ç½®ï¼Œç„¶åå¤åˆ¶åˆ°~/.kubeé‡Œé¢ä¹Ÿè¡Œï¼Œè¿™é‡Œæˆ‘å›¾ä¸ªæ–¹ä¾¿</span>
<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>--certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># æ·»åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯</span>
kubectl config set-credentials cluster-admin <span class=se>\
</span><span class=se></span>--client-certificate<span class=o>=</span>/etc/kubernetes/TLS/k8s/kubectl.pem <span class=se>\
</span><span class=se></span>--client-key<span class=o>=</span>/etc/kubernetes/TLS/k8s/kubectl-key.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>--cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>--user<span class=o>=</span>cluster-admin <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/root/.kube/config
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/root/.kube/config
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230823163202.png data-srcset="https://cdn.agou-ops.cn/others/20230823163202.png, https://cdn.agou-ops.cn/others/20230823163202.png 1.5x, https://cdn.agou-ops.cn/others/20230823163202.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230823163202.png title=image.png></p><h3 id=46-éƒ¨ç½²nodeç›¸å…³ç»„ä»¶kube-proxykubelet>4.6 éƒ¨ç½²nodeç›¸å…³ç»„ä»¶kube-proxyã€kubelet</h3><h4 id=461-bootstrapè‡ªåŠ¨è®¤è¯kubelet>4.6.1 bootstrapè‡ªåŠ¨è®¤è¯kubelet</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
<span class=c1># ç”Ÿæˆéšæœºè®¤è¯tokenidå’Œsecretï¼Œå¹¶èµ‹äºˆæƒé™ï¼Œä¸‹é¢ç›´åˆ°EOFä¸€å—æ‰§è¡Œã€‚</span>
<span class=nv>TOKEN_ID</span><span class=o>=</span><span class=sb>`</span>head -c <span class=m>16</span> /dev/urandom <span class=p>|</span> od -An -t x <span class=p>|</span> tr -d <span class=s1>&#39; &#39;</span> <span class=p>|</span> head -c6<span class=sb>`</span>
<span class=nv>TOKEN_SECRET</span><span class=o>=</span><span class=sb>`</span>head -c <span class=m>16</span> /dev/urandom <span class=p>|</span> od -An -t x <span class=p>|</span> tr -d <span class=s1>&#39; &#39;</span> <span class=p>|</span> head -c16<span class=sb>`</span>
cat &gt; bootstrap.secret.yaml <span class=s>&lt;&lt;EOF
</span><span class=s>apiVersion: v1
</span><span class=s>kind: Secret
</span><span class=s>metadata:
</span><span class=s>  name: bootstrap-token-$a
</span><span class=s>  namespace: kube-system
</span><span class=s>type: bootstrap.kubernetes.io/token
</span><span class=s>stringData:
</span><span class=s>  description: &#34;The default bootstrap token generated by &#39;kubelet &#39;.&#34;
</span><span class=s>  token-id: &#34;$TOKEN_ID&#34;
</span><span class=s>  token-secret: &#34;$TOKEN_SECRET&#34;
</span><span class=s>  usage-bootstrap-authentication: &#34;true&#34;
</span><span class=s>  usage-bootstrap-signing: &#34;true&#34;
</span><span class=s>  auth-extra-groups:  system:bootstrappers:default-node-token,system:bootstrappers:worker,system:bootstrappers:ingress
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: kubelet-bootstrap
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:node-bootstrapper
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:bootstrappers:default-node-token
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: node-autoapprove-bootstrap
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:bootstrappers:default-node-token
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: node-autoapprove-certificate-rotation
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeclient
</span><span class=s>subjects:
</span><span class=s>- apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: Group
</span><span class=s>  name: system:nodes
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRole
</span><span class=s>metadata:
</span><span class=s>  annotations:
</span><span class=s>    rbac.authorization.kubernetes.io/autoupdate: &#34;true&#34;
</span><span class=s>  labels:
</span><span class=s>    kubernetes.io/bootstrapping: rbac-defaults
</span><span class=s>  name: system:kube-apiserver-to-kubelet
</span><span class=s>rules:
</span><span class=s>  - apiGroups:
</span><span class=s>      - &#34;&#34;
</span><span class=s>    resources:
</span><span class=s>      - nodes/proxy
</span><span class=s>      - nodes/stats
</span><span class=s>      - nodes/log
</span><span class=s>      - nodes/spec
</span><span class=s>      - nodes/metrics
</span><span class=s>    verbs:
</span><span class=s>      - &#34;*&#34;
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: system:kube-apiserver
</span><span class=s>  namespace: &#34;&#34;
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:kube-apiserver-to-kubelet
</span><span class=s>subjects:
</span><span class=s>  - apiGroup: rbac.authorization.k8s.io
</span><span class=s>    kind: User
</span><span class=s>    name: kube-apiserver
</span><span class=s>EOF</span>

<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes  <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span>   <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æ·»åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯</span>
kubectl config set-credentials kubelet-bootstrap-user  <span class=se>\
</span><span class=se></span>  --token<span class=o>=</span><span class=nv>$TOKEN_ID</span>.<span class=nv>$TOKEN_SECRET</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context kubelet-bootstrap-user@kubernetes <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes   <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>kubelet-bootstrap-user <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context kubelet-bootstrap-user@kubernetes  <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
</code></pre></td></tr></table></div></div><h4 id=462-éƒ¨ç½²kubelet>4.6.2 éƒ¨ç½²kubelet</h4><p>âš  ç”±äºmasterèŠ‚ç‚¹åŒæ ·è¦è¿è¡Œä¸€äº›podï¼Œæ¯”å¦‚flannelã€calicoç½‘ç»œç»„ä»¶ç­‰ï¼Œæ‰€ä»¥åœ¨masterèŠ‚ç‚¹ä¹Ÿéœ€è¦å®‰è£…Kubeletå’ŒKube-proxyç»„ä»¶ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># å‚è€ƒï¼šhttps://kubernetes.io/zh-cn/docs/reference/config-api/kubelet-config.v1beta1/</span>
vim /etc/kubernetes/config/kubelet-conf.yml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
address: 172.19.82.157
port: <span class=m>10250</span>
readOnlyPort: <span class=m>10255</span>
authentication:
  anonymous:
    enabled: <span class=nb>false</span>
  webhook:
    cacheTTL: 2m0s
    enabled: <span class=nb>true</span>
  x509:
    clientCAFile: /etc/kubernetes/TLS/k8s/ca.pem
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 5m0s
    cacheUnauthorizedTTL: 30s
cgroupDriver: systemd
cgroupsPerQOS: <span class=nb>true</span>
clusterDNS:
- 10.100.0.2
clusterDomain: cluster.local
containerLogMaxFiles: <span class=m>5</span>
containerLogMaxSize: 10Mi
contentType: application/vnd.kubernetes.protobuf
cpuCFSQuota: <span class=nb>true</span>
cpuManagerPolicy: none
cpuManagerReconcilePeriod: 10s
enableControllerAttachDetach: <span class=nb>true</span>
enableDebuggingHandlers: <span class=nb>true</span>
enforceNodeAllocatable:
- pods
eventBurst: <span class=m>10</span>
eventRecordQPS: <span class=m>5</span>
evictionHard:
  imagefs.available: 15%
  memory.available: 100Mi
  nodefs.available: 10%
  nodefs.inodesFree: 5%
evictionPressureTransitionPeriod: 5m0s
failSwapOn: <span class=nb>true</span>
fileCheckFrequency: 20s
hairpinMode: promiscuous-bridge
healthzBindAddress: 127.0.0.1
healthzPort: <span class=m>10248</span>
httpCheckFrequency: 20s
imageGCHighThresholdPercent: <span class=m>85</span>
imageGCLowThresholdPercent: <span class=m>80</span>
imageMinimumGCAge: 2m0s
iptablesDropBit: <span class=m>15</span>
iptablesMasqueradeBit: <span class=m>14</span>
kubeAPIBurst: <span class=m>10</span>
kubeAPIQPS: <span class=m>5</span>
makeIPTablesUtilChains: <span class=nb>true</span>
maxOpenFiles: <span class=m>1000000</span>
maxPods: <span class=m>110</span>
nodeStatusUpdateFrequency: 10s
oomScoreAdj: -999
podPidsLimit: -1
registryBurst: <span class=m>10</span>
registryPullQPS: <span class=m>5</span>
resolvConf: /etc/resolv.conf
rotateCertificates: <span class=nb>true</span>
runtimeRequestTimeout: 2m0s
serializeImagePulls: <span class=nb>true</span>
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 4h0m0s
syncFrequency: 1m0s
volumeStatsAggPeriod: 1m0s


vim /usr/local/kubernetes/server/bin/kubelet-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kubelet <span class=se>\
</span><span class=se></span>  --bootstrap-kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet.kubeconfig <span class=se>\
</span><span class=se></span>  --config<span class=o>=</span>/etc/kubernetes/config/kubelet-conf.yml <span class=se>\
</span><span class=se></span>  --hostname-override<span class=o>=</span>master0 <span class=se>\
</span><span class=se></span>  --node-labels<span class=o>=</span>node.kubernetes.io/node<span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=se>\
</span><span class=se></span>  --container-runtime-endpoint<span class=o>=</span>unix:///var/run/containerd/containerd.sock


<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes <span class=se>\
</span><span class=se></span>--certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>--embed-certs<span class=o>=</span><span class=nb>true</span> <span class=se>\
</span><span class=se></span>--server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æ·»åŠ è¯ä¹¦æ–‡ä»¶ä¿¡æ¯ï¼Œä¸‹é¢è¿™ä¸ªtokenæ˜¯ä¹‹å‰ç”Ÿæˆçš„ï¼Œä¹Ÿå°±æ˜¯/etc/kubernetes/config/token.csv</span>
kubectl config set-credentials kubelet-bootstrap <span class=se>\
</span><span class=se></span>--token<span class=o>=</span>8d435b925863119020c4da4d16e064c8 <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context default <span class=se>\
</span><span class=se></span>--cluster<span class=o>=</span>kubernetes <span class=se>\
</span><span class=se></span>--user<span class=o>=</span>kubelet-bootstrap <span class=se>\
</span><span class=se></span>--kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context default --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kubelet-bootstrap.kubeconfig


chmod +x /usr/local/kubernetes/server/bin/kubelet-startup.sh
mkdir -pv /data/logs/kubernetes/kubelet/ /etc/kubernetes/manifests/

vim /etc/supervisor/conf.d/kubelet.conf
<span class=o>[</span>program:kubelet-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kubelet-startup.sh
                  <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kubelet/kubelet.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824111121.png data-srcset="https://cdn.agou-ops.cn/others/20230824111121.png, https://cdn.agou-ops.cn/others/20230824111121.png 1.5x, https://cdn.agou-ops.cn/others/20230824111121.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824111121.png title=image.png></p><h4 id=463-å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥åˆ°é›†ç¾¤å†…éƒ¨>4.6.3 å°†masterèŠ‚ç‚¹ä½œä¸ºnodeåŠ å…¥åˆ°é›†ç¾¤å†…éƒ¨</h4><p><strong>âš  æ³¨æ„ï¼šè¿™ä¸ªæ­¥éª¤å¦‚æœåšäº†bootstrap kubeletï¼Œåˆ™ä¸éœ€è¦æ‰‹åŠ¨æˆæƒï¼Œå¯ç›´æ¥å¿½ç•¥æ”¹æ­¥éª¤ã€‚</strong></p><blockquote><p>ä»¥ä¸‹æ¥æºäºç½‘ç»œï¼š
å½“kubeletç»„ä»¶å¯åŠ¨æˆåŠŸåï¼Œå°±ä¼šæƒ³apiserverå‘é€ä¸€ä¸ªè¯·æ±‚åŠ å…¥é›†ç¾¤çš„ä¿¡æ¯ï¼Œåªæœ‰å½“masterèŠ‚ç‚¹æˆæƒåŒæ„åï¼Œæ‰å¯ä»¥æ­£å¸¸åŠ å…¥ï¼Œè™½ç„¶æ˜¯masterèŠ‚ç‚¹éƒ¨ç½²çš„nodeç»„ä»¶ï¼Œ> ä½†æ˜¯ä¹Ÿä¼šå‘ç”Ÿä¸€ä¸ªåŠ å…¥é›†ç¾¤çš„ä¿¡æ¯ï¼Œéœ€è¦masteråŒæ„ã€‚</p><p>å½“kubeletå¯åŠ¨ä¹‹åï¼Œé¦–å…ˆä¼šåœ¨è¯ä¹¦ç›®å½•ç”Ÿæˆä¸€ä¸ªkubelet-client.key.tmpè¿™ä¸ªæ–‡ä»¶ï¼Œå½“ä½¿ç”¨kubectl certificate approveå‘½ä»¤æˆæƒæˆåŠŸnodeçš„è¯·æ±‚ä¹‹åï¼Œkubele> t-client.key.tmpå°æ—¶ï¼Œéšä¹‹ä¼šç”Ÿæˆä¸€ä¸ªkubelet-client-current.pemçš„è¯ä¹¦æ–‡ä»¶ï¼Œç”¨äºä¸apiserverå»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶å†ä½¿ç”¨kubectl get > nodeå°±ä¼šçœ‹åˆ°èŠ‚ç‚¹ä¿¡æ¯äº†ã€‚</p><p>æ‰©å±•ï¼šå¦‚æœåæœŸæƒ³è¦ä¿®æ”¹nodeçš„åç§°ï¼Œé‚£ä¹ˆå°±æŠŠç”Ÿæˆçš„kubeletè¯ä¹¦æ–‡ä»¶å…¨éƒ¨åˆ é™¤ï¼Œç„¶åä½¿ç”¨kubectl delete > nodeåˆ é™¤è¯¥èŠ‚ç‚¹ï¼Œåœ¨ä¿®æ”¹kubeleté…ç½®æ–‡ä»¶ä¸­è¯¥èŠ‚ç‚¹çš„åç§°ï¼Œç„¶åä½¿ç”¨kubectl delete > csråˆ é™¤æˆæƒä¿¡æ¯ï¼Œå†é‡å¯kubeletç”Ÿæˆæ–°çš„æˆæƒä¿¡æ¯ï¼Œç„¶åæˆæƒé€šè¿‡å³å¯çœ‹åˆ°æ–°çš„åå­—çš„nodeèŠ‚ç‚¹ã€‚</p><p>åªæœ‰å½“æˆæƒé€šè¿‡åï¼Œkubeletç”Ÿæˆäº†è¯ä¹¦æ–‡ä»¶ï¼Œkubeletçš„ç«¯å£æ‰ä¼šè¢«å¯åŠ¨</p><p>æ³¨æ„ï¼šå½“kubeletçš„æˆæƒè¢«masterè¯·æ±‚é€šåï¼Œkube-proxyå¯åŠ¨æˆåŠŸåï¼ŒèŠ‚ç‚¹æ‰ä¼šæ­£çœŸçš„åŠ å…¥é›†ç¾¤ï¼Œå³ä½¿kubectl get > nodeçœ‹åˆ°çš„èŠ‚ç‚¹æ˜¯Readyï¼Œè¯¥èŠ‚ç‚¹ä¹Ÿæ˜¯ä¸å¯ç”¨çš„ï¼Œå¿…é¡»å½“kube-proxyå¯åŠ¨å®Œæ¯•åï¼Œè¿™ä¸ªèŠ‚ç‚¹æ‰ç®—æ­£çœŸçš„å¯åŠ¨å®Œæ¯•.</p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># masterèŠ‚ç‚¹ä¸Šï¼Œè·å–è¯·æ±‚åˆ—è¡¨</span>
&gt; kubectl get csr
<span class=c1># output</span>
NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           REQUESTEDDURATION   CONDITION
node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I   2m46s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   &lt;none&gt;              Pending


<span class=c1># å‡†è®¸è¯¥èŠ‚ç‚¹åŠ å…¥é›†ç¾¤</span>
&gt; kubectl certificate approve node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I
<span class=c1># output</span>
certificatesigningrequest.certificates.k8s.io/node-csr-VVgl1LpQ91JlbJLifEJIy_0KlbQ1mih6GPaGfaykQ-I approved
</code></pre></td></tr></table></div></div><p>èŠ‚ç‚¹åŠ å…¥ç»“æœ<code>kubectl get nodes</code>ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824113851.png data-srcset="https://cdn.agou-ops.cn/others/20230824113851.png, https://cdn.agou-ops.cn/others/20230824113851.png 1.5x, https://cdn.agou-ops.cn/others/20230824113851.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824113851.png title=image.png></p><h4 id=463-éƒ¨ç½²kube-proxy>4.6.3 éƒ¨ç½²kube-proxy</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>cat &gt; kube-proxy.yml <span class=s>&lt;&lt; EOF
</span><span class=s>apiVersion: v1
</span><span class=s>kind: ServiceAccount
</span><span class=s>metadata:
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>---
</span><span class=s>apiVersion: rbac.authorization.k8s.io/v1
</span><span class=s>kind: ClusterRoleBinding
</span><span class=s>metadata:
</span><span class=s>  name: system:kube-proxy
</span><span class=s>roleRef:
</span><span class=s>  apiGroup: rbac.authorization.k8s.io
</span><span class=s>  kind: ClusterRole
</span><span class=s>  name: system:node-proxier
</span><span class=s>subjects:
</span><span class=s>- kind: ServiceAccount
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>---
</span><span class=s>apiVersion: v1
</span><span class=s>kind: Secret
</span><span class=s>metadata:
</span><span class=s>  name: kube-proxy
</span><span class=s>  namespace: kube-system
</span><span class=s>  annotations:
</span><span class=s>    kubernetes.io/service-account.name: &#34;kube-proxy&#34;
</span><span class=s>type: kubernetes.io/service-account-token
</span><span class=s>EOF</span>

kubectl apply -f kube-proxy.yml
<span class=c1># è·å–token</span>
<span class=nv>JWT_TOKEN</span><span class=o>=</span><span class=k>$(</span>kubectl -n kube-system get secret/kube-proxy <span class=se>\
</span><span class=se></span>--output<span class=o>=</span><span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.token}&#39;</span> <span class=p>|</span> base64 -d<span class=k>)</span>

<span class=c1># æ·»åŠ é›†ç¾¤apiserverä¿¡æ¯</span>
kubectl config set-cluster kubernetes   <span class=se>\
</span><span class=se></span>  --certificate-authority<span class=o>=</span>/etc/kubernetes/TLS/k8s/ca.pem <span class=se>\
</span><span class=se></span>  --embed-certs<span class=o>=</span><span class=nb>true</span>    <span class=se>\
</span><span class=se></span>  --server<span class=o>=</span><span class=s2>&#34;https://172.19.82.157:6443&#34;</span> <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># æ·»åŠ token</span>
kubectl config set-credentials system:kube-proxy    <span class=se>\
</span><span class=se></span>  --token<span class=o>=</span><span class=si>${</span><span class=nv>JWT_TOKEN</span><span class=si>}</span>   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># æ·»åŠ ç”¨æˆ·</span>
kubectl config set-context default    <span class=se>\
</span><span class=se></span>  --cluster<span class=o>=</span>kubernetes   <span class=se>\
</span><span class=se></span>  --user<span class=o>=</span>system:kube-proxy   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig
<span class=c1># æŒ‡å®šé»˜è®¤çš„é›†ç¾¤</span>
kubectl config use-context default   <span class=se>\
</span><span class=se></span>  --kubeconfig<span class=o>=</span>/etc/kubernetes/config/kube-proxy.kubeconfig


<span class=c1># å‚è€ƒï¼šhttps://kubernetes.io/zh-cn/docs/reference/config-api/kube-proxy-config.v1alpha1/</span>
vim /etc/kubernetes/config/kube-proxy-conf.yml
apiVersion: kubeproxy.config.k8s.io/v1alpha1
bindAddress: 172.19.82.157
clientConnection:
  acceptContentTypes: <span class=s2>&#34;&#34;</span>
  burst: <span class=m>10</span>
  contentType: application/vnd.kubernetes.protobuf
  kubeconfig: /etc/kubernetes/config/kube-proxy.kubeconfig
  qps: <span class=m>5</span>
clusterCIDR: 10.244.0.0/16
configSyncPeriod: 15m0s
conntrack:
  max: null
  maxPerCore: <span class=m>32768</span>
  min: <span class=m>131072</span>
  tcpCloseWaitTimeout: 1h0m0s
  tcpEstablishedTimeout: 24h0m0s
enableProfiling: <span class=nb>false</span>
healthzBindAddress: 0.0.0.0:10256
hostnameOverride: <span class=s2>&#34;</span><span class=nv>$a</span><span class=s2>&#34;</span>
iptables:
  masqueradeAll: <span class=nb>false</span>
  masqueradeBit: <span class=m>14</span>
  minSyncPeriod: 0s
  syncPeriod: 30s
ipvs:
  masqueradeAll: <span class=nb>true</span>
  minSyncPeriod: 5s
  scheduler: <span class=s2>&#34;rr&#34;</span>
  syncPeriod: 30s
kind: KubeProxyConfiguration
metricsBindAddress: 127.0.0.1:10249
mode: <span class=s2>&#34;ipvs&#34;</span>
nodePortAddresses: null
oomScoreAdj: -999
portRange: <span class=s2>&#34;&#34;</span>
udpIdleTimeout: 250ms


vim /usr/local/kubernetes/server/bin/kube-proxy-startup.sh
<span class=c1>#!/usr/bin/env sh</span>
./kube-proxy <span class=se>\
</span><span class=se></span>  --config<span class=o>=</span>/etc/kubernetes/config/kube-proxy-conf.yml <span class=se>\
</span><span class=se></span>  --v<span class=o>=</span><span class=m>2</span>

chmod +x /usr/local/kubernetes/server/bin/kube-proxy-startup.sh
mkdir -pv /data/logs/kubernetes/kube-proxy/

vim /etc/supervisor/conf.d/kube-proxy.conf
<span class=o>[</span>program:kube-proxy-157<span class=o>]</span>
<span class=nv>command</span><span class=o>=</span>/usr/local/kubernetes/server/bin/kube-proxy-startup.sh     <span class=p>;</span> the program <span class=o>(</span>relative uses PATH, can take args<span class=o>)</span>
<span class=nv>numprocs</span><span class=o>=</span><span class=m>1</span>                                                               <span class=p>;</span> number of processes copies to start <span class=o>(</span>def 1<span class=o>)</span>
<span class=nv>directory</span><span class=o>=</span>/usr/local/kubernetes/server/bin                                  <span class=p>;</span> directory to cwd to before <span class=nb>exec</span> <span class=o>(</span>def no cwd<span class=o>)</span>
<span class=nv>autostart</span><span class=o>=</span><span class=nb>true</span>                                                           <span class=p>;</span> start at supervisord start <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>autorestart</span><span class=o>=</span><span class=nb>true</span>                                                         <span class=p>;</span> retstart at unexpected quit <span class=o>(</span>default: <span class=nb>true</span><span class=o>)</span>
<span class=nv>startsecs</span><span class=o>=</span><span class=m>0</span>                                                             <span class=p>;</span> number of secs prog must stay running <span class=o>(</span>def. 1<span class=o>)</span>
<span class=nv>startretries</span><span class=o>=</span><span class=m>3</span>                                                           <span class=p>;</span> max <span class=c1># of serial start failures (default 3)</span>
<span class=nv>exitcodes</span><span class=o>=</span>0,2                                                            <span class=p>;</span> <span class=s1>&#39;expected&#39;</span> <span class=nb>exit</span> codes <span class=k>for</span> process <span class=o>(</span>default 0,2<span class=o>)</span>
<span class=nv>stopsignal</span><span class=o>=</span>QUIT                                                          <span class=p>;</span> signal used to <span class=nb>kill</span> process <span class=o>(</span>default TERM<span class=o>)</span>
<span class=nv>stopwaitsecs</span><span class=o>=</span><span class=m>10</span>                                                          <span class=p>;</span> max num secs to <span class=nb>wait</span> b4 SIGKILL <span class=o>(</span>default 10<span class=o>)</span>
<span class=nv>user</span><span class=o>=</span>root                                                                <span class=p>;</span> setuid to this UNIX account to run the program
<span class=nv>redirect_stderr</span><span class=o>=</span><span class=nb>true</span>                                                     <span class=p>;</span> redirect proc stderr to stdout <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>
<span class=nv>stdout_logfile</span><span class=o>=</span>/data/logs/kubernetes/kube-proxy/kube-proxy.stdout.log <span class=p>;</span> stderr log path, NONE <span class=k>for</span> none<span class=p>;</span> default AUTO
<span class=nv>stdout_logfile_maxbytes</span><span class=o>=</span>64MB                                             <span class=p>;</span> max <span class=c1># logfile bytes b4 rotation (default 50MB)</span>
<span class=nv>stdout_logfile_backups</span><span class=o>=</span><span class=m>4</span>                                                 <span class=p>;</span> <span class=c1># of stdout logfile backups (default 10)</span>
<span class=nv>stdout_capture_maxbytes</span><span class=o>=</span>1MB                                              <span class=p>;</span> number of bytes in <span class=s1>&#39;capturemode&#39;</span> <span class=o>(</span>default 0<span class=o>)</span>
<span class=nv>stdout_events_enabled</span><span class=o>=</span><span class=nb>false</span>                                              <span class=p>;</span> emit events on stdout writes <span class=o>(</span>default <span class=nb>false</span><span class=o>)</span>

supervisorctl update
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824115519.png data-srcset="https://cdn.agou-ops.cn/others/20230824115519.png, https://cdn.agou-ops.cn/others/20230824115519.png 1.5x, https://cdn.agou-ops.cn/others/20230824115519.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824115519.png title=image.png></p><h4 id=464-æˆæƒapiserverè®¿é—®kubelet>4.6.4 æˆæƒapiserverè®¿é—®kubelet</h4><p>å¦‚æœä¸åšè¯¥æˆæƒçš„è¯ï¼Œä¼šå¯¼è‡´kubectlæ— æ³•è·å–åˆ°é›†ç¾¤çš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚logs.
åˆ›å»ºä¸€ä¸ªRBACèµ„æºä½¿å¾—apiserverèƒ½å¤Ÿè®¿é—®kubeletï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
vim apiserver2kubelet-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: <span class=s2>&#34;true&#34;</span>
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: system:kube-apiserver-to-kubelet
rules:
  - apiGroups:
      - <span class=s2>&#34;&#34;</span>
    resources:
      - nodes/proxy
      - nodes/stats
      - nodes/log
      - nodes/spec
      - nodes/metrics
      - pods/log
    verbs:
      - <span class=s2>&#34;*&#34;</span>
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: system:kube-apiserver
  namespace: <span class=s2>&#34;&#34;</span>
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:kube-apiserver-to-kubelet
subjects:
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: kubernetes


kubectl apply -f apiserver2kubelet-rbac.yaml
<span class=c1># output</span>
clusterrole.rbac.authorization.k8s.io/system:apiserver2kubelet created
clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created
</code></pre></td></tr></table></div></div><h4 id=465-éƒ¨ç½²flannelç½‘ç»œç»„ä»¶>4.6.5 éƒ¨ç½²flannelç½‘ç»œç»„ä»¶</h4><p>éƒ¨ç½²å®Œä»¥ä¸Šç»„ä»¶ä¹‹åï¼Œä½¿ç”¨<code>kubectl get nodes</code>å‘ç°æ–°åŠ è¿›æ¥çš„masterèŠ‚ç‚¹å¤„äº<code>NotReady</code>çŠ¶æ€ï¼ŒåŸå› æ˜¯æ²¡æœ‰ç½‘ç»œç»„ä»¶ï¼Œä¸€æ—¦å®‰è£…å¥½ç½‘ç»œç»„ä»¶ä¼šç«‹å³å˜ä¸º<code>Ready</code>çŠ¶æ€ã€‚</p><p>é…ç½®containerdä½¿ç”¨ä»£ç†å’Œç§æœ‰ä»“ï¼ˆä¸ç„¶é•œåƒæ‹‰ä¸ä¸‹æ¥å–”ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># é…ç½®ä»£ç†</span>
vim /lib/systemd/system/containerd.service
<span class=c1># åœ¨Servicesé…ç½®æ®µæ·»åŠ </span>
<span class=o>[</span>Service<span class=o>]</span>
...
<span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTP_PROXY=172.19.82.100:7891&#34;</span>
<span class=nv>Environment</span><span class=o>=</span><span class=s2>&#34;HTTPS_PROXY=172.19.82.100:7891&#34;</span>
...

systemctl daemon-reload

<span class=c1># é…ç½®ç§æœ‰ä»“</span>
vim /etc/containerd/config.toml
<span class=c1># å¤§æ¦‚ç¬¬149è¡Œå¼€å§‹</span>
...
      <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs<span class=o>]</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;harbor.xxx.local&#34;</span>.auth<span class=o>]</span>
        <span class=nv>username</span> <span class=o>=</span> <span class=s2>&#34;al-admin&#34;</span>
        <span class=nv>password</span> <span class=o>=</span> <span class=s2>&#34;52PXZ2IDNWzk&#34;</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.configs.<span class=s2>&#34;harbor.xxx.local&#34;</span>.tls<span class=o>]</span>
        <span class=nv>insecure_skip_verify</span> <span class=o>=</span> <span class=nb>true</span>
      <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors<span class=o>]</span>
        <span class=o>[</span>plugins.<span class=s2>&#34;io.containerd.grpc.v1.cri&#34;</span>.registry.mirrors.<span class=s2>&#34;harbor.xxx.local&#34;</span><span class=o>]</span>
         <span class=nv>endpoint</span> <span class=o>=</span> <span class=o>[</span><span class=s2>&#34;https://harbor.xxx.local&#34;</span><span class=o>]</span>

...

systemctl restart containerd
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230824134826.png data-srcset="https://cdn.agou-ops.cn/others/20230824134826.png, https://cdn.agou-ops.cn/others/20230824134826.png 1.5x, https://cdn.agou-ops.cn/others/20230824134826.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230824134826.png title=image.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>cd</span> /etc/kubernetes/config
wget https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml
<span class=c1># å¦‚æœä½ ç”¨çš„ä¸æ˜¯10.244.0.0/16è¿™ä¸ªç½‘æ®µï¼Œåˆ™éœ€è¦æ‰‹åŠ¨ä¿®æ”¹kube-flannel.ymlèµ„æºé…ç½®æ–‡ä»¶ã€‚</span>
<span class=c1># å¦‚</span>
vim kube-flannel.yml
...
  net-conf.json: <span class=p>|</span>
    <span class=o>{</span>
      <span class=s2>&#34;Network&#34;</span>: <span class=s2>&#34;10.96.0.0/16&#34;</span>,   <span class=c1># æ”¹è¿™é‡Œ</span>
      <span class=s2>&#34;Backend&#34;</span>: <span class=o>{</span>
        <span class=s2>&#34;Type&#34;</span>: <span class=s2>&#34;vxlan&#34;</span>
      <span class=o>}</span>
    <span class=o>}</span>
...

kubectl apply -f kube-flannel.yml
</code></pre></td></tr></table></div></div><p>æ£€æŸ¥flannelè¿è¡ŒçŠ¶æ€<code>kubectl get po -n kube-flannel</code>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141026.png data-srcset="https://cdn.agou-ops.cn/others/20230825141026.png, https://cdn.agou-ops.cn/others/20230825141026.png 1.5x, https://cdn.agou-ops.cn/others/20230825141026.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141026.png title=image.png></p><h3 id=47-æ£€æŸ¥masterèŠ‚ç‚¹éƒ¨ç½²ç»“æœ>4.7 æ£€æŸ¥masterèŠ‚ç‚¹éƒ¨ç½²ç»“æœ</h3><h4 id=471-æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€>4.7.1 æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€</h4><ul><li>æœåŠ¡è¿è¡ŒçŠ¶æ€ï¼ˆ<code>supervisorctl status</code>ï¼‰ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141505.png data-srcset="https://cdn.agou-ops.cn/others/20230825141505.png, https://cdn.agou-ops.cn/others/20230825141505.png 1.5x, https://cdn.agou-ops.cn/others/20230825141505.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141505.png title=image.png></li><li>ç»„ä»¶çŠ¶æ€ï¼ˆ<code>kubectl get cs</code>ï¼‰ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141536.png data-srcset="https://cdn.agou-ops.cn/others/20230825141536.png, https://cdn.agou-ops.cn/others/20230825141536.png 1.5x, https://cdn.agou-ops.cn/others/20230825141536.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141536.png title=image.png></li><li>masterèŠ‚ç‚¹çŠ¶æ€(<code>kubectl get node -owide</code>)
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825141605.png data-srcset="https://cdn.agou-ops.cn/others/20230825141605.png, https://cdn.agou-ops.cn/others/20230825141605.png 1.5x, https://cdn.agou-ops.cn/others/20230825141605.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825141605.png title=image.png>
å¦‚æœä»¥ä¸Šæœ‰æŠ¥é”™ï¼Œå°±å›å¤´æ£€æŸ¥æˆ–è€…é‡æ–°éƒ¨ç½²ä¸€ä¸‹æœ‰é—®é¢˜çš„æœåŠ¡å³å¯ã€‚</li></ul><h4 id=472-é™„æ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹>4.7.2 é™„ï¼šæ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹</h4><ul><li>è¯ä¹¦åŠé…ç½®æ–‡ä»¶ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> tree /etc/kubernetes/
/etc/kubernetes/             <span class=c1># è¯¥ç›®å½•ä¸ºk8sé›†ç¾¤çš„æ‰€æœ‰è¯ä¹¦å’Œé…ç½®æ–‡ä»¶å­˜æ”¾ç›®å½•</span>
â”œâ”€â”€ TLS                      <span class=c1># è¯ä¹¦å­˜æ”¾ç›®å½•</span>
â”‚Â Â  â”œâ”€â”€ etcd                 <span class=c1># etcdè¯ä¹¦å­˜æ”¾ç›®å½•ï¼Œå•ç‹¬çš„ä¸€ä¸ªCA</span>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca-config.json   <span class=c1># caé…ç½®æ–‡ä»¶</span>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca-csr.json      <span class=c1># caè¯·æ±‚é…ç½®æ–‡ä»¶</span>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca-key.pem       <span class=c1># caç§é’¥</span>
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca.csr
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etcd-server-csr.json
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etcd-server-key.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etcd-server.csr
â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd-server.pem
â”‚Â Â  â””â”€â”€ k8s                  <span class=c1># k8sé›†ç¾¤ç»„ä»¶è¯ä¹¦ç›®å½•</span>
â”‚Â Â      â”œâ”€â”€ ca-config.json
â”‚Â Â      â”œâ”€â”€ ca-csr.json
â”‚Â Â      â”œâ”€â”€ ca-key.pem
â”‚Â Â      â”œâ”€â”€ ca.csr
â”‚Â Â      â”œâ”€â”€ ca.pem
â”‚Â Â      â”œâ”€â”€ kube-apiserver-csr.json
â”‚Â Â      â”œâ”€â”€ kube-apiserver-key.pem
â”‚Â Â      â”œâ”€â”€ kube-apiserver.csr
â”‚Â Â      â”œâ”€â”€ kube-apiserver.pem
â”‚Â Â      â”œâ”€â”€ kube-controller-manager-csr.json
â”‚Â Â      â”œâ”€â”€ kube-controller-manager-key.pem
â”‚Â Â      â”œâ”€â”€ kube-controller-manager.csr
â”‚Â Â      â”œâ”€â”€ kube-controller-manager.pem
â”‚Â Â      â”œâ”€â”€ kube-scheduler-csr.json
â”‚Â Â      â”œâ”€â”€ kube-scheduler-key.pem
â”‚Â Â      â”œâ”€â”€ kube-scheduler.csr
â”‚Â Â      â”œâ”€â”€ kube-scheduler.pem
â”‚Â Â      â”œâ”€â”€ kubectl-csr.json
â”‚Â Â      â”œâ”€â”€ kubectl-key.pem
â”‚Â Â      â”œâ”€â”€ kubectl.csr
â”‚Â Â      â”œâ”€â”€ kubectl.pem
â”‚Â Â      â”œâ”€â”€ proxy-client
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-ca-csr.json
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-ca-key.pem
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-ca.csr
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-ca.pem
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-client-csr.json
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-client-key.pem
â”‚Â Â      â”‚Â Â  â”œâ”€â”€ front-proxy-client.csr
â”‚Â Â      â”‚Â Â  â””â”€â”€ front-proxy-client.pem
â”‚Â Â      â”œâ”€â”€ sa.key
â”‚Â Â      â””â”€â”€ sa.pub
â”œâ”€â”€ config               <span class=c1># æ‰€æœ‰é…ç½®ï¼ŒåŒ…æ‹¬è®¤è¯å’Œå„ç§kubeconfig</span>
â”‚Â Â  â”œâ”€â”€ apiserver2kubelet-rbac.yaml
â”‚Â Â  â”œâ”€â”€ bootstrap.secret.yaml
â”‚Â Â  â”œâ”€â”€ kube-controller-manager.kubeconfig
â”‚Â Â  â”œâ”€â”€ kube-flannel.yml
â”‚Â Â  â”œâ”€â”€ kube-proxy-config.yml
â”‚Â Â  â”œâ”€â”€ kube-proxy-scret.yml
â”‚Â Â  â”œâ”€â”€ kube-proxy.kubeconfig
â”‚Â Â  â”œâ”€â”€ kube-scheduler.kubeconfig
â”‚Â Â  â”œâ”€â”€ kubelet-bootstrap.kubeconfig
â”‚Â Â  â”œâ”€â”€ kubelet-conf.yml
â”‚Â Â  â””â”€â”€ kubelet.kubeconfig
â””â”€â”€ manifests

<span class=m>7</span> directories, <span class=m>51</span> files

</code></pre></td></tr></table></div></div><ul><li>k8säºŒè¿›åˆ¶ç¨‹åºä»¥åŠå¯åŠ¨è„šæœ¬ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># ä»¥.shç»“å°¾çš„å°±æ˜¯å¯¹åº”æœåŠ¡çš„å¯åŠ¨è„šæœ¬</span>
 tree /usr/local/kubernetes/server/bin/
/usr/local/kubernetes/server/bin/
â”œâ”€â”€ apiextensions-apiserver
â”œâ”€â”€ kube-aggregator
â”œâ”€â”€ kube-apiserver
â”œâ”€â”€ kube-apiserver-startup.sh
â”œâ”€â”€ kube-controller-manager
â”œâ”€â”€ kube-controller-manager-startup.sh
â”œâ”€â”€ kube-log-runner
â”œâ”€â”€ kube-proxy
â”œâ”€â”€ kube-proxy-startup.sh
â”œâ”€â”€ kube-scheduler
â”œâ”€â”€ kube-scheduler-startup.sh
â”œâ”€â”€ kubeadm
â”œâ”€â”€ kubectl
â”œâ”€â”€ kubectl-convert
â”œâ”€â”€ kubelet
â”œâ”€â”€ kubelet-startup.sh
â””â”€â”€ mounter

<span class=m>1</span> directory, <span class=m>17</span> files
</code></pre></td></tr></table></div></div><ul><li>supervisoré…ç½®æ–‡ä»¶ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># k8så„ç»„ä»¶çš„supervisoré…ç½®</span>
 tree /etc/supervisor/conf.d/
/etc/supervisor/conf.d/
â”œâ”€â”€ apiserver.conf
â”œâ”€â”€ controller-manager.conf
â”œâ”€â”€ etcd-server.conf
â”œâ”€â”€ kube-proxy.conf
â”œâ”€â”€ kubelet.conf
â””â”€â”€ scheduler.conf

<span class=m>1</span> directory, <span class=m>6</span> files
</code></pre></td></tr></table></div></div><h2 id=äº”éƒ¨ç½²nodeèŠ‚ç‚¹>äº”ã€éƒ¨ç½²nodeèŠ‚ç‚¹</h2><p><strong>å…¶å®å®Œå…¨å¯ä»¥åˆå¹¶æˆä¸€ä¸ªï¼Œä½†æ˜¯ä¸ºäº†æ¡ç†æ¸…æ™°ï¼Œæ‰€ä»¥æ‹†å¼€å•ç‹¬å¼„ã€‚</strong>
åœ¨masterä¸Šå°†kubeletå’Œkube-proxyäºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‘ä¸‹å»ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># åˆ›å»ºç¨‹åºç›®å½•</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /usr/local/kubernetes/server/bin&#34;</span>
  <span class=c1># åˆ†å‘bootstrapè®¤è¯æ–‡ä»¶</span>
 scp -r /usr/local/kubernetes/server/bin/kubelet* /usr/local/kubernetes/server/bin/kube-proxy* <span class=nv>$i</span>:/usr/local/kubernetes/server/bin
  <span class=c1># å¢åŠ å¯æ‰§è¡Œæƒé™</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;chmod +x /usr/local/kubernetes/server/bin/*&#34;</span>
<span class=k>done</span>
</code></pre></td></tr></table></div></div><h3 id=51-éƒ¨ç½²kubelet>5.1 éƒ¨ç½²kubelet</h3><p>åœ¨masterèŠ‚ç‚¹ä¸Šåˆ†å‘è®¤è¯æ–‡ä»¶åŠkubeleté…ç½®æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># é…ç½®è¯ä¹¦åŠé…ç½®æ–‡ä»¶ç›®å½•</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /etc/kubernetes/{TLS,config,manifests}&#34;</span>
  <span class=c1># åˆ†å‘bootstrapè®¤è¯æ–‡ä»¶</span>
  scp /etc/kubernetes/config/kubelet-bootstrap.kubeconfig <span class=nv>$i</span>:/etc/kubernetes/config/kubelet-bootstrap.kubeconfig
  <span class=c1># å¤åˆ¶é…ç½®æ–‡ä»¶</span>
  scp /etc/kubernetes/config/kubelet-conf.yml <span class=nv>$i</span>:/etc/kubernetes/config/kubelet-conf.yml
  scp /etc/kubernetes/TLS/k8s/ca.pem <span class=nv>$i</span>:/etc/kubernetes/TLS/k8s/ca.pem
<span class=k>done</span>
</code></pre></td></tr></table></div></div><p>é…ç½®supervisorï¼ˆå’ŒmasterèŠ‚ç‚¹ç±»ä¼¼ï¼Œæ‰€ä»¥ç›´æ¥å¤åˆ¶è¿‡å»å¥½äº†ï¼‰ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  <span class=c1># åˆ›å»ºæ—¥å¿—ç›®å½•</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /data/logs/kubernetes/kubelet&#34;</span>
  <span class=c1># å¤åˆ¶kubeletçš„supervisoré…ç½®æ–‡ä»¶</span>
  scp /etc/supervisor/conf.d/kubelet.conf <span class=nv>$i</span>:/etc/supervisor/conf.d/kubelet.conf
  <span class=c1># ä¿®æ”¹idï¼Œæ–¹ä¾¿åŒºåˆ†ï¼Œè¿™é‡Œä¸çŸ¥ä¸ºä½•ä¸‹é¢å‘½ä»¤ä¸èƒ½ç”¨ã€‚ã€‚ï¼ˆæ‰‹åŠ¨æ”¹ä¸€ä¸‹å§</span>
  <span class=c1># ssh $i &#34;id=`ip a show dev eth0 | grep -w inet | awk &#39;{print $2}&#39; | sed -e &#39;s/.*\.\([0-9]\+\)\/.*/\1/&#39;` ; sed -i &#34;s/157/$id/&#34; /etc/supervisor/conf.d/kubelet.conf&#34;</span>
<span class=k>done</span>
</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825150503.png data-srcset="https://cdn.agou-ops.cn/others/20230825150503.png, https://cdn.agou-ops.cn/others/20230825150503.png 1.5x, https://cdn.agou-ops.cn/others/20230825150503.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825150503.png title=image.png>
æ”¹å®Œä¹‹ååœ¨node01å’Œnode02åˆ†åˆ«æ‰§è¡Œï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># node01</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kubelet-conf.yml
sed -i <span class=s2>&#34;s/master0/node01/&#34;</span> /usr/local/kubernetes/server/bin/kubelet-startup.sh
supervisor update

<span class=c1># node02</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>&#34;</span> /etc/kubernetes/config/kubelet-conf.yml
sed -i <span class=s2>&#34;s/master0/node02/&#34;</span> /usr/local/kubernetes/server/bin/kubelet-startup.sh
supervisor update
</code></pre></td></tr></table></div></div><p>å¯åŠ¨å®Œæˆä¹‹ååœ¨masterèŠ‚ç‚¹ä¸Šå¯ä»¥çœ‹åˆ°ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl get nodes
<span class=c1># output</span>
NAME      STATUS     ROLES    AGE     VERSION
master0   Ready      &lt;none&gt;   125m    v1.25.12
node01    NotReady   &lt;none&gt;   12s     v1.25.12
node02    NotReady   &lt;none&gt;   3m27s   v1.25.12
</code></pre></td></tr></table></div></div><h3 id=52-éƒ¨ç½²kube-proxy>5.2 éƒ¨ç½²kube-proxy</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span>
<span class=k>for</span> i in node01 node02<span class=p>;</span> <span class=k>do</span>
  ssh <span class=nv>$i</span> <span class=s2>&#34;mkdir -pv /data/logs/kubernetes/kube-proxy/&#34;</span>
  <span class=c1># æ‹·è´kube-proxyé…ç½®åˆ°nodeèŠ‚ç‚¹</span>
  scp /etc/kubernetes/config/kube-proxy.kubeconfig <span class=nv>$i</span>:/etc/kubernetes/config/kube-proxy.kubeconfig
  scp /etc/kubernetes/config/kube-proxy-conf.yml <span class=nv>$i</span>:/etc/kubernetes/config/kube-proxy-conf.yml
  scp /etc/supervisor/conf.d/kube-proxy.conf <span class=nv>$i</span>:/etc/supervisor/conf.d/kube-proxy.conf
<span class=k>done</span>

<span class=c1># åœ¨node01èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kube-proxy-conf.yml
supervisor update

<span class=c1># åœ¨node02èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span>
<span class=nv>IP</span><span class=o>=</span><span class=sb>`</span>ip a show dev eth0 <span class=p>|</span> grep -w inet <span class=p>|</span> awk <span class=s1>&#39;{print $2}&#39;</span> <span class=p>|</span> cut -d <span class=s1>&#39;/&#39;</span> -f 1<span class=sb>`</span>
sed -i <span class=s2>&#34;s/172.19.82.157/</span><span class=nv>$IP</span><span class=s2>/&#34;</span> /etc/kubernetes/config/kube-proxy-conf.yml
supervisor update

</code></pre></td></tr></table></div></div><h3 id=53-æ£€æŸ¥nodeèŠ‚ç‚¹éƒ¨ç½²ç»“æœ>5.3 æ£€æŸ¥nodeèŠ‚ç‚¹éƒ¨ç½²ç»“æœ</h3><h4 id=531-æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€>5.3.1 æ£€æŸ¥æœåŠ¡è¿è¡ŒçŠ¶æ€</h4><ul><li>supervisoræœåŠ¡è¿è¡ŒçŠ¶æ€ï¼ˆ<code>sueprvisorctl status</code>ï¼‰ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825154847.png data-srcset="https://cdn.agou-ops.cn/others/20230825154847.png, https://cdn.agou-ops.cn/others/20230825154847.png 1.5x, https://cdn.agou-ops.cn/others/20230825154847.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825154847.png title=image.png></li><li>ç½‘ç»œç»„ä»¶ä»¥åŠèŠ‚ç‚¹çŠ¶æ€ï¼š(<code>kubectl get node -owide/kubectl get po -A -owide</code>)ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825155014.png data-srcset="https://cdn.agou-ops.cn/others/20230825155014.png, https://cdn.agou-ops.cn/others/20230825155014.png 1.5x, https://cdn.agou-ops.cn/others/20230825155014.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825155014.png title=image.png></li></ul><h4 id=532-é™„æ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹>5.3.2 é™„ï¼šæ–‡ä»¶åˆ—è¡¨åŠç®€ä»‹</h4><p>ä»¥node01èŠ‚ç‚¹ä¸ºä¾‹ï¼Œå…¶ä»–nodeèŠ‚ç‚¹éƒ½ä¸€æ ·ã€‚</p><ul><li>è¯ä¹¦åŠé…ç½®æ–‡ä»¶ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash> tree /etc/kubernetes/
/etc/kubernetes/
â”œâ”€â”€ TLS
â”‚Â Â  â”œâ”€â”€ etcd
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca-key.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ca.pem
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ etcd-server-key.pem
â”‚Â Â  â”‚Â Â  â””â”€â”€ etcd-server.pem
â”‚Â Â  â””â”€â”€ k8s
â”‚Â Â      â””â”€â”€ ca.pem
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ kube-proxy-conf.yml
â”‚Â Â  â”œâ”€â”€ kube-proxy-config.yml
â”‚Â Â  â”œâ”€â”€ kube-proxy.kubeconfig
â”‚Â Â  â”œâ”€â”€ kubelet-bootstrap.kubeconfig
â”‚Â Â  â”œâ”€â”€ kubelet-conf.yml
â”‚Â Â  â””â”€â”€ kubelet.kubeconfig
â””â”€â”€ manifests

<span class=m>6</span> directories, <span class=m>11</span> files
</code></pre></td></tr></table></div></div><ul><li>supervisoré…ç½®æ–‡ä»¶ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>tree /etc/supervisor/conf.d/
/etc/supervisor/conf.d/
â”œâ”€â”€ etcd-server.conf
â”œâ”€â”€ kube-proxy.conf
â””â”€â”€ kubelet.conf

<span class=m>1</span> directory, <span class=m>3</span> files
</code></pre></td></tr></table></div></div><ul><li>k8sç»„ä»¶äºŒè¿›åˆ¶ç¨‹åºåŠå¯¹åº”å¯åŠ¨è„šæœ¬ä¸€è§ˆï¼š</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>tree /usr/local/kubernetes/server/bin/
/usr/local/kubernetes/server/bin/
â”œâ”€â”€ kube-proxy
â”œâ”€â”€ kube-proxy-startup.sh
â”œâ”€â”€ kubelet
â””â”€â”€ kubelet-startup.sh

<span class=m>1</span> directory, <span class=m>4</span> files
</code></pre></td></tr></table></div></div><h2 id=å…­å…¶ä»–å¯é€‰ç»„ä»¶å®‰è£…>å…­ã€å…¶ä»–å¯é€‰ç»„ä»¶å®‰è£…</h2><h3 id=61-coredns>6.1 coredns</h3><h4 id=611-éƒ¨ç½²coredns>6.1.1 éƒ¨ç½²coredns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># åœ¨masterèŠ‚ç‚¹ä¸Šæ‰§è¡Œ</span>
<span class=nb>cd</span> /etc/kubernetes/config
wget https://raw.githubusercontent.com/coredns/deployment/master/kubernetes/coredns.yaml.sed -O coredns.yaml

<span class=c1># ä¿®æ”¹èµ„æºæ¸…å•é‡Œé¢çš„Corefileå’ŒclusterIP</span>
vim coredns.yaml
<span class=c1># ç¬¬ä¸€å¤„</span>
...
  Corefile: <span class=p>|</span>
    .:53 <span class=o>{</span>
        errors
        health <span class=o>{</span>
          lameduck 5s
        <span class=o>}</span>
        ready
        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=o>{</span>  <span class=c1># ä¿®æ”¹åå‘è§£æ</span>
          fallthrough in-addr.arpa ip6.arpa
        <span class=o>}</span>
        prometheus :9153
        forward . 8.8.8.8 <span class=o>{</span>          <span class=c1># ä¿®æ”¹ä¸ºå¤–éƒ¨dnsè§£æåœ°å€ï¼Œå½“corednsè§£æä¸åˆ°æ—¶ä¼šä¼ ç»™è¯¥dns</span>
          max_concurrent <span class=m>1000</span>
        <span class=o>}</span>
        cache <span class=m>30</span>
        loop
        reload
        loadbalance
    <span class=o>}</span>                           <span class=c1># è¿™åé¢æœ‰ä¸ªSTUBDOMAINSå»æ‰</span>
...

<span class=c1># ç¬¬äºŒå¤„ï¼Œå¤§æ¦‚191è¡Œ</span>
...
  clusterIP: 10.100.0.2
...

<span class=c1># ä¿®æ”¹å®Œæˆä¹‹å</span>
kubectl apply -f coredns.yaml
</code></pre></td></tr></table></div></div><p>æ£€æŸ¥corednsè¿è¡ŒçŠ¶æ€ï¼š
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825162329.png data-srcset="https://cdn.agou-ops.cn/others/20230825162329.png, https://cdn.agou-ops.cn/others/20230825162329.png 1.5x, https://cdn.agou-ops.cn/others/20230825162329.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825162329.png title=image.png></p><h4 id=æµ‹è¯•coredns>æµ‹è¯•coredns</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim helloworld.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: helloworld
spec:
  selector:
    matchLabels:
      app: helloworld
  replicas: <span class=m>1</span>
  template:
    metadata:
      labels:
        app: helloworld
    spec:
      containers:
      - name: helloworld
        image: karthequian/helloworld:latest
        ports:
        - containerPort: <span class=m>80</span>
---
apiVersion: v1
kind: Service
metadata:
  name: helloworld-service
spec:
  selector:
    app: helloworld
  ports:
    - protocol: TCP
      port: <span class=m>80</span>
      targetPort: <span class=m>80</span>
  type: ClusterIP

kubectl apply -f helloworld.yaml

<span class=c1># è¿è¡Œç½‘ç»œæµ‹è¯•å®¹å™¨</span>
kubectl run tmp-shell --rm -i --tty --image nicolaka/netshoot
tmp-shell î‚° ~ î‚° dig kubernetes.default.svc.cluster.local +short
10.96.0.1
tmp-shell2 î‚° ~ î‚° dig helloworld-service.default.svc.cluster.local +short
10.105.77.246
</code></pre></td></tr></table></div></div><h3 id=62-nginx-ingress>6.2 nginx ingress</h3><p>å‚è€ƒé“¾æ¥ï¼š<a href=https://kubernetes.github.io/ingress-nginx/ target=_blank rel="noopener noreffer">https://kubernetes.github.io/ingress-nginx/</a></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml -O nginx-ingress.yaml

kubectl apply -f nginx-ingress.yaml
</code></pre></td></tr></table></div></div><h3 id=63-é¢æ¿>6.3 é¢æ¿</h3><h4 id=631-dashboard>6.3.1 dashboard</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>wget https://raw.githubusercontent.com/kubernetes/dashboard/v3.0.0-alpha0/charts/kubernetes-dashboard.yaml

kubectl apply -f kubernetes-dashboard.yaml

<span class=c1># ä¿®æ”¹dashboardçš„Servicesç±»å‹ä¸ºnodeportï¼Œæ–¹ä¾¿è®¿é—®</span>
kubectl --namespace kubernetes-dashboard patch svc kubernetes-dashboard -p <span class=s1>&#39;{&#34;spec&#34;: {&#34;type&#34;: &#34;NodePort&#34;}}&#39;</span>

</code></pre></td></tr></table></div></div><p><img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230825180332.png data-srcset="https://cdn.agou-ops.cn/others/20230825180332.png, https://cdn.agou-ops.cn/others/20230825180332.png 1.5x, https://cdn.agou-ops.cn/others/20230825180332.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230825180332.png title=image.png>
å®‰è£…å®Œæˆä¹‹åï¼Œä½¿ç”¨ä¸€ä¸‹å‘½ä»¤è·å–è‡ªåŠ¨åˆ†é…çš„nodeportï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>kubectl get svc/kubernetes-dashboard -n kubernetes-dashboard -owide
<span class=c1># output</span>
NAME                   TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class=o>(</span>S<span class=o>)</span>         AGE     SELECTOR
kubernetes-dashboard   NodePort   10.99.165.217   &lt;none&gt;        443:36046/TCP   3m54s   k8s-app<span class=o>=</span>kubernetes-dashboard
</code></pre></td></tr></table></div></div><p>è®¿é—®ä»»ä¸€èŠ‚ç‚¹çš„IPåŠ ä¸Šé¢çš„nodeportå³å¯ï¼Œæ¯”å¦‚ï¼š<a href=https://172.19.82.157:36046/#/login target=_blank rel="noopener noreffer">https://172.19.82.157:36046/#/login</a>
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230827094647.png data-srcset="https://cdn.agou-ops.cn/others/20230827094647.png, https://cdn.agou-ops.cn/others/20230827094647.png 1.5x, https://cdn.agou-ops.cn/others/20230827094647.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230827094647.png title=image.png>
åˆ›å»ºsaä½¿ç”¨tokenç™»å½•dashboardï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>vim dashboard-sa.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dashboard-admin
  namespace: kubernetes-dashboard
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: dashboard-admin
  namespace: kubernetes-dashboard
---
<span class=c1># æ³¨æ„è¾ƒæ–°ç‰ˆæœ¬çš„k8sä¸ä¼šè‡ªåŠ¨åˆ›å»ºsecret</span>
apiVersion: v1
kind: Secret
metadata:
  name: dashboard-admin-secret
  namespace: kubernetes-dashboard
  annotations:
    kubernetes.io/service-account.name: dashboard-admin
type: kubernetes.io/service-account-token

kubectl apply -f dashboard-sa.yaml

<span class=c1># è·å–token</span>
 kubectl describe secret dashboard-admin-secret -n kubernetes-dashboard
<span class=c1># output</span>

Name:         dashboard-admin-secret
Namespace:    kubernetes-dashboard
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: dashboard-admin
              kubernetes.io/service-account.uid: 80bf284e-06e7-4ea4-b747-0a2e77f0ed1f

Type:  kubernetes.io/service-account-token

<span class=nv>Data</span>
<span class=o>====</span>
ca.crt:     <span class=m>1314</span> bytes
namespace:  <span class=m>20</span> bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlhYRkQ2bmRNc0s2WktiWHYxT044M1ZfWTQ2UWRxZk81U3Q4TFJnRFo2QncifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tc2VjcmV0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjgwYmYyODRlLTA2ZTctNGVhNC1iNzQ3LTBhMmU3N2YwZWQxZiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlcm5ldGVzLWRhc2hib2FyZDpkYXNoYm9hcmQtYWRtaW4ifQ.RN82A652pjg5PSoIfVCrzj6b6irTQAaHP4Sr-ROf2LCA3A-GttYaH3Tq0pNQx3x2lfhEK2wqWjmKUtcP7yCfoemkXNdAHV_XOnM1qJ86crv-DHkbaqc8JikwyPOucwex8pZ-EeblDpNUyD-QKbImWRmE3XF09g3tBgRrqANFBKbJd82ABKg_BZyQV1iLEz0wN1Int3uk4f8nm19_YoPfjJPE1UcmKcI0m44aqqANSYNU4e6gej4d-YkBHvaIUZ0-9j9r7t_dKS1qVQiqcAwxdFlt0Tjxbi2KurOIAtazQriHaSbe7VhDJa_v-WYfzcZuHgoWpAELyAR9rbcyScgMbw
</code></pre></td></tr></table></div></div><p>ä½¿ç”¨ä¸Šé¢è¾“å‡ºçš„tokenå³å¯ç™»å½•dashboard.
<img class=lazyload src=/myBlog-2/svg/loading.min.svg data-src=https://cdn.agou-ops.cn/others/20230827100314.png data-srcset="https://cdn.agou-ops.cn/others/20230827100314.png, https://cdn.agou-ops.cn/others/20230827100314.png 1.5x, https://cdn.agou-ops.cn/others/20230827100314.png 2x" data-sizes=auto alt=https://cdn.agou-ops.cn/others/20230827100314.png title=image.png></p><h4 id=632-rancher>6.3.2 rancher</h4><p>ç•¥ï¼Œå‚è€ƒï¼š<a href=https://ranchermanager.docs.rancher.com/pages-for-subheaders/install-upgrade-on-a-kubernetes-cluster#install-the-rancher-helm-chart target=_blank rel="noopener noreffer">ä½¿ç”¨helmå¿«é€Ÿå®‰è£…rancher</a></p><h2 id=ä¸ƒæœªå®Œå¾…ç»­>ä¸ƒã€æœªå®Œå¾…ç»­</h2><p>To Be Continued&mldr;</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>æ›´æ–°äº 2023-08-27</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/index.md target=_blank>é˜…è¯»åŸå§‹æ–‡æ¡£</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="åˆ†äº«åˆ° Twitter" data-sharer=twitter data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12" data-hashtags=k8s,kubernetes,äºŒè¿›åˆ¶å®‰è£…><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Facebook" data-sharer=facebook data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-hashtag=k8s><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Hacker News" data-sharer=hackernews data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° Line" data-sharer=line data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° å¾®åš" data-sharer=weibo data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12" data-ralateuid=AGou-ops><i class="fab fa-weibo fa-fw"></i></a><a href=javascript:void(0); title="åˆ†äº«åˆ° ç™¾åº¦" data-sharer=baidu data-url=https://agou-ops.cn/myBlog-2/post/k8s-debian12%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/ data-title="Debian12äºŒè¿›åˆ¶å®‰è£…k8s v1.25.12"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/baidu.svg></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/myBlog-2/tags/k8s/>k8s</a>,&nbsp;<a href=/myBlog-2/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/myBlog-2/tags/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85/>äºŒè¿›åˆ¶å®‰è£…</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>è¿”å›</a></span>&nbsp;|&nbsp;<span><a href=/myBlog-2/>ä¸»é¡µ</a></span></section></div><div class=post-nav><a href=/myBlog-2/post/containerdharbor%E7%A7%81%E6%9C%89%E4%BB%93https/ class=prev rel=prev title=Containerdï¼‹Harborç§æœ‰ä»“ï¼ˆhttpsï¼‰><i class="fas fa-angle-left fa-fw"></i>Containerdï¼‹Harborç§æœ‰ä»“ï¼ˆhttpsï¼‰</a>
<a href=/myBlog-2/post/k8s%E4%B8%AD%E9%83%A8%E7%BD%B2apollo%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/ class=next rel=next title=K8sä¸­éƒ¨ç½²Apolloé…ç½®ä¸­å¿ƒ>K8sä¸­éƒ¨ç½²Apolloé…ç½®ä¸­å¿ƒ<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://agou-ops.github.io/-/ target=_blank rel="noopener noreferrer" style=color:red>ã€AGou-ops.cnã€‘</a> å¤‡ä»½ç«™ç‚¹</div><div class=footer-line>ç”± <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.75.1">Hugo</a> å¼ºåŠ›é©±åŠ¨ | ä¸»é¢˜ - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i>LoveIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/myBlog-2/ target=_blank>AGou-ops</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp>é²ICPå¤‡19050296å·-2</span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=å›åˆ°é¡¶éƒ¨><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=æŸ¥çœ‹è¯„è®º><i class="fas fa-comment fa-fw"></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/twemoji@13.0.0/dist/twemoji.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"å¤åˆ¶åˆ°å‰ªè´´æ¿","maxShownLines":10},"comment":{"utterances":{"darkTheme":"github-dark","issueTerm":"pathname","label":"","lightTheme":"github-light","repo":"AGou-ops/comments"}},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"search":{"algoliaAppID":"5M8VQRD7W9","algoliaIndex":"blog-2","algoliaSearchKey":"2fcdbd0ce638664e7a28cc64939603b9","highlightTag":"em","maxResultLength":10,"noResultsFound":"æ²¡æœ‰æ‰¾åˆ°ç»“æœ","snippetLength":50,"type":"algolia"},"twemoji":true};</script><script type=text/javascript src=/myBlog-2/js/theme.min.js></script></body></html>